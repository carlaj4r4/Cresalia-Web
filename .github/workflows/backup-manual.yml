name: Backup Manual de Supabase

# Este workflow puede ejecutarse manualmente desde GitHub Actions
# Ãštil para crear backups on-demand o para testing

on:
  workflow_dispatch:

jobs:
  backup:
    name: Crear Backup Manual
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ðŸ“š Instalar dependencias
        run: |
          cd scripts
          if [ ! -f "package.json" ]; then
            cat > package.json << EOF
          {
            "name": "backup-supabase-script",
            "version": "1.0.0",
            "private": true,
            "dependencies": {
              "@supabase/supabase-js": "^2.39.0"
            }
          }
          EOF
          fi
          npm install
      
      - name: ðŸ” Verificar secrets (debug)
        run: |
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "âŒ Error: SUPABASE_URL secret no estÃ¡ configurado"
            echo "ðŸ’¡ Ve a Settings â†’ Secrets and variables â†’ Actions"
            echo "ðŸ’¡ Crea un secret con name: SUPABASE_URL"
            exit 1
          else
            echo "âœ… SUPABASE_URL estÃ¡ configurado (longitud: ${#SUPABASE_URL} caracteres)"
            # Mostrar solo los primeros caracteres para debug (sin exponer el secreto completo)
            echo "   Primeros caracteres: $(echo '${{ secrets.SUPABASE_URL }}' | head -c 30)..."
          fi
          
          if [ -z "${{ secrets.SUPABASE_SERVICE_KEY }}" ]; then
            echo "âŒ Error: SUPABASE_SERVICE_KEY secret no estÃ¡ configurado"
            echo "ðŸ’¡ Ve a Settings â†’ Secrets and variables â†’ Actions"
            echo "ðŸ’¡ Crea un secret con name: SUPABASE_SERVICE_KEY"
            exit 1
          else
            echo "âœ… SUPABASE_SERVICE_KEY estÃ¡ configurado (longitud: ${#SUPABASE_SERVICE_KEY} caracteres)"
          fi
      
      - name: ðŸ’¾ Ejecutar Backup
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          if [ -f "scripts/backup-supabase.js" ]; then
            cd scripts
            node backup-supabase.js
          else
            echo "âŒ Error: No se encontrÃ³ scripts/backup-supabase.js"
            exit 1
          fi
      
      - name: ðŸ“¦ Comprimir backups
        if: success()
        run: |
          cd backups
          tar -czf ../backup-manual-$(date +%Y%m%d-%H%M%S).tar.gz *.json
          cd ..
      
      - name: ðŸ“¤ Subir backups como artefacto
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: supabase-backup-manual-${{ github.run_number }}
          path: |
            backups/*.json
            backup-manual-*.tar.gz
          retention-days: 90
          if-no-files-found: warn
      
      - name: âœ… Backup completado
        if: success()
        run: |
          echo "âœ… Backup manual completado exitosamente"

