name: Backup Manual de Supabase (Tiendas + Comunidades)

# Este workflow puede ejecutarse manualmente desde GitHub Actions
# Ãštil para crear backups on-demand o para testing

on:
  workflow_dispatch:

jobs:
  backup-tiendas:
    name: Backup Manual Cresalia-Tiendas
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ“š Instalar dependencias
        run: |
          echo "ğŸ“¦ Instalando dependencias de Supabase..."
          cd scripts
          if [ ! -f "package.json" ]; then
            echo "ğŸ“ Creando package.json..."
            echo '{"name":"backup-supabase-script","version":"1.0.0","private":true,"dependencies":{"@supabase/supabase-js":"^2.39.0"}}' > package.json
          fi
          echo "ğŸ“¥ Instalando @supabase/supabase-js..."
          npm install --no-save @supabase/supabase-js@^2.39.0
          cd ..
          echo "âœ… Dependencias instaladas"
      
      - name: ğŸ” Verificar secrets (debug)
        run: |
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "âŒ Error: SUPABASE_URL secret no estÃ¡ configurado"
            echo "ğŸ’¡ Ve a Settings â†’ Secrets and variables â†’ Actions"
            echo "ğŸ’¡ Crea un secret con name: SUPABASE_URL (para Tiendas)"
            exit 1
          else
            echo "âœ… SUPABASE_URL estÃ¡ configurado (Tiendas)"
          fi
          
          if [ -z "${{ secrets.SUPABASE_SERVICE_KEY }}" ]; then
            echo "âŒ Error: SUPABASE_SERVICE_KEY secret no estÃ¡ configurado"
            echo "ğŸ’¡ Ve a Settings â†’ Secrets and variables â†’ Actions"
            echo "ğŸ’¡ Crea un secret con name: SUPABASE_SERVICE_KEY (para Tiendas)"
            exit 1
          else
            echo "âœ… SUPABASE_SERVICE_KEY estÃ¡ configurado (Tiendas)"
          fi
      
      - name: ğŸ’¾ Ejecutar Backup de Tiendas
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "ğŸ” Verificando que el script existe..."
          if [ ! -f "scripts/backup-supabase.js" ]; then
            echo "âŒ Error: No se encontrÃ³ scripts/backup-supabase.js"
            exit 1
          fi
          
          echo "ğŸ“ Creando directorio backups/tiendas si no existe..."
          mkdir -p backups/tiendas
          
          echo "ğŸš€ Ejecutando backup de TIENDAS..."
          cd scripts
          node backup-supabase.js
          cd ..
          
          echo "âœ… Backup de Tiendas ejecutado, verificando archivos creados..."
          ls -la backups/tiendas/ || echo "âš ï¸ No se encontraron archivos en backups/tiendas/"
      
      - name: ğŸ“¤ Subir backups de Tiendas como artefacto
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: supabase-backup-tiendas-manual-${{ github.run_number }}
          path: |
            backups/tiendas/*.json
          retention-days: 90
          if-no-files-found: warn

  backup-comunidades:
    name: Backup Manual Cresalia-Comunidades
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ“š Instalar dependencias
        run: |
          echo "ğŸ“¦ Instalando dependencias de Supabase..."
          cd scripts
          if [ ! -f "package.json" ]; then
            echo "ğŸ“ Creando package.json..."
            echo '{"name":"backup-supabase-script","version":"1.0.0","private":true,"dependencies":{"@supabase/supabase-js":"^2.39.0"}}' > package.json
          fi
          echo "ğŸ“¥ Instalando @supabase/supabase-js..."
          npm install --no-save @supabase/supabase-js@^2.39.0
          cd ..
          echo "âœ… Dependencias instaladas"
      
      - name: ğŸ” Verificar secrets (debug)
        run: |
          if [ -z "${{ secrets.SUPABASE_URL_COMUNIDADES }}" ]; then
            echo "âŒ Error: SUPABASE_URL_COMUNIDADES secret no estÃ¡ configurado"
            echo "ğŸ’¡ Ve a Settings â†’ Secrets and variables â†’ Actions"
            echo "ğŸ’¡ Crea un secret con name: SUPABASE_URL_COMUNIDADES"
            exit 1
          else
            echo "âœ… SUPABASE_URL_COMUNIDADES estÃ¡ configurado"
          fi
          
          if [ -z "${{ secrets.SUPABASE_SERVICE_KEY_COMUNIDADES }}" ]; then
            echo "âŒ Error: SUPABASE_SERVICE_KEY_COMUNIDADES secret no estÃ¡ configurado"
            echo "ğŸ’¡ Ve a Settings â†’ Secrets and variables â†’ Actions"
            echo "ğŸ’¡ Crea un secret con name: SUPABASE_SERVICE_KEY_COMUNIDADES"
            exit 1
          else
            echo "âœ… SUPABASE_SERVICE_KEY_COMUNIDADES estÃ¡ configurado"
          fi
      
      - name: ğŸ’¾ Ejecutar Backup de Comunidades
        env:
          SUPABASE_URL_COMUNIDADES: ${{ secrets.SUPABASE_URL_COMUNIDADES }}
          SUPABASE_SERVICE_KEY_COMUNIDADES: ${{ secrets.SUPABASE_SERVICE_KEY_COMUNIDADES }}
        run: |
          echo "ğŸ” Verificando que el script existe..."
          if [ ! -f "scripts/backup-supabase-comunidades.js" ]; then
            echo "âŒ Error: No se encontrÃ³ scripts/backup-supabase-comunidades.js"
            exit 1
          fi
          
          echo "ğŸ“ Creando directorio backups/comunidades si no existe..."
          mkdir -p backups/comunidades
          
          echo "ğŸš€ Ejecutando backup de COMUNIDADES..."
          cd scripts
          node backup-supabase-comunidades.js
          cd ..
          
          echo "âœ… Backup de Comunidades ejecutado, verificando archivos creados..."
          ls -la backups/comunidades/ || echo "âš ï¸ No se encontraron archivos en backups/comunidades/"
      
      - name: ğŸ“¤ Subir backups de Comunidades como artefacto
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: supabase-backup-comunidades-manual-${{ github.run_number }}
          path: |
            backups/comunidades/*.json
          retention-days: 90
          if-no-files-found: warn

  notificar:
    name: Notificar resultado
    runs-on: ubuntu-latest
    needs: [backup-tiendas, backup-comunidades]
    if: always()
    
    steps:
      - name: âœ… Backup manual completado
        if: success()
        run: |
          echo "âœ… Ambos backups manuales completados exitosamente"
          echo "ğŸ“ Backups disponibles en la secciÃ³n 'Artifacts' de este workflow"
