name: Backup Diario de Supabase (Tiendas + Comunidades)

on:
  schedule:
    # Ejecutar diariamente a las 2:00 AM UTC (ajusta segÃºn tu zona horaria)
    # UTC-3 (Argentina): 2 AM UTC = 11 PM del dÃ­a anterior
    # Para cambiar hora, edita: cron: '0 2 * * *'
    # Formato: minuto hora dÃ­a mes dÃ­a-semana
    - cron: '0 2 * * *'
  
  # Permitir ejecuciÃ³n manual desde GitHub Actions
  workflow_dispatch:

jobs:
  backup-tiendas:
    name: Backup Cresalia-Tiendas
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ðŸ“š Instalar dependencias
        run: |
          echo "ðŸ“¦ Instalando dependencias de Supabase..."
          cd scripts
          if [ ! -f "package.json" ]; then
            echo "ðŸ“ Creando package.json..."
            cat > package.json << 'EOF'
{
  "name": "backup-supabase-script",
  "version": "1.0.0",
  "private": true,
  "dependencies": {
    "@supabase/supabase-js": "^2.39.0"
  }
}
EOF
          fi
          echo "ðŸ“¥ Instalando @supabase/supabase-js..."
          npm install --no-save @supabase/supabase-js@^2.39.0
          cd ..
          echo "âœ… Dependencias instaladas"
      
      - name: ðŸ” Verificar secrets (debug)
        run: |
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "âŒ Error: SUPABASE_URL secret no estÃ¡ configurado"
            echo "ðŸ’¡ Ve a Settings â†’ Secrets and variables â†’ Actions"
            echo "ðŸ’¡ Crea un secret con name: SUPABASE_URL (para Tiendas)"
            exit 1
          else
            echo "âœ… SUPABASE_URL estÃ¡ configurado (Tiendas)"
          fi
          
          if [ -z "${{ secrets.SUPABASE_SERVICE_KEY }}" ]; then
            echo "âŒ Error: SUPABASE_SERVICE_KEY secret no estÃ¡ configurado"
            echo "ðŸ’¡ Ve a Settings â†’ Secrets and variables â†’ Actions"
            echo "ðŸ’¡ Crea un secret con name: SUPABASE_SERVICE_KEY (para Tiendas)"
            exit 1
          else
            echo "âœ… SUPABASE_SERVICE_KEY estÃ¡ configurado (Tiendas)"
          fi
      
      - name: ðŸ’¾ Ejecutar Backup de Tiendas
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "ðŸ” Verificando que el script existe..."
          if [ ! -f "scripts/backup-supabase.js" ]; then
            echo "âŒ Error: No se encontrÃ³ scripts/backup-supabase.js"
            exit 1
          fi
          
          echo "ðŸ“ Creando directorio backups/tiendas si no existe..."
          mkdir -p backups/tiendas
          
          echo "ðŸš€ Ejecutando backup de TIENDAS..."
          cd scripts
          node backup-supabase.js
          cd ..
          
          echo "âœ… Backup de Tiendas ejecutado, verificando archivos creados..."
          ls -la backups/tiendas/ || echo "âš ï¸ No se encontraron archivos en backups/tiendas/"
      
      - name: ðŸ“¤ Subir backups de Tiendas como artefacto
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: supabase-backup-tiendas-${{ github.run_number }}
          path: |
            backups/tiendas/*.json
          retention-days: 30
          if-no-files-found: warn

  backup-comunidades:
    name: Backup Cresalia-Comunidades
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ðŸ“š Instalar dependencias
        run: |
          echo "ðŸ“¦ Instalando dependencias de Supabase..."
          cd scripts
          if [ ! -f "package.json" ]; then
            echo "ðŸ“ Creando package.json..."
            cat > package.json << 'EOF'
{
  "name": "backup-supabase-script",
  "version": "1.0.0",
  "private": true,
  "dependencies": {
    "@supabase/supabase-js": "^2.39.0"
  }
}
EOF
          fi
          echo "ðŸ“¥ Instalando @supabase/supabase-js..."
          npm install --no-save @supabase/supabase-js@^2.39.0
          cd ..
          echo "âœ… Dependencias instaladas"
      
      - name: ðŸ” Verificar secrets (debug)
        run: |
          if [ -z "${{ secrets.SUPABASE_URL_COMUNIDADES }}" ]; then
            echo "âŒ Error: SUPABASE_URL_COMUNIDADES secret no estÃ¡ configurado"
            echo "ðŸ’¡ Ve a Settings â†’ Secrets and variables â†’ Actions"
            echo "ðŸ’¡ Crea un secret con name: SUPABASE_URL_COMUNIDADES"
            exit 1
          else
            echo "âœ… SUPABASE_URL_COMUNIDADES estÃ¡ configurado"
          fi
          
          if [ -z "${{ secrets.SUPABASE_SERVICE_KEY_COMUNIDADES }}" ]; then
            echo "âŒ Error: SUPABASE_SERVICE_KEY_COMUNIDADES secret no estÃ¡ configurado"
            echo "ðŸ’¡ Ve a Settings â†’ Secrets and variables â†’ Actions"
            echo "ðŸ’¡ Crea un secret con name: SUPABASE_SERVICE_KEY_COMUNIDADES"
            exit 1
          else
            echo "âœ… SUPABASE_SERVICE_KEY_COMUNIDADES estÃ¡ configurado"
          fi
      
      - name: ðŸ’¾ Ejecutar Backup de Comunidades
        env:
          SUPABASE_URL_COMUNIDADES: ${{ secrets.SUPABASE_URL_COMUNIDADES }}
          SUPABASE_SERVICE_KEY_COMUNIDADES: ${{ secrets.SUPABASE_SERVICE_KEY_COMUNIDADES }}
        run: |
          echo "ðŸ” Verificando que el script existe..."
          if [ ! -f "scripts/backup-supabase-comunidades.js" ]; then
            echo "âŒ Error: No se encontrÃ³ scripts/backup-supabase-comunidades.js"
            exit 1
          fi
          
          echo "ðŸ“ Creando directorio backups/comunidades si no existe..."
          mkdir -p backups/comunidades
          
          echo "ðŸš€ Ejecutando backup de COMUNIDADES..."
          cd scripts
          node backup-supabase-comunidades.js
          cd ..
          
          echo "âœ… Backup de Comunidades ejecutado, verificando archivos creados..."
          ls -la backups/comunidades/ || echo "âš ï¸ No se encontraron archivos en backups/comunidades/"
      
      - name: ðŸ“¤ Subir backups de Comunidades como artefacto
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: supabase-backup-comunidades-${{ github.run_number }}
          path: |
            backups/comunidades/*.json
          retention-days: 30
          if-no-files-found: warn

  notificar:
    name: Notificar resultado
    runs-on: ubuntu-latest
    needs: [backup-tiendas, backup-comunidades]
    if: always()
    
    steps:
      - name: âœ… Notificar Ã©xito
        if: success()
        run: |
          echo "âœ… Ambos backups completados exitosamente"
          echo "ðŸ“ Backups disponibles en la secciÃ³n 'Artifacts' de este workflow"
      
      - name: âŒ Notificar error
        if: failure()
        run: |
          echo "âŒ ERROR: Uno o ambos backups fallaron"
          echo "Por favor, revisa los logs y verifica las credenciales en GitHub Secrets"
          exit 1
