name: Backup Diario de Supabase (Tiendas + Comunidades)

on:
  schedule:
    # Ejecutar diariamente a las 2:00 AM UTC (ajusta seg√∫n tu zona horaria)
    # UTC-3 (Argentina): 2 AM UTC = 11 PM del d√≠a anterior
    # Para cambiar hora, edita: cron: '0 2 * * *'
    # Formato: minuto hora d√≠a mes d√≠a-semana
    - cron: '0 2 * * *'
  
  # Permitir ejecuci√≥n manual desde GitHub Actions
  workflow_dispatch:

jobs:
  backup-tiendas:
    name: Backup Cresalia-Tiendas
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout del c√≥digo
        uses: actions/checkout@v4
      
      - name: üì¶ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: üìö Instalar dependencias
        run: |
          echo "üì¶ Instalando dependencias de Supabase..."
          cd scripts
          if [ ! -f "package.json" ]; then
            echo "üìù Creando package.json..."
            echo '{"name":"backup-supabase-script","version":"1.0.0","private":true,"dependencies":{"@supabase/supabase-js":"^2.39.0"}}' > package.json
          fi
          echo "üì• Instalando @supabase/supabase-js..."
          npm install --no-save @supabase/supabase-js@^2.39.0
          cd ..
          echo "‚úÖ Dependencias instaladas"
      
      - name: üîç Verificar secrets (debug)
        run: |
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "‚ùå Error: SUPABASE_URL secret no est√° configurado"
            echo "üí° Ve a Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "üí° Crea un secret con name: SUPABASE_URL (para Tiendas)"
            exit 1
          else
            echo "‚úÖ SUPABASE_URL est√° configurado (Tiendas)"
          fi
          
          if [ -z "${{ secrets.SUPABASE_SERVICE_KEY }}" ]; then
            echo "‚ùå Error: SUPABASE_SERVICE_KEY secret no est√° configurado"
            echo "üí° Ve a Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "üí° Crea un secret con name: SUPABASE_SERVICE_KEY (para Tiendas)"
            exit 1
          else
            echo "‚úÖ SUPABASE_SERVICE_KEY est√° configurado (Tiendas)"
          fi
      
      - name: üíæ Ejecutar Backup de Tiendas
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "üîç Verificando que el script existe..."
          if [ ! -f "scripts/backup-supabase.js" ]; then
            echo "‚ùå Error: No se encontr√≥ scripts/backup-supabase.js"
            exit 1
          fi
          
          echo "üìÅ Creando directorio backups/tiendas si no existe..."
          mkdir -p backups/tiendas
          
          echo "üöÄ Ejecutando backup de TIENDAS..."
          cd scripts
          node backup-supabase.js
          cd ..
          
          echo "‚úÖ Backup de Tiendas ejecutado, verificando archivos creados..."
          ls -la backups/tiendas/ || echo "‚ö†Ô∏è No se encontraron archivos en backups/tiendas/"
      
      - name: üì§ Subir backups de Tiendas como artefacto
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: supabase-backup-tiendas-${{ github.run_number }}
          path: |
            backups/tiendas/*.json
          retention-days: 30
          if-no-files-found: warn

  backup-comunidades:
    name: Backup Cresalia-Comunidades
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout del c√≥digo
        uses: actions/checkout@v4
      
      - name: üì¶ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: üìö Instalar dependencias
        run: |
          echo "üì¶ Instalando dependencias de Supabase..."
          cd scripts
          if [ ! -f "package.json" ]; then
            echo "üìù Creando package.json..."
            echo '{"name":"backup-supabase-script","version":"1.0.0","private":true,"dependencies":{"@supabase/supabase-js":"^2.39.0"}}' > package.json
          fi
          echo "üì• Instalando @supabase/supabase-js..."
          npm install --no-save @supabase/supabase-js@^2.39.0
          cd ..
          echo "‚úÖ Dependencias instaladas"
      
      - name: üîç Verificar secrets (debug)
        run: |
          if [ -z "${{ secrets.SUPABASE_URL_COMUNIDADES }}" ]; then
            echo "‚ùå Error: SUPABASE_URL_COMUNIDADES secret no est√° configurado"
            echo "üí° Ve a Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "üí° Crea un secret con name: SUPABASE_URL_COMUNIDADES"
            exit 1
          else
            echo "‚úÖ SUPABASE_URL_COMUNIDADES est√° configurado"
          fi
          
          if [ -z "${{ secrets.SUPABASE_SERVICE_KEY_COMUNIDADES }}" ]; then
            echo "‚ùå Error: SUPABASE_SERVICE_KEY_COMUNIDADES secret no est√° configurado"
            echo "üí° Ve a Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "üí° Crea un secret con name: SUPABASE_SERVICE_KEY_COMUNIDADES"
            exit 1
          else
            echo "‚úÖ SUPABASE_SERVICE_KEY_COMUNIDADES est√° configurado"
          fi
      
      - name: üíæ Ejecutar Backup de Comunidades
        env:
          SUPABASE_URL_COMUNIDADES: ${{ secrets.SUPABASE_URL_COMUNIDADES }}
          SUPABASE_SERVICE_KEY_COMUNIDADES: ${{ secrets.SUPABASE_SERVICE_KEY_COMUNIDADES }}
        run: |
          echo "üîç Verificando que el script existe..."
          if [ ! -f "scripts/backup-supabase-comunidades.js" ]; then
            echo "‚ùå Error: No se encontr√≥ scripts/backup-supabase-comunidades.js"
            exit 1
          fi
          
          echo "üìÅ Creando directorio backups/comunidades si no existe..."
          mkdir -p backups/comunidades
          
          echo "üöÄ Ejecutando backup de COMUNIDADES..."
          cd scripts
          node backup-supabase-comunidades.js
          cd ..
          
          echo "‚úÖ Backup de Comunidades ejecutado, verificando archivos creados..."
          ls -la backups/comunidades/ || echo "‚ö†Ô∏è No se encontraron archivos en backups/comunidades/"
      
      - name: üì§ Subir backups de Comunidades como artefacto
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: supabase-backup-comunidades-${{ github.run_number }}
          path: |
            backups/comunidades/*.json
          retention-days: 30
          if-no-files-found: warn

  notificar:
    name: Notificar resultado
    runs-on: ubuntu-latest
    needs: [backup-tiendas, backup-comunidades]
    if: always()
    
    steps:
      - name: üì• Checkout del c√≥digo
        uses: actions/checkout@v4
      
      - name: üì¶ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ‚úÖ Enviar notificaci√≥n de √©xito
        if: success()
        env:
          BREVO_API_KEY: ${{ secrets.BREVO_API_KEY }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL || 'cresalia25@gmail.com' }}
        run: |
          echo "üìß Enviando notificaci√≥n de √©xito..."
          node -e "
          const https = require('https');
          const data = JSON.stringify({
            to: process.env.ADMIN_EMAIL,
            to_name: 'Equipo Cresalia',
            subject: '‚úÖ Backup Diario Completado - Cresalia',
            html_content: \`
              <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;\">
                <h2 style=\"color: #10B981;\">‚úÖ Backup Diario Completado</h2>
                <p>Los backups de ambos proyectos se completaron exitosamente:</p>
                <ul>
                  <li>‚úÖ <strong>Cresalia-Tiendas</strong> - Backup completado</li>
                  <li>‚úÖ <strong>Cresalia-Comunidades</strong> - Backup completado</li>
                </ul>
                <p><strong>Fecha:</strong> $(date)</p>
                <p><strong>Workflow:</strong> <a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">Ver en GitHub Actions</a></p>
                <p>Los backups est√°n disponibles en la secci√≥n 'Artifacts' del workflow.</p>
              </div>
            \`
          });
          const options = {
            hostname: 'cresalia-web.vercel.app',
            port: 443,
            path: '/api/enviar-email-brevo',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': data.length
            }
          };
          const req = https.request(options, (res) => {
            console.log('Status:', res.statusCode);
            if (res.statusCode === 200) {
              console.log('‚úÖ Notificaci√≥n enviada exitosamente');
            }
          });
          req.on('error', (e) => {
            console.warn('‚ö†Ô∏è Error enviando notificaci√≥n:', e.message);
          });
          req.write(data);
          req.end();
          "
        continue-on-error: true
      
      - name: ‚ùå Enviar notificaci√≥n de error
        if: failure()
        env:
          BREVO_API_KEY: ${{ secrets.BREVO_API_KEY }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL || 'cresalia25@gmail.com' }}
        run: |
          echo "üìß Enviando notificaci√≥n de error..."
          node -e "
          const https = require('https');
          const data = JSON.stringify({
            to: process.env.ADMIN_EMAIL,
            to_name: 'Equipo Cresalia',
            subject: '‚ùå ERROR: Backup Diario Fall√≥ - Cresalia',
            html_content: \`
              <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;\">
                <h2 style=\"color: #DC2626;\">‚ùå Error en Backup Diario</h2>
                <p>Uno o ambos backups fallaron. Por favor, revisa los logs.</p>
                <p><strong>Fecha:</strong> $(date)</p>
                <p><strong>Workflow:</strong> <a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">Ver logs en GitHub Actions</a></p>
                <p><strong>Acci√≥n requerida:</strong> Revisa los logs y verifica las credenciales en GitHub Secrets.</p>
              </div>
            \`
          });
          const options = {
            hostname: 'cresalia-web.vercel.app',
            port: 443,
            path: '/api/enviar-email-brevo',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': data.length
            }
          };
          const req = https.request(options, (res) => {
            console.log('Status:', res.statusCode);
          });
          req.on('error', (e) => {
            console.warn('‚ö†Ô∏è Error enviando notificaci√≥n:', e.message);
          });
          req.write(data);
          req.end();
          "
        continue-on-error: true
      
      - name: ‚úÖ Mostrar mensaje de √©xito
        if: success()
        run: |
          echo "‚úÖ Ambos backups completados exitosamente"
          echo "üìÅ Backups disponibles en la secci√≥n 'Artifacts' de este workflow"
          echo "üìß Notificaci√≥n de √©xito enviada por email"
      
      - name: ‚ùå Mostrar mensaje de error
        if: failure()
        run: |
          echo "‚ùå ERROR: Uno o ambos backups fallaron"
          echo "Por favor, revisa los logs y verifica las credenciales en GitHub Secrets"
          echo "üìß Notificaci√≥n de error enviada por email"
