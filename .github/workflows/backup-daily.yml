name: Backup Diario de Supabase

on:
  schedule:
    # Ejecutar diariamente a las 2:00 AM UTC (ajusta segÃºn tu zona horaria)
    # UTC-3 (Argentina): 2 AM UTC = 11 PM del dÃ­a anterior
    # Para cambiar hora, edita: cron: '0 2 * * *'
    # Formato: minuto hora dÃ­a mes dÃ­a-semana
    - cron: '0 2 * * *'
  
  # Permitir ejecuciÃ³n manual desde GitHub Actions
  workflow_dispatch:
  
  # TambiÃ©n ejecutar en push a main (opcional, para testing)
  # Descomenta la siguiente lÃ­nea si quieres probarlo con cada push:
  # push:
  #   branches:
  #     - main

jobs:
  backup:
    name: Crear Backup de Supabase
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ðŸ“š Instalar dependencias
        run: |
          # Instalar desde la raÃ­z si existe package.json, sino crear uno en scripts
          if [ -f "package.json" ]; then
            echo "ðŸ“¦ Instalando dependencias desde package.json raÃ­z..."
            npm ci || npm install
          else
            echo "ðŸ“¦ Creando package.json en scripts..."
            cd scripts
            if [ ! -f "package.json" ]; then
              cat > package.json << 'EOF'
          {
            "name": "backup-supabase-script",
            "version": "1.0.0",
            "private": true,
            "dependencies": {
              "@supabase/supabase-js": "^2.39.0"
            }
          }
          EOF
            fi
            npm install
            cd ..
          fi
      
      - name: ðŸ” Verificar secrets (debug)
        run: |
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "âŒ Error: SUPABASE_URL secret no estÃ¡ configurado"
            echo "ðŸ’¡ Ve a Settings â†’ Secrets and variables â†’ Actions"
            echo "ðŸ’¡ Crea un secret con name: SUPABASE_URL"
            exit 1
          else
            echo "âœ… SUPABASE_URL estÃ¡ configurado"
          fi
          
          if [ -z "${{ secrets.SUPABASE_SERVICE_KEY }}" ]; then
            echo "âŒ Error: SUPABASE_SERVICE_KEY secret no estÃ¡ configurado"
            echo "ðŸ’¡ Ve a Settings â†’ Secrets and variables â†’ Actions"
            echo "ðŸ’¡ Crea un secret con name: SUPABASE_SERVICE_KEY"
            exit 1
          else
            echo "âœ… SUPABASE_SERVICE_KEY estÃ¡ configurado"
          fi
      
      - name: ðŸ’¾ Ejecutar Backup
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          if [ -f "scripts/backup-supabase.js" ]; then
            cd scripts
            node backup-supabase.js
          else
            echo "âŒ Error: No se encontrÃ³ scripts/backup-supabase.js"
            exit 1
          fi
      
      - name: ðŸ“¦ Comprimir backups
        if: success()
        run: |
          cd backups
          tar -czf ../backups-$(date +%Y%m%d-%H%M%S).tar.gz *.json
          cd ..
      
      - name: ðŸ“¤ Subir backups como artefacto
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: supabase-backup-${{ github.run_number }}
          path: |
            backups/*.json
            backups-*.tar.gz
          retention-days: 30
          if-no-files-found: warn
      
      - name: ðŸ“§ Notificar Ã©xito (opcional)
        if: success()
        run: |
          echo "âœ… Backup completado exitosamente"
          echo "ðŸ“ Backups disponibles en la secciÃ³n 'Artifacts' de este workflow"
      
      - name: âŒ Notificar error
        if: failure()
        run: |
          echo "âŒ ERROR: El backup fallÃ³"
          echo "Por favor, revisa los logs y verifica las credenciales en GitHub Secrets"
          exit 1

