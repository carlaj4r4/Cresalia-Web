<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Compradores</title>
    
    <!-- Meta Security - CSP actualizado para permitir todos los recursos necesarios -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: blob: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://conversations-widget.brevo.com https://*.supabase.co https://supabase.co; script-src-elem 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://conversations-widget.brevo.com https://*.supabase.co https://supabase.co; style-src 'self' 'unsafe-inline' https: https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://*.cloudflare.com https://ajax.cloudflare.com; style-src-elem 'self' 'unsafe-inline' https: https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://*.cloudflare.com https://ajax.cloudflare.com; font-src 'self' https: data: https://fonts.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; img-src 'self' data: https: blob:; connect-src 'self' https: https://conversations-widget.brevo.com https://api.brevo.com https://*.brevo.com https://*.supabase.co https://supabase.co wss://*.supabase.co; frame-src 'self' https: https://conversations-widget.brevo.com; object-src 'none'; base-uri 'self'; form-action 'self'; worker-src 'self' blob:; child-src 'self' blob:; media-src 'self' data: blob:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" href="assets/logo/logo-cresalia.png">
    <link rel="apple-touch-icon" href="assets/logo/logo-cresalia.png">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Estilos -->
    <link rel="stylesheet" href="/css/buyer-interface-improved.css">
    <link rel="stylesheet" href="/css/z-index-layers.css">
    <link rel="stylesheet" href="/css/elegant-notifications.css">
    <link rel="stylesheet" href="/css/animacion-fiestas.css">
    <link rel="stylesheet" href="/css/logo-navideno.css">
    
    <!-- Sistema de Interconexiones -->
    <script src="/js/sistema-interconexiones-global.js"></script>
    
    <!-- Sistema de Alertas de Emergencia -->
    <script src="/js/sistema-alertas-emergencia-global.js"></script>
    
    <!-- Sistema de Notificaciones Push para Compradores -->
    <script src="/js/sistema-notificaciones-push.js"></script>
    <script src="/js/configuracion-notificaciones-panel.js"></script>
    <script src="/js/configuracion-notificaciones-comprador.js"></script>
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .demo-header {
            background: linear-gradient(135deg, #7C3AED, #EC4899);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .demo-info {
            background: #F8FAFC;
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #E5E7EB;
        }
        
        .demo-nav {
            background: white;
            padding: 15px 0;
            border-bottom: 1px solid #E5E7EB;
            position: sticky;
        }
        
        .search-filters {
            background: #F8FAFC;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .filter-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-item label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }
        
        .filter-item input,
        .filter-item select {
            padding: 8px 12px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .stock-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .stock-disponible {
            background: #D1FAE5;
            color: #065F46;
        }
        
        .stock-bajo {
            background: #FEF3C7;
            color: #92400E;
        }
        
        .stock-agotado {
            background: #FEE2E2;
            color: #991B1B;
        }
        
        /* Bot칩n flotante para activar calculadora */
        .calculadora-toggle-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #7C3AED, #EC4899);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 10px 16px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.85rem;
            gap: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 996; /* Menor que los widgets */
        }
        
        .calculadora-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
        }
        
        .calculadora-toggle-btn i {
            font-size: 1rem;
        }
        
        /* Calculadora (oculta por defecto) */
        .calculadora-tiempo-real {
            position: fixed;
            bottom: 70px;
            left: 20px;
            background: white;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 997; /* Menor que los widgets para que no se superpongan */
            min-width: 200px;
            max-width: 220px;
            font-size: 0.8rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            display: none; /* Oculto por defecto */
        }
        
        .calculadora-tiempo-real.visible {
            display: block;
        }
        
        /* Contenido de la calculadora */
        .calculadora-contenido {
            display: block;
        }
        
        .calculadora-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .calculadora-tiempo-real h4 {
            margin: 0;
            color: #1F2937;
            font-size: 0.9rem;
            flex: 1;
        }
        
        .calculadora-btn-cerrar {
            background: transparent;
            border: none;
            color: #6B7280;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            font-weight: 600;
        }
        
        .calculadora-btn-cerrar:hover {
            background: #FEE2E2;
            color: #DC2626;
        }
        
        .calculadora-tiempo-real input {
            width: 100%;
            padding: 6px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 0.8rem;
            box-sizing: border-box;
        }
        
        .calculadora-tiempo-real .resultado {
            background: #F3F4F6;
            padding: 6px;
            border-radius: 6px;
            font-weight: 600;
            color: #1F2937;
            font-size: 0.85rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .calculadora-tiempo-real {
                bottom: 70px;
                left: 10px;
                right: auto;
                max-width: 200px;
                min-width: 180px;
                padding: 10px;
            }
            
            .calculadora-toggle-btn {
                padding: 8px 14px;
                font-size: 0.8rem;
            }
        }
        
        /* Ocultar notificaciones molestas */
        .notification, .alert, .toast, .popup {
            display: none !important;
        }
        
        /* Ocultar mensajes de media query */
        [class*="media-query"], [class*="responsive"], [class*="breakpoint"] {
            display: none !important;
        }
        
        .demo-nav ul {
            list-style: none;
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 0;
            padding: 0;
        }

        /* Estilos para servicios */
        .servicios-section {
            padding: 60px 0;
            background: #F8FAFC;
        }

        .servicios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .servicio-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .servicio-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            border-color: #7C3AED;
        }

        .servicio-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #7C3AED, #EC4899);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .servicio-icon i {
            font-size: 24px;
            color: white;
        }

        .servicio-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 10px;
        }

        .servicio-description {
            color: #6B7280;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .servicio-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .servicio-precio {
            font-size: 1.2rem;
            font-weight: 700;
            color: #10B981;
        }

        .servicio-duracion {
            background: #E5E7EB;
            color: #374151;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .servicio-actions .btn {
            width: 100%;
            background: linear-gradient(135deg, #7C3AED, #EC4899);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .servicio-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(124, 58, 237, 0.4);
        }
        
        .cumple-preferencias-section {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(14, 165, 233, 0.06));
            padding: 50px 0;
            border-bottom: 1px solid rgba(99, 102, 241, 0.12);
        }

        .cumple-preferencias-wrapper {
            max-width: 980px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 20px 55px rgba(15, 23, 42, 0.12);
            border: 1px solid rgba(79, 70, 229, 0.12);
        }

        .cumple-preferencias-header h2 {
            margin: 0;
            color: #5B21B6;
            font-size: 1.9rem;
        }

        .cumple-preferencias-header p {
            margin: 8px 0 0 0;
            color: #4338CA;
            font-size: 1rem;
        }

        .cumple-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }

        .cumple-form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .cumple-form-group label {
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
        }

        .cumple-form-group input,
        .cumple-form-group textarea {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background: #F9FAFB;
        }

        .cumple-form-group input:focus,
        .cumple-form-group textarea:focus {
            border-color: #7C3AED;
            box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.15);
            outline: none;
            background: white;
        }

        .cumple-switch-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(14, 165, 233, 0.08));
            border-radius: 14px;
            padding: 16px 20px;
            border: 1px solid rgba(79, 70, 229, 0.15);
            gap: 16px;
        }

        .cumple-switch-info h4 {
            margin: 0;
            color: #3730A3;
            font-size: 1.05rem;
        }

        .cumple-switch-info p {
            margin: 4px 0 0 0;
            color: #4338CA;
            font-size: 0.9rem;
        }

        .cumple-toggle {
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .cumple-toggle input[type="checkbox"] {
            width: 50px;
            height: 26px;
            border-radius: 999px;
            appearance: none;
            background: #CBD5F5;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .cumple-toggle input[type="checkbox"]::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.2);
            transition: transform 0.2s ease;
        }

        .cumple-toggle input[type="checkbox"]:checked {
            background: linear-gradient(135deg, #7C3AED, #0EA5E9);
        }

        .cumple-toggle input[type="checkbox"]:checked::after {
            transform: translateX(24px);
        }

        .cumple-toggle span {
            font-weight: 600;
            color: #312E81;
            font-size: 0.95rem;
        }

        .cumple-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 24px;
        }

        .cumple-actions button {
            border: none;
            border-radius: 12px;
            padding: 12px 22px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s;
        }

        .btn-guardar-cumple {
            background: linear-gradient(135deg, #7C3AED, #EC4899);
            color: white;
            box-shadow: 0 12px 25px rgba(236, 72, 153, 0.25);
        }

        .btn-ver-cumple {
            background: rgba(14, 165, 233, 0.1);
            color: #0E7490;
            border: 1px solid rgba(14, 165, 233, 0.25);
        }

        .btn-reset-cumple {
            background: rgba(244, 114, 182, 0.12);
            color: #BE185D;
            border: 1px solid rgba(236, 72, 153, 0.2);
        }

        .cumple-actions button:disabled {
            opacity: 0.6;
            cursor: default;
            transform: none !important;
            box-shadow: none !important;
        }

        .cumple-actions button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 14px 28px rgba(79, 70, 229, 0.2);
        }

        .cumple-status {
            margin-top: 18px;
            padding: 14px 18px;
            border-radius: 12px;
            font-size: 0.9rem;
            background: rgba(79, 70, 229, 0.08);
            color: #312E81;
            border: 1px solid rgba(79, 70, 229, 0.18);
            display: none;
        }

        .cumple-status.visible {
            display: block;
        }

        .cumple-status.success {
            background: rgba(16, 185, 129, 0.12);
            border-color: rgba(5, 150, 105, 0.25);
            color: #065F46;
        }

        .cumple-status.error {
            background: rgba(239, 68, 68, 0.12);
            border-color: rgba(239, 68, 68, 0.25);
            color: #991B1B;
        }

        .cumple-last-sync {
            margin-top: 12px;
            font-size: 0.85rem;
            color: #6B7280;
        }

        .cumple-info-extra {
            margin-top: 16px;
            padding: 14px 18px;
            background: rgba(224, 231, 255, 0.5);
            border-radius: 12px;
            color: #3730A3;
            font-size: 0.9rem;
        }

        .demo-nav a {
            color: #6B7280;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .demo-nav a:hover {
            color: #7C3AED;
        }
        
        /* =============================================== */
        /* RESPONSIVE M칍VIL - ARREGLO RESPONSIVE 游눞 */
        /* =============================================== */
        @media (max-width: 768px) {
            body {
                overflow-x: hidden;
            }
            
            /* Bot칩n "Ir al Inicio" responsive */
            .demo-nav ul li:first-child a {
                padding: 8px 12px !important;
                font-size: 0.85rem !important;
            }
            
            .demo-nav ul li:first-child a span {
                display: none; /* Ocultar texto en m칩vil, solo icono */
            }
            
            /* Widget de perfil responsive */
            .widget-perfil-usuario > div {
                flex-direction: column;
                text-align: center;
            }
            
            .widget-perfil-usuario > div > div:last-child {
                width: 100%;
                justify-content: center;
            }
            
            /* Bot칩n "Ir al Inicio" responsive */
            .demo-nav ul li:first-child a {
                padding: 8px 12px !important;
                font-size: 0.85rem !important;
            }
            
            .demo-nav ul li:first-child a span {
                display: none; /* Ocultar texto en m칩vil, solo icono */
            }
            
            /* Widget de perfil responsive */
            .widget-perfil-usuario > div {
                flex-direction: column;
                text-align: center;
            }
            
            .widget-perfil-usuario .avatar-container {
                margin: 0 auto 15px auto;
            }
            
            .widget-perfil-usuario #tipo-usuario-widget {
                display: block !important;
                font-size: 11px !important;
                margin-top: 6px !important;
                opacity: 0.9 !important;
            }
            
            .widget-perfil-usuario > div > div:last-child {
                width: 100%;
                justify-content: center;
                margin-top: 15px;
            }
            
            .widget-perfil-usuario > div > div:last-child button {
                flex: 1;
                min-width: 120px;
            }
            
            .demo-header {
                padding: 15px 10px;
            }
            
            .demo-header h1 {
                font-size: 1.5rem;
            }
            
            .demo-info {
                padding: 15px 10px;
            }
            
            .demo-nav ul {
                flex-wrap: wrap;
                gap: 15px;
                padding: 0 10px;
            }
            
            .demo-nav {
                padding: 10px 0;
            }
            
            /* Contenedor principal responsive */
            .container, .buyer-container {
                width: 100% !important;
                max-width: 100% !important;
                padding: 0 10px !important;
                margin: 0 !important;
                overflow-x: hidden !important;
            }
            
            /* Cards de productos responsive */
            .product-card, .store-card, .servicio-card {
                width: calc(50% - 10px) !important;
                margin: 5px !important;
                padding: 10px !important;
            }
            
            /* Grid responsive */
            .products-grid, .stores-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
                padding: 10px !important;
            }
            
            /* Secciones responsive */
            section {
                padding: 20px 10px !important;
                margin: 0 !important;
            }
            
            .cumple-preferencias-wrapper {
                padding: 24px 18px;
            }
            
            .cumple-form-grid {
                grid-template-columns: 1fr;
            }
            
            .cumple-switch-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .cumple-toggle {
                width: 100%;
                justify-content: space-between;
            }
            
            /* Botones responsive */
            .btn {
                padding: 8px 15px !important;
                font-size: 0.9rem !important;
            }
        }
        
        /* RESPONSIVE TABLET */
        @media (max-width: 1024px) and (min-width: 769px) {
            .widget-perfil-usuario {
                padding: 20px !important;
            }
            
            .widget-perfil-usuario #tipo-usuario-widget {
                display: block !important;
                font-size: 12px !important;
                margin-top: 6px !important;
            }
            
            .widget-perfil-usuario > div {
                gap: 15px !important;
            }
        }
        
        @media (max-width: 480px) {
            .demo-header h1 {
                font-size: 1.2rem;
            }
            
            .demo-nav ul {
                gap: 10px;
                font-size: 0.9rem;
            }
            
            .product-card, .store-card {
                width: 100% !important;
            }
            
            .products-grid, .stores-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* PROTEGER widgets de Mi Cuenta en m칩vil peque침o - mantener tama침o adecuado */
            #grid-mi-cuenta .producto-card {
                width: 100% !important;
                margin: 15px 0 !important;
            }
            
            /* Proteger contenido interno de los cards de Mi Cuenta en m칩vil peque침o */
            #grid-mi-cuenta .producto-card .producto-content {
                padding: 24px 20px !important;
            }
            
            #grid-mi-cuenta .producto-card .producto-image {
                height: 160px !important;
            }
            
            #grid-mi-cuenta .producto-card .producto-title {
                font-size: 18px !important;
                margin-bottom: 10px !important;
            }
            
            #grid-mi-cuenta .producto-card .producto-description {
                font-size: 13px !important;
                margin-bottom: 18px !important;
            }
            
            #grid-mi-cuenta.productos-grid {
                grid-template-columns: 1fr !important;
                gap: 18px !important;
                padding: 18px 12px !important;
            }
            
            /* Widget de perfil en m칩vil peque침o */
            .widget-perfil-usuario {
                padding: 18px !important;
            }
            
            .widget-perfil-usuario .avatar-container img {
                width: 60px !important;
                height: 60px !important;
            }
            
            .widget-perfil-usuario #nombre-usuario-widget {
                font-size: 20px !important;
            }
            
            .widget-perfil-usuario #email-usuario-widget {
                font-size: 13px !important;
            }
            
            .widget-perfil-usuario #tipo-usuario-widget {
                font-size: 10px !important;
                margin-top: 4px !important;
            }
            
            .widget-perfil-usuario > div > div:last-child button {
                padding: 8px 12px !important;
                font-size: 0.85rem !important;
            }
        }
            
            .cumple-preferencias-wrapper {
                padding: 20px 16px;
            }
            
            .cumple-preferencias-header h2 {
                font-size: 1.35rem;
            }
            
            .cumple-switch-row {
                padding: 14px 16px;
            }
        }
        
        /* =============================================== */
        /* ESTILOS CHATBOTS IA Y SOPORTE */
        /* =============================================== */
        
        /* Chatbot IA Container - MEJOR ESPACIADO */
        .ai-chatbot-container {
            position: fixed !important;
            bottom: 20px !important;
            right: 120px !important;
            z-index: 10000 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .ai-chatbot-toggle {
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
            border: none !important;
            border-radius: 50px !important;
            padding: 10px 16px !important;
            color: white !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3) !important;
            transition: all 0.3s ease !important;
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            font-size: 0.85rem !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .ai-chatbot-toggle:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4);
        }
        
        .ai-toggle-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ai-toggle-text {
            font-size: 14px;
        }
        
        /* Chatbot de Soporte Container */
        .chatbot-container {
            position: fixed !important;
            bottom: 20px !important;
            right: 20px !important;
            z-index: 10000 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .chatbot-toggle {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            border: none !important;
            border-radius: 50px !important;
            padding: 10px 16px !important;
            color: white !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3) !important;
            transition: all 0.3s ease !important;
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            font-size: 0.85rem !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* Asegurar que los contenedores siempre est칠n visibles */
        .ai-chatbot-container,
        .chatbot-container {
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
        }
        
        .chatbot-toggle:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.4);
        }
        
        .chatbot-toggle-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chatbot-toggle-text {
            font-size: 14px;
        }
        
        /* Widget de Soporte (CresaliaSupportWidget) */
        #cresalia-support-widget {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 9999;
        }
        
        .support-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7C3AED, #A78BFA);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4);
            transition: all 0.3s ease;
        }
        
        .support-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(124, 58, 237, 0.6);
        }
        
        .support-panel {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 420px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }
        
        /* Modales de Chatbot - MEJOR POSICIONADOS */
        .ai-chatbot-modal {
            position: fixed;
            bottom: 90px;
            right: 140px;
            width: 380px;
            height: 480px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            z-index: 10001;
            overflow: hidden;
        }
        
        .chatbot-modal {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 380px;
            height: 480px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            z-index: 10001;
            overflow: hidden;
        }
        
        /* Headers de Chatbot */
        .ai-chatbot-header, .chatbot-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chatbot-header {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .ai-header-content, .chatbot-header-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .ai-avatar, .chatbot-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .ai-header-info h3, .chatbot-header-info h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .ai-status, .chatbot-status {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .ai-chatbot-close, .chatbot-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s ease;
        }
        
        .ai-chatbot-close:hover, .chatbot-close:hover {
            background: rgba(255,255,255,0.2);
        }
        
        /* Messages */
        .ai-chatbot-messages, .chatbot-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .ai-message, .chat-message {
            max-width: 80%;
            animation: slideIn 0.3s ease;
        }
        
        .ai-message.ai-bot, .chat-message.bot {
            align-self: flex-start;
        }
        
        .ai-message.ai-user, .chat-message.user {
            align-self: flex-end;
        }
        
        .ai-message-content, .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            background: #f1f5f9;
            color: #333;
            line-height: 1.4;
        }
        
        .ai-message.ai-user .ai-message-content, .chat-message.user .message-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .ai-message-content p, .message-content p {
            margin: 0;
            font-size: 14px;
        }
        
        /* Suggestions & Quick Actions */
        .ai-suggestions, .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        
        .ai-suggestions button, .quick-actions button {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            color: #667eea;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ai-suggestions button:hover, .quick-actions button:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-1px);
        }
        
        /* Input */
        .ai-chatbot-input, .chatbot-input {
            padding: 15px 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        .input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .input-container input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        .input-container input:focus {
            border-color: #667eea;
        }
        
        .send-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        /* Responsive Chatbots - MEJORADO Y M츼S GRANDES EN M칍VIL */
        @media (max-width: 768px) {
            .ai-chatbot-modal {
                width: calc(100vw - 20px) !important;
                max-width: 95vw !important;
                height: calc(100vh - 100px) !important;
                max-height: 85vh !important;
                bottom: 100px !important;
                right: 10px !important;
                left: 10px !important;
            }
            
            .chatbot-modal {
                width: calc(100vw - 20px) !important;
                max-width: 95vw !important;
                height: calc(100vh - 100px) !important;
                max-height: 85vh !important;
                bottom: 100px !important;
                right: 10px !important;
                left: 10px !important;
            }
            
            .ai-chatbot-container {
                right: 80px;
                bottom: 15px;
            }
            
            .chatbot-container {
                right: 15px;
                bottom: 15px;
            }
            
            /* Botones toggle m치s grandes en m칩vil */
            .ai-chatbot-toggle, .chatbot-toggle {
                padding: 16px 24px !important;
                font-size: 16px !important;
                min-width: 180px !important;
                gap: 10px !important;
            }
            
            .ai-toggle-text, .chatbot-toggle-text {
                font-size: 16px !important;
                display: block !important;
            }
            
            /* Widget de soporte m치s grande */
            .support-toggle {
                width: 70px !important;
                height: 70px !important;
                font-size: 28px !important;
                bottom: 20px !important;
                right: 20px !important;
            }
            
            .support-panel {
                width: calc(100vw - 20px) !important;
                max-width: 95vw !important;
                height: calc(100vh - 100px) !important;
                max-height: 85vh !important;
                bottom: 100px !important;
                right: 10px !important;
                left: 10px !important;
            }
        }
        
        /* Para pantallas muy peque침as - A칔N M츼S GRANDES */
        @media (max-width: 480px) {
            .ai-chatbot-container {
                right: 70px;
                bottom: 10px;
            }
            
            .chatbot-container {
                right: 10px;
                bottom: 10px;
            }
            
            .ai-chatbot-toggle, .chatbot-toggle {
                padding: 18px 26px !important;
                font-size: 17px !important;
                min-width: 200px !important;
            }
            
            .ai-toggle-text, .chatbot-toggle-text {
                font-size: 17px !important;
            }
            
            .support-toggle {
                width: 75px !important;
                height: 75px !important;
                font-size: 30px !important;
            }
            
            .ai-chatbot-modal,
            .chatbot-modal,
            .support-panel {
                width: calc(100vw - 10px) !important;
                height: calc(100vh - 80px) !important;
                max-height: 90vh !important;
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="demo-header">
        <h1 id="titulo-panel-usuario"><i class="fas fa-shopping-cart"></i> Panel de Usuario</h1>
        <p>Explora, compra y gestiona tu cuenta en Cresalia</p>
    </div>
    
    <!-- Filtros de B칰squeda Inteligente (Ocultos por defecto) -->
    <div class="search-filters" style="display: none;" id="filtrosSeccion">
        <h3>游댌 B칰squeda Inteligente y Filtros</h3>
        <div class="filter-group">
            <div class="filter-item">
                <label>Buscar</label>
                <input type="text" id="busqueda" placeholder="Productos, servicios, tiendas..." onkeyup="filtrarResultados()">
            </div>
            <div class="filter-item">
                <label>Zona</label>
                <select id="zona" onchange="filtrarResultados()">
                    <option value="">Todas las zonas</option>
                    <option value="centro">Centro</option>
                    <option value="norte">Norte</option>
                    <option value="sur">Sur</option>
                    <option value="este">Este</option>
                    <option value="oeste">Oeste</option>
                </select>
            </div>
            <div class="filter-item">
                <label>Categor칤a</label>
                <select id="categoria" onchange="filtrarResultados()">
                    <option value="">Todas las categor칤as</option>
                    <option value="ropa">Ropa</option>
                    <option value="comida">Comida</option>
                    <option value="servicios">Servicios</option>
                    <option value="tecnologia">Tecnolog칤a</option>
                    <option value="hogar">Hogar</option>
                </select>
            </div>
            <div class="filter-item">
                <label>Precio M치ximo</label>
                <input type="number" id="precioMax" placeholder="$0" onchange="filtrarResultados()">
            </div>
            <div class="filter-item">
                <label>Stock</label>
                <select id="stock" onchange="filtrarResultados()">
                    <option value="">Todos</option>
                    <option value="disponible">Disponible</option>
                    <option value="bajo">Stock Bajo</option>
                </select>
            </div>
        </div>
    </div>

    <nav class="demo-nav">
        <ul>
            <li>
                <a href="index-cresalia.html" style="background: linear-gradient(135deg, #7C3AED, #EC4899); color: white; padding: 8px 16px; border-radius: 8px; font-weight: 600; transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <i class="fas fa-home"></i> Ir al Inicio
                </a>
            </li>
            <li><a href="#productos">Productos</a></li>
            <li><a href="panel-comunidad-compradores.html" target="_blank" style="color: #EC4899; font-weight: 600;">
                <i class="fas fa-users"></i> Comunidad
            </a></li>
            <li><a href="#" onclick="abrirFeedbackCompradores(); return false;" style="color: #10B981; font-weight: 600;">
                <i class="fas fa-comment-dots"></i> Feedback
            </a></li>
            <li><a href="#" onclick="mostrarHistorialCompras(); return false;" style="color: #8B5CF6; font-weight: 600;">
                <i class="fas fa-history"></i> Mis Compras
            </a></li>
            <li><a href="#" onclick="mostrarHistorialServicios(); return false;" style="color: #10B981; font-weight: 600;">
                <i class="fas fa-cogs"></i> Mis Servicios
            </a></li>
            <li><a href="#" onclick="mostrarPanelPuntos(); return false;" style="color: #F59E0B; font-weight: 600;">
                <i class="fas fa-star"></i> Mis Puntos
            </a></li>
            <li><a href="#" onclick="mostrarPanelAlertasStock(); return false;" style="color: #3B82F6; font-weight: 600;">
                <i class="fas fa-bell"></i> Alertas de Stock
            </a></li>
            <li><a href="#" onclick="mostrarPanelMetricas(); return false;" style="color: #8B5CF6; font-weight: 600;">
                <i class="fas fa-chart-bar"></i> Mis M칠tricas
            </a></li>
            <li><a href="#" onclick="SistemaComparadorProductos.mostrarPanelComparacion(); return false;" style="color: #3B82F6; font-weight: 600;">
                <i class="fas fa-balance-scale"></i> Comparar Productos 
                <span id="contador-comparador" style="background: #EF4444; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 5px; display: none;">0</span>
            </a></li>
            <li><a href="#" onclick="SistemaBusquedaMapaCompradores.mostrarPanelMapa(); return false;" style="color: #10B981; font-weight: 600;">
                <i class="fas fa-map-marked-alt"></i> Buscar por Mapa
            </a></li>
            <li><a href="#mi-cuenta" style="color: #2563EB; font-weight: 600;">
                <i class="fas fa-user-circle"></i> Mi Cuenta
            </a></li>
            <li><a href="#" onclick="abrirConfiguracionNotificacionesComprador(); return false;" style="color: #F59E0B; font-weight: 600;">
                <i class="fas fa-bell"></i> Notificaciones
            </a></li>
            <li><a href="#" onclick="toggleCart(); return false;">
                <i class="fas fa-shopping-cart"></i> Carrito
                <span id="navCartCount" style="background: #EF4444; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; margin-left: 5px;">0</span>
            </a></li>
            <li>
                <a href="#" onclick="cerrarSesionComprador(); return false;" style="color: #EF4444; font-weight: 600;">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesi칩n
                </a>
            </li>
        </ul>
    </nav>

    <!-- Mi Cuenta Section -->
    <section id="mi-cuenta" class="productos-section">
        <div class="container">
            <div class="section-header">
                <h2><i class="fas fa-user-circle"></i> Mi Cuenta</h2>
                <p>Accede a tu perfil, sesiones y preferencias.</p>
            </div>
            
            <!-- Widget de Perfil con Avatar -->
            <div id="widget-perfil-usuario" class="widget-perfil-usuario" style="background: linear-gradient(135deg, #7C3AED, #EC4899); border-radius: 16px; padding: 24px; margin-bottom: 24px; color: white; display: none;">
                <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                    <div class="avatar-container" style="position: relative;">
                        <img id="avatar-usuario" src="" alt="Avatar" style="width: 80px; height: 80px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.3); object-fit: cover; background: rgba(255,255,255,0.2); cursor: pointer;" onclick="document.getElementById('input-avatar').click()">
                        <label for="input-avatar" style="position: absolute; bottom: 0; right: 0; background: rgba(255,255,255,0.9); border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                            <i class="fas fa-camera" style="color: #7C3AED; font-size: 12px;"></i>
                        </label>
                        <input type="file" id="input-avatar" accept="image/*" style="display: none;" onchange="cambiarAvatar(event)">
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <h3 id="nombre-usuario-widget" style="margin: 0 0 8px 0; font-size: 24px; font-weight: 600;">Usuario</h3>
                        <p id="email-usuario-widget" style="margin: 0; opacity: 0.9; font-size: 14px;">email@ejemplo.com</p>
                        <p id="tipo-usuario-widget" style="margin: 4px 0 0 0; opacity: 0.8; font-size: 12px; display: none;"></p>
                    </div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button onclick="mostrarHistorialCompras()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            <i class="fas fa-shopping-bag"></i> Mis Compras
                        </button>
                        <button onclick="abrirConfiguracionNotificacionesComprador()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            <i class="fas fa-bell"></i> Notificaciones
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="productos-grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));" id="grid-mi-cuenta">
                <div class="producto-card" id="card-ingresar-registro" style="display: none;">
                    <div class="producto-image" style="background: linear-gradient(135deg, #2563EB, #7C3AED); color: white;">
                        <i class="fas fa-sign-in-alt fa-3x"></i>
                    </div>
                    <div class="producto-content">
                        <h3 class="producto-title">Ingresar / Registrarse</h3>
                        <p class="producto-description">Inicia sesi칩n o crea tu cuenta de comprador.</p>
                        <div class="producto-actions">
                            <a class="btn-add-cart" href="/login-comprador.html" style="width: 100%; text-align: center;">
                                <i class="fas fa-sign-in-alt"></i> Ir a Login
                            </a>
                        </div>
                    </div>
                </div>
                <div class="producto-card">
                    <div class="producto-image" style="background: linear-gradient(135deg, #3B82F6, #2563EB); color: white;">
                        <i class="fas fa-edit fa-3x"></i>
                    </div>
                    <div class="producto-content">
                        <h3 class="producto-title">Editar Mi Perfil</h3>
                        <p class="producto-description">Actualiza tu domicilio, celular, DNI y correo electr칩nico.</p>
                        <div class="producto-actions">
                            <button class="btn-view-store" onclick="abrirEditarPerfil()" style="width: 100%; text-align: center; border: none; cursor: pointer;">
                                <i class="fas fa-user-edit"></i> Editar Perfil
                            </button>
                        </div>
                    </div>
                </div>
                <div class="producto-card">
                    <div class="producto-image" style="background: linear-gradient(135deg, #10B981, #059669); color: white;">
                        <i class="fas fa-map-marker-alt fa-3x"></i>
                    </div>
                    <div class="producto-content">
                        <h3 class="producto-title">Mis Direcciones</h3>
                        <p class="producto-description">Gestiona tus direcciones de env칤o (Casa, Trabajo, etc.)</p>
                        <div class="producto-actions">
                            <button class="btn-view-store" onclick="if(typeof SistemaDireccionesMultiples !== 'undefined' && SistemaDireccionesMultiples.mostrarGestionDirecciones) { SistemaDireccionesMultiples.mostrarGestionDirecciones(); } else { alert('El sistema de direcciones se est치 cargando. Por favor, espera un momento y vuelve a intentar.'); }" style="width: 100%; text-align: center; border: none; cursor: pointer;">
                                <i class="fas fa-map-marked-alt"></i> Gestionar Direcciones
                            </button>
                        </div>
                    </div>
                </div>
                <div class="producto-card">
                    <div class="producto-image" style="background: linear-gradient(135deg, #10B981, #14B8A6); color: white;">
                        <i class="fas fa-user-cog fa-3x"></i>
                    </div>
                    <div class="producto-content">
                        <h3 class="producto-title">Preferencias</h3>
                        <p class="producto-description">Actualiza tus datos, notificaciones y preferencias.</p>
                        <div class="producto-actions">
                            <a class="btn-view-store" href="#preferencias-cumple" style="width: 100%; text-align: center;">
                                <i class="fas fa-birthday-cake"></i> Ver preferencias
                            </a>
                        </div>
                    </div>
                </div>
                <div class="producto-card">
                    <div class="producto-image" style="background: linear-gradient(135deg, #EC4899, #F472B6); color: white;">
                        <i class="fas fa-rocket fa-3x"></i>
                    </div>
                    <div class="producto-content">
                        <h3 class="producto-title">Acceso Directo a Comunidades</h3>
                        <p class="producto-description">Crea un acceso directo personalizado a tus comunidades favoritas.</p>
                        <div class="producto-actions">
                            <button class="btn-view-store" onclick="abrirWidgetComunidades()" style="width: 100%; text-align: center; border: none; cursor: pointer;">
                                <i class="fas fa-users"></i> Crear Acceso Directo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Secci칩n de Editar Perfil -->
    <section id="editar-perfil-section" class="productos-section" style="display: none;">
        <div class="container">
            <div class="section-header">
                <h2><i class="fas fa-user-edit"></i> Editar Mi Perfil</h2>
                <p>Actualiza tu informaci칩n personal y de contacto</p>
            </div>
            
            <div class="card" style="max-width: 800px; margin: 0 auto; padding: 30px;">
                <form id="form-editar-perfil" onsubmit="guardarPerfil(event)">
                    <!-- Correo Electr칩nico -->
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">
                            <i class="fas fa-envelope"></i> Correo Electr칩nico
                        </label>
                        <input type="email" id="perfil-email" readonly style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem; background: #F9FAFB; color: #6B7280;">
                        <small style="color: #6B7280; font-size: 14px; margin-top: 5px; display: block;">
                            El correo no se puede cambiar desde aqu칤. Contact치 a soporte si necesit치s modificarlo.
                        </small>
                    </div>

                    <!-- DNI (Opcional) -->
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">
                            <i class="fas fa-id-card"></i> DNI (Opcional)
                        </label>
                        <input type="text" id="perfil-dni" placeholder="12345678" maxlength="20" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem;">
                        <small style="color: #6B7280; font-size: 14px; margin-top: 5px; display: block;">
                            Solo se usa para facturaci칩n. Es opcional y se mantiene privado.
                        </small>
                    </div>

                    <!-- N칰mero de Celular -->
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">
                            <i class="fas fa-phone"></i> N칰mero de Celular <span style="color: #EF4444;">*</span>
                        </label>
                        <input type="tel" id="perfil-telefono" placeholder="+54 9 11 1234-5678" required style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem;">
                        <small style="color: #6B7280; font-size: 14px; margin-top: 5px; display: block;">
                            N칰mero de contacto principal (con c칩digo de pa칤s).
                        </small>
                    </div>

                    <!-- Domicilio -->
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 15px; font-weight: 600; color: #374151;">
                            <i class="fas fa-map-marker-alt"></i> Domicilio <span style="color: #EF4444;">*</span>
                        </label>
                        
                        <!-- Calle -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #4B5563;">Calle y n칰mero</label>
                            <input type="text" id="perfil-calle" placeholder="Av. Corrientes 1234" required style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem;">
                        </div>

                        <!-- Ciudad -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #4B5563;">Ciudad</label>
                            <input type="text" id="perfil-ciudad" placeholder="Ciudad Aut칩noma de Buenos Aires" required style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem;">
                        </div>

                        <!-- Provincia -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #4B5563;">Provincia</label>
                            <input type="text" id="perfil-provincia" placeholder="Buenos Aires" required style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem;">
                        </div>

                        <!-- C칩digo Postal -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #4B5563;">C칩digo Postal</label>
                            <input type="text" id="perfil-codigo-postal" placeholder="C1043AAX" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem;">
                        </div>
                    </div>

                    <!-- Botones de Acci칩n -->
                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="button" onclick="cerrarEditarPerfil()" style="flex: 1; background: #6B7280; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" style="flex: 1; background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                            <i class="fas fa-save"></i> Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>
    
    <!-- Secci칩n de Widget de Acceso Directo a Comunidades -->
    <section id="widget-comunidades-section" class="productos-section" style="display: none;">
        <div class="container">
            <div class="section-header">
                <h2><i class="fas fa-rocket"></i> Acceso Directo a Comunidades</h2>
                <p>Crea accesos directos personalizados a tus comunidades favoritas</p>
            </div>
            
            <div class="card" style="max-width: 900px; margin: 0 auto; padding: 30px;">
                <div style="background: linear-gradient(135deg, #ECFDF5, #D1FAE5); padding: 25px; border-radius: 15px; margin-bottom: 25px; border-left: 4px solid #10B981;">
                    <h3 style="color: #065F46; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-info-circle"></i> 쯈u칠 es esto?
                    </h3>
                    <p style="color: #047857; line-height: 1.6;">
                        Crea un acceso directo personalizado a cualquier <strong>comunidad de Cresalia</strong> con tu avatar. 
                        Ideal para acceder r치pidamente a tus comunidades favoritas desde cualquier dispositivo.
                    </p>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-weight: 600; color: #374151;">
                        <input type="checkbox" id="activar-widget-comunidad-comprador" style="width: 20px; height: 20px; cursor: pointer;">
                        <span>Activar Widget de Acceso Directo a Comunidades</span>
                    </label>
                    <p style="color: #6B7280; font-size: 14px; margin-left: 30px;">
                        Al activar, podr치s generar widgets personalizados para acceder r치pidamente a comunidades.
                    </p>
                </div>
                
                <div id="contenido-widget-comunidad-comprador" style="display: none;">
                    <!-- Selector de Comunidad -->
                    <div style="margin-bottom: 30px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #374151;">
                            <i class="fas fa-users"></i> Selecciona una Comunidad
                        </label>
                        <select id="select-comunidad-comprador" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;" onchange="generarWidgetComunidadComprador()">
                            <option value="">-- Selecciona una comunidad --</option>
                            <option value="mujeres-sobrevivientes|comunidades/mujeres-sobrevivientes/index.html|游눞 Mujeres Sobrevivientes">游눞 Mujeres Sobrevivientes</option>
                            <option value="hombres-sobrevivientes|comunidades/hombres-sobrevivientes/index.html|游눛 Hombres Sobrevivientes">游눛 Hombres Sobrevivientes</option>
                            <option value="lgbtq-experiencias|comunidades/lgbtq-experiencias/index.html|游낍勇꽳릛 LGBTQ+ Experiencias">游낍勇꽳릛 LGBTQ+ Experiencias</option>
                            <option value="inmigrantes-racializados|comunidades/inmigrantes-racializados/index.html|游깴 Inmigrantes y Racializados">游깴 Inmigrantes y Racializados</option>
                            <option value="adultos-mayores|comunidades/adultos-mayores/index.html|游놊 Adultos Mayores">游놊 Adultos Mayores</option>
                            <option value="discapacidad|comunidades/discapacidad/index.html|鮫 Discapacidad">鮫 Discapacidad</option>
                            <option value="enfermedades-cronicas|comunidades/enfermedades-cronicas/index.html|游눜 Enfermedades Cr칩nicas">游눜 Enfermedades Cr칩nicas</option>
                            <option value="cuidadores|comunidades/cuidadores/index.html|游 Cuidadores">游 Cuidadores</option>
                            <option value="madres-padres-solteros|comunidades/madres-padres-solteros/index.html|游녿꽳릠뽹꽳릠 Madres/Padres Solteros">游녿꽳릠뽹꽳릠 Madres/Padres Solteros</option>
                            <option value="maternidad|comunidades/maternidad/index.html|游뱜 Maternidad">游뱜 Maternidad</option>
                            <option value="duelo-perinatal|comunidades/duelo-perinatal/index.html|游눖 Duelo Perinatal">游눖 Duelo Perinatal</option>
                            <option value="anti-bullying|comunidades/anti-bullying/index.html|游띠勇 Anti-Bullying">游띠勇 Anti-Bullying</option>
                            <option value="estres-laboral|comunidades/estres-laboral/index.html|游눺 Estr칠s Laboral">游눺 Estr칠s Laboral</option>
                            <option value="estres|comunidades/estres/index.html|游땷 Estr칠s">游땷 Estr칠s</option>
                            <option value="desempleos|comunidades/desempleos/index.html|游늶 Desempleos">游늶 Desempleos</option>
                            <option value="libertad-emocional|comunidades/libertad-emocional/index.html|游붊 Libertad Emocional">游붊 Libertad Emocional</option>
                            <option value="libertad-economica|comunidades/libertad-economica/index.html|游눯 Libertad Econ칩mica">游눯 Libertad Econ칩mica</option>
                            <option value="sanando-abandonos|comunidades/sanando-abandonos/index.html|游눞 Sanando Abandonos">游눞 Sanando Abandonos</option>
                            <option value="injusticias-vividas|comunidades/injusticias-vividas/index.html|丘뒲잺 Injusticias Vividas">丘뒲잺 Injusticias Vividas</option>
                            <option value="espiritualidad-fe|comunidades/espiritualidad-fe/index.html|游똂 Espiritualidad y Fe">游똂 Espiritualidad y Fe</option>
                            <option value="medicos-enfermeros|comunidades/medicos-enfermeros/index.html|丘됊잺 M칠dicos y Enfermeros">丘됊잺 M칠dicos y Enfermeros</option>
                            <option value="bomberos|comunidades/bomberos/index.html|游 Bomberos">游 Bomberos</option>
                            <option value="veterinarios|comunidades/veterinarios/index.html|游 Veterinarios">游 Veterinarios</option>
                            <option value="transporte-publico|comunidades/transporte-publico/index.html|游뚧 Transporte P칰blico">游뚧 Transporte P칰blico</option>
                            <option value="alertas-servicios-publicos|comunidades/alertas-servicios-publicos/index.html|游뚿 Alertas Servicios P칰blicos">游뚿 Alertas Servicios P칰blicos</option>
                            <option value="gamers-videojuegos|comunidades/gamers-videojuegos/index.html|游꿡 Gamers y Videojuegos">游꿡 Gamers y Videojuegos</option>
                            <option value="otakus-anime-manga|comunidades/otakus-anime-manga/index.html|游꿃 Otakus, Anime y Manga">游꿃 Otakus, Anime y Manga</option>
                            <option value="caminando-juntos|comunidades/caminando-juntos/index.html|游녺 Caminando Juntos">游녺 Caminando Juntos</option>
                            <option value="viajeros|comunidades/viajeros/index.html|九걾잺 Viajeros">九걾잺 Viajeros</option>
                            <option value="desahogo-libre|comunidades/desahogo-libre/index.html|游눫 Desahogo Libre">游눫 Desahogo Libre</option>
                            <option value="experiencias-sobrenaturales|comunidades/experiencias-sobrenaturales/index.html|游놑 Experiencias Sobrenaturales">游놑 Experiencias Sobrenaturales</option>
                            <option value="panel-comunidad-vendedores|panel-comunidad-vendedores.html|游눺 Comunidad de Vendedores">游눺 Comunidad de Vendedores</option>
                            <option value="panel-comunidad-compradores|panel-comunidad-compradores.html|游 Comunidad de Compradores">游 Comunidad de Compradores</option>
                        </select>
                    </div>
                    
                    <!-- Preview del Widget Comunidad -->
                    <div id="preview-widget-comunidad-comprador-container" style="display: none;">
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #1F2937; margin-bottom: 20px;">游님 Vista Previa del Widget</h3>
                            <div id="preview-widget-comunidad-comprador" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); padding: 40px; border-radius: 20px; max-width: 400px; margin: 0 auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                                <div style="background: white; border-radius: 15px; padding: 30px; text-align: center;">
                                    <div style="width: 60px; height: 60px; margin: 0 auto 15px; background: linear-gradient(135deg, #7C3AED, #EC4899); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">
                                        游눞
                                    </div>
                                    <img id="preview-logo-usuario-comunidad" src="" alt="Logo" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid #E5E7EB; margin: 0 auto 15px; display: block;">
                                    <div id="preview-comunidad-badge-comprador" style="background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 8px 16px; border-radius: 20px; display: inline-block; margin-bottom: 15px; font-size: 14px; font-weight: 600;"></div>
                                    <h4 id="preview-nombre-comunidad-comprador" style="color: #1F2937; margin-bottom: 5px;">Comunidad</h4>
                                    <p style="color: #6B7280; margin-bottom: 20px; font-size: 14px;">Acceso Directo</p>
                                    <button style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 12px 25px; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%;">
                                        <i class="fas fa-users"></i> Acceder a la Comunidad
                                    </button>
                                    <p style="color: #9CA3AF; font-size: 11px; margin-top: 15px;">Powered by Cresalia</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- URL del Widget Comunidad -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #1F2937; margin-bottom: 15px;">游댕 URL de tu Widget</h3>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="url-widget-comunidad-comprador" readonly style="flex: 1; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 14px; background: #F9FAFB;">
                                <button onclick="copiarUrlWidgetComunidadComprador()" class="btn btn-success" style="white-space: nowrap; padding: 12px 20px; background: #10B981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-copy"></i> Copiar
                                </button>
                            </div>
                        </div>
                        
                        <!-- C칩digo HTML Embed Comunidad -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #1F2937; margin-bottom: 15px;">游늯 C칩digo HTML para Embed</h3>
                            <div style="background: #1F2937; color: #F9FAFB; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; overflow-x: auto; margin-bottom: 10px;">
                                <pre id="codigo-html-widget-comunidad-comprador" style="margin: 0; white-space: pre-wrap; word-wrap: break-word;"></pre>
                            </div>
                            <button onclick="copiarCodigoWidgetComunidadComprador()" class="btn btn-secondary" style="padding: 12px 20px; background: #6B7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-copy"></i> Copiar C칩digo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="cumple-preferencias-section" id="preferencias-cumple">
        <div class="cumple-preferencias-wrapper">
            <div class="cumple-preferencias-header">
                <h2>游꾹 Preferencias de cumplea침os</h2>
                <p>Eleg칤 si quer칠s aparecer en Cumplea침eros del Mes, recibir sorpresas y personalizar el mensaje que ver치 la comunidad.</p>
            </div>
            <form id="formCumplePreferencias" class="cumple-form">
                <div class="cumple-form-grid">
                    <div class="cumple-form-group">
                        <label for="preferenciasEmail">Email asociado a tu cuenta</label>
                        <input type="email" id="preferenciasEmail" name="email" placeholder="tu@email.com" required>
                        <small style="color:#6B7280;">Us치 el mismo correo con el que te registraste como comprador.</small>
                    </div>
                    <div class="cumple-form-group">
                        <label for="preferenciasFecha">Fecha de cumplea침os</label>
                        <input type="date" id="preferenciasFecha" name="fecha_nacimiento" max="9999-12-31">
                        <small style="color:#6B7280;">Solo se usa para calcular el d칤a exacto. Nunca se comparte p칰blicamente la fecha completa.</small>
                    </div>
                </div>

                <div class="cumple-switch-row">
                    <div class="cumple-switch-info">
                        <h4>Mostrar mi celebraci칩n en la portada</h4>
                        <p>Tu nombre o alias aparecer치 en la secci칩n p칰blica con tu mensaje personalizado.</p>
                    </div>
                    <label class="cumple-toggle">
                        <input type="checkbox" id="preferenciasPublico" name="acepta_publico">
                        <span>Quiero participar 游눞</span>
                    </label>
                </div>

                <div class="cumple-switch-row" style="margin-top: 16px;">
                    <div class="cumple-switch-info">
                        <h4>Recibir beneficio especial de cumplea침os</h4>
                        <p>Activ치 esta opci칩n para recibir descuentos o regalos sorpresa durante tu mes.</p>
                    </div>
                    <label class="cumple-toggle">
                        <input type="checkbox" id="preferenciasBeneficio" name="acepta_descuento">
                        <span>Activar beneficio</span>
                    </label>
                </div>

                <div class="cumple-form-group" style="margin-top: 24px;">
                    <label for="preferenciasMensaje">Mensaje para la comunidad (opcional)</label>
                    <textarea id="preferenciasMensaje" name="mensaje_publico" rows="3" maxlength="220" placeholder="쯈uer칠s dejar un mensaje que acompa침e tu saludo? Contale a la comunidad c칩mo quer칠s celebrar este a침o 游눞"></textarea>
                </div>

                <div class="cumple-actions">
                    <button type="button" class="btn-ver-cumple" data-action="load">
                        <i class="fas fa-sync-alt"></i> Ver mis preferencias
                    </button>
                    <button type="submit" class="btn-guardar-cumple">
                        <i class="fas fa-save"></i> Guardar preferencias
                    </button>
                    <button type="button" class="btn-reset-cumple" data-action="reset">
                        <i class="fas fa-undo"></i> Limpiar formulario
                    </button>
                </div>

                <div class="cumple-status" data-status></div>
                <div class="cumple-last-sync" data-last-sync></div>
                <div class="cumple-info-extra">
                    游눠 Pod칠s cambiar tu decisi칩n en cualquier momento. Si prefer칤s que no te contactemos, solo desactiva la opci칩n y autom치ticamente dejamos de mostrarte.
                </div>
            </form>
        </div>
    </section>

    <!-- Productos Section -->
    <section id="productos" class="productos-section">
        <div class="container">
            <div class="section-header">
                <h2><i class="fas fa-box"></i> Productos</h2>
                <p>No hay productos de prueba. Cuando conectes tu tienda, se mostrar치n aqu칤.</p>
            </div>
            
            <div class="productos-grid">
                <div class="producto-card" style="grid-column: 1 / -1; text-align: center; padding: 30px;">
                    <div class="producto-image" style="background: #EEF2FF; color: #6366F1;">
                        <i class="fas fa-box-open fa-3x"></i>
                    </div>
                    <div class="producto-content">
                        <h3 class="producto-title">Sin productos cargados</h3>
                        <p class="producto-description">Carga tu cat치logo real para verlo en esta secci칩n.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Secciones de servicios y tiendas ocultadas porque no hay datos reales -->

    <!-- Secciones de ofertas y combos ocultadas porque no hay datos reales -->

    <!-- Secci칩n: Historias con Coraz칩n Cresalia -->
    <section id="historias-corazon" class="historias-corazon-section" style="display: none; padding: 80px 0; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(236, 72, 153, 0.05));">
        <div class="container">
            <div class="section-header" style="text-align: center; margin-bottom: 40px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <img src="/assets/logo/logo-cresalia.png" alt="Cresalia" style="width: 80px; height: 80px; border-radius: 20px; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);">
                </div>
                <h2 style="color: #1e293b; margin-bottom: 10px;">
                    <i class="fas fa-heart" style="color: #ec4899;"></i> Historias con Coraz칩n Cresalia
                </h2>
                <p style="color: #64748b; font-size: 1.1rem;">Conoc칠 las historias de nuestros emprendedores que decidieron compartir su camino con nosotros</p>
            </div>
            
            <div id="historiasGrid" class="historias-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 30px; margin-top: 40px;">
                <!-- Las historias se cargar치n din치micamente -->
            </div>
            
            <div id="sinHistorias" class="sin-historias" style="display: none; text-align: center; padding: 60px 20px; color: #64748b;">
                <i class="fas fa-book-open" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.5;"></i>
                <h3 style="color: #475569; margin-bottom: 10px;">A칰n no hay historias compartidas</h3>
                <p style="font-size: 1.1rem;">Las historias de nuestros emprendedores aparecer치n aqu칤 cuando decidan compartirlas</p>
            </div>
        </div>
    </section>

    <!-- Carro flotante -->
    <div class="floating-cart" onclick="toggleCart()">
        <div class="floating-cart-content">
            <div class="floating-cart-icon">
                <i class="fas fa-shopping-cart"></i>
                <span class="floating-cart-count">0</span>
            </div>
            <div class="floating-cart-info">
                <span class="floating-cart-text">Carrito</span>
                <span class="floating-cart-total">$0.00</span>
            </div>
        </div>
    </div>

    <!-- Modal de Feedback para Compradores -->
    <div id="feedbackModalCompradores" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative;">
            <button onclick="cerrarFeedbackCompradores()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; color: #666; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
            
            <div style="text-align: center; margin-bottom: 30px;">
                <h3 style="color: #10B981; margin-bottom: 10px;">
                    <i class="fas fa-comment-dots"></i> Tu Opini칩n es Importante
                </h3>
                <p style="color: #666; margin: 0;">Ay칰danos a mejorar Cresalia con tus sugerencias y comentarios</p>
            </div>
            
            <form id="feedbackFormCompradores" onsubmit="enviarFeedbackCompradores(event)">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Tipo de Feedback:</label>
                    <select id="tipoFeedback" required style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem;">
                        <option value="">Selecciona el tipo de feedback</option>
                        <option value="sugerencia">游눠 Sugerencia de mejora</option>
                        <option value="problema">游냍 Reporte de problema</option>
                        <option value="elogio">救 Elogio/Reconocimiento</option>
                        <option value="nueva-funcionalidad">游 Solicitud de nueva funcionalidad</option>
                        <option value="experiencia-usuario">游녻 Experiencia de usuario</option>
                        <option value="otro">游닇 Otro</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Tu Nombre (opcional):</label>
                    <input type="text" id="nombreFeedback" placeholder="Tu nombre o alias" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Tu Email (opcional):</label>
                    <input type="email" id="emailFeedback" placeholder="tu@email.com" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Tu Mensaje:</label>
                    <textarea id="mensajeFeedback" required placeholder="Cu칠ntanos tu experiencia, sugerencias o comentarios..." style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem; min-height: 120px; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Calificaci칩n General:</label>
                    <div id="estrellas-feedback" style="display: flex; gap: 5px; justify-content: center; margin-bottom: 15px;">
                        <i class="fas fa-star" style="font-size: 2rem; color: #E5E7EB; cursor: pointer; transition: all 0.3s ease;" data-rating="1"></i>
                        <i class="fas fa-star" style="font-size: 2rem; color: #E5E7EB; cursor: pointer; transition: all 0.3s ease;" data-rating="2"></i>
                        <i class="fas fa-star" style="font-size: 2rem; color: #E5E7EB; cursor: pointer; transition: all 0.3s ease;" data-rating="3"></i>
                        <i class="fas fa-star" style="font-size: 2rem; color: #E5E7EB; cursor: pointer; transition: all 0.3s ease;" data-rating="4"></i>
                        <i class="fas fa-star" style="font-size: 2rem; color: #E5E7EB; cursor: pointer; transition: all 0.3s ease;" data-rating="5"></i>
                    </div>
                    <input type="hidden" id="rating-feedback" value="0">
                </div>
                
                <button type="submit" style="width: 100%; background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: 600; font-size: 1.1rem; cursor: pointer; transition: all 0.3s ease;">
                    <i class="fas fa-paper-plane"></i> Enviar Feedback
                </button>
            </form>
        </div>
    </div>

    <!-- Modal de Calificaci칩n de Tiendas -->
    <div id="calificacionModalTienda" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative;">
            <button onclick="cerrarCalificacionTienda()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; color: #666; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
            
            <div style="text-align: center; margin-bottom: 30px;">
                <h3 style="color: #F59E0B; margin-bottom: 10px;">
                    <i class="fas fa-star"></i> Calificar Tienda
                </h3>
                <p id="nombreTiendaCalificacion" style="color: #666; margin: 0; font-weight: 600; font-size: 1.1rem;"></p>
            </div>
            
            <form id="calificacionFormTienda" onsubmit="enviarCalificacionTienda(event)">
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 15px; font-weight: 600; color: #333; text-align: center;">Tu Calificaci칩n:</label>
                    <div id="estrellas-tienda" style="display: flex; gap: 8px; justify-content: center; margin-bottom: 15px;">
                        <i class="fas fa-star" style="font-size: 2.5rem; color: #E5E7EB; cursor: pointer; transition: all 0.3s ease;" data-rating="1"></i>
                        <i class="fas fa-star" style="font-size: 2.5rem; color: #E5E7EB; cursor: pointer; transition: all 0.3s ease;" data-rating="2"></i>
                        <i class="fas fa-star" style="font-size: 2.5rem; color: #E5E7EB; cursor: pointer; transition: all 0.3s ease;" data-rating="3"></i>
                        <i class="fas fa-star" style="font-size: 2.5rem; color: #E5E7EB; cursor: pointer; transition: all 0.3s ease;" data-rating="4"></i>
                        <i class="fas fa-star" style="font-size: 2.5rem; color: #E5E7EB; cursor: pointer; transition: all 0.3s ease;" data-rating="5"></i>
                    </div>
                    <input type="hidden" id="rating-tienda" value="0" required>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Tu Nombre (opcional):</label>
                    <input type="text" id="nombreCalificacion" placeholder="Tu nombre o alias" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Comentario (opcional):</label>
                    <textarea id="comentarioCalificacion" placeholder="Cu칠ntanos tu experiencia con esta tienda..." style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem; min-height: 100px; resize: vertical;"></textarea>
                </div>
                
                <button type="submit" style="width: 100%; background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: 600; font-size: 1.1rem; cursor: pointer; transition: all 0.3s ease;">
                    <i class="fas fa-star"></i> Enviar Calificaci칩n
                </button>
            </form>
        </div>
    </div>

    <!-- Bot칩n flotante para activar calculadora -->
    <button class="calculadora-toggle-btn" id="calculadoraToggleBtn" onclick="mostrarCalculadora()">
        <i class="fas fa-calculator"></i>
        <span>Calculadora</span>
    </button>
    
    <!-- Calculadora en Tiempo Real -->
    <div class="calculadora-tiempo-real" id="calculadora">
        <!-- Contenido de la calculadora -->
        <div class="calculadora-contenido">
            <div class="calculadora-header">
                <h4>游눯 Calculadora de Precios</h4>
                <button class="calculadora-btn-cerrar" onclick="ocultarCalculadora()" title="Cerrar">
                    칑
                </button>
            </div>
            <input type="number" id="precioBase" placeholder="Precio base" oninput="calcularPrecio()">
            <input type="number" id="cantidad" placeholder="Cantidad" oninput="calcularPrecio()">
            <input type="number" id="descuento" placeholder="Descuento %" oninput="calcularPrecio()">
            <div class="resultado" id="resultadoCalculadora">Total: $0</div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/js/elegant-notifications.js"></script>
    <script src="/js/historiales-sistema.js"></script>
    <script src="/js/sistema-direcciones-multiples.js"></script>
    
    <!-- Sistema de Seguridad -->
    <script src="/security-system.js?v=2.0"></script>
    <script src="/core/proteccion-devtools-avanzada.js?v=2.0"></script>
    <script src="/core/proteccion-datos-sensibles.js?v=1.0"></script>
    
    <script>
        // ===== CARRITO DE COMPRAS =====
        let carrito = [];
        let cartCount = 0;
        let cartTotal = 0;
        
        // Demo de notificaciones
        function demoAction(action) {
            if (window.elegantNotifications) {
                window.elegantNotifications.show(`游꿢 ${action}`, 'success');
            } else {
                alert(action);
            }
        }
        
        // Funci칩n para agregar al carrito
        function agregarAlCarrito(productoId) {
            console.log('丘멆잺 No hay cat치logo cargado. Conecta tu tienda para habilitar el carrito.');
            demoAction('Carga tus productos para habilitar el carrito');
        }
        
        // Funci칩n para actualizar carrito
        function actualizarCarrito() {
            cartCount = carrito.reduce((total, item) => total + item.cantidad, 0);
            cartTotal = carrito.reduce((total, item) => total + (item.precio * item.cantidad), 0);
            
            // Actualizar contador flotante
            const floatingCount = document.querySelector('.floating-cart-count');
            const floatingTotal = document.querySelector('.floating-cart-total');
            
            if (floatingCount) floatingCount.textContent = cartCount;
            if (floatingTotal) floatingTotal.textContent = `$${cartTotal.toFixed(2)}`;
            
            // Actualizar contador de navegaci칩n
            const navCartCount = document.getElementById('navCartCount');
            if (navCartCount) navCartCount.textContent = cartCount;
        }

        // Funci칩n para reservar servicios
        function reservarServicio(servicioId) {
            const servicios = [
                { id: 1, nombre: 'Corte de Cabello', precio: 25.00, duracion: '1 hora' },
                { id: 2, nombre: 'Transporte Local', precio: 15.00, duracion: '30 min' },
                { id: 3, nombre: 'Consultor칤a T칠cnica', precio: 50.00, duracion: '2 horas' },
                { id: 4, nombre: 'Dise침o Gr치fico', precio: 75.00, duracion: '1 d칤a' }
            ];
            
            const servicio = servicios.find(s => s.id === servicioId);
            if (servicio) {
                mostrarModalReservaServicio(servicio);
            }
        }

        // Funci칩n para mostrar modal de reserva de servicio
        function mostrarModalReservaServicio(servicio) {
            const modalHTML = `
                <div id="reservaServicioModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999999;">
                    <div style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h3 style="color: #333; font-size: 1.8rem; margin-bottom: 10px;">
                                <i class="fas fa-calendar-plus" style="color: #7C3AED;"></i> Reservar Servicio
                            </h3>
                            <p style="color: #666; font-size: 1rem;">Completa los datos para reservar tu turno</p>
                        </div>
                        
                        <div style="background: #F8FAFC; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                            <h4 style="margin: 0 0 10px 0; color: #333;">${servicio.nombre}</h4>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 1.2rem; font-weight: 700; color: #10B981;">$${servicio.precio}</span>
                                <span style="background: #E5E7EB; color: #374151; padding: 5px 12px; border-radius: 20px; font-size: 0.9rem;">${servicio.duracion}</span>
                            </div>
                        </div>
                        
                        <form id="formReservaServicio" style="display: grid; gap: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Nombre</label>
                                    <input type="text" id="nombreCliente" required style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem;" placeholder="Tu nombre">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Apellido</label>
                                    <input type="text" id="apellidoCliente" required style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem;" placeholder="Tu apellido">
                                </div>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Fecha de Cumplea침os</label>
                                <input type="date" id="cumpleanosCliente" required style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem;">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Tel칠fono</label>
                                <input type="tel" id="telefonoCliente" required style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem;" placeholder="Tu n칰mero de tel칠fono">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Email</label>
                                <input type="email" id="emailCliente" required style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem;" placeholder="tu@email.com">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Fecha Preferida</label>
                                <input type="date" id="fechaServicio" required style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem;">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Hora Preferida</label>
                                <select id="horaServicio" required style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem;">
                                    <option value="">Selecciona una hora</option>
                                    <option value="09:00">09:00 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="14:00">02:00 PM</option>
                                    <option value="15:00">03:00 PM</option>
                                    <option value="16:00">04:00 PM</option>
                                    <option value="17:00">05:00 PM</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Comentarios Adicionales</label>
                                <textarea id="comentariosServicio" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem; min-height: 80px;" placeholder="Alguna preferencia especial o comentario..."></textarea>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                                <button type="button" onclick="cerrarModalReservaServicio()" style="background: #6b7280; color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                                <button type="submit" style="background: linear-gradient(135deg, #7C3AED, #EC4899); color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                                    <i class="fas fa-calendar-check"></i> Confirmar Reserva
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Configurar fecha m칤nima (hoy)
            const fechaInput = document.getElementById('fechaServicio');
            const hoy = new Date().toISOString().split('T')[0];
            fechaInput.min = hoy;
            
            // Manejar env칤o del formulario
            document.getElementById('formReservaServicio').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const reserva = {
                    servicio: servicio.nombre,
                    precio: servicio.precio,
                    duracion: servicio.duracion,
                    cliente: {
                        nombre: document.getElementById('nombreCliente').value,
                        apellido: document.getElementById('apellidoCliente').value,
                        cumpleanos: document.getElementById('cumpleanosCliente').value,
                        telefono: document.getElementById('telefonoCliente').value,
                        email: document.getElementById('emailCliente').value
                    },
                    fecha: document.getElementById('fechaServicio').value,
                    hora: document.getElementById('horaServicio').value,
                    comentarios: document.getElementById('comentariosServicio').value,
                    estado: 'pendiente',
                    fechaReserva: new Date().toISOString()
                };
                
                // Guardar reserva en localStorage
                let reservas = JSON.parse(localStorage.getItem('reservasServicios') || '[]');
                reservas.push(reserva);
                localStorage.setItem('reservasServicios', JSON.stringify(reservas));
                
                // Mostrar confirmaci칩n
                alert(`九 춰Reserva confirmada!\n\nServicio: ${servicio.nombre}\nFecha: ${reserva.fecha}\nHora: ${reserva.hora}\n\nTe contactaremos pronto para confirmar los detalles.`);
                
                cerrarModalReservaServicio();
            });
        }

        // Funci칩n para cerrar modal de reserva
        function cerrarModalReservaServicio() {
            const modal = document.getElementById('reservaServicioModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Funci칩n para mostrar/ocultar modal del carrito
        function toggleCart() {
            const modal = document.getElementById('cartModal');
            if (modal) {
                // Si el modal existe, cerrarlo
                cerrarModalCarrito();
            } else {
                // Si no existe, mostrarlo
                mostrarModalCarrito();
            }
        }
        
        function mostrarModalCarrito() {
            // Siempre mostrar el modal, incluso si est치 vac칤o
            
            // Crear modal din치mico
            const modalHTML = `
                <div id="cartModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999;">
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: #7C3AED; margin: 0;">
                                <i class="fas fa-shopping-cart"></i> Mi Carrito
                            </h3>
                            <button onclick="cerrarModalCarrito()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6B7280;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div id="cartItems" style="margin-bottom: 20px;">
                            ${carrito.length === 0 ? `
                                <div style="text-align: center; padding: 40px; color: #6B7280;">
                                    <i class="fas fa-shopping-cart" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
                                    <h3 style="margin: 0 0 10px 0; color: #374151;">Tu carrito est치 vac칤o</h3>
                                    <p style="margin: 0;">춰Agrega algunos productos para comenzar!</p>
                                </div>
                            ` : `
                                ${carrito.map(item => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #E5E7EB; border-radius: 8px; margin-bottom: 10px;">
                                    <div>
                                        <h4 style="margin: 0; color: #374151;">${item.nombre}</h4>
                                        <p style="margin: 5px 0 0 0; color: #6B7280;">Cantidad: ${item.cantidad}</p>
                                    </div>
                                    <div style="text-align: right;">
                                        <p style="margin: 0; font-weight: 600; color: #7C3AED;">$${(item.precio * item.cantidad).toFixed(2)}</p>
                                        <button onclick="eliminarDelCarrito(${item.id})" style="background: #EF4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 5px;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="border-top: 2px solid #E5E7EB; padding-top: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h4 style="margin: 0; color: #374151;">Total:</h4>
                                <h4 style="margin: 0; color: #7C3AED;">$${cartTotal.toFixed(2)}</h4>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                ${carrito.length > 0 ? `
                                    <button onclick="vaciarCarrito()" style="flex: 1; background: #6B7280; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        <i class="fas fa-trash"></i> Vaciar Carrito
                                    </button>
                                    <button onclick="procederAlPago()" style="flex: 2; background: linear-gradient(135deg, #7C3AED, #EC4899); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        <i class="fas fa-credit-card"></i> Proceder al Pago
                                    </button>
                                ` : `
                                    <button onclick="cerrarModalCarrito()" style="flex: 1; background: linear-gradient(135deg, #7C3AED, #EC4899); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        <i class="fas fa-shopping-bag"></i> Ir a Productos
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal existente si hay uno
            const modalExistente = document.getElementById('cartModal');
            if (modalExistente) {
                modalExistente.remove();
            }
            
            // Agregar nuevo modal
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Inicializar campo de cup칩n si hay items en el carrito
            if (carrito.length > 0 && window.SistemaCupones) {
                setTimeout(() => {
                    const container = document.getElementById('campo-cupon-carrito');
                    if (container) {
                        window.SistemaCupones.mostrarCampoCupon('campo-cupon-carrito');
                    }
                }, 100);
            }
            
            // Inicializar campo de c칩digo de puntos
            if (carrito.length > 0 && window.SistemaPuntosComprador) {
                setTimeout(async () => {
                    const container = document.getElementById('campo-codigo-puntos-carrito');
                    if (container) {
                        await mostrarCampoCodigoPuntos('campo-codigo-puntos-carrito');
                    }
                }, 200);
            }

            // Agregar funcionalidad de cerrar al hacer click fuera del modal
            const modal = document.getElementById('cartModal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        cerrarModalCarrito();
                    }
                });
                
                // Agregar funcionalidad de cerrar con tecla Escape
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        cerrarModalCarrito();
                        document.removeEventListener('keydown', handleEscape);
                    }
                };
                document.addEventListener('keydown', handleEscape);
            }
        }
        
        // Funci칩n para cerrar modal
        function cerrarModalCarrito() {
            const modal = document.getElementById('cartModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Funci칩n para eliminar del carrito
        function eliminarDelCarrito(productoId) {
            carrito = carrito.filter(item => item.id !== productoId);
            actualizarCarrito();
            
            // Actualizar modal si est치 abierto
            const modal = document.getElementById('cartModal');
            if (modal) {
                if (carrito.length === 0) {
                    cerrarModalCarrito();
                    demoAction('Carrito vaciado');
                } else {
                    mostrarModalCarrito(); // Recargar modal
                }
            }
        }
        
        // Funci칩n para vaciar carrito
        function vaciarCarrito() {
            carrito = [];
            actualizarCarrito();
            cerrarModalCarrito();
            demoAction('Carrito vaciado completamente');
        }
        
        // Funci칩n para proceder al pago
        async function procederAlPago() {
            cerrarModalCarrito();
            demoAction(`Procesando pago de $${cartTotal.toFixed(2)}...`);

            // Simular proceso de pago
            setTimeout(async () => {
                // Crear objeto de compra para el agradecimiento
                const compra = {
                    cliente: 'Cliente de Cresalia',
                    items: carrito.map(item => ({
                        nombre: item.nombre,
                        precio: item.precio,
                        cantidad: item.cantidad
                    })),
                    total: cartTotal.toFixed(2),
                    fecha: new Date().toLocaleDateString('es-ES')
                };

                // Agregar puntos por compra (si el sistema est치 disponible)
                if (window.SistemaPuntosComprador && cartTotal > 0) {
                    try {
                        // Nota: En producci칩n, esto se har칤a despu칠s de confirmar el pago
                        // Por ahora simulamos que la compra se complet칩
                        console.log('游눯 Agregando puntos por compra...');
                        // await window.SistemaPuntosComprador.agregarPuntosPorCompra(compraId, cartTotal);
                    } catch (error) {
                        console.warn('No se pudieron agregar puntos:', error);
                    }
                }

                // Limpiar carrito
                carrito = [];
                actualizarCarrito();
                
                // Enviar agradecimiento por la compra
                enviarAgradecimientoDespuesCompra(compra);
                
                // Mostrar confirmaci칩n de entrega
                setTimeout(() => {
                    mostrarConfirmacionEntrega(compra);
                }, 1000);
                
                demoAction('춰Pago procesado exitosamente!');
            }, 2000);
        }

        // Funci칩n para mostrar confirmaci칩n de entrega
        function mostrarConfirmacionEntrega(compra) {
            const modalHTML = `
                <div id="confirmacionEntregaModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999999;">
                    <div style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h3 style="color: #333; font-size: 1.8rem; margin-bottom: 10px;">
                                <i class="fas fa-truck" style="color: #10B981;"></i> Confirmar Entrega
                            </h3>
                            <p style="color: #666; font-size: 1rem;">쯏a recibiste tu pedido?</p>
                        </div>
                        
                        <div style="background: #F8FAFC; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                            <h4 style="margin: 0 0 10px 0; color: #333;">Resumen de tu compra:</h4>
                            <p style="margin: 0; color: #666;">Total: $${compra.total}</p>
                            <p style="margin: 0; color: #666;">Fecha: ${compra.fecha}</p>
                        </div>
                        
                        <div style="display: grid; gap: 15px; margin-bottom: 25px;">
                            <button onclick="confirmarEntrega('recibido', ${JSON.stringify(compra).replace(/"/g, '&quot;')})" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                                <i class="fas fa-check"></i> S칤, ya recib칤 mi pedido
                            </button>
                            <button onclick="confirmarEntrega('pendiente', ${JSON.stringify(compra).replace(/"/g, '&quot;')})" style="background: linear-gradient(135deg, #F59E0B, #FBBF24); color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                                <i class="fas fa-clock"></i> A칰n no lo he recibido
                            </button>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="cerrarConfirmacionEntrega()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Funci칩n para confirmar entrega
        function confirmarEntrega(estado, compra) {
            const compraObj = JSON.parse(compra);
            
            // Guardar confirmaci칩n en localStorage
            let entregas = JSON.parse(localStorage.getItem('confirmacionesEntrega') || '[]');
            entregas.push({
                ...compraObj,
                estadoEntrega: estado,
                fechaConfirmacion: new Date().toISOString()
            });
            localStorage.setItem('confirmacionesEntrega', JSON.stringify(entregas));
            
            if (estado === 'recibido') {
                alert('九 춰Gracias por confirmar! 춰Esperamos que disfrutes tu compra!');
            } else {
                alert('낍 Entendido. Te contactaremos pronto para coordinar la entrega.');
            }
            
            cerrarConfirmacionEntrega();
        }

        // Funci칩n para cerrar modal de confirmaci칩n
        function cerrarConfirmacionEntrega() {
            const modal = document.getElementById('confirmacionEntregaModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Funci칩n auxiliar para ocultar secciones no relacionadas
        function ocultarSeccionesNoRelacionadas(seccionActiva) {
            const seccionesAOcultar = [
                'historias-corazon',
                'widget-comunidades-section',
                'editar-perfil-section'
            ];
            
            seccionesAOcultar.forEach(seccionId => {
                if (seccionId !== seccionActiva) {
                    const seccion = document.getElementById(seccionId);
                    if (seccion) {
                        seccion.style.display = 'none';
                    }
                }
            });
        }
        
        // Demo de navegaci칩n suave
        document.querySelectorAll('.demo-nav a').forEach(link => {
            link.addEventListener('click', function(e) {
                const href = this.getAttribute('href');
                
                if (href && href.startsWith('#')) {
                    e.preventDefault();
                    const targetId = href.substring(1); // Remover el #
                    const target = document.getElementById(targetId);
                    
                    if (target) {
                        // Ocultar todas las secciones no relacionadas
                        ocultarSeccionesNoRelacionadas(targetId);
                        
                        // Si es mi-cuenta, asegurarse de que se muestre correctamente
                        if (targetId === 'mi-cuenta') {
                            target.style.display = 'block';
                        }
                        
                        // Solo mostrar historias-corazon si el hash es expl칤citamente #historias-corazon o #compartidas
                        if (targetId === 'historias-corazon' || targetId === 'compartidas') {
                            target.style.display = 'block';
                        }
                        
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                        
                        // Actualizar el hash de la URL
                        window.location.hash = targetId;
                    }
                }
            });
        });
        
        // Manejar cambios de hash en la URL para evitar redirecciones incorrectas
        window.addEventListener('hashchange', function() {
            const hash = window.location.hash.substring(1);
            
            if (hash) {
                const target = document.getElementById(hash);
                
                if (target) {
                    // Ocultar todas las secciones no relacionadas
                    ocultarSeccionesNoRelacionadas(hash);
                    
                    // Si el hash es mi-cuenta, mostrar esa secci칩n
                    if (hash === 'mi-cuenta') {
                        target.style.display = 'block';
                    }
                    // Solo mostrar historias-corazon si el hash es expl칤citamente #historias-corazon o #compartidas
                    else if (hash === 'historias-corazon' || hash === 'compartidas') {
                        target.style.display = 'block';
                    }
                    // Para otras secciones, mostrar normalmente
                    else {
                        target.style.display = 'block';
                    }
                    
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            } else {
                // Si no hay hash, ocultar secciones especiales
                ocultarSeccionesNoRelacionadas('');
            }
        });
        
        // Al cargar la p치gina, verificar el hash inicial
        document.addEventListener('DOMContentLoaded', function() {
            const hash = window.location.hash.substring(1);
            
            // Si no hay hash o el hash no es historias-corazon/compartidas, ocultar historias
            if (hash !== 'historias-corazon' && hash !== 'compartidas') {
                const historiasSection = document.getElementById('historias-corazon');
                if (historiasSection) {
                    historiasSection.style.display = 'none';
                }
            }
            
            // Si el hash es mi-cuenta, asegurarse de que se muestre correctamente
            if (hash === 'mi-cuenta') {
                const target = document.getElementById('mi-cuenta');
                if (target) {
                    ocultarSeccionesNoRelacionadas('mi-cuenta');
                    target.style.display = 'block';
                }
            }
        });
        
        // ===== SISTEMA DE FEEDBACK PARA COMPRADORES =====
        
        // Inicializar sistema de estrellas para feedback
        document.addEventListener('DOMContentLoaded', function() {
            const estrellas = document.querySelectorAll('#estrellas-feedback i');
            
            estrellas.forEach((estrella, index) => {
                estrella.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    document.getElementById('rating-feedback').value = rating;
                    
                    // Actualizar visual de estrellas
                    estrellas.forEach((s, i) => {
                        if (i < rating) {
                            s.style.color = '#F59E0B';
                        } else {
                            s.style.color = '#E5E7EB';
                        }
                    });
                });
                
                estrella.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    estrellas.forEach((s, i) => {
                        if (i < rating) {
                            s.style.color = '#F59E0B';
                        } else {
                            s.style.color = '#E5E7EB';
                        }
                    });
                });
            });
            
            // Restaurar estrellas al salir del hover
            document.getElementById('estrellas-feedback').addEventListener('mouseleave', function() {
                const currentRating = parseInt(document.getElementById('rating-feedback').value);
                const estrellas = document.querySelectorAll('#estrellas-feedback i');
                
                estrellas.forEach((s, i) => {
                    if (i < currentRating) {
                        s.style.color = '#F59E0B';
                    } else {
                        s.style.color = '#E5E7EB';
                    }
                });
            });
        });
        
        // Funci칩n para abrir el modal de feedback
        function abrirFeedbackCompradores() {
            const modal = document.getElementById('feedbackModalCompradores');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        // Funci칩n para cerrar el modal de feedback
        function cerrarFeedbackCompradores() {
            const modal = document.getElementById('feedbackModalCompradores');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Limpiar formulario
            document.getElementById('feedbackFormCompradores').reset();
            document.getElementById('rating-feedback').value = '0';
            
            // Restaurar estrellas
            const estrellas = document.querySelectorAll('#estrellas-feedback i');
            estrellas.forEach(s => s.style.color = '#E5E7EB');
        }
        
        // Funci칩n para enviar feedback
        function enviarFeedbackCompradores(event) {
            event.preventDefault();
            
            const tipoFeedback = document.getElementById('tipoFeedback').value;
            const nombre = document.getElementById('nombreFeedback').value.trim();
            const email = document.getElementById('emailFeedback').value.trim();
            const mensaje = document.getElementById('mensajeFeedback').value.trim();
            const rating = parseInt(document.getElementById('rating-feedback').value);
            
            // Validaciones
            if (!tipoFeedback) {
                alert('丘멆잺 Por favor selecciona el tipo de feedback.');
                return;
            }
            
            if (!mensaje) {
                alert('丘멆잺 Por favor escribe tu mensaje.');
                return;
            }
            
            if (mensaje.length < 10) {
                alert('丘멆잺 El mensaje debe tener al menos 10 caracteres.');
                return;
            }
            
            // Crear objeto de feedback
            const feedback = {
                id: Date.now(),
                tipo: tipoFeedback,
                nombre: nombre || 'Comprador An칩nimo',
                email: email || '',
                mensaje: mensaje,
                rating: rating || 0,
                fecha: new Date().toLocaleDateString('es-ES'),
                hora: new Date().toLocaleTimeString('es-ES'),
                usuario: 'comprador'
            };
            
            // Guardar en localStorage
            let feedbacks = JSON.parse(localStorage.getItem('feedbacks_compradores') || '[]');
            feedbacks.push(feedback);
            localStorage.setItem('feedbacks_compradores', JSON.stringify(feedbacks));
            
            // Cerrar modal
            cerrarFeedbackCompradores();
            
            // Mostrar confirmaci칩n
            if (window.elegantNotifications) {
                window.elegantNotifications.show('九 춰Feedback enviado exitosamente! Gracias por ayudarnos a mejorar Cresalia.', 'success');
            } else {
                alert('九 춰Feedback enviado exitosamente! Gracias por ayudarnos a mejorar Cresalia.');
            }
            
            // Tambi칠n guardar en el sistema general de feedbacks (compatible con vendedores)
            let feedbacksGenerales = JSON.parse(localStorage.getItem('feedbacks_generales') || '[]');
            feedbacksGenerales.push(feedback);
            localStorage.setItem('feedbacks_generales', JSON.stringify(feedbacksGenerales));
        }
        
        // Cerrar modal al hacer click fuera
        document.getElementById('feedbackModalCompradores').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarFeedbackCompradores();
            }
        });
        
        // ===== SISTEMA DE CALIFICACI칍N DE TIENDAS =====
        
        // Variables globales para calificaci칩n
        let tiendaActualCalificacion = '';
        
        // Inicializar sistema de estrellas para calificaci칩n de tiendas
        document.addEventListener('DOMContentLoaded', function() {
            const estrellasTienda = document.querySelectorAll('#estrellas-tienda i');
            
            estrellasTienda.forEach((estrella, index) => {
                estrella.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    document.getElementById('rating-tienda').value = rating;
                    
                    // Actualizar visual de estrellas
                    estrellasTienda.forEach((s, i) => {
                        if (i < rating) {
                            s.style.color = '#F59E0B';
                        } else {
                            s.style.color = '#E5E7EB';
                        }
                    });
                });
                
                estrella.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    estrellasTienda.forEach((s, i) => {
                        if (i < rating) {
                            s.style.color = '#F59E0B';
                        } else {
                            s.style.color = '#E5E7EB';
                        }
                    });
                });
            });
            
            // Restaurar estrellas al salir del hover
            document.getElementById('estrellas-tienda').addEventListener('mouseleave', function() {
                const currentRating = parseInt(document.getElementById('rating-tienda').value);
                const estrellasTienda = document.querySelectorAll('#estrellas-tienda i');
                
                estrellasTienda.forEach((s, i) => {
                    if (i < currentRating) {
                        s.style.color = '#F59E0B';
                    } else {
                        s.style.color = '#E5E7EB';
                    }
                });
            });
        });
        
        // Funci칩n para abrir el modal de calificaci칩n de tienda
        function abrirCalificacionTienda(nombreTienda, tiendaId) {
            tiendaActualCalificacion = nombreTienda;
            document.getElementById('nombreTiendaCalificacion').textContent = nombreTienda;
            
            const modal = document.getElementById('calificacionModalTienda');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        // Funci칩n para cerrar el modal de calificaci칩n
        function cerrarCalificacionTienda() {
            const modal = document.getElementById('calificacionModalTienda');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Limpiar formulario
            document.getElementById('calificacionFormTienda').reset();
            document.getElementById('rating-tienda').value = '0';
            
            // Restaurar estrellas
            const estrellasTienda = document.querySelectorAll('#estrellas-tienda i');
            estrellasTienda.forEach(s => s.style.color = '#E5E7EB');
        }
        
        // Funci칩n para enviar calificaci칩n de tienda
        function enviarCalificacionTienda(event) {
            event.preventDefault();
            
            const rating = parseInt(document.getElementById('rating-tienda').value);
            const nombre = document.getElementById('nombreCalificacion').value.trim();
            const comentario = document.getElementById('comentarioCalificacion').value.trim();
            
            // Validaciones
            if (rating === 0) {
                alert('丘멆잺 Por favor selecciona una calificaci칩n con estrellas.');
                return;
            }
            
            // Crear objeto de calificaci칩n
            const calificacion = {
                id: Date.now(),
                tienda: tiendaActualCalificacion,
                rating: rating,
                nombre: nombre || 'Comprador An칩nimo',
                comentario: comentario || '',
                fecha: new Date().toLocaleDateString('es-ES'),
                hora: new Date().toLocaleTimeString('es-ES'),
                usuario: 'comprador'
            };
            
            // Guardar en localStorage
            let calificaciones = JSON.parse(localStorage.getItem('calificaciones_tiendas') || '[]');
            calificaciones.push(calificacion);
            localStorage.setItem('calificaciones_tiendas', JSON.stringify(calificaciones));
            
            // Cerrar modal
            cerrarCalificacionTienda();
            
            // Mostrar confirmaci칩n
            if (window.elegantNotifications) {
                window.elegantNotifications.show(`救 춰Calificaci칩n enviada! Gracias por calificar a ${tiendaActualCalificacion}.`, 'success');
            } else {
                alert(`救 춰Calificaci칩n enviada! Gracias por calificar a ${tiendaActualCalificacion}.`);
            }
        }
        
        // Cerrar modal de calificaci칩n al hacer click fuera
        document.getElementById('calificacionModalTienda').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarCalificacionTienda();
            }
        });
        
        // Demo de notificaci칩n inicial
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (window.elegantNotifications) {
                    window.elegantNotifications.show('游띐勇 Interfaz de compradores cargada correctamente', 'success');
                }
            }, 1000);
        });
        
        // Demo de scroll spy
        window.addEventListener('scroll', function() {
            const sections = document.querySelectorAll('section[id]');
            const navLinks = document.querySelectorAll('.demo-nav a');
            
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                const sectionHeight = section.clientHeight;
                if (scrollY >= (sectionTop - 200)) {
                    current = section.getAttribute('id');
                }
            });
            
            navLinks.forEach(link => {
                link.style.color = '#6B7280';
                if (link.getAttribute('href') === '#' + current) {
                    link.style.color = '#7C3AED';
                }
            });
        });
    </script>

    <!-- =============================================== -->
    <!-- CHATBOT IA Y SOPORTE - AGREGADO POR CRESALIA TEAM 游눞 -->
    <!-- =============================================== -->

    <!-- Chatbot IA -->
    <div class="ai-chatbot-container">
        <button class="ai-chatbot-toggle" onclick="toggleAIChatbot()">
            <div class="ai-toggle-content">
                <i class="fas fa-brain"></i>
                <span class="ai-toggle-text">Cresalia AI</span>
            </div>
        </button>
        
        <div class="ai-chatbot-modal" id="aiChatbotModal">
            <div class="ai-chatbot-header">
                <div class="ai-header-content">
                    <div class="ai-avatar">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="ai-header-info">
                        <h3>Cresalia AI</h3>
                        <span class="ai-status">Asistente Inteligente</span>
                    </div>
                </div>
                <button class="ai-chatbot-close" onclick="toggleAIChatbot()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="ai-chatbot-messages" id="aiChatbotMessages">
                <div class="ai-message ai-bot">
                    <div class="ai-message-content">
                        <p>춰Hola! 游녦 Soy tu asistente de Cresalia AI. 쮼n qu칠 puedo ayudarte hoy?</p>
                        <div class="ai-suggestions">
                            <button onclick="sendAIMessage('쮺칩mo funciona Cresalia?')">쮺칩mo funciona Cresalia?</button>
                            <button onclick="sendAIMessage('쯈u칠 productos tienen?')">쯈u칠 productos tienen?</button>
                            <button onclick="sendAIMessage('Ayuda con mi pedido')">Ayuda con mi pedido</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="ai-chatbot-input">
                <div class="input-container">
                    <input type="text" id="aiChatInput" placeholder="Escribe tu consulta..." onkeypress="handleAIChatKeyPress(event)">
                    <button onclick="sendAIMessage()" class="send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbot Cresalia (Servicio de Ayuda) -->
    <div class="chatbot-container">
        <button class="chatbot-toggle" onclick="toggleChatbot()">
            <div class="chatbot-toggle-content">
                <i class="fas fa-headset"></i>
                <span class="chatbot-toggle-text">Ayuda</span>
            </div>
        </button>
        
        <div class="chatbot-modal" id="chatbotModal">
            <div class="chatbot-header">
                <div class="chatbot-header-content">
                    <div class="chatbot-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="chatbot-header-info">
                        <h3>Soporte Cresalia</h3>
                        <span class="chatbot-status">En l칤nea</span>
                    </div>
                </div>
                <button class="chatbot-close" onclick="toggleChatbot()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="chatbot-messages" id="chatbotMessages">
                <div class="chat-message bot">
                    <div class="message-content">
                        <p>춰Hola! 游땕 Soy Crisla, tu asistente de soporte. 쮼n qu칠 puedo ayudarte?</p>
                        <div class="quick-actions">
                            <button onclick="sendMessage('Tengo un problema con mi pedido')">Problema con pedido</button>
                            <button onclick="sendMessage('쮺칩mo puedo contactar a una tienda?')">Contactar tienda</button>
                            <button onclick="sendMessage('Necesito ayuda con el pago')">Ayuda con pago</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chatbot-input">
                <div class="input-container">
                    <input type="text" id="chatInput" placeholder="Escribe tu mensaje..." onkeypress="handleChatKeyPress(event)">
                    <button onclick="sendMessage()" class="send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script de Soporte -->
    <script src="/js/crisla-support-integration.js"></script>
    <script src="/js/support-client.js"></script>

    <!-- Scripts de Chatbot -->
    <script>
        // ========================================
        // FUNCIONES DE CHATBOT IA Y SOPORTE
        // ========================================

        // Variables globales
        let aiChatbotOpen = false;
        let chatbotOpen = false;

        // Funci칩n para toggle Chatbot IA
        function toggleAIChatbot() {
            const modal = document.getElementById('aiChatbotModal');
            const button = document.querySelector('.ai-chatbot-toggle');
            
            aiChatbotOpen = !aiChatbotOpen;
            
            if (aiChatbotOpen) {
                modal.style.display = 'flex';
                button.style.transform = 'scale(0.9)';
                // Cerrar el otro chatbot si est치 abierto
                if (chatbotOpen) {
                    toggleChatbot();
                }
            } else {
                modal.style.display = 'none';
                button.style.transform = 'scale(1)';
            }
        }

        // Funci칩n para toggle Chatbot de Soporte
        function toggleChatbot() {
            const modal = document.getElementById('chatbotModal');
            const button = document.querySelector('.chatbot-toggle');
            
            chatbotOpen = !chatbotOpen;
            
            if (chatbotOpen) {
                modal.style.display = 'flex';
                button.style.transform = 'scale(0.9)';
                // Cerrar el otro chatbot si est치 abierto
                if (aiChatbotOpen) {
                    toggleAIChatbot();
                }
            } else {
                modal.style.display = 'none';
                button.style.transform = 'scale(1)';
            }
        }

        // Construir contexto simple desde la p치gina (productos/servicios visibles)
        function buildAIContext() {
            try {
                const parts = [];
                document.querySelectorAll('[data-product-name]').forEach(el => {
                    const name = el.getAttribute('data-product-name');
                    const desc = el.getAttribute('data-product-desc') || '';
                    const price = el.getAttribute('data-product-price') || '';
                    if (name) parts.push(`Producto: ${name} ${price ? 'Precio: ' + price : ''} ${desc ? 'Desc: ' + desc : ''}`);
                });
                // Si no hay data-attrs, tomar algunos textos de tarjetas gen칠ricas
                if (parts.length === 0) {
                    document.querySelectorAll('.product-card, .producto-card, .combo-card').forEach(el => {
                        const title = el.querySelector('h3, h4, .title, .producto-titulo')?.textContent?.trim() || '';
                        const desc = el.querySelector('p')?.textContent?.trim() || '';
                        if (title) parts.push(`Item: ${title}${desc ? ' - ' + desc : ''}`);
                    });
                }
                return parts.slice(0, 8).join(' | ');
            } catch (e) {
                return '';
            }
        }

        // Registrar builder de contexto en el cliente
        if (window.CresaliaSupport && typeof window.CresaliaSupport.setAIContextBuilder === 'function') {
            window.CresaliaSupport.setAIContextBuilder(buildAIContext);
        }

        // Funci칩n para enviar mensaje AI
        async function sendAIMessage(message = null) {
            const input = document.getElementById('aiChatInput');
            const messagesContainer = document.getElementById('aiChatbotMessages');
            
            const messageText = message || input.value.trim();
            if (!messageText) return;
            
            // Mensaje del usuario
            const userMessage = document.createElement('div');
            userMessage.className = 'ai-message ai-user';
            userMessage.innerHTML = `
                <div class="ai-message-content">
                    <p>${messageText}</p>
                </div>
            `;
            messagesContainer.appendChild(userMessage);
            
            // Limpiar input
            if (!message) input.value = '';
            
            // Llamar IA real (si plan lo permite) con fallback local
            try {
                const plan = window.CresaliaSupport?.getCurrentPlan() || 'free';
                const reply = await window.CresaliaSupport.enviarConsultaAI({
                    mensaje: messageText,
                    plan,
                    history: []
                });
                
                const botMessage = document.createElement('div');
                botMessage.className = 'ai-message ai-bot';
                botMessage.innerHTML = `
                    <div class="ai-message-content">
                        <p>${reply}</p>
                    </div>
                `;
                messagesContainer.appendChild(botMessage);
            } catch (error) {
                console.warn('丘멆잺 IA real no disponible, usando respuesta local:', error.message);
                const aiResponse = getAIResponse(messageText);
                const botMessage = document.createElement('div');
                botMessage.className = 'ai-message ai-bot';
                botMessage.innerHTML = `
                    <div class="ai-message-content">
                        <p>${aiResponse}</p>
                    </div>
                `;
                messagesContainer.appendChild(botMessage);
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Funci칩n para enviar mensaje de soporte
        async function sendMessage(message = null) {
            const input = document.getElementById('chatInput');
            const messagesContainer = document.getElementById('chatbotMessages');
            
            const messageText = message || input.value.trim();
            if (!messageText) return;
            
            // Mensaje del usuario
            const userMessage = document.createElement('div');
            userMessage.className = 'chat-message user';
            userMessage.innerHTML = `
                <div class="message-content">
                    <p>${messageText}</p>
                </div>
            `;
            messagesContainer.appendChild(userMessage);
            
            // Limpiar input
            if (!message) input.value = '';
            
            // Enviar ticket al backend (con fallback local)
            try {
                const plan = window.CresaliaSupport?.getCurrentPlan() || 'free';
                const email = (typeof localStorage !== 'undefined' && localStorage.getItem('userEmail')) || null;
                await window.CresaliaSupport.enviarTicketSoporte({
                    email,
                    nombre: null,
                    mensaje: messageText,
                    plan,
                    tipo: 'chatbot',
                    metadata: { origen: 'demo-buyer-interface' }
                });
                
                const botMessage = document.createElement('div');
                botMessage.className = 'chat-message bot';
                botMessage.innerHTML = `
                    <div class="message-content">
                        <p>춰Listo! Registr칠 tu consulta en soporte. Te responderemos pronto.</p>
                    </div>
                `;
                messagesContainer.appendChild(botMessage);
            } catch (error) {
                console.warn('丘멆잺 Soporte real no disponible, usando respuesta local:', error.message);
                const supportResponse = getSupportResponse(messageText);
                const botMessage = document.createElement('div');
                botMessage.className = 'chat-message bot';
                botMessage.innerHTML = `
                    <div class="message-content">
                        <p>${supportResponse}</p>
                    </div>
                `;
                messagesContainer.appendChild(botMessage);
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Respuestas del AI
        function getAIResponse(message) {
            const responses = {
                'c칩mo funciona': '游 Cresalia es una plataforma que conecta compradores con tiendas locales. Puedes explorar productos, comparar precios y comprar de forma segura.',
                'productos': '游띐勇 Tenemos productos y servicios: electr칩nicos, ropa, hogar, belleza, servicios profesionales y mucho m치s. 쮹uscas algo espec칤fico?',
                'pedido': '游닍 Puedo ayudarte con tu pedido. 쮺u치l es el n칰mero de tu pedido o qu칠 problema tienes?',
                'default': '游눠 Entiendo tu consulta. Para ayudarte mejor, 쯣odr칤as ser m치s espec칤fico? Tambi칠n puedes contactar con soporte para asistencia personalizada.'
            };
            
            const lowerMessage = message.toLowerCase();
            for (let key in responses) {
                if (lowerMessage.includes(key)) {
                    return responses[key];
                }
            }
            return responses.default;
        }

        // Respuestas del soporte
        function getSupportResponse(message) {
            const responses = {
                'pedido': '游닍 Para ayudarte con tu pedido, necesito el n칰mero de orden. Tambi칠n puedes revisar el estado en "Mis Pedidos".',
                'contactar': '游 Puedes contactar directamente con las tiendas desde su perfil, o escribir a soporte@cresalia.com',
                'pago': '游눱 Aceptamos tarjetas de cr칠dito/d칠bito, transferencias y pago en efectivo. 쯊ienes alg칰n problema espec칤fico?',
                'default': '游땕 Gracias por contactarnos. Un agente revisar치 tu consulta y te responder치 pronto. 쮿ay algo m치s en lo que pueda ayudarte?'
            };
            
            const lowerMessage = message.toLowerCase();
            for (let key in responses) {
                if (lowerMessage.includes(key)) {
                    return responses[key];
                }
            }
            return responses.default;
        }

        // Manejar Enter en inputs
        function handleAIChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendAIMessage();
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Cerrar chatbots al hacer clic fuera
        document.addEventListener('click', function(event) {
            const aiModal = document.getElementById('aiChatbotModal');
            const chatModal = document.getElementById('chatbotModal');
            const aiToggle = document.querySelector('.ai-chatbot-toggle');
            const chatToggle = document.querySelector('.chatbot-toggle');
            
            if (aiChatbotOpen && !aiModal.contains(event.target) && !aiToggle.contains(event.target)) {
                toggleAIChatbot();
            }
            
            if (chatbotOpen && !chatModal.contains(event.target) && !chatToggle.contains(event.target)) {
                toggleChatbot();
            }
        });

        console.log('九 Chatbots IA y Soporte cargados en demo-buyer-interface.html');
        
        // ===== SISTEMA DE AGRADECIMIENTO AUTOM츼TICO =====
        
        // Funci칩n para enviar agradecimiento por usar la plataforma
        function enviarAgradecimientoUsoPlataforma() {
            const ultimoAgradecimiento = localStorage.getItem('ultimoAgradecimientoUso');
            const ahora = new Date();
            const ultimoAgradecimientoFecha = ultimoAgradecimiento ? new Date(ultimoAgradecimiento) : null;
            
            // Verificar si ha pasado al menos 1 d칤a desde el 칰ltimo agradecimiento
            if (!ultimoAgradecimientoFecha || (ahora.getTime() - ultimoAgradecimientoFecha.getTime()) > 24 * 60 * 60 * 1000) {
                generarAgradecimientoUsoPlataforma();
                localStorage.setItem('ultimoAgradecimientoUso', ahora.toISOString());
            }
        }
        
        // Funci칩n para generar agradecimiento por usar la plataforma
        function generarAgradecimientoUsoPlataforma() {
            const agradecimientoUso = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gracias por usar Cresalia</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%); }
        .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #F59E0B, #FBBF24); color: white; padding: 30px; text-align: center; }
        .content { padding: 30px; }
        .highlight { background: #fef3c7; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #F59E0B; }
        .footer { background: #f8fafc; padding: 20px; text-align: center; color: #666; border-top: 1px solid #e5e7eb; }
        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0; }
        .stat-card { background: #fef3c7; padding: 15px; border-radius: 8px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>춰Gracias por usar Cresalia! 游띐勇</h1>
            <p style="margin: 0; font-size: 1.1rem;">Tu plataforma de compras de confianza</p>
        </div>
        
        <div class="content">
            <h2>춰Apreciamos tu confianza! 游눞</h2>
            
            <p>Gracias por elegir Cresalia para tus compras. Tu apoyo nos motiva a seguir mejorando y ofreciendo el mejor servicio.</p>
            
            <div class="highlight">
                <h3>游꿀 춰Nuevas Funcionalidades Disponibles!</h3>
                <ul>
                    <li>九 Sistema de transporte local</li>
                    <li>九 Calificaciones y opiniones</li>
                    <li>九 Ofertas especiales</li>
                    <li>九 Soporte 24/7</li>
                    <li>九 Compras seguras</li>
                    <li>九 Notas de agradecimiento personalizadas</li>
                </ul>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <h3 style="margin: 0; color: #F59E0B;">游낅</h3>
                    <p style="margin: 5px 0; color: #666;">Tiendas Locales</p>
                </div>
                <div class="stat-card">
                    <h3 style="margin: 0; color: #F59E0B;">游뚱</h3>
                    <p style="margin: 5px 0; color: #666;">Servicio de Transporte</p>
                </div>
            </div>
            
            <p>Tu satisfacci칩n es nuestra prioridad. Si tienes alguna sugerencia o necesitas ayuda, no dudes en contactarnos.</p>
            
            <div style="text-align: center; margin: 30px 0;">
                <p style="font-size: 1.2rem; color: #F59E0B; font-weight: bold;">
                    춰Gracias por hacer crecer Cresalia! 游
                </p>
            </div>
        </div>
        
        <div class="footer">
            <p><strong>El equipo de Cresalia</strong> te agradece por usar nuestra plataforma</p>
            <p style="font-size: 0.9rem; margin-top: 10px;">
                Esta nota fue generada autom치ticamente por Cresalia - Tu plataforma de confianza para el comercio digital
            </p>
            <p style="font-size: 0.8rem; color: #999; margin-top: 15px;">
                Fecha: ${new Date().toLocaleString('es-ES')}
            </p>
        </div>
    </div>
</body>
</html>
            `;
            
            // Crear y descargar el agradecimiento
            const blob = new Blob([agradecimientoUso], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `agradecimiento-uso-cresalia-${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('游닎 Agradecimiento por uso de plataforma generado');
        }
        
        // Funci칩n para enviar agradecimiento despu칠s de una compra
        function enviarAgradecimientoDespuesCompra(compra) {
            console.log('游닎 Enviando agradecimiento por compra realizada...');
            
            // Generar mensaje de agradecimiento personalizado
            const agradecimientoCompra = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>춰Gracias por tu compra en Cresalia!</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: linear-gradient(135deg, #7C3AED 0%, #EC4899 100%); }
        .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #7C3AED, #EC4899); color: white; padding: 30px; text-align: center; }
        .content { padding: 30px; }
        .footer { background: #F8FAFC; padding: 20px; text-align: center; color: #6B7280; }
        .btn { display: inline-block; background: linear-gradient(135deg, #7C3AED, #EC4899); color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; margin: 10px 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>춰Gracias por tu compra! 游꿀</h1>
            <p>Tu pedido ha sido procesado exitosamente</p>
        </div>
        <div class="content">
            <h2>Hola ${compra.cliente || 'Cliente'},</h2>
            <p>춰Muchas gracias por confiar en Cresalia! Tu compra ha sido procesada exitosamente.</p>
            
            <h3>游닍 Detalles de tu compra:</h3>
            <ul>
                ${compra.items ? compra.items.map(item => `<li>${item.nombre} - $${item.precio}</li>`).join('') : '<li>Productos varios</li>'}
            </ul>
            
            <p><strong>Total: $${compra.total || '0.00'}</strong></p>
            
            <h3>游늶 Pr칩ximos pasos:</h3>
            <p>1. Recibir치s una confirmaci칩n por email</p>
            <p>2. El vendedor se pondr치 en contacto contigo</p>
            <p>3. Coordinar치s la entrega o retiro</p>
            
            <div style="text-align: center; margin: 30px 0;">
                <a href="#" class="btn">Ver mis compras</a>
                <a href="#" class="btn">Contactar vendedor</a>
            </div>
            
            <p>춰Esperamos que disfrutes tu compra!</p>
            <p>El equipo de Cresalia 游눞</p>
        </div>
        <div class="footer">
            <p>춸 2024 Cresalia - Conectando emprendedores y compradores</p>
        </div>
    </div>
</body>
</html>`;
            
            // Crear y descargar el archivo
            const blob = new Blob([agradecimientoCompra], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `agradecimiento-compra-${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('游닎 Agradecimiento por compra enviado');
        }

        // ===== HISTORIAL DE SERVICIOS =====
        
        // Funci칩n para mostrar historial de servicios
        function mostrarHistorialServicios() {
            console.log('游댢 Mostrando historial de servicios...');
            
            // Cargar servicios del localStorage
            const serviciosReservados = JSON.parse(localStorage.getItem('reservasServicios') || '[]');
            
            const modalHTML = `
                <div id="historialServiciosModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999999;">
                    <div style="background: white; border-radius: 20px; padding: 40px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h3 style="color: #333; font-size: 1.8rem; margin-bottom: 10px;">
                                <i class="fas fa-cogs" style="color: #10B981;"></i> Mis Servicios
                            </h3>
                            <p style="color: #666; font-size: 1rem;">Historial de servicios reservados</p>
                        </div>
                        
                        <div id="listaServiciosHistorial" style="max-height: 400px; overflow-y: auto;">
                            ${serviciosReservados.length === 0 ? `
                                <div style="text-align: center; padding: 40px; color: #6B7280;">
                                    <i class="fas fa-cogs" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
                                    <h3 style="margin: 0 0 10px 0; color: #374151;">No tienes servicios reservados</h3>
                                    <p style="margin: 0;">춰Reserva tu primer servicio!</p>
                                </div>
                            ` : serviciosReservados.map((servicio, index) => `
                                <div style="border: 2px solid #E5E7EB; border-radius: 12px; padding: 20px; margin-bottom: 15px; background: #F8FAFC;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                        <div>
                                            <h4 style="margin: 0 0 5px 0; color: #333; font-size: 1.2rem;">${servicio.servicio}</h4>
                                            <p style="margin: 0; color: #6B7280; font-size: 0.9rem;">Cliente: ${servicio.cliente.nombre} ${servicio.cliente.apellido}</p>
                                        </div>
                                        <div style="text-align: right;">
                                            <span style="background: ${servicio.estado === 'pendiente' ? '#F59E0B' : '#10B981'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                                                ${servicio.estado === 'pendiente' ? 'Pendiente' : 'Confirmado'}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                        <div>
                                            <strong style="color: #374151;">Precio:</strong><br>
                                            <span style="color: #10B981; font-weight: 600;">$${servicio.precio}</span>
                                        </div>
                                        <div>
                                            <strong style="color: #374151;">Duraci칩n:</strong><br>
                                            <span style="color: #6B7280;">${servicio.duracion}</span>
                                        </div>
                                        <div>
                                            <strong style="color: #374151;">Fecha:</strong><br>
                                            <span style="color: #6B7280;">${servicio.fecha}</span>
                                        </div>
                                        <div>
                                            <strong style="color: #374151;">Hora:</strong><br>
                                            <span style="color: #6B7280;">${servicio.hora}</span>
                                        </div>
                                    </div>
                                    
                                    ${servicio.comentarios ? `
                                        <div style="background: white; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                                            <strong style="color: #374151;">Comentarios:</strong><br>
                                            <span style="color: #6B7280;">${servicio.comentarios}</span>
                                        </div>
                                    ` : ''}
                                    
                                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                        <button onclick="repetirServicio(${index})" style="background: linear-gradient(135deg, #7C3AED, #EC4899); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                            <i class="fas fa-redo"></i> Repetir
                                        </button>
                                        <button onclick="contactarVendedorServicio(${index})" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                            <i class="fas fa-phone"></i> Contactar
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="cerrarHistorialServicios()" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-times"></i> Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Funci칩n para repetir servicio
        function repetirServicio(servicioIndex) {
            const serviciosReservados = JSON.parse(localStorage.getItem('reservasServicios') || '[]');
            const servicio = serviciosReservados[servicioIndex];
            
            if (!servicio) {
                alert('仇 Servicio no encontrado');
                return;
            }
            
            // Mostrar modal de repetici칩n con opciones
            const modalHTML = `
                <div id="repetirServicioModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999999;">
                    <div style="background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h3 style="color: #333; font-size: 1.8rem; margin-bottom: 10px;">
                                <i class="fas fa-redo" style="color: #7C3AED;"></i> Repetir Servicio
                            </h3>
                            <p style="color: #666; font-size: 1rem;">쮻칩nde y cu치ndo quieres repetir este servicio?</p>
                        </div>
                        
                        <div style="background: #F8FAFC; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                            <h4 style="margin: 0 0 10px 0; color: #333;">${servicio.servicio}</h4>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 1.2rem; font-weight: 700; color: #10B981;">$${servicio.precio}</span>
                                <span style="background: #E5E7EB; color: #374151; padding: 5px 12px; border-radius: 20px; font-size: 0.9rem;">${servicio.duracion}</span>
                            </div>
                        </div>
                        
                        <form id="formRepetirServicio" style="display: grid; gap: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Lugar Preferido</label>
                                <select id="lugarRepetir" required style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem;">
                                    <option value="">Selecciona un lugar</option>
                                    <option value="mismo-lugar">Mismo lugar que la vez anterior</option>
                                    <option value="domicilio">A domicilio</option>
                                    <option value="oficina-centro">Oficina Centro</option>
                                    <option value="oficina-norte">Oficina Norte</option>
                                    <option value="oficina-sur">Oficina Sur</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Fecha Preferida</label>
                                <input type="date" id="fechaRepetir" required style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem;">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Hora Preferida</label>
                                <select id="horaRepetir" required style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem;">
                                    <option value="">Selecciona una hora</option>
                                    <option value="09:00">09:00 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="14:00">02:00 PM</option>
                                    <option value="15:00">03:00 PM</option>
                                    <option value="16:00">04:00 PM</option>
                                    <option value="17:00">05:00 PM</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Comentarios Adicionales</label>
                                <textarea id="comentariosRepetir" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem; min-height: 80px;" placeholder="Alguna preferencia especial para esta repetici칩n..."></textarea>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                                <button type="button" onclick="cerrarRepetirServicio()" style="background: #6b7280; color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                                <button type="submit" style="background: linear-gradient(135deg, #7C3AED, #EC4899); color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                                    <i class="fas fa-calendar-check"></i> Confirmar Repetici칩n
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Configurar fecha m칤nima (hoy)
            const fechaInput = document.getElementById('fechaRepetir');
            const hoy = new Date().toISOString().split('T')[0];
            fechaInput.min = hoy;
            
            // Manejar env칤o del formulario
            document.getElementById('formRepetirServicio').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const nuevaReserva = {
                    ...servicio,
                    fecha: document.getElementById('fechaRepetir').value,
                    hora: document.getElementById('horaRepetir').value,
                    lugar: document.getElementById('lugarRepetir').value,
                    comentarios: document.getElementById('comentariosRepetir').value,
                    esRepeticion: true,
                    servicioOriginal: servicio.servicio,
                    fechaReserva: new Date().toISOString()
                };
                
                // Guardar nueva reserva
                let reservas = JSON.parse(localStorage.getItem('reservasServicios') || '[]');
                reservas.push(nuevaReserva);
                localStorage.setItem('reservasServicios', JSON.stringify(reservas));
                
                // Mostrar confirmaci칩n
                alert(`九 춰Repetici칩n confirmada!\n\nServicio: ${servicio.servicio}\nLugar: ${nuevaReserva.lugar}\nFecha: ${nuevaReserva.fecha}\nHora: ${nuevaReserva.hora}\n\nTe contactaremos pronto para confirmar los detalles.`);
                
                cerrarRepetirServicio();
                cerrarHistorialServicios();
                
                // Recargar historial
                setTimeout(() => mostrarHistorialServicios(), 500);
            });
        }

        // Funci칩n para contactar vendedor del servicio
        function contactarVendedorServicio(servicioIndex) {
            const serviciosReservados = JSON.parse(localStorage.getItem('reservasServicios') || '[]');
            const servicio = serviciosReservados[servicioIndex];
            
            if (!servicio) {
                alert('仇 Servicio no encontrado');
                return;
            }
            
            alert(`游 Contactando vendedor para:\n\nServicio: ${servicio.servicio}\nFecha: ${servicio.fecha}\nHora: ${servicio.hora}\n\nSe abrir치 WhatsApp o se enviar치 un email al vendedor.`);
        }

        // Funci칩n para cerrar modal de historial de servicios
        function cerrarHistorialServicios() {
            const modal = document.getElementById('historialServiciosModal');
            if (modal) {
                modal.remove();
            }
        }

        // Funci칩n para cerrar modal de repetir servicio
        function cerrarRepetirServicio() {
            const modal = document.getElementById('repetirServicioModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // ===== FUNCIONES DE B칔SQUEDA Y FILTROS =====
        function filtrarResultados() {
            const busqueda = document.getElementById('busqueda').value.toLowerCase();
            const zona = document.getElementById('zona').value;
            const categoria = document.getElementById('categoria').value;
            const precioMax = parseFloat(document.getElementById('precioMax').value) || Infinity;
            const stock = document.getElementById('stock').value;
            
            console.log('游댌 Filtrando resultados:', { busqueda, zona, categoria, precioMax, stock });
            
            // Aqu칤 se implementar칤a la l칩gica de filtrado
            // Por ahora solo mostramos en consola
        }
        
        // ===== CALCULADORA EN TIEMPO REAL =====
        function calcularPrecio() {
            const precioBase = parseFloat(document.getElementById('precioBase').value) || 0;
            const cantidad = parseFloat(document.getElementById('cantidad').value) || 1;
            const descuento = parseFloat(document.getElementById('descuento').value) || 0;
            
            const subtotal = precioBase * cantidad;
            const descuentoMonto = subtotal * (descuento / 100);
            const total = subtotal - descuentoMonto;
            
            document.getElementById('resultadoCalculadora').textContent = `Total: $${total.toFixed(2)}`;
        }
        
        // ===== CALCULADORA - Mostrar/Ocultar =====
        function mostrarCalculadora() {
            const calculadora = document.getElementById('calculadora');
            const toggleBtn = document.getElementById('calculadoraToggleBtn');
            
            if (calculadora) {
                calculadora.classList.add('visible');
                if (toggleBtn) {
                    toggleBtn.style.display = 'none'; // Ocultar bot칩n cuando la calculadora est치 visible
                }
                localStorage.setItem('calculadora-visible', 'true');
                console.log('九 Calculadora mostrada');
            }
        }
        
        function ocultarCalculadora() {
            const calculadora = document.getElementById('calculadora');
            const toggleBtn = document.getElementById('calculadoraToggleBtn');
            
            if (calculadora) {
                calculadora.classList.remove('visible');
                if (toggleBtn) {
                    toggleBtn.style.display = 'flex'; // Mostrar bot칩n cuando la calculadora est치 oculta
                }
                localStorage.setItem('calculadora-visible', 'false');
                console.log('九 Calculadora oculta');
            }
        }
        
        // Restaurar estado de la calculadora al cargar
        document.addEventListener('DOMContentLoaded', function() {
            const calculadora = document.getElementById('calculadora');
            const toggleBtn = document.getElementById('calculadoraToggleBtn');
            const estadoGuardado = localStorage.getItem('calculadora-visible');
            
            // Por defecto, la calculadora est치 oculta
            if (estadoGuardado === 'true') {
                if (calculadora) {
                    calculadora.classList.add('visible');
                }
                if (toggleBtn) {
                    toggleBtn.style.display = 'none';
                }
            } else {
                // Asegurar que est칠 oculta
                if (calculadora) {
                    calculadora.classList.remove('visible');
                }
                if (toggleBtn) {
                    toggleBtn.style.display = 'flex';
                }
            }
        });
        
        // ===== FUNCI칍N PARA MOSTRAR STOCK =====
        function mostrarStock(cantidad) {
            if (cantidad > 10) {
                return '<span class="stock-indicator stock-disponible">Disponible</span>';
            } else if (cantidad > 0) {
                return '<span class="stock-indicator stock-bajo">Stock Bajo</span>';
            } else {
                return '<span class="stock-indicator stock-agotado">Agotado</span>';
            }
        }
        
        // ===== INICIALIZACI칍N =====
        document.addEventListener('DOMContentLoaded', function() {
            calcularPrecio();
            console.log('游띐勇 Interfaz de compradores inicializada');
            
            // Inicializar protecci칩n de datos sensibles
            if (typeof ProteccionDatosSensibles !== 'undefined') {
                new ProteccionDatosSensibles();
            }
            
            // Inicializar protecci칩n de devtools
            if (typeof ProteccionDevToolsAvanzada !== 'undefined') {
                new ProteccionDevToolsAvanzada();
            }
        });
    </script>
    
    <script src="js/compradores-cumple-consent.js"></script>
    <!-- Sistema de Alertas de Emergencia Global -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/js/inject-env-vars.js"></script>
    <script src="auth/supabase-config.js"></script>
    <script src="/js/sistema-alertas-comunidades.js"></script>
    <!-- Sistema de Check-in Autom치tico de Emergencias -->
    <script src="/js/sistema-checkin-emergencias.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (typeof SistemaAlertasComunidades !== 'undefined') {
                    window.alertasGlobal = new SistemaAlertasComunidades('global');
                }
            }, 500);
        });
    </script>
    
    <!-- Widget de Chat de Email - Brevo -->
    <script src="/js/widget-brevo-chat.js"></script>
    
    <!-- Sistema de Historias con Coraz칩n Cresalia -->
    <script src="/js/historias-corazon-cresalia.js"></script>
    
    <!-- Sistema de Alertas Inteligente (Solidaridad Global + Proximidad Local) -->
    <script src="/js/sistema-alertas-inteligente.js"></script>
    
    <!-- Sistema de Registro de Ubicaci칩n para Alertas -->
    <script src="/js/sistema-registro-ubicacion-alertas.js"></script>
    
    <!-- Sistema de Env칤o de Emails Autom치ticos -->
    <script src="/js/sistema-envio-emails-alertas.js"></script>
    
    <!-- Sistema de Mensaje Festivo 24 de Diciembre -->
    <script src="/js/sistema-mensaje-festivo-24-diciembre.js"></script>
    
    <!-- Sistema de Sesiones Persistentes -->
    <script src="/js/sistema-sesiones-persistentes.js"></script>
    
    <!-- Funci칩n de Logout para Compradores -->
    <script>
        async function cerrarSesionComprador() {
            if (!confirm('쮼st치s seguro que quer칠s cerrar sesi칩n?')) {
                return;
            }
            
            try {
                console.log('游뛁 Cerrando sesi칩n de comprador...');
                
                const supabase = await esperarInitSupabase();
                
                if (supabase) {
                    const { error } = await supabase.auth.signOut();
                    
                    if (error) {
                        console.error('Error al cerrar sesi칩n:', error);
                    }
                }
                
                // Limpiar localStorage
                localStorage.removeItem('cresalia_sesion_activa');
                localStorage.removeItem('cresalia_session_token');
                localStorage.removeItem('cresalia_user_data');
                localStorage.removeItem('cresalia_comprador_id');
                localStorage.removeItem('carrito_cresalia');
                
                // Limpiar sessionStorage
                sessionStorage.clear();
                
                console.log('九 Sesi칩n cerrada correctamente');
                
                // Redirigir al inicio
                window.location.href = '/index-cresalia.html';
                
            } catch (error) {
                console.error('仇 Error al cerrar sesi칩n:', error);
                alert('Error al cerrar sesi칩n. Recargando p치gina...');
                window.location.reload();
            }
        }
        
        // Hacer disponible globalmente
        window.cerrarSesionComprador = cerrarSesionComprador;
        
        // Funci칩n auxiliar para esperar initSupabase
        async function esperarInitSupabase(maxIntentos = 10, intervalo = 500) {
            for (let i = 0; i < maxIntentos; i++) {
                if (typeof initSupabase === 'function') {
                    try {
                        const supabase = initSupabase();
                        if (supabase) return supabase;
                    } catch (error) {
                        console.warn('Error al llamar initSupabase:', error);
                    }
                }
                if (i < maxIntentos - 1) {
                    await new Promise(resolve => setTimeout(resolve, intervalo));
                }
            }
            console.error('仇 initSupabase no disponible despu칠s de varios intentos');
            return null;
        }
        
                // Cargar datos del usuario cuando la p치gina est칠 lista
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(cargarDatosUsuario, 1000);
        });
        
        // Funci칩n para mostrar/ocultar card de login seg칰n si hay sesi칩n
        async function verificarYActualizarCardLogin() {
            try {
                const supabase = await esperarInitSupabase();
                if (!supabase) return;
                
                const { data: { user }, error } = await supabase.auth.getUser();
                const cardLogin = document.getElementById('card-ingresar-registro');
                
                if (cardLogin) {
                    // Si hay usuario logueado, ocultar card de login
                    if (user && !error) {
                        cardLogin.style.display = 'none';
                    } else {
                        // Si no hay usuario, mostrar card de login
                        cardLogin.style.display = 'block';
                    }
                }
            } catch (error) {
                console.log('Error verificando sesi칩n para card login:', error);
                // Si hay error, mostrar card de login por defecto
                const cardLogin = document.getElementById('card-ingresar-registro');
                if (cardLogin) {
                    cardLogin.style.display = 'block';
                }
            }
        }
        
        // Verificar al cargar la p치gina
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(verificarYActualizarCardLogin, 1500);
        });
        
        // ===== WIDGET DE ACCESO DIRECTO A COMUNIDADES (PARA COMPRADORES) =====
        function abrirWidgetComunidades() {
            document.getElementById('widget-comunidades-section').style.display = 'block';
            document.getElementById('widget-comunidades-section').scrollIntoView({ behavior: 'smooth' });
            inicializarWidgetComunidadComprador();
        }
        
        function inicializarWidgetComunidadComprador() {
            const checkbox = document.getElementById('activar-widget-comunidad-comprador');
            const contenidoActivo = document.getElementById('contenido-widget-comunidad-comprador');
            
            if (!checkbox) return;
            
            // Cargar estado guardado
            const widgetActivo = localStorage.getItem('cresalia_widget_comunidad_comprador_activo') === 'true';
            checkbox.checked = widgetActivo;
            
            if (widgetActivo) {
                contenidoActivo.style.display = 'block';
            } else {
                contenidoActivo.style.display = 'none';
            }
            
            // Listener para cambios
            checkbox.addEventListener('change', function() {
                const activado = this.checked;
                localStorage.setItem('cresalia_widget_comunidad_comprador_activo', activado ? 'true' : 'false');
                
                if (activado) {
                    const confirmar = confirm('쮻eseas activar el Widget de Acceso Directo a Comunidades?\n\nEsto te permitir치 generar URLs personalizadas para acceder r치pidamente a cualquier comunidad de Cresalia.');
                    if (confirmar) {
                        contenidoActivo.style.display = 'block';
                    } else {
                        this.checked = false;
                        localStorage.setItem('cresalia_widget_comunidad_comprador_activo', 'false');
                    }
                } else {
                    contenidoActivo.style.display = 'none';
                }
            });
        }
        
        async function generarWidgetComunidadComprador() {
            const select = document.getElementById('select-comunidad-comprador');
            if (!select || !select.value) {
                document.getElementById('preview-widget-comunidad-comprador-container').style.display = 'none';
                return;
            }
            
            const [nombreComunidad, urlComunidad, labelComunidad] = select.value.split('|');
            const partesLabel = labelComunidad.split(' ');
            const iconoComunidad = partesLabel[0];
            const nombreComunidadLimpio = partesLabel.slice(1).join(' ');
            
            try {
                // Obtener datos del usuario desde el widget de perfil
                const nombreUsuario = document.getElementById('nombre-usuario-widget')?.textContent || 'Usuario';
                const avatarUrl = document.getElementById('avatar-usuario')?.src || localStorage.getItem('cresalia_avatar_url') || '';
                
                const baseUrl = window.location.origin;
                const widgetUrl = `${baseUrl}/tiendas/ejemplo-tienda/widget-acceso-comunidad.html?url=${encodeURIComponent(urlComunidad)}&logo=${encodeURIComponent(avatarUrl)}&tienda=${encodeURIComponent(nombreUsuario)}&comunidad=${encodeURIComponent(nombreComunidadLimpio)}&icono=${encodeURIComponent(iconoComunidad)}`;
                
                // Actualizar preview
                const previewLogo = document.getElementById('preview-logo-usuario-comunidad');
                const previewNombre = document.getElementById('preview-nombre-comunidad-comprador');
                const previewBadge = document.getElementById('preview-comunidad-badge-comprador');
                
                if (previewLogo) {
                    if (avatarUrl && !avatarUrl.includes('data:image/svg')) {
                        previewLogo.src = avatarUrl;
                    } else {
                        const iniciales = nombreUsuario.substring(0, 2).toUpperCase();
                        // Usar comillas dobles en el SVG para evitar conflictos con template literal
                        previewLogo.src = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="%237C3AED"/><text x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-size="36" font-weight="bold" fill="white">${iniciales}</text></svg>`;
                    }
                }
                
                if (previewNombre) {
                    previewNombre.textContent = nombreComunidadLimpio;
                }
                
                if (previewBadge) {
                    previewBadge.innerHTML = iconoComunidad + ' ' + nombreComunidadLimpio;
                }
                
                // Mostrar preview
                document.getElementById('preview-widget-comunidad-comprador-container').style.display = 'block';
                
                // Actualizar URL
                const urlInput = document.getElementById('url-widget-comunidad-comprador');
                if (urlInput) {
                    urlInput.value = widgetUrl;
                }
                
                // Generar c칩digo HTML - Construir de forma segura usando funci칩n helper
                const escaparHTML = (str) => String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                const nombreComunidadEscapado = escaparHTML(nombreComunidadLimpio);
                const widgetUrlEscapado = escaparHTML(widgetUrl);
                const widgetUrlJS = JSON.stringify(widgetUrl);
                
                // Construir partes del HTML de forma segura
                const partesHTML = [];
                partesHTML.push('<!DOCTYPE html>');
                partesHTML.push('<html lang="es">');
                partesHTML.push('<head>');
                partesHTML.push('    <meta charset="UTF-8">');
                partesHTML.push('    <meta name="viewport" content="width=device-width, initial-scale=1.0">');
                partesHTML.push('    <title>Acceso Directo - ' + nombreComunidadEscapado + '</title>');
                partesHTML.push('    <meta http-equiv="refresh" content="0; url=' + widgetUrlEscapado + '">');
                partesHTML.push('</head>');
                partesHTML.push('<body style="margin:0;padding:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif">');
                // Construir script tag de forma segura
                const scriptTagClose = '</' + 'script>';
                const scriptContent = '        window.location.href = ' + widgetUrlJS + ';';
                partesHTML.push('    <script>');
                partesHTML.push(scriptContent);
                partesHTML.push('    ' + scriptTagClose);
                partesHTML.push('    <div style="text-align:center;color:white;padding:20px">');
                partesHTML.push('        <p style="font-size:18px;margin-bottom:15px">Redirigiendo...</p>');
                partesHTML.push('        <a href="' + widgetUrlEscapado + '" style="color:white;text-decoration:underline;font-size:16px">Si no redirige autom치ticamente, haz clic aqu칤</a>');
                partesHTML.push('    </div>');
                partesHTML.push('</body>');
                partesHTML.push('</html>');
                
                const codigoHTMLCompleto = partesHTML.join('\n');
                
                const codigoDiv = document.getElementById('codigo-html-widget-comunidad-comprador');
                if (codigoDiv) {
                    codigoDiv.textContent = codigoHTMLCompleto;
                }
                
            } catch (error) {
                console.error('Error generando widget comunidad:', error);
            }
        }
        
        function copiarUrlWidgetComunidadComprador() {
            const urlInput = document.getElementById('url-widget-comunidad-comprador');
            if (urlInput) {
                urlInput.select();
                document.execCommand('copy');
                alert('九 URL copiada al portapapeles');
            }
        }
        
        function copiarCodigoWidgetComunidadComprador() {
            const codigoDiv = document.getElementById('codigo-html-widget-comunidad-comprador');
            if (codigoDiv) {
                const textarea = document.createElement('textarea');
                textarea.value = codigoDiv.textContent;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('九 C칩digo copiado al portapapeles');
            }
        }
        
        // ===== SISTEMA DE AVATAR =====
        async function cargarDatosUsuario() {
            try {
                // Esperar a que initSupabase est칠 disponible
                const supabase = await esperarInitSupabase();
                if (!supabase) {
                    console.warn('丘멆잺 initSupabase no disponible, reintentando en 1 segundo...');
                    setTimeout(cargarDatosUsuario, 1000);
                    return;
                }
                
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error || !user) {
                    // Usuario no logueado, ocultar widget
                    document.getElementById('widget-perfil-usuario').style.display = 'none';
                    return;
                }
                
                // Mostrar widget
                const widget = document.getElementById('widget-perfil-usuario');
                widget.style.display = 'block';
                
                // Cargar datos del usuario
                const nombre = user.user_metadata?.nombre || user.user_metadata?.nombre_tienda || user.email?.split('@')[0] || 'Usuario';
                const email = user.email || '';
                
                // Verificar tipo de usuario: primero en tabla tiendas (m치s confiable)
                let tipoUsuario = null;
                
                // 1. Verificar si existe en tabla tiendas (prioridad)
                try {
                    const { data: tienda, error: errorTienda } = await supabase
                        .from('tiendas')
                        .select('configuracion, plan')
                        .eq('user_id', user.id)
                        .single();
                    
                    if (tienda && !errorTienda) {
                        // Usuario es vendedor/emprendedor/servicios
                        if (tienda.configuracion?.tipo) {
                            const tipoConfig = tienda.configuracion.tipo;
                            tipoUsuario = tipoConfig === 'servicio' ? 'servicios' : 
                                        tipoConfig === 'emprendedor' ? 'emprendedor' : 
                                        'vendedor';
                        } else {
                            // Si no tiene tipo en configuracion, pero existe en tiendas, es vendedor
                            tipoUsuario = 'vendedor';
                        }
                    }
                } catch (error) {
                    // No hay tienda, continuar verificando
                    console.log('Usuario no tiene tienda registrada');
                }
                
                // 2. Si no es vendedor, verificar metadata
                if (!tipoUsuario) {
                    tipoUsuario = user.user_metadata?.tipo_usuario;
                }
                
                // 3. Si a칰n no hay tipo, verificar en tabla compradores
                if (!tipoUsuario) {
                    try {
                        const { data: comprador, error: errorComprador } = await supabase
                            .from('compradores')
                            .select('user_id')
                            .eq('user_id', user.id)
                            .single();
                        
                        if (comprador && !errorComprador) {
                            tipoUsuario = 'comprador';
                        }
                    } catch (error) {
                        // No hay comprador registrado
                    }
                }
                
                // 4. Por defecto, comprador
                if (!tipoUsuario) {
                    tipoUsuario = 'comprador';
                }
                
                // Determinar el tipo de usuario correcto para mostrar
                let tipoDisplay = '';
                if (['vendedor', 'emprendedor', 'servicios'].includes(tipoUsuario)) {
                    tipoDisplay = tipoUsuario === 'vendedor' ? '游낅 Vendedor' : 
                                 tipoUsuario === 'emprendedor' ? '游눺 Emprendedor' : 
                                 '游댢 Servicios';
                } else {
                    tipoDisplay = '游 Comprador';
                }
                
                document.getElementById('nombre-usuario-widget').textContent = nombre;
                document.getElementById('email-usuario-widget').textContent = email;
                
                // Mostrar tipo de usuario solo si existe el elemento
                const tipoWidget = document.getElementById('tipo-usuario-widget');
                if (tipoWidget) {
                    tipoWidget.textContent = tipoDisplay;
                    tipoWidget.style.display = 'block';
                }
                
                // Actualizar t칤tulo del panel seg칰n tipo de usuario
                const tituloPanel = document.getElementById('titulo-panel-usuario');
                if (tituloPanel) {
                    if (['vendedor', 'emprendedor', 'servicios'].includes(tipoUsuario)) {
                        tituloPanel.innerHTML = '<i class="fas fa-store"></i> Panel de Vendedor';
                    } else {
                        tituloPanel.innerHTML = '<i class="fas fa-shopping-cart"></i> Panel de Comprador';
                    }
                }
                
                // Cargar avatar guardado
                const avatarUrl = localStorage.getItem('cresalia_avatar_url');
                if (avatarUrl) {
                    document.getElementById('avatar-usuario').src = avatarUrl;
                } else {
                    // Avatar por defecto con iniciales
                    const iniciales = nombre.charAt(0).toUpperCase();
                    document.getElementById('avatar-usuario').src = `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80'><rect width='80' height='80' fill='%237C3AED'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='32' font-weight='bold' fill='white'>${iniciales}</text></svg>`;
                }
                
            } catch (error) {
                console.error('Error cargando datos de usuario:', error);
            }
        }
        
        async function cambiarAvatar(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validar tama침o (m치x 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('丘멆잺 La imagen es muy grande. Por favor, eleg칤 una imagen menor a 2MB.');
                return;
            }
            
            // Validar tipo
            if (!file.type.startsWith('image/')) {
                alert('丘멆잺 Por favor, eleg칤 una imagen v치lida.');
                return;
            }
            
            try {
                // Crear preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const avatarImg = document.getElementById('avatar-usuario');
                    avatarImg.src = e.target.result;
                    
                    // Guardar en localStorage
                    localStorage.setItem('cresalia_avatar_url', e.target.result);
                    
                    // Opcional: Subir a Supabase Storage
                    subirAvatarASupabase(file);
                };
                reader.readAsDataURL(file);
                
            } catch (error) {
                console.error('Error cambiando avatar:', error);
                alert('仇 Error al cambiar el avatar. Por favor, intent치 de nuevo.');
            }
        }
        
        async function subirAvatarASupabase(file) {
            try {
                const supabase = initSupabase();
                if (!supabase) return;
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;
                
                // Crear nombre 칰nico para el archivo
                const fileName = `avatars/${user.id}/${Date.now()}_${file.name}`;
                
                // Subir a Supabase Storage (si ten칠s un bucket configurado)
                // const { data, error } = await supabase.storage
                //     .from('avatars')
                //     .upload(fileName, file, { upsert: true });
                
                // Por ahora solo guardamos en localStorage
                console.log('九 Avatar guardado localmente');
                
            } catch (error) {
                console.warn('丘멆잺 No se pudo subir a Supabase, guardado solo localmente:', error);
            }
        }
        
        // Variable para prevenir apertura autom치tica del modal de compras (declarada temprano)
        let modalComprasAbierto = false;
        
        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', () => {
            // Cerrar cualquier modal de compras que pueda estar abierto por error
            const modalExistente = document.getElementById('modal-historial-compras');
            if (modalExistente) {
                modalExistente.remove();
                document.body.style.overflow = '';
                modalComprasAbierto = false;
            }
            
            setTimeout(cargarDatosUsuario, 1000);
        });
        
        // Hacer funciones globales
        window.cambiarAvatar = cambiarAvatar;
        window.cargarDatosUsuario = cargarDatosUsuario;
        
        // ===== FUNCIONES DE EDICI칍N DE PERFIL =====
        
        async function abrirEditarPerfil() {
            try {
                // Ocultar todas las secciones no relacionadas
                const historiasSection = document.getElementById('historias-corazon');
                if (historiasSection) {
                    historiasSection.style.display = 'none';
                }
                
                const widgetComunidades = document.getElementById('widget-comunidades-section');
                if (widgetComunidades) {
                    widgetComunidades.style.display = 'none';
                }
                
                // Mostrar secci칩n de editar perfil
                const seccion = document.getElementById('editar-perfil-section');
                if (seccion) {
                    seccion.style.display = 'block';
                    seccion.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    // Actualizar hash sin disparar scroll
                    window.history.replaceState(null, null, '#editar-perfil');
                    
                    // Cargar datos del usuario
                    await cargarDatosPerfil();
                }
            } catch (error) {
                console.error('Error abriendo editar perfil:', error);
                alert('仇 Error al abrir el formulario de edici칩n');
            }
        }
        
        function cerrarEditarPerfil() {
            const seccion = document.getElementById('editar-perfil-section');
            if (seccion) {
                seccion.style.display = 'none';
            }
        }
        
        async function cargarDatosPerfil() {
            try {
                const supabase = await esperarInitSupabase();
                if (!supabase) {
                    console.warn('丘멆잺 initSupabase no disponible');
                    return;
                }
                
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError || !user) {
                    alert('仇 Debes estar logueado para editar tu perfil');
                    return;
                }
                
                // Cargar email
                document.getElementById('perfil-email').value = user.email || '';
                
                // Cargar datos del comprador desde Supabase
                const { data: comprador, error: compradorError } = await supabase
                    .from('compradores')
                    .select('telefono, direccion_principal, dni')
                    .eq('user_id', user.id)
                    .single();
                
                if (comprador && !compradorError) {
                    // Cargar tel칠fono
                    document.getElementById('perfil-telefono').value = comprador.telefono || '';
                    
                    // Cargar DNI (si existe el campo, o desde metadata)
                    const dni = comprador.dni || user.user_metadata?.dni || '';
                    document.getElementById('perfil-dni').value = dni;
                    
                    // Cargar direcci칩n
                    if (comprador.direccion_principal) {
                        const dir = comprador.direccion_principal;
                        document.getElementById('perfil-calle').value = dir.calle || '';
                        document.getElementById('perfil-ciudad').value = dir.ciudad || '';
                        document.getElementById('perfil-provincia').value = dir.provincia || '';
                        document.getElementById('perfil-codigo-postal').value = dir.codigo_postal || '';
                    }
                } else {
                    console.log('No se encontraron datos del comprador, se crear치n al guardar');
                }
                
            } catch (error) {
                console.error('Error cargando datos del perfil:', error);
            }
        }
        
        async function guardarPerfil(event) {
            event.preventDefault();
            
            try {
                const supabase = await esperarInitSupabase();
                if (!supabase) {
                    alert('仇 Error: No se pudo conectar a Supabase');
                    return;
                }
                
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError || !user) {
                    alert('仇 Debes estar logueado para guardar cambios');
                    return;
                }
                
                // Obtener valores del formulario
                const telefono = document.getElementById('perfil-telefono').value.trim();
                const dni = document.getElementById('perfil-dni').value.trim();
                const calle = document.getElementById('perfil-calle').value.trim();
                const ciudad = document.getElementById('perfil-ciudad').value.trim();
                const provincia = document.getElementById('perfil-provincia').value.trim();
                const codigoPostal = document.getElementById('perfil-codigo-postal').value.trim();
                
                // Validar campos requeridos
                if (!telefono) {
                    alert('仇 Por favor, ingresa tu n칰mero de celular');
                    return;
                }
                
                if (!calle || !ciudad || !provincia) {
                    alert('仇 Por favor, completa todos los campos de direcci칩n requeridos');
                    return;
                }
                
                // Preparar direcci칩n principal
                const direccionPrincipal = {
                    calle: calle,
                    ciudad: ciudad,
                    provincia: provincia,
                    codigo_postal: codigoPostal,
                    pais: 'Argentina'
                };
                
                // Verificar si el comprador ya existe
                const { data: compradorExistente } = await supabase
                    .from('compradores')
                    .select('id')
                    .eq('user_id', user.id)
                    .single();
                
                const datosActualizar = {
                    telefono: telefono,
                    direccion_principal: direccionPrincipal
                };
                
                // Agregar DNI si existe (intentar guardarlo en la tabla, si falla se guarda en metadata)
                if (dni) {
                    // Intentar agregar DNI a datosActualizar (solo funcionar치 si la columna existe)
                    try {
                        datosActualizar.dni = dni;
                    } catch (e) {
                        // Si la columna no existe, se guardar치 en metadata
                        console.log('Campo DNI no existe en tabla, se guardar치 en metadata');
                    }
                }
                
                let resultado;
                if (compradorExistente) {
                    // Actualizar comprador existente
                    resultado = await supabase
                        .from('compradores')
                        .update(datosActualizar)
                        .eq('user_id', user.id);
                } else {
                    // Crear nuevo registro de comprador
                    datosActualizar.user_id = user.id;
                    datosActualizar.nombre_completo = user.user_metadata?.nombre || user.email?.split('@')[0] || 'Usuario';
                    datosActualizar.email = user.email;
                    
                    resultado = await supabase
                        .from('compradores')
                        .insert([datosActualizar]);
                }
                
                if (resultado.error) {
                    console.error('Error guardando perfil:', resultado.error);
                    alert('仇 Error al guardar: ' + resultado.error.message);
                    return;
                }
                
                // Si se proporcion칩 DNI, tambi칠n guardarlo en user_metadata
                if (dni) {
                    const { error: updateMetadataError } = await supabase.auth.updateUser({
                        data: { dni: dni }
                    });
                    if (updateMetadataError) {
                        console.warn('No se pudo guardar DNI en metadata:', updateMetadataError);
                    }
                }
                
                alert('九 Perfil actualizado correctamente');
                cerrarEditarPerfil();
                
                // Recargar datos del usuario en el widget
                await cargarDatosUsuario();
                
            } catch (error) {
                console.error('Error guardando perfil:', error);
                alert('仇 Error inesperado al guardar: ' + error.message);
            }
        }
        
        window.abrirEditarPerfil = abrirEditarPerfil;
        window.cerrarEditarPerfil = cerrarEditarPerfil;
        window.guardarPerfil = guardarPerfil;
        
        // ===== SISTEMA DE TRACKING Y HISTORIAL DE COMPRAS =====
        
        async function mostrarHistorialCompras() {
            // Prevenir m칰ltiples aperturas simult치neas
            if (modalComprasAbierto) {
                return;
            }
            
            try {
                modalComprasAbierto = true;
                
                const supabase = await esperarInitSupabase();
                if (!supabase) {
                    alert('仇 No se pudo conectar a Supabase');
                    modalComprasAbierto = false;
                    return;
                }
                
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError || !user) {
                    alert('仇 Debes estar logueado para ver tu historial');
                    modalComprasAbierto = false;
                    return;
                }
                
                // Obtener comprador_id
                const { data: comprador } = await supabase
                    .from('compradores')
                    .select('id')
                    .eq('user_id', user.id)
                    .single();
                
                if (!comprador) {
                    alert('仇 No se encontr칩 tu perfil de comprador');
                    modalComprasAbierto = false;
                    return;
                }
                
                // Cargar compras
                const { data: compras, error } = await supabase
                    .from('compras')
                    .select('*')
                    .eq('comprador_id', comprador.id)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error:', error);
                    alert('仇 Error al cargar tus compras');
                    modalComprasAbierto = false;
                    return;
                }
                
                // Crear modal de historial
                crearModalHistorialCompras(compras || []);
                
            } catch (error) {
                console.error('Error en mostrarHistorialCompras:', error);
                alert('仇 Error inesperado');
                modalComprasAbierto = false;
            }
        }
        
        function cerrarModalHistorialCompras() {
            const modal = document.getElementById('modal-historial-compras');
            if (modal) {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                    modal.remove();
                    document.body.style.overflow = '';
                    modalComprasAbierto = false;
                }, 300);
            } else {
                modalComprasAbierto = false;
            }
        }
        
        function crearModalHistorialCompras(compras) {
            // Cerrar modal existente si hay
            const modalExistente = document.getElementById('modal-historial-compras');
            if (modalExistente) {
                cerrarModalHistorialCompras();
                // Esperar a que se cierre antes de crear uno nuevo
                setTimeout(() => {
                    crearModalHistorialComprasInterno(compras);
                }, 350);
                return;
            }
            crearModalHistorialComprasInterno(compras);
        }
        
        function crearModalHistorialComprasInterno(compras) {
            // Asegurar que compras es un array
            if (!Array.isArray(compras)) {
                compras = [];
            }
            
            // Generar contenido de compras de forma segura
            let contenidoCompras = '';
            if (compras.length === 0) {
                contenidoCompras = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <i class="fas fa-shopping-bag" style="font-size: 64px; color: #D1D5DB; margin-bottom: 20px;"></i>
                        <h3 style="color: #6B7280; margin-bottom: 10px;">No tienes compras a칰n</h3>
                        <p style="color: #9CA3AF;">Cuando realices una compra, aparecer치 aqu칤.</p>
                    </div>
                `;
            } else {
                try {
                    contenidoCompras = compras.map(compra => {
                        const estadoInfo = obtenerInfoEstadoCompra(compra.estado || 'pendiente');
                        const numeroOrden = compra.numero_orden || compra.id || 'N/A';
                        const fecha = compra.created_at ? new Date(compra.created_at).toLocaleString('es-AR') : 'Fecha no disponible';
                        const total = compra.total ? parseFloat(compra.total).toLocaleString('es-AR', {minimumFractionDigits: 2}) : '0.00';
                        const compraId = compra.id || '';
                        const numeroSeguimiento = compra.numero_seguimiento || '';
                        
                        // Escapar valores antes de usarlos en template literal
                        const numeroOrdenEscapado = String(numeroOrden).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        const compraIdEscapado = String(compraId).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        
                        let botonSeguimiento = '';
                        if (numeroSeguimiento) {
                            const numeroSeguimientoEscapado = String(numeroSeguimiento).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                            botonSeguimiento = '<button class="btn-copiar-seguimiento" data-numero-seguimiento="' + numeroSeguimientoEscapado + '" style="background: #10B981; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-left: 10px;"><i class="fas fa-copy"></i> Copiar N춿 Seguimiento</button>';
                        }
                        
                        return '<div style="background: #F8FAFC; border-radius: 15px; padding: 20px; margin-bottom: 20px; border-left: 4px solid ' + estadoInfo.color + '">' +
                            '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;">' +
                            '<div><h3 style="margin: 0 0 5px 0; color: #1F2937;">Orden #' + numeroOrdenEscapado + '</h3>' +
                            '<p style="margin: 0; color: #6B7280; font-size: 14px;">' + fecha + '</p></div>' +
                            '<div style="text-align: right;">' +
                            '<div style="background: ' + estadoInfo.colorFondo + '; color: ' + estadoInfo.colorTexto + '; padding: 6px 12px; border-radius: 8px; display: inline-block; font-weight: 600; font-size: 14px;">' +
                            estadoInfo.icono + ' ' + estadoInfo.estado + '</div>' +
                            '<p style="margin: 10px 0 0 0; font-size: 20px; font-weight: 700; color: #1F2937;">$' + total + '</p></div></div>' +
                            '<div style="display: flex; gap: 10px; flex-wrap: wrap;">' +
                            '<button class="btn-ver-seguimiento" data-compra-id="' + compraIdEscapado + '" data-numero-orden="' + numeroOrdenEscapado + '" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">' +
                            '<i class="fas fa-shipping-fast"></i> Ver Seguimiento</button>' +
                            botonSeguimiento +
                            '</div></div>';
                    }).join('');
                } catch (error) {
                    console.error('Error generando contenido de compras:', error);
                    contenidoCompras = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 64px; color: #F59E0B; margin-bottom: 20px;"></i>
                            <h3 style="color: #6B7280; margin-bottom: 10px;">Error al cargar compras</h3>
                            <p style="color: #9CA3AF;">Por favor, intenta recargar la p치gina.</p>
                        </div>
                    `;
                }
            }
            
            const numPedidos = compras.length;
            const textoPedidos = numPedidos === 1 ? 'pedido' : 'pedidos';
            
            const modalHTML = `
                <div id="modal-historial-compras" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; opacity: 0; transition: opacity 0.3s ease;">
                    <div id="modal-content-compras" style="background: white; border-radius: 20px; max-width: 900px; width: 100%; max-height: 90vh; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <!-- Header -->
                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 20px 20px 0 0; position: sticky; top: 0; z-index: 10;">
                            <button id="btn-cerrar-modal-compras" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">
                                <i class="fas fa-times"></i>
                            </button>
                            <h2 style="margin: 0; font-size: 24px; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-shopping-bag"></i> Mis Compras
                            </h2>
                            <p style="margin: 10px 0 0 0; opacity: 0.9;">${numPedidos} ${textoPedidos}</p>
                        </div>
                        
                        <!-- Lista de Compras -->
                        <div style="padding: 30px; max-height: calc(90vh - 120px); overflow-y: auto;">
                            ${contenidoCompras}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Prevenir scroll del body cuando el modal est치 abierto
            document.body.style.overflow = 'hidden';
            
            // Hacer el modal visible con animaci칩n
            const modal = document.getElementById('modal-historial-compras');
            setTimeout(() => {
                if (modal) {
                    modal.style.opacity = '1';
                }
            }, 10);
            
            // Agregar event listeners para cerrar el modal
            const btnCerrar = document.getElementById('btn-cerrar-modal-compras');
            if (btnCerrar) {
                btnCerrar.addEventListener('click', cerrarModalHistorialCompras);
                // Agregar efectos hover con JavaScript en lugar de inline
                btnCerrar.addEventListener('mouseenter', function() {
                    this.style.background = 'rgba(255,255,255,0.3)';
                });
                btnCerrar.addEventListener('mouseleave', function() {
                    this.style.background = 'rgba(255,255,255,0.2)';
                });
            }
            
            // Prevenir cierre al hacer click en el contenido del modal
            const modalContent = document.getElementById('modal-content-compras');
            if (modalContent) {
                modalContent.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
            
            // Cerrar al hacer click fuera del modal
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    cerrarModalHistorialCompras();
                }
            });
            
            // Cerrar con tecla ESC
            const handleEscape = function(e) {
                if (e.key === 'Escape' && document.getElementById('modal-historial-compras')) {
                    cerrarModalHistorialCompras();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
            
            // Agregar event listeners para los botones de seguimiento y copiar
            setTimeout(() => {
                // Botones de ver seguimiento
                const botonesSeguimiento = modal.querySelectorAll('.btn-ver-seguimiento');
                botonesSeguimiento.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const compraId = this.getAttribute('data-compra-id');
                        const numeroOrden = this.getAttribute('data-numero-orden');
                        if (window.SistemaTrackingEnvios && window.SistemaTrackingEnvios.mostrarTrackingPedido) {
                            window.SistemaTrackingEnvios.mostrarTrackingPedido(compraId, numeroOrden);
                        } else {
                            alert('Sistema de tracking no disponible');
                        }
                    });
                });
                
                // Botones de copiar seguimiento
                const botonesCopiar = modal.querySelectorAll('.btn-copiar-seguimiento');
                botonesCopiar.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const numeroSeguimiento = this.getAttribute('data-numero-seguimiento');
                        if (numeroSeguimiento) {
                            copiarSeguimiento(numeroSeguimiento);
                        }
                    });
                });
            }, 50);
        }
        
        function obtenerInfoEstadoCompra(estado) {
            const estados = {
                'pendiente': { estado: 'Pendiente', icono: '낍', color: '#F59E0B', colorFondo: '#FEF3C7', colorTexto: '#92400E' },
                'confirmada': { estado: 'Confirmada', icono: '九', color: '#10B981', colorFondo: '#D1FAE5', colorTexto: '#065F46' },
                'preparando': { estado: 'Preparando', icono: '游닍', color: '#3B82F6', colorFondo: '#DBEAFE', colorTexto: '#1E40AF' },
                'enviada': { estado: 'Enviada', icono: '游뚴', color: '#8B5CF6', colorFondo: '#E0E7FF', colorTexto: '#3730A3' },
                'entregada': { estado: 'Entregada', icono: '游꿀', color: '#10B981', colorFondo: '#D1FAE5', colorTexto: '#065F46' },
                'cancelada': { estado: 'Cancelada', icono: '仇', color: '#EF4444', colorFondo: '#FEE2E2', colorTexto: '#991B1B' }
            };
            return estados[estado] || { estado: estado || 'Desconocido', icono: '仇', color: '#6B7280', colorFondo: '#F3F4F6', colorTexto: '#374151' };
        }
        
        function copiarSeguimiento(numero) {
            navigator.clipboard.writeText(numero).then(() => {
                alert('九 N칰mero de seguimiento copiado: ' + numero);
            }).catch(() => {
                alert('仇 Error al copiar');
            });
        }
        
        window.mostrarHistorialCompras = mostrarHistorialCompras;
        window.cerrarModalHistorialCompras = cerrarModalHistorialCompras;
        
        // ===== SISTEMA DE PUNTOS =====
        async function mostrarPanelPuntos() {
            try {
                // Crear modal
                const modalHTML = `
                    <div id="modal-puntos" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;">
                        <div style="background: white; border-radius: 20px; max-width: 800px; width: 100%; max-height: 90vh; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                            <!-- Header -->
                            <div style="background: linear-gradient(135deg, #F59E0B, #FCD34D); color: white; padding: 25px; border-radius: 20px 20px 0 0; position: sticky; top: 0; z-index: 10;">
                                <button onclick="cerrarModalPuntos()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-times"></i>
                                </button>
                                <h2 style="margin: 0; font-size: 24px; display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-star"></i> Sistema de Puntos y Recompensas
                                </h2>
                                <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 14px;">
                                    Gan치 puntos con cada compra y canjealos por descuentos
                                </p>
                            </div>
                            
                            <!-- Contenido -->
                            <div style="padding: 30px;">
                                <div id="panel-puntos"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remover modal existente
                const modalExistente = document.getElementById('modal-puntos');
                if (modalExistente) {
                    modalExistente.remove();
                }
                
                // Agregar modal
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Cargar panel de puntos
                if (window.SistemaPuntosComprador) {
                    await window.SistemaPuntosComprador.mostrarPanelPuntos('panel-puntos');
                }
                
                // Event listeners para cerrar
                const modal = document.getElementById('modal-puntos');
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        cerrarModalPuntos();
                    }
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && document.getElementById('modal-puntos')) {
                        cerrarModalPuntos();
                    }
                });
                
            } catch (error) {
                console.error('Error mostrando panel de puntos:', error);
                alert('仇 Error al cargar el panel de puntos');
            }
        }
        
        function cerrarModalPuntos() {
            const modal = document.getElementById('modal-puntos');
            if (modal) {
                modal.remove();
            }
        }
        
        window.mostrarPanelPuntos = mostrarPanelPuntos;
        window.cerrarModalPuntos = cerrarModalPuntos;
        
        // Funci칩n para mostrar campo de c칩digo de puntos
        async function mostrarCampoCodigoPuntos(containerId) {
            try {
                const puntos = await window.SistemaPuntosComprador.obtenerMisPuntos();
                if (puntos.error || !puntos.puntos_disponibles || puntos.puntos_disponibles < 100) {
                    return; // No mostrar si no tiene puntos suficientes
                }
                
                const container = document.getElementById(containerId);
                if (!container) return;
                
                // Obtener canjes activos
                const supabase = await esperarInitSupabase();
                if (!supabase) return;
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;
                
                const { data: comprador } = await supabase
                    .from('compradores')
                    .select('id')
                    .eq('user_id', user.id)
                    .single();
                
                if (!comprador) return;
                
                const { data: canjesActivos } = await supabase
                    .from('puntos_canjes')
                    .select('codigo_canje, descuento_obtenido, fecha_expiracion')
                    .eq('comprador_id', comprador.id)
                    .eq('estado', 'activo')
                    .gt('fecha_expiracion', new Date().toISOString())
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (!canjesActivos || canjesActivos.length === 0) {
                    return; // No mostrar si no tiene c칩digos activos
                }
                
                const html = `
                    <div style="background: #FEF3C7; border: 2px dashed #F59E0B; border-radius: 12px; padding: 20px; margin: 20px 0;">
                        <h4 style="margin: 0 0 15px 0; color: #92400E;">
                            <i class="fas fa-star"></i> 쯊en칠s un c칩digo de puntos?
                        </h4>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                            <input type="text" id="codigo-puntos-input" placeholder="Ingres치 tu c칩digo de canje" 
                                   style="flex: 1; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem;">
                            <button onclick="aplicarCodigoPuntos()" id="btn-aplicar-puntos" 
                                    style="background: #F59E0B; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                Aplicar
                            </button>
                        </div>
                        ${canjesActivos.length > 0 ? `
                            <div style="margin-top: 15px;">
                                <p style="margin: 0 0 10px 0; color: #92400E; font-size: 14px; font-weight: 600;">
                                    Tus c칩digos activos:
                                </p>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${canjesActivos.map(canje => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px; border-radius: 8px; border: 1px solid #FCD34D;">
                                            <div>
                                                <strong style="color: #92400E; font-family: monospace;">${canje.codigo_canje}</strong>
                                                <p style="margin: 5px 0 0 0; color: #6B7280; font-size: 12px;">
                                                    Descuento: $${parseFloat(canje.descuento_obtenido).toFixed(2)}
                                                </p>
                                            </div>
                                            <button onclick="copiarCodigoPuntos('${canje.codigo_canje}')" 
                                                    style="background: #F59E0B; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                                <i class="fas fa-copy"></i> Copiar
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        <div id="mensaje-codigo-puntos" style="margin-top: 10px;"></div>
                    </div>
                `;
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error mostrando campo de c칩digo de puntos:', error);
            }
        }
        
        async function aplicarCodigoPuntos() {
            const codigoInput = document.getElementById('codigo-puntos-input');
            const mensajeDiv = document.getElementById('mensaje-codigo-puntos');
            const btnAplicar = document.getElementById('btn-aplicar-puntos');
            
            if (!codigoInput || !mensajeDiv) return;
            
            const codigo = codigoInput.value.trim().toUpperCase();
            if (!codigo) {
                mensajeDiv.innerHTML = '<p style="color: #EF4444; margin: 0;">Por favor, ingres치 un c칩digo</p>';
                return;
            }
            
            btnAplicar.disabled = true;
            btnAplicar.textContent = 'Validando...';
            mensajeDiv.innerHTML = '';
            
            try {
                const supabase = await esperarInitSupabase();
                if (!supabase) {
                    throw new Error('Error de conexi칩n');
                }
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    throw new Error('Usuario no autenticado');
                }
                
                const { data: comprador } = await supabase
                    .from('compradores')
                    .select('id')
                    .eq('user_id', user.id)
                    .single();
                
                if (!comprador) {
                    throw new Error('Comprador no encontrado');
                }
                
                // Verificar c칩digo de canje
                const { data: canje, error } = await supabase
                    .from('puntos_canjes')
                    .select('*')
                    .eq('codigo_canje', codigo)
                    .eq('comprador_id', comprador.id)
                    .eq('estado', 'activo')
                    .single();
                
                if (error || !canje) {
                    mensajeDiv.innerHTML = '<p style="color: #EF4444; margin: 0;">仇 C칩digo inv치lido o ya usado</p>';
                    btnAplicar.disabled = false;
                    btnAplicar.textContent = 'Aplicar';
                    return;
                }
                
                // Verificar expiraci칩n
                if (new Date(canje.fecha_expiracion) < new Date()) {
                    mensajeDiv.innerHTML = '<p style="color: #EF4444; margin: 0;">仇 Este c칩digo ha expirado</p>';
                    btnAplicar.disabled = false;
                    btnAplicar.textContent = 'Aplicar';
                    return;
                }
                
                // Aplicar descuento (similar a cup칩n)
                window.codigoPuntosAplicado = {
                    codigo: codigo,
                    descuento: parseFloat(canje.descuento_obtenido),
                    canje: canje
                };
                
                // Actualizar totales
                if (typeof actualizarTotalesConCupon === 'function') {
                    actualizarTotalesConCupon(parseFloat(canje.descuento_obtenido));
                }
                
                mensajeDiv.innerHTML = `<p style="color: #10B981; margin: 0;">九 C칩digo aplicado: Descuento de $${parseFloat(canje.descuento_obtenido).toFixed(2)}</p>`;
                codigoInput.disabled = true;
                btnAplicar.disabled = true;
                
            } catch (error) {
                console.error('Error aplicando c칩digo de puntos:', error);
                mensajeDiv.innerHTML = `<p style="color: #EF4444; margin: 0;">仇 ${error.message}</p>`;
                btnAplicar.disabled = false;
                btnAplicar.textContent = 'Aplicar';
            }
        }
        
        function copiarCodigoPuntos(codigo) {
            navigator.clipboard.writeText(codigo).then(() => {
                alert(`九 C칩digo copiado: ${codigo}`);
            }).catch(() => {
                alert('仇 Error al copiar');
            });
        }
        
        window.mostrarCampoCodigoPuntos = mostrarCampoCodigoPuntos;
        window.aplicarCodigoPuntos = aplicarCodigoPuntos;
        window.copiarCodigoPuntos = copiarCodigoPuntos;
        
        // ===== PANEL DE ALERTAS DE STOCK =====
        async function mostrarPanelAlertasStock() {
            try {
                const modalHTML = `
                    <div id="modal-alertas-stock" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;">
                        <div style="background: white; border-radius: 20px; max-width: 800px; width: 100%; max-height: 90vh; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                            <!-- Header -->
                            <div style="background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white; padding: 25px; border-radius: 20px 20px 0 0; position: sticky; top: 0; z-index: 10;">
                                <button onclick="cerrarModalAlertasStock()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-times"></i>
                                </button>
                                <h2 style="margin: 0; font-size: 24px; display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-bell"></i> Alertas de Stock
                                </h2>
                                <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 14px;">
                                    Te notificaremos cuando los productos agotados vuelvan a estar disponibles
                                </p>
                            </div>
                            
                            <!-- Contenido -->
                            <div style="padding: 30px;">
                                <div id="panel-alertas-stock"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remover modal existente
                const modalExistente = document.getElementById('modal-alertas-stock');
                if (modalExistente) {
                    modalExistente.remove();
                }
                
                // Agregar modal
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Cargar alertas
                if (window.SistemaNotificacionesStock) {
                    await window.SistemaNotificacionesStock.mostrarPanelAlertas('panel-alertas-stock');
                }
                
                // Event listeners para cerrar
                const modal = document.getElementById('modal-alertas-stock');
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        cerrarModalAlertasStock();
                    }
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && document.getElementById('modal-alertas-stock')) {
                        cerrarModalAlertasStock();
                    }
                });
                
            } catch (error) {
                console.error('Error mostrando panel de alertas:', error);
                alert('仇 Error al cargar el panel de alertas');
            }
        }
        
        function cerrarModalAlertasStock() {
            const modal = document.getElementById('modal-alertas-stock');
            if (modal) {
                modal.remove();
            }
        }
        
        window.mostrarPanelAlertasStock = mostrarPanelAlertasStock;
        window.cerrarModalAlertasStock = cerrarModalAlertasStock;
        
        // ===== PANEL DE M칄TRICAS AVANZADAS =====
        async function mostrarPanelMetricas() {
            try {
                const modalHTML = `
                    <div id="modal-metricas-comprador" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;">
                        <div style="background: white; border-radius: 20px; max-width: 900px; width: 100%; max-height: 90vh; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                            <!-- Header -->
                            <div style="background: linear-gradient(135deg, #8B5CF6, #EC4899); color: white; padding: 25px; border-radius: 20px 20px 0 0; position: sticky; top: 0; z-index: 10;">
                                <button onclick="cerrarModalMetricas()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-times"></i>
                                </button>
                                <h2 style="margin: 0; font-size: 24px; display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-chart-bar"></i> Mis M칠tricas
                                </h2>
                                <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 14px;">
                                    Estad칤sticas de tus compras, gastos y categor칤as favoritas
                                </p>
                            </div>
                            
                            <!-- Contenido -->
                            <div style="padding: 30px;">
                                <div id="panel-metricas-comprador"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remover modal existente
                const modalExistente = document.getElementById('modal-metricas-comprador');
                if (modalExistente) {
                    modalExistente.remove();
                }
                
                // Agregar modal
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Cargar m칠tricas
                if (window.SistemaMetricasComprador) {
                    await window.SistemaMetricasComprador.mostrarPanelMetricas('panel-metricas-comprador');
                }
                
                // Event listeners para cerrar
                const modal = document.getElementById('modal-metricas-comprador');
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        cerrarModalMetricas();
                    }
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && document.getElementById('modal-metricas-comprador')) {
                        cerrarModalMetricas();
                    }
                });
                
            } catch (error) {
                console.error('Error mostrando panel de m칠tricas:', error);
                alert('仇 Error al cargar las m칠tricas');
            }
        }
        
        function cerrarModalMetricas() {
            const modal = document.getElementById('modal-metricas-comprador');
            if (modal) {
                modal.remove();
            }
        }
        
        window.mostrarPanelMetricas = mostrarPanelMetricas;
        window.cerrarModalMetricas = cerrarModalMetricas;
    </script>
    
    <!-- Scripts de Tracking -->
    <script src="/js/sistema-tracking-envios.js"></script>
    
    <!-- Sistema de Productos Relacionados -->
    <script src="/js/sistema-productos-relacionados.js"></script>
    
    <!-- Sistema de Cupones -->
    <script src="/js/sistema-cupones.js"></script>
    
    <!-- Sistema de Puntos y Recompensas -->
    <script src="/js/sistema-puntos-comprador.js"></script>
    
    <!-- Sistema de Notificaciones de Stock -->
    <script src="/js/sistema-notificaciones-stock.js"></script>
    <script src="/js/integrar-alertas-stock.js"></script>
    
    <!-- Sistema de M칠tricas Avanzadas -->
    <script src="/js/sistema-metricas-comprador.js"></script>
    
    <!-- Sistema de Comparador de Productos -->
    <script src="/js/sistema-comparador-productos.js"></script>
    
    <!-- Sistema de B칰squeda por Mapa/Ubicaci칩n -->
    <script src="/js/sistema-busqueda-mapa-compradores.js"></script>
    
    <!-- Integraci칩n de Productos Relacionados -->
    <script src="/js/integrar-productos-relacionados.js"></script>
    
    <!-- Animaci칩n Festiva de Fin de A침o -->
    <script src="/js/animacion-fiestas.js"></script>
    
    <!-- Logo Navide침o con Gorro -->
    <script src="/js/logo-navideno.js"></script>
</body>
</html>
