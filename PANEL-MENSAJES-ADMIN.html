<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Mensajes Globales - Admin</title>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Configuraci√≥n Supabase -->
    <script src="config-supabase-seguro.js"></script>
    
    <!-- Sistema de Mensajes Globales -->
    <script src="js/sistema-mensajes-globales.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #6B7280;
        }
        
        .panel {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            transform: scale(1.3);
            cursor: pointer;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #E5E7EB;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #D1D5DB;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #EF4444, #F43F5E);
            color: white;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .notification {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .notification.success {
            background: #ECFDF5;
            border: 2px solid #10B981;
            color: #065F46;
        }
        
        .notification.error {
            background: #FEF2F2;
            border: 2px solid #EF4444;
            color: #991B1B;
        }
        
        .notification.show {
            display: block;
        }
        
        .mensajes-list {
            display: grid;
            gap: 15px;
        }
        
        .mensaje-card {
            background: #F9FAFB;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #E5E7EB;
            transition: all 0.3s;
        }
        
        .mensaje-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }
        
        .mensaje-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }
        
        .mensaje-title {
            font-size: 18px;
            font-weight: 600;
            color: #1F2937;
        }
        
        .mensaje-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-emergencia { background: #FEE2E2; color: #991B1B; }
        .badge-agradecimiento { background: #FEEFC3; color: #92400E; }
        .badge-anuncio { background: #DBEAFE; color: #1E40AF; }
        .badge-mantenimiento { background: #FEF3C7; color: #92400E; }
        
        .mensaje-stats {
            display: flex;
            gap: 20px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #E5E7EB;
            font-size: 14px;
            color: #6B7280;
        }
        
        .templates {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .template-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .template-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .template-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .template-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .template-desc {
            font-size: 14px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-paper-plane"></i> Panel de Mensajes Globales</h1>
            <p>Env√≠a mensajes de agradecimiento, alertas de emergencia y anuncios a toda la comunidad Cresalia</p>
        </div>
        
        <!-- Notificaci√≥n -->
        <div id="notification" class="notification"></div>
        
        <!-- Templates R√°pidos -->
        <div class="panel">
            <h2 style="margin-bottom: 20px; color: #374151;">‚ö° Plantillas R√°pidas</h2>
            <div class="templates">
                <div class="template-card" onclick="usarPlantilla('agradecimiento')">
                    <div class="template-icon">üíú</div>
                    <div class="template-title">Mensaje de Agradecimiento</div>
                    <div class="template-desc">Agradecer a la comunidad</div>
                </div>
                
                <div class="template-card" onclick="usarPlantilla('emergencia')">
                    <div class="template-icon">üö®</div>
                    <div class="template-title">Alerta de Emergencia</div>
                    <div class="template-desc">Notificaci√≥n urgente</div>
                </div>
                
                <div class="template-card" onclick="usarPlantilla('mantenimiento')">
                    <div class="template-icon">üîß</div>
                    <div class="template-title">Mantenimiento</div>
                    <div class="template-desc">Avisar de mantenimiento programado</div>
                </div>
                
                <div class="template-card" onclick="usarPlantilla('anuncio')">
                    <div class="template-icon">üì¢</div>
                    <div class="template-title">Anuncio Importante</div>
                    <div class="template-desc">Comunicado general</div>
                </div>
            </div>
        </div>
        
        <!-- Formulario de Env√≠o -->
        <div class="panel">
            <h2 style="margin-bottom: 20px; color: #374151;">‚úçÔ∏è Nuevo Mensaje</h2>
            
            <form id="formMensaje" onsubmit="enviarMensaje(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo de Mensaje</label>
                        <select id="tipo" required>
                            <option value="agradecimiento">üíú Agradecimiento</option>
                            <option value="emergencia">üö® Emergencia</option>
                            <option value="anuncio">üì¢ Anuncio</option>
                            <option value="mantenimiento">üîß Mantenimiento</option>
                            <option value="promocion">üéÅ Promoci√≥n</option>
                            <option value="bienvenida">üéâ Bienvenida</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Destinatarios</label>
                        <select id="destinatarios" required>
                            <option value="todos">üë• Todos los usuarios</option>
                            <option value="compradores">üõçÔ∏è Solo Compradores</option>
                            <option value="vendedores">üè™ Solo Vendedores</option>
                            <option value="emprendedores">üöÄ Solo Emprendedores</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Prioridad</label>
                        <select id="prioridad" required>
                            <option value="normal">Normal</option>
                            <option value="alta">Alta</option>
                            <option value="critica">Cr√≠tica</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Estilo Visual</label>
                        <select id="estilo" required>
                            <option value="info">‚ÑπÔ∏è Informaci√≥n</option>
                            <option value="success">‚úÖ √âxito</option>
                            <option value="warning">‚ö†Ô∏è Advertencia</option>
                            <option value="error">‚ùå Error</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>T√≠tulo del Mensaje</label>
                    <input type="text" id="titulo" placeholder="Ej: ¬°Gracias por estar aqu√≠! üíú" required>
                </div>
                
                <div class="form-group">
                    <label>Mensaje</label>
                    <textarea id="mensaje" placeholder="Escribe tu mensaje aqu√≠..." required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Icono (Emoji opcional)</label>
                        <input type="text" id="icono" placeholder="Ej: üíú">
                    </div>
                </div>
                
                <!-- Programaci√≥n de Fecha y Hora -->
                <h3 style="margin: 20px 0 10px 0; color: #374151; font-size: 16px;">‚è∞ Programaci√≥n (Opcional)</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>üìÖ Fecha de inicio (dejar vac√≠o = ahora)</label>
                        <input type="datetime-local" id="fecha_inicio">
                    </div>
                    
                    <div class="form-group">
                        <label>üìÖ Fecha de fin (dejar vac√≠o = sin l√≠mite)</label>
                        <input type="datetime-local" id="fecha_fin">
                    </div>
                </div>
                
                <div style="margin: 10px 0; padding: 12px; background: #FEF3C7; border-left: 4px solid #F59E0B; border-radius: 6px;">
                    <strong>üí° O usa atajos r√°pidos:</strong>
                    <div style="display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap;">
                        <button type="button" onclick="setDuracion(1, 'horas')" class="btn" style="padding: 6px 12px; font-size: 13px;">1 hora</button>
                        <button type="button" onclick="setDuracion(6, 'horas')" class="btn" style="padding: 6px 12px; font-size: 13px;">6 horas</button>
                        <button type="button" onclick="setDuracion(1, 'dias')" class="btn" style="padding: 6px 12px; font-size: 13px;">1 d√≠a</button>
                        <button type="button" onclick="setDuracion(3, 'dias')" class="btn" style="padding: 6px 12px; font-size: 13px;">3 d√≠as</button>
                        <button type="button" onclick="setDuracion(7, 'dias')" class="btn" style="padding: 6px 12px; font-size: 13px;">1 semana</button>
                        <button type="button" onclick="setDuracion(0, 'permanente')" class="btn" style="padding: 6px 12px; font-size: 13px;">‚ôæÔ∏è Permanente</button>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="sonido">
                            <label for="sonido" style="margin: 0;">üîä Reproducir sonido (solo emergencias)</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="persistente">
                            <label for="persistente" style="margin: 0;">üìå No cerrar autom√°ticamente</label>
                        </div>
                    </div>
                </div>
                
                <div class="actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Enviar Mensaje
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">
                        <i class="fas fa-eraser"></i> Limpiar
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Lista de Mensajes Enviados -->
        <div class="panel">
            <h2 style="margin-bottom: 20px; color: #374151;">üìã Mensajes Enviados</h2>
            <div id="listaMensajes" class="mensajes-list">
                <p style="color: #6B7280; text-align: center;">Cargando mensajes...</p>
            </div>
        </div>
    </div>
    
    <!-- Config Supabase -->
    <script src="/config-supabase-seguro.js"></script>
    
    <!-- Sistema de Mensajes -->
    <script src="/js/sistema-mensajes-globales.js"></script>
    
    <script>
        // Templates predefinidos
        const templates = {
            agradecimiento: {
                tipo: 'agradecimiento',
                titulo: '¬°Gracias por estar aqu√≠! üíú',
                mensaje: 'Queridos amigos,\n\nQuiero agradecerles de coraz√≥n por confiar en Cresalia. Cada uno de ustedes hace que esta comunidad sea especial.\n\nCon mucho cari√±o üíú',
                destinatarios: 'todos',
                prioridad: 'alta',
                estilo: 'success',
                icono: 'üíú'
            },
            emergencia: {
                tipo: 'emergencia',
                titulo: 'üö® Alerta de Emergencia',
                mensaje: 'Se ha reportado una emergencia. Por favor, mantente seguro y sigue las indicaciones de las autoridades locales.',
                destinatarios: 'todos',
                prioridad: 'critica',
                estilo: 'error',
                icono: 'üö®',
                sonido: true,
                persistente: true
            },
            mantenimiento: {
                tipo: 'mantenimiento',
                titulo: 'Mantenimiento Programado üîß',
                mensaje: 'Realizaremos mantenimiento del sistema pr√≥ximamente. Algunas funciones pueden no estar disponibles temporalmente. Gracias por tu paciencia.',
                destinatarios: 'todos',
                prioridad: 'normal',
                estilo: 'warning',
                icono: 'üîß',
                duracion: 2
            },
            anuncio: {
                tipo: 'anuncio',
                titulo: 'üì¢ Anuncio Importante',
                mensaje: 'Tenemos novedades importantes para compartir con la comunidad Cresalia.',
                destinatarios: 'todos',
                prioridad: 'normal',
                estilo: 'info',
                icono: 'üì¢'
            }
        };
        
        function usarPlantilla(tipo) {
            const template = templates[tipo];
            if (!template) return;
            
            document.getElementById('tipo').value = template.tipo;
            document.getElementById('titulo').value = template.titulo;
            document.getElementById('mensaje').value = template.mensaje;
            document.getElementById('destinatarios').value = template.destinatarios;
            document.getElementById('prioridad').value = template.prioridad;
            document.getElementById('estilo').value = template.estilo;
            document.getElementById('icono').value = template.icono || '';
            document.getElementById('sonido').checked = template.sonido || false;
            document.getElementById('persistente').checked = template.persistente || false;
            
            // Si tiene duraci√≥n en la plantilla, configurarla
            if (template.duracion) {
                setDuracion(template.duracion, 'dias');
            }
            
            // Scroll al formulario
            document.getElementById('formMensaje').scrollIntoView({ behavior: 'smooth' });
            
            mostrarNotificacion('Plantilla cargada! Puedes editarla antes de enviar.', 'success');
        }
        
        function setDuracion(cantidad, unidad) {
            const ahora = new Date();
            let fechaFin;
            
            if (unidad === 'permanente') {
                // Sin fecha de fin
                document.getElementById('fecha_inicio').value = '';
                document.getElementById('fecha_fin').value = '';
                mostrarNotificacion('‚úÖ Mensaje permanente (sin fecha de fin)', 'success');
                return;
            } else if (unidad === 'horas') {
                fechaFin = new Date(ahora.getTime() + cantidad * 60 * 60 * 1000);
            } else if (unidad === 'dias') {
                fechaFin = new Date(ahora.getTime() + cantidad * 24 * 60 * 60 * 1000);
            }
            
            // Formatear para datetime-local (YYYY-MM-DDTHH:MM)
            const formatearFecha = (fecha) => {
                const year = fecha.getFullYear();
                const month = String(fecha.getMonth() + 1).padStart(2, '0');
                const day = String(fecha.getDate()).padStart(2, '0');
                const hours = String(fecha.getHours()).padStart(2, '0');
                const minutes = String(fecha.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            };
            
            document.getElementById('fecha_inicio').value = ''; // Ahora
            document.getElementById('fecha_fin').value = formatearFecha(fechaFin);
            
            mostrarNotificacion(`‚úÖ Duracion configurada: ${cantidad} ${unidad}`, 'success');
        }
        
        async function enviarMensaje(event) {
            event.preventDefault();
            
            // Obtener fechas configuradas
            const fechaInicioInput = document.getElementById('fecha_inicio').value;
            const fechaFinInput = document.getElementById('fecha_fin').value;
            
            const fechaInicio = fechaInicioInput ? new Date(fechaInicioInput).toISOString() : null;
            const fechaFin = fechaFinInput ? new Date(fechaFinInput).toISOString() : null;
            
            const datos = {
                tipo: document.getElementById('tipo').value,
                titulo: document.getElementById('titulo').value,
                mensaje: document.getElementById('mensaje').value,
                destinatarios: document.getElementById('destinatarios').value,
                prioridad: document.getElementById('prioridad').value,
                estilo: document.getElementById('estilo').value,
                icono: document.getElementById('icono').value,
                sonido: document.getElementById('sonido').checked,
                persistente: document.getElementById('persistente').checked,
                fecha_inicio: fechaInicio,
                fecha_fin: fechaFin
            };
            
            mostrarNotificacion('Enviando mensaje...', 'success');
            
            const resultado = await panelMensajesAdmin.enviarMensaje(datos);
            
            if (resultado.success) {
                mostrarNotificacion('‚úÖ ¬°Mensaje enviado correctamente a toda la comunidad!', 'success');
                limpiarFormulario();
                cargarMensajes();
            } else {
                mostrarNotificacion('‚ùå Error: ' + resultado.error, 'error');
            }
        }
        
        function limpiarFormulario() {
            document.getElementById('formMensaje').reset();
            document.getElementById('fecha_inicio').value = '';
            document.getElementById('fecha_fin').value = '';
        }
        
        function mostrarNotificacion(mensaje, tipo) {
            const notif = document.getElementById('notification');
            notif.textContent = mensaje;
            notif.className = `notification ${tipo} show`;
            
            setTimeout(() => {
                notif.classList.remove('show');
            }, 5000);
        }
        
        async function cargarMensajes() {
            const lista = document.getElementById('listaMensajes');
            lista.innerHTML = '<p style="color: #6B7280; text-align: center;">Cargando mensajes...</p>';
            
            const resultado = await panelMensajesAdmin.obtenerTodosMensajes();
            
            if (resultado.success && resultado.data.length > 0) {
                lista.innerHTML = resultado.data.map(msg => `
                    <div class="mensaje-card">
                        <div class="mensaje-header">
                            <div>
                                <div class="mensaje-title">${msg.icono || ''} ${msg.titulo}</div>
                                <span class="mensaje-badge badge-${msg.tipo}">${msg.tipo}</span>
                            </div>
                            <button class="btn btn-danger" onclick="desactivarMensaje('${msg.id}')" ${!msg.activo ? 'disabled' : ''}>
                                <i class="fas fa-power-off"></i> ${msg.activo ? 'Desactivar' : 'Inactivo'}
                            </button>
                        </div>
                        <p style="color: #6B7280; margin: 10px 0;">${msg.mensaje}</p>
                        <div class="mensaje-stats">
                            <span><i class="fas fa-users"></i> ${msg.destinatarios}</span>
                            <span><i class="fas fa-flag"></i> ${msg.prioridad}</span>
                            <span><i class="fas fa-eye"></i> ${msg.total_lecturas || 0} lecturas</span>
                            <span><i class="fas fa-clock"></i> ${new Date(msg.creado_en).toLocaleString('es')}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                lista.innerHTML = '<p style="color: #6B7280; text-align: center;">No hay mensajes todav√≠a.</p>';
            }
        }
        
        async function desactivarMensaje(id) {
            if (!confirm('¬øDesactivar este mensaje?')) return;
            
            const resultado = await panelMensajesAdmin.desactivarMensaje(id);
            
            if (resultado.success) {
                mostrarNotificacion('‚úÖ Mensaje desactivado', 'success');
                cargarMensajes();
            } else {
                mostrarNotificacion('‚ùå Error: ' + resultado.error, 'error');
            }
        }
        
        // Cargar mensajes al inicio
        setTimeout(cargarMensajes, 1000);
    </script>
</body>
</html>
