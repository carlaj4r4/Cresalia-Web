<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cresalia - Panel de Administraci贸n</title>
    
    <!-- Meta Security -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' cdnjs.cloudflare.com cdn.jsdelivr.net sdk.mercadopago.com https:; script-src-elem 'self' 'unsafe-inline' cdnjs.cloudflare.com cdn.jsdelivr.net sdk.mercadopago.com https:; style-src 'self' 'unsafe-inline' fonts.googleapis.com cdnjs.cloudflare.com cdn.jsdelivr.net https: file:; style-src-elem 'self' 'unsafe-inline' fonts.googleapis.com cdnjs.cloudflare.com cdn.jsdelivr.net https: file:; font-src 'self' fonts.gstatic.com cdnjs.cloudflare.com https: file:; img-src 'self' data: https: file: blob:; connect-src 'self' https: api.mercadopago.com; frame-src 'self' https: file:; object-src 'none'; base-uri 'self'; form-action 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="../../assets/logo/logo-cresalia.png">
    <link rel="icon" type="image/png" href="../../assets/logo/logo-cresalia.png">
    <link rel="shortcut icon" href="../../assets/logo/logo-cresalia.png">
    <link rel="apple-touch-icon" href="../../assets/logo/logo-cresalia.png">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Sistema de Emails Autom谩ticos Cresalia -->
    <script src="../../js/sistema-emails-automaticos.js"></script>
    
    <!-- Sistema de Notificaciones Push -->
    <script src="../../js/sistema-notificaciones-push.js"></script>
    
    <script src="../../js/configuracion-notificaciones-panel.js"></script>
    <script src="../../js/inyectar-tab-notificaciones.js"></script>
    
    <!-- CSS Principal de Cresalia -->
    <link rel="stylesheet" href="../../styles-cresalia.css?v=2.0">
    <link rel="stylesheet" href="../../styles-admin-cresalia.css?v=2.0">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Mercado Pago SDK -->
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    
    <style>
        /* ESTILOS CRTICOS INMEDIATOS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: block;
            visibility: visible;
            opacity: 1;
        }
        
        .admin-container {
            display: flex;
            min-height: 100vh;
            visibility: visible;
            opacity: 1;
        }
        
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid #E5E7EB;
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            display: block;
            visibility: visible;
            opacity: 1;
        }
        
        .main-content {
            flex: 1;
            padding: 2rem;
            margin-left: 280px;
            display: block;
            visibility: visible;
            opacity: 1;
        }
        
        .nav-menu {
            list-style: none;
            padding: 0 1rem;
        }
        
        .nav-item {
            margin-bottom: 0.5rem;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: #374151;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .nav-link:hover,
        .nav-link.active {
            background: #F3F4F6;
            color: #8B5CF6;
        }
        
        .nav-link i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #E5E7EB;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #8B5CF6, #A78BFA);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary {
            background: #F3F4F6;
            color: #374151;
            border: 1px solid #D1D5DB;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #8B5CF6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .table th {
            background: #F9FAFB;
            font-weight: 600;
            color: #374151;
        }
        
        .table tbody tr:hover {
            background: #F9FAFB;
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-success {
            background: #10B981;
            color: white;
        }
        
        .badge-warning {
            background: #F59E0B;
            color: white;
        }
        
        .badge-danger {
            background: #EF4444;
            color: white;
        }
        
        .badge-info {
            background: #3B82F6;
            color: white;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid transparent;
        }
        
        .alert-success {
            background: #D1FAE5;
            color: #065F46;
            border-color: #A7F3D0;
        }
        
        .alert-warning {
            background: #FEF3C7;
            color: #92400E;
            border-color: #FDE68A;
        }
        
        .alert-danger {
            background: #FEE2E2;
            color: #991B1B;
            border-color: #FECACA;
        }
        
        .alert-info {
            background: #DBEAFE;
            color: #1E40AF;
            border-color: #93C5FD;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999999;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: .5rem;
        }
        .modal-header-accent {
            margin: -2rem -2rem 1.25rem;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        .modal-actions {
            display: flex;
            gap: .75rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }
        .form-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1rem;
        }
        @media (max-width: 768px) {
            .form-grid-2 { grid-template-columns: 1fr; }
            
            /* Widget de perfil tienda responsive */
            .widget-perfil-tienda > div {
                flex-direction: column;
                text-align: center;
            }
            
            .widget-perfil-tienda > div > div:last-child {
                width: 100%;
                justify-content: center;
            }
            
            .widget-perfil-tienda > div > div:last-child button {
                flex: 1;
                min-width: 120px;
            }
            
            /* Bot贸n Ir al Inicio responsive */
            .nav-text-inicio {
                display: none; /* Solo icono en m贸vil */
            }
        }

        /* Ajustes extra para bienestar en pantallas peque帽as */
        @media (max-width: 768px) {
            #modalBienestar .modal-content {
                max-width: 100%;
                width: 95%;
                padding: 1rem;
            }
        }
        
        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6B7280;
        }
        
        .close-btn:hover {
            color: #374151;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 2rem;
            padding: 0 1rem;
        }
        
        .logo h1 {
            color: #8B5CF6;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .widget-bienestar {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, #8B5CF6, #A78BFA);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 300px;
        }
        
        .widget-bienestar h3 {
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        .widget-bienestar p {
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        
        .widget-bienestar .btn {
            width: 100%;
            justify-content: center;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #E5E7EB;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }
        
        .stat-icon.primary {
            background: linear-gradient(135deg, #8B5CF6, #A78BFA);
        }
        
        .stat-icon.success {
            background: linear-gradient(135deg, #10B981, #059669);
        }
        
        .stat-icon.warning {
            background: linear-gradient(135deg, #F59E0B, #D97706);
        }
        
        .stat-icon.info {
            background: linear-gradient(135deg, #3B82F6, #1D4ED8);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1F2937;
        }
        
        .stat-label {
            color: #6B7280;
            font-size: 0.875rem;
        }
        
        .content-header {
            margin-bottom: 2rem;
        }
        
        .content-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 0.5rem;
        }
        
        .content-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 0.5rem;
        }
        
        .content-header p {
            color: #6B7280;
            font-size: 1rem;
        }
        
        .welcome-message {
            background: linear-gradient(135deg, #F3F4F6, #E5E7EB);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .welcome-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .welcome-message h3 {
            color: #1F2937;
            margin-bottom: 1rem;
        }
        
        .welcome-message p {
            color: #6B7280;
            max-width: 600px;
            margin: 0 auto;
        }

        .celebracion-banner {
            border-radius: 18px;
            padding: 28px;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            color: #FFFFFF;
            box-shadow: 0 20px 35px rgba(15, 23, 42, 0.25);
            display: none;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .celebracion-banner::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.28), transparent 60%);
            pointer-events: none;
        }

        .celebracion-banner:hover {
            transform: translateY(-3px);
            box-shadow: 0 25px 45px rgba(15, 23, 42, 0.28);
        }

        .celebracion-header {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            position: relative;
            z-index: 2;
        }

        .celebracion-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0.9rem;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.18);
            backdrop-filter: blur(6px);
            font-weight: 600;
            letter-spacing: 0.01em;
            font-size: 0.9rem;
            align-self: flex-start;
        }

        .celebracion-banner h2 {
            font-size: 1.9rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 10px rgba(15, 23, 42, 0.25);
        }

        .celebracion-banner p {
            margin: 0;
            font-size: 1.05rem;
            opacity: 0.92;
        }

        .celebracion-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
            position: relative;
            z-index: 2;
        }

        .celebracion-actions button {
            border: none;
            border-radius: 999px;
            padding: 0.65rem 1.3rem;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .celebracion-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 22px rgba(15, 23, 42, 0.2);
        }

        .celebracion-actions button.secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #FFFFFF;
        }

        .celebracion-actions button.link {
            background: transparent;
            color: rgba(255, 255, 255, 0.85);
            text-decoration: underline;
            padding: 0.4rem 0;
        }

        .celebracion-metricas {
            margin-top: 1.4rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            position: relative;
            z-index: 2;
        }

        .celebracion-metrica-card {
            background: rgba(255, 255, 255, 0.18);
            padding: 1rem;
            border-radius: 14px;
            backdrop-filter: blur(6px);
        }

        .celebracion-metrica-card span {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            line-height: 1.1;
        }

        .celebracion-metrica-card small {
            display: block;
            opacity: 0.8;
            font-size: 0.85rem;
            margin-top: 0.35rem;
        }

        .celebracion-banner .celebracion-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.25);
            border: none;
            color: inherit;
            border-radius: 999px;
            width: 34px;
            height: 34px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .celebracion-banner .celebracion-close:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        @media (max-width: 768px) {
            .celebracion-banner {
                padding: 20px;
            }

            .celebracion-banner h2 {
                font-size: 1.6rem;
            }

            .celebracion-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .celebracion-actions button {
                width: 100%;
                justify-content: center;
            }
        }
        
        .section-header {
            margin-bottom: 1.5rem;
        }
        
        .section-header h3 {
            color: #1F2937;
            margin-bottom: 0.5rem;
        }
        
        .section-header p {
            color: #6B7280;
        }
        
        .ventas-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .venta-item {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .venta-info h4 {
            color: #1F2937;
            margin-bottom: 0.25rem;
        }
        
        .venta-info p {
            color: #6B7280;
            font-size: 0.875rem;
        }
        
        .venta-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-5 { margin-bottom: 1.25rem; }
        
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-5 { margin-top: 1.25rem; }
        
        .p-1 { padding: 0.25rem; }
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-5 { padding: 1.25rem; }
        
        .d-flex { display: flex; }
        .d-block { display: block; }
        .d-none { display: none; }
        
        .justify-content-center { justify-content: center; }
        .justify-content-between { justify-content: space-between; }
        .align-items-center { align-items: center; }
        
        .w-100 { width: 100%; }
        .h-100 { height: 100%; }
        
        .fs-1 { font-size: 2.5rem; }
        .fs-2 { font-size: 2rem; }
        .fs-3 { font-size: 1.75rem; }
        .fs-4 { font-size: 1.5rem; }
        .fs-5 { font-size: 1.25rem; }
        .fs-6 { font-size: 1rem; }
        
        .fw-bold { font-weight: 700; }
        .fw-semibold { font-weight: 600; }
        .fw-normal { font-weight: 400; }
        .fw-light { font-weight: 300; }
        
        .text-primary { color: #8B5CF6; }
        .text-secondary { color: #6B7280; }
        .text-success { color: #10B981; }
        .text-warning { color: #F59E0B; }
        .text-danger { color: #EF4444; }
        .text-info { color: #3B82F6; }
        .text-muted { color: #9CA3AF; }
        
        .bg-primary { background-color: #8B5CF6; }
        .bg-secondary { background-color: #F3F4F6; }
        .bg-success { background-color: #10B981; }
        .bg-warning { background-color: #F59E0B; }
        .bg-danger { background-color: #EF4444; }
        .bg-info { background-color: #3B82F6; }
        .bg-light { background-color: #F9FAFB; }
        .bg-white { background-color: #FFFFFF; }
        
        .border { border: 1px solid #D1D5DB; }
        .border-0 { border: none; }
        .rounded { border-radius: 8px; }
        .rounded-lg { border-radius: 12px; }
        .rounded-xl { border-radius: 16px; }
        .rounded-circle { border-radius: 50%; }
        
        .shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
        .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .shadow-none { box-shadow: none; }
        
        /* Menu Toggle Button */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: #667eea;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .menu-toggle:hover {
            background: #5a67d8;
        }
        
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        .sidebar-overlay.show {
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 280px;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }
            
            .menu-toggle {
                display: block;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .modal-content {
                width: 95%;
                max-width: 500px;
                margin: 1rem;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: fixed;
                z-index: 1000;
                height: 100vh;
                overflow-y: auto;
            }
            
            .main-content {
                margin-left: 0;
                padding: 0.5rem;
            }
            
            .widget-bienestar {
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 999;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .card {
                margin-bottom: 1rem;
            }
            
            .modal-content {
                width: 95%;
                max-width: 400px;
                margin: 0.5rem;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .nav-link {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
            
            .nav-link i {
                margin-right: 0.5rem;
            }
            
            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            
            .form-control {
                font-size: 0.9rem;
                padding: 0.5rem;
            }
            
            .table-responsive {
                font-size: 0.8rem;
            }
            
            .d-flex {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .d-flex.justify-content-end {
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .main-content {
                padding: 0.25rem;
            }
            
            .card {
                padding: 1rem;
            }
            
            .modal-content {
                width: 98%;
                margin: 0.25rem;
                padding: 1rem;
            }
            
            .stats-grid {
                gap: 0.25rem;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .nav-link {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            
            .btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideOutDown {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(30px);
            }
        }
        
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <!-- rea de Alertas de Emergencia Global -->
    <div id="alertas-emergencia-comunidades"></div>
    
    <div class="admin-container">
        <button class="menu-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        <div class="sidebar-overlay" onclick="closeSidebar()"></div>
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h1 id="logo-text"> Cresalia</h1>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="/index-cresalia.html" class="nav-link" style="background: linear-gradient(135deg, #7C3AED, #EC4899); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: transform 0.3s; white-space: nowrap;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fas fa-home"></i>
                            <span class="nav-text-inicio">Ir al Inicio</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link active" onclick="mostrarSeccion('dashboard')">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="mostrarSeccion('productos')">
                            <i class="fas fa-box"></i>
                            <span>Productos</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="mostrarSeccion('servicios')">
                            <i class="fas fa-concierge-bell"></i>
                            <span>Servicios</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="mostrarSeccion('turnos')">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Turnos</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="mostrarSeccion('analytics')">
                            <i class="fas fa-chart-line"></i>
                            <span>Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="mostrarSeccion('feedbacks')">
                            <i class="fas fa-comments"></i>
                            <span>Feedbacks</span>
                        </a>
                    </li>
                    <li class="nav-item" id="navItemBienestar" style="display: none;">
                        <a href="#" class="nav-link" onclick="mostrarSistemaBienestar()">
                            <i class="fas fa-heart"></i>
                            <span>Bienestar Emocional</span>
                            <small style="display: block; font-size: 0.7rem; opacity: 0.8;"> Solo FREE y BASIC</small>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="mostrarSeccion('comunidad')">
                            <i class="fas fa-users"></i>
                            <span>Comunidad de Vendedores</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="mostrarSeccion('suscripciones')">
                            <i class="fas fa-credit-card"></i>
                            <span>Suscripciones</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="abrirConfiguracionAgradecimiento()">
                            <i class="fas fa-heart"></i>
                            <span>Agradecimientos</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="abrirConfiguracionMediosPago()">
                            <i class="fas fa-credit-card"></i>
                            <span>Medios de Pago</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="abrirGestionFeedbacksTienda()">
                            <i class="fas fa-comments"></i>
                            <span>Feedbacks Tienda</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="abrirGestionPuntosComunes()">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>Puntos Comunes</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="abrirConfiguracionEnviosDomicilio()">
                            <i class="fas fa-truck"></i>
                            <span>Env铆os Domicilio</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="abrirHistorialVentasTurnos()">
                            <i class="fas fa-chart-bar"></i>
                            <span>Historial</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="mostrarSeccion('historias-corazon')">
                            <i class="fas fa-heart"></i>
                            <span>Mi Historia</span>
                            <small style="display: block; font-size: 0.7rem; opacity: 0.8;"> Comparte tu historia</small>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="abrirHistorialSesiones()">
                            <i class="fas fa-shield-alt"></i>
                            <span>Sesiones</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="abrirConfiguracionGarantiasDevoluciones()">
                            <i class="fas fa-shield-alt"></i>
                            <span>Garant铆as</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="abrirConfiguracionTiendaCompleta()">
                            <i class="fas fa-cog"></i>
                            <span>Configuraci贸n</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="abrirConfiguracionRemiseria()">
                            <i class="fas fa-car"></i>
                            <span>Remiser铆a</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="abrirGestionBackup()">
                            <i class="fas fa-database"></i>
                            <span>Backup</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="abrirGestionOfertasCombos()">
                            <i class="fas fa-tags"></i>
                            <span>Ofertas y Combos</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="abrirMensajeriaCrisla()">
                            <i class="fas fa-comments"></i>
                            <span>Mensajer铆a Crisla</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="abrirGestionSoporte()">
                            <i class="fas fa-headset"></i>
                            <span>Sistema de Soporte</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="abrirGestionUbicaciones()">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>Ubicaciones</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="abrirEditorVisualBots()">
                            <i class="fas fa-robot"></i>
                            <span>Editor Visual de Bots</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="mostrarSeccion('configuracion-celebraciones')">
                            <i class="fas fa-birthday-cake"></i>
                            <span>Configuraci贸n de Celebraciones</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="abrirGestionRemiseriaCompleta()">
                            <i class="fas fa-car"></i>
                            <span>Remiser铆a Completa</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="abrirGestionCalendariosServicios()">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Calendarios de Servicios</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="abrirHistorialPagos()">
                            <i class="fas fa-credit-card"></i>
                            <span>Historial de Pagos</span>
                        </a>
                    </li>
                    
                    <!-- Bot贸n de Logout -->
                    <li class="nav-item" style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                        <a href="#" class="nav-link" onclick="cerrarSesionSegura()" style="color: #fca5a5; transition: all 0.3s;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#fca5a5'">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Cerrar Sesi贸n</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <div class="content-header">
                    <h1>Dashboard</h1>
                    <p>Bienvenido a tu panel de administraci贸n</p>
                </div>

                <div id="celebracionBanner" class="celebracion-banner" style="display:none;"></div>
                
                <!-- Widget de Perfil con Avatar/Logo -->
                <div id="widget-perfil-tienda" class="widget-perfil-tienda" style="background: linear-gradient(135deg, #7C3AED, #EC4899); border-radius: 16px; padding: 24px; margin-bottom: 24px; color: white; display: none;">
                    <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                        <div class="avatar-container" style="position: relative;">
                            <img id="avatar-tienda" src="" alt="Logo/Avatar" style="width: 100px; height: 100px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.3); object-fit: cover; background: rgba(255,255,255,0.2); cursor: pointer;" onclick="document.getElementById('input-avatar-tienda').click()">
                            <label for="input-avatar-tienda" style="position: absolute; bottom: 0; right: 0; background: rgba(255,255,255,0.9); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                <i class="fas fa-camera" style="color: #7C3AED; font-size: 14px;"></i>
                            </label>
                            <input type="file" id="input-avatar-tienda" accept="image/*" style="display: none;" onchange="cambiarAvatarTienda(event)">
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <h3 id="nombre-tienda-widget" style="margin: 0 0 8px 0; font-size: 24px; font-weight: 600;">Mi Tienda</h3>
                            <p id="email-tienda-widget" style="margin: 0; opacity: 0.9; font-size: 14px;">email@ejemplo.com</p>
                            <p id="plan-tienda-widget" style="margin: 8px 0 0; opacity: 0.8; font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px; display: inline-block;">Plan: FREE</p>
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button onclick="mostrarSeccion('productos')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                <i class="fas fa-box"></i> Productos
                            </button>
                            <button onclick="mostrarSeccion('servicios')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                <i class="fas fa-concierge-bell"></i> Servicios
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon primary">
                            <i class="fas fa-box"></i>
                        </div>
                        <div>
                            <div class="stat-value" id="totalProductos">0</div>
                            <div class="stat-label">Productos Activos</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-concierge-bell"></i>
                        </div>
                        <div>
                            <div class="stat-value" id="totalServicios">0</div>
                            <div class="stat-label">Servicios Disponibles</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div>
                            <div class="stat-value" id="ventasPendientes">0</div>
                            <div class="stat-label">Ventas Pendientes</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon info">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div>
                            <div class="stat-value" id="ventasConfirmadas">0</div>
                            <div class="stat-label">Ventas Confirmadas</div>
                        </div>
                    </div>
                </div>
                
                <!-- Secci贸n de Ventas Pendientes -->
                <div class="dashboard-section">
                    <div class="section-header">
                        <h3> Confirmar Pagos</h3>
                        <p>Marca los pagos como confirmados y env铆a agradecimientos</p>
                    </div>
                    
                    <div id="ventasPendientesList" class="ventas-list">
                        <!-- Las ventas pendientes se cargar谩n aqu铆 -->
                    </div>
                </div>
                
                <!-- Mensaje de Bienvenida -->
                <div class="welcome-message">
                    <div class="welcome-icon"></div>
                    <h3>隆Bienvenido a Cresalia!</h3>
                    <p>Tu plataforma de confianza para el comercio digital. Aqu铆 puedes gestionar todos los aspectos de tu tienda de manera respetuosa y profesional.</p>
                </div>
                
                <div class="content-header">
                    <h2>Acciones R谩pidas</h2>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="mostrarFormularioProducto()">
                            <i class="fas fa-plus"></i>
                            Agregar Producto
                        </button>
                        <button class="btn btn-success" onclick="mostrarFormularioServicio()">
                            <i class="fas fa-plus"></i>
                            Agregar Servicio
                        </button>
                        <button class="btn btn-primary" onclick="abrirSistemaTurnos()">
                            <i class="fas fa-calendar-plus"></i>
                            Nuevo Turno
                        </button>
                        <button class="btn btn-info" onclick="mostrarSeccion('analytics')">
                            <i class="fas fa-chart-line"></i>
                            Ver Analytics
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Productos Section -->
            <div id="productos" class="content-section">
                <div class="content-header">
                    <h1>Gesti贸n de Productos</h1>
                    <p>Administra tu cat谩logo de productos</p>
                </div>
                <div class="card">
                    <button class="btn btn-primary" onclick="abrirGestionProductos()">
                        <i class="fas fa-box"></i> Gestionar Productos
                    </button>
                    <p style="margin-top: 1rem; color: #6B7280;">Haz click para abrir el sistema completo de gesti贸n de productos.</p>
                </div>
            </div>
            
            <!-- Servicios Section -->
            <div id="servicios" class="content-section">
                <div class="content-header">
                    <h1>Gesti贸n de Servicios</h1>
                    <p>Administra los servicios de tu tienda</p>
                </div>
                <div class="card">
                    <button class="btn btn-primary" onclick="abrirGestionServicios()">
                        <i class="fas fa-concierge-bell"></i> Gestionar Servicios
                    </button>
                    <p style="margin-top: 1rem; color: #6B7280;">Haz click para abrir el sistema completo de gesti贸n de servicios.</p>
                </div>
            </div>
            
            <!-- Turnos Section -->
            <div id="turnos" class="content-section">
                <div class="content-header">
                    <h1>Sistema de Turnos</h1>
                    <p>Gestiona las citas y turnos de tus clientes</p>
                </div>
                <div class="card">
                    <button class="btn btn-primary" onclick="abrirSistemaTurnos()">
                        <i class="fas fa-calendar-alt"></i> Abrir Sistema de Turnos
                    </button>
                    <p style="margin-top: 1rem; color: #6B7280;">Haz click para abrir el sistema completo de gesti贸n de turnos.</p>
                </div>
            </div>
            
            <!-- Analytics Section -->
            <div id="analytics" class="content-section">
                <div class="content-header">
                    <h1>Analytics</h1>
                    <p>M茅tricas y estad铆sticas de tu tienda</p>
                </div>
                <div class="card">
                    <button class="btn btn-primary" onclick="abrirAnalyticsAvanzado()">
                        <i class="fas fa-chart-line"></i> Ver Analytics Avanzado
                    </button>
                    <p style="margin-top: 1rem; color: #6B7280;">Haz click para abrir el sistema completo de an谩lisis de tu tienda.</p>
                </div>
            </div>
            
            <!-- Feedbacks Section -->
            <div id="feedbacks" class="content-section">
                <div class="content-header">
                    <h1>Feedbacks</h1>
                    <p>Opiniones y comentarios de tus clientes</p>
                </div>
                <div class="card">
                    <button class="btn btn-primary" onclick="abrirGestionFeedbacksTienda()">
                        <i class="fas fa-comments"></i> Gestionar Feedbacks
                    </button>
                    <p style="margin-top: 1rem; color: #6B7280;">Haz click para abrir el sistema completo de feedbacks de tu tienda.</p>
                </div>
            </div>
            
            <!-- Secci贸n: Mi Historia con Coraz贸n -->
            <div id="historias-corazon" class="content-section">
                <div id="seccion-historias-corazon">
                    <!-- El contenido se carga din谩micamente -->
                </div>
            </div>
            
            <!-- Comunidad de Vendedores Section -->
            <div id="comunidad" class="content-section">
                <div class="content-header">
                    <h1>Comunidad de Vendedores</h1>
                    <p>Conecta con la comunidad directamente desde tu panel</p>
                </div>
                <div class="card" style="text-align: center; padding: 60px 40px;">
                    <div style="max-width: 600px; margin: 0 auto;">
                        <div style="font-size: 4rem; margin-bottom: 20px;"></div>
                        <h2 style="color: #1F2937; margin-bottom: 15px;">Comunidad de Vendedores Cresalia</h2>
                        <p style="color: #6B7280; margin-bottom: 30px; font-size: 1.1rem;">
                            Espacio seguro para protegernos y crecer juntos. Comparte experiencias, aprende de otros emprendedores y encuentra apoyo cuando lo necesites.
                        </p>
                        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="abrirComunidadVendedores()" class="btn btn-primary" style="padding: 15px 30px; font-size: 1.1rem;">
                                <i class="fas fa-users"></i> Abrir Comunidad
                            </button>
                            <a href="../../panel-comunidad-vendedores.html" target="_blank" class="btn btn-secondary" style="padding: 15px 30px; font-size: 1.1rem; text-decoration: none; display: inline-block;">
                                <i class="fas fa-external-link-alt"></i> Abrir en Nueva Pesta帽a
                            </a>
                        </div>
                        <div style="margin-top: 40px; padding: 20px; background: #F3F4F6; border-radius: 12px;">
                            <h3 style="color: #374151; margin-bottom: 15px; font-size: 1.2rem;"> 驴Qu茅 encontrar谩s?</h3>
                            <ul style="text-align: left; color: #6B7280; list-style: none; padding: 0;">
                                <li style="margin-bottom: 10px;"><i class="fas fa-check-circle" style="color: #10B981; margin-right: 10px;"></i> Sistema de Mentor铆a Autom谩tica</li>
                                <li style="margin-bottom: 10px;"><i class="fas fa-check-circle" style="color: #10B981; margin-right: 10px;"></i> Compartir experiencias y consejos</li>
                                <li style="margin-bottom: 10px;"><i class="fas fa-check-circle" style="color: #10B981; margin-right: 10px;"></i> Soporte entre vendedores</li>
                                <li style="margin-bottom: 10px;"><i class="fas fa-check-circle" style="color: #10B981; margin-right: 10px;"></i> Reportar compradores deshonestos</li>
                                <li style="margin-bottom: 10px;"><i class="fas fa-check-circle" style="color: #10B981; margin-right: 10px;"></i> Espacio seguro y privado</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Configuraci贸n de Celebraciones Section -->
            <div id="configuracion-celebraciones" class="content-section">
                <!-- El contenido se cargar谩 din谩micamente desde configuracion-celebracion-panel.js -->
            </div>

            <!-- Productos Section -->
            <div id="productos" class="content-section">
                <div class="content-header">
                    <h1>Gesti贸n de Productos</h1>
                    <p>Administra tu cat谩logo de productos</p>
                </div>
                
                <div class="card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3>Productos de tu tienda</h3>
                        <button class="btn btn-primary" onclick="mostrarFormularioProducto()">
                            <i class="fas fa-plus"></i> Agregar Producto
                        </button>
                    </div>
                    
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaProductos">
                            <tr>
                                <td>Producto de Prueba 1</td>
                                <td>$50.00</td>
                                <td>10</td>
                                <td><span class="badge badge-success">Activo</span></td>
                                <td>
                                    <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Editar</button>
                                    <button class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Eliminar</button>
                                </td>
                            </tr>
                            <tr>
                                <td>Producto de Prueba 2</td>
                                <td>$75.00</td>
                                <td>5</td>
                                <td><span class="badge badge-warning">Pendiente</span></td>
                                <td>
                                    <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Editar</button>
                                    <button class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Eliminar</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Servicios Section -->
            <div id="servicios" class="content-section">
                <div class="content-header">
                    <h1>Gesti贸n de Servicios</h1>
                    <p>Administra los servicios que ofreces</p>
                </div>
                
                <div class="card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3>Servicios disponibles</h3>
                        <button class="btn btn-primary" onclick="mostrarFormularioServicio()">
                            <i class="fas fa-plus"></i> Agregar Servicio
                        </button>
                    </div>
                    
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Servicio</th>
                                <th>Precio</th>
                                <th>Duraci贸n</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaServicios">
                            <tr>
                                <td>Servicio de Consultor铆a</td>
                                <td>$100.00</td>
                                <td>1 hora</td>
                                <td><span class="badge badge-success">Activo</span></td>
                                <td>
                                    <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Editar</button>
                                    <button class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Eliminar</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Turnos Section -->
            <div id="turnos" class="content-section">
                <div class="content-header">
                    <h1>Sistema de Turnos</h1>
                    <p>Gestiona las citas y turnos de tus clientes</p>
                </div>
                
                <div class="card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3>Turnos programados</h3>
                <button class="btn btn-primary" onclick="abrirSistemaTurnos()">
                            <i class="fas fa-plus"></i> Agregar Turno
                        </button>
                    </div>
                    
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Servicio</th>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaTurnos">
                            <tr>
                                <td>-</td>
                                <td>Consultor铆a</td>
                                <td>30/10/2025</td>
                                <td>10:00</td>
                                <td><span class="badge badge-success">Confirmado</span></td>
                                <td>
                                    <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Editar</button>
                                    <button class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Cancelar</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Analytics Section -->
            <div id="analytics" class="content-section">
                <div class="content-header">
                    <h1>Analytics y Reportes</h1>
                    <p>Analiza el rendimiento de tu tienda</p>
                </div>
                
                <div class="card">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon primary">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div>
                                <div class="stat-value" id="metricVisitas">1,234</div>
                                <div class="stat-label">Visitas</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon success">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div>
                                <div class="stat-value" id="metricVentas">56</div>
                                <div class="stat-label">Ventas</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon warning">
                                <i class="fas fa-box"></i>
                            </div>
                            <div>
                                <div class="stat-value" id="metricProductos">12</div>
                                <div class="stat-label">Productos</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon info">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div>
                                <div class="stat-value" id="metricIngresos">$2,450</div>
                                <div class="stat-label">Ingresos</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Feedbacks Section -->
            <div id="feedbacks" class="content-section">
                <div class="content-header">
                    <h1>Gesti贸n de Feedbacks</h1>
                    <p>Administra los comentarios y rese帽as de tus clientes</p>
                </div>
                
                <div class="card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3>Comentarios de clientes</h3>
                        <button class="btn btn-primary" onclick="abrirGestionFeedbacksTienda()">
                            <i class="fas fa-plus"></i> Agregar Feedback
                        </button>
                    </div>
                    
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Comentario</th>
                                <th>Calificaci贸n</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaFeedbacks">
                            <tr>
                                <td>Cliente Satisfecho</td>
                                <td>Excelente servicio, muy recomendado</td>
                                <td><span class="badge badge-success">5 猸</span></td>
                                <td>29/10/2025</td>
                                <td>
                                    <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="abrirResponderFeedback('Cliente Satisfecho','Excelente servicio, muy recomendado')">Responder</button>
                                    <button class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Eliminar</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Suscripciones Section -->
            <div id="suscripciones" class="content-section">
                <div class="content-header">
                    <h1>Gesti贸n de Suscripciones</h1>
                    <p>Administra tu plan de suscripci贸n</p>
                </div>
                
                <div class="card">
                    <div class="alert alert-info">
                        <strong>Plan Actual:</strong> FREE - <span id="dias-restantes">30</span> d铆as restantes
                    </div>
                    
                    <div class="alert alert-warning" style="margin-top: 1rem;">
                        <strong> Comisiones Cresalia:</strong> FREE: 0.8%  BASIC: 1.2%  PRO: 1.2%  ENTERPRISE: 0.8%<br>
                        <strong>锔 Importante:</strong> Las comisiones de Mercado Pago son APARTE y se calculan seg煤n sus tarifas oficiales.
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon primary">
                                <i class="fas fa-gift"></i>
                            </div>
                            <div>
                                <h3 class="text-primary">FREE</h3>
                                <h2>$0/mes</h2>
                                <p style="margin: 0.5rem 0; color: #6B7280; font-size: 0.9rem;">Comisi贸n Cresalia: 0.8%</p>
                                <ul style="list-style: none; padding: 0;">
                                    <li> Hasta 5 productos</li>
                                    <li> Gesti贸n b谩sica de tienda</li>
                                    <li> Bot IA editable</li>
                                    <li> Analytics avanzados</li>
                                </ul>
                                <button class="btn btn-outline-primary w-100" style="margin-top: 1rem;">Plan Actual</button>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon success">
                                <i class="fas fa-star"></i>
                            </div>
                            <div>
                                <h3 class="text-success">BASIC</h3>
                                <h2>$29,000 ARS/mes</h2>
                                <ul style="list-style: none; padding: 0;">
                                    <li> Hasta 50 productos</li>
                                    <li> Gesti贸n completa de tienda</li>
                                    <li> Bot IA editable</li>
                                    <li> Analytics b谩sicos</li>
                                </ul>
                                <button class="btn btn-success w-100" style="margin-top: 1rem;" onclick="cambiarPlan('basic')">
                                    <i class="fas fa-credit-card"></i> Actualizar (Comisi贸n Cresalia: 1.2%)
                                </button>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon warning">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div>
                                <h3 class="text-warning">PRO</h3>
                                <h2>$79,000 ARS/mes</h2>
                                <ul style="list-style: none; padding: 0;">
                                    <li> Productos ilimitados</li>
                                    <li> Gesti贸n avanzada de tienda</li>
                                    <li> Bot IA editable</li>
                                    <li> Analytics avanzados</li>
                                </ul>
                                <button class="btn btn-warning w-100" style="margin-top: 1rem;" onclick="cambiarPlan('pro')">
                                    <i class="fas fa-credit-card"></i> Actualizar (Comisi贸n Cresalia: 1.2%)
                                </button>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon info">
                                <i class="fas fa-rocket"></i>
                            </div>
                            <div>
                                <h3 class="text-info">ENTERPRISE</h3>
                                <h2>$199,000 ARS/mes</h2>
                                <ul style="list-style: none; padding: 0;">
                                    <li> Todo ilimitado</li>
                                    <li> Gesti贸n empresarial</li>
                                    <li> Bot IA avanzado</li>
                                    <li> Analytics premium</li>
                                </ul>
                                <button class="btn btn-info w-100" style="margin-top: 1rem;" onclick="cambiarPlan('enterprise')">
                                    <i class="fas fa-credit-card"></i> Actualizar (Comisi贸n Cresalia: 0.8%)
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Historial de Suscripciones -->
                    <div class="card" style="margin-top: 2rem;">
                        <h3 style="margin-bottom: 1.5rem; color: #374151;"> Historial de Suscripciones</h3>
                        <div id="historialSuscripciones" style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #F3F4F6; border-bottom: 2px solid #E5E7EB;">
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Plan</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Fecha Inicio</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Fecha Fin</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Duraci贸n</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Precio</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="historialSuscripcionesBody">
                                    <!-- Se llenar谩 con JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Informaci贸n de D铆as Restantes -->
                    <div class="card" style="margin-top: 2rem; background: linear-gradient(135deg, #EEF2FF, #E0E7FF); border: 2px solid #818CF8;">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="font-size: 3rem;"></div>
                            <div>
                                <h3 style="margin: 0 0 8px; color: #4338CA;">Tu Suscripci贸n Actual</h3>
                                <p style="margin: 0; font-size: 1.1rem; color: #6366F1;">
                                    <strong>Plan:</strong> <span id="planActualNombre">FREE</span><br>
                                    <strong>D铆as Restantes:</strong> <span id="diasRestantesDetalle" style="font-size: 1.5rem; font-weight: 700; color: #4F46E5;">30</span> d铆as<br>
                                    <strong>Renovaci贸n:</strong> <span id="fechaRenovacion">-</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Widget de Bienestar Emocional (Solo para planes FREE y BASIC) - RESPONSIVE -->
    <div class="widget-bienestar" id="widgetBienestar" style="display: none; position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #EC4899, #F9A8D4); color: white; padding: 15px; border-radius: 16px; box-shadow: 0 8px 24px rgba(236,72,153,0.3); z-index: 1000; max-width: 280px; width: calc(100% - 40px);">
        <h3 style="margin: 0 0 8px; font-size: 1.1rem;"> Bienestar Emocional</h3>
        <p style="margin: 0 0 12px; font-size: 0.9rem; opacity: 0.95;">驴C贸mo te sientes hoy?</p>
        <button onclick="mostrarSistemaBienestar()" style="background: white; color: #EC4899; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; font-size: 0.9rem;">
            <i class="fas fa-heart"></i> Abrir Mi Espacio
        </button>
    </div>
    <style>
        @media (max-width: 768px) {
            .widget-bienestar {
                bottom: 10px !important;
                right: 10px !important;
                max-width: 200px !important;
                padding: 12px !important;
            }
            .widget-bienestar h3 {
                font-size: 0.95rem !important;
            }
            .widget-bienestar p {
                font-size: 0.8rem !important;
                margin-bottom: 8px !important;
            }
            .widget-bienestar button {
                padding: 8px 12px !important;
                font-size: 0.8rem !important;
            }
        }
        @media (max-width: 480px) {
            .widget-bienestar {
                max-width: 160px !important;
                padding: 10px !important;
            }
            .widget-bienestar h3 {
                font-size: 0.85rem !important;
            }
            .widget-bienestar p {
                font-size: 0.75rem !important;
            }
            .widget-bienestar button {
                padding: 6px 10px !important;
                font-size: 0.75rem !important;
            }
        }
    </style>
    
    <!-- Modales -->
    <!-- Modal de Cambio de Plan -->
    <div id="modalCambioPlan" class="modal">
        <div class="modal-content">
            <div class="modal-header-accent">
                <button class="close-btn" onclick="cerrarModal('modalCambioPlan')"></button>
                <h2><i class="fas fa-crown"></i> Cambiar Plan de Suscripci贸n</h2>
            </div>
            <div class="mb-3">
                <label for="nuevoPlanSeleccionado" class="form-label">Selecciona tu nuevo plan:</label>
                <select id="nuevoPlanSeleccionado" name="nuevoPlanSeleccionado" class="form-control" required>
                    <option value="basic">BASIC - $29,000 ARS/mes (Comisi贸n: 1.2%)</option>
                    <option value="pro">PRO - $79,000 ARS/mes (Comisi贸n: 1.2%)</option>
                    <option value="enterprise">ENTERPRISE - $199,000 ARS/mes (Comisi贸n: 0.8%)</option>
                </select>
            </div>
            <div class="alert alert-info">
                <strong> Informaci贸n:</strong> Todas las comisiones van a tu cuenta de Mercado Pago. El pago se procesar谩 de forma segura.
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModal('modalCambioPlan')">
                    Cancelar
                </button>
                <button class="btn btn-primary" onclick="confirmarCambioPlan()">
                    <i class="fas fa-credit-card"></i> Procesar Pago
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Bienestar Emocional -->
    <div id="modalBienestar" class="modal">
        <div class="modal-content">
            <div class="modal-header-accent" style="background: linear-gradient(135deg,#EC4899,#F9A8D4);">
                <button class="close-btn" onclick="cerrarModal('modalBienestar')"></button>
                <h2> Diario Emocional</h2>
            </div>
            <div class="alert alert-info" style="margin-bottom:1rem;">
                <strong>Configuraci贸n:</strong> Puedes activar o desactivar el sistema de bienestar cuando quieras (solo FREE y BASIC).
            </div>
            <div class="form-grid-2" style="margin-bottom:1rem;">
                <div class="mb-3">
                    <label for="estadoBienestar" class="form-label">Estado del Sistema</label>
                    <select id="estadoBienestar" name="estadoBienestar" class="form-control">
                        <option value="activo">Activo</option>
                        <option value="inactivo">Inactivo</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="privacidadBienestar" class="form-label">Privacidad</label>
                    <select id="privacidadBienestar" name="privacidadBienestar" class="form-control">
                        <option value="privado">Privado</option>
                        <option value="solo_tienda">Solo visible en tu tienda</option>
                    </select>
                </div>
            </div>
            <p>Cu茅ntanos c贸mo te sientes hoy. Estamos aqu铆 para apoyarte.</p>
            <textarea class="form-control" id="diarioEmocional" name="diarioEmocional" rows="4" placeholder="Escribe c贸mo te sientes..."></textarea>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModal('modalBienestar')">
                    Cancelar
                </button>
                <button class="btn btn-primary" onclick="guardarDiarioEmocional()">
                    <i class="fas fa-heart"></i> Guardar
                </button>
                <button class="btn btn-success" onclick="aplicarConfiguracionBienestar()">
                    <i class="fas fa-toggle-on"></i> Aplicar Configuraci贸n
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Agregar Producto -->
    <div id="modalAgregarProducto" class="modal">
        <div class="modal-content">
            <div class="modal-header-accent">
                <button class="close-btn" onclick="cerrarModal('modalAgregarProducto')"></button>
                <h2><i class="fas fa-box"></i> Agregar Nuevo Producto</h2>
            </div>
            <form id="formAgregarProducto" name="formAgregarProducto">
                <div class="form-grid-2">
                <div class="mb-3">
                    <label for="nombreProducto" class="form-label">Nombre del Producto</label>
                    <input type="text" id="nombreProducto" name="nombreProducto" class="form-control" placeholder="Nombre del producto" required>
                </div>
                <div class="mb-3">
                    <label for="precioProducto" class="form-label">Precio</label>
                    <input type="number" id="precioProducto" name="precioProducto" class="form-control" placeholder="0.00" step="0.01" required>
                </div>
                <div class="mb-3">
                    <label for="stockProducto" class="form-label">Stock</label>
                    <input type="number" id="stockProducto" name="stockProducto" class="form-control" placeholder="0" required>
                </div>
                <div class="mb-3">
                    <label for="categoriaProducto" class="form-label">Categor铆a</label>
                    <select id="categoriaProducto" name="categoriaProducto" class="form-control" required>
                        <option value="">Selecciona categor铆a</option>
                        <option value="tecnologia">Tecnolog铆a</option>
                        <option value="moda">Moda y Accesorios</option>
                        <option value="ropa">Ropa</option>
                        <option value="hogar">Hogar y Jard铆n</option>
                        <option value="deportes">Deportes y Fitness</option>
                        <option value="belleza">Belleza y Cuidado</option>
                        <option value="salud">Salud y Bienestar</option>
                        <option value="alimentacion">Alimentaci贸n</option>
                        <option value="automotriz">Automotriz</option>
                        <option value="libros">Libros y Educaci贸n</option>
                        <option value="juguetes">Juguetes y Ni帽os</option>
                        <option value="mascotas">Mascotas</option>
                        <option value="viajes">Viajes y Turismo</option>
                        <option value="arte">Arte y Manualidades</option>
                        <option value="musica">M煤sica e Instrumentos</option>
                        <option value="oficina">Oficina y Negocios</option>
                        <option value="herramientas">Herramientas</option>
                        <option value="jardineria">Jardiner铆a</option>
                        <option value="fotografia">Fotograf铆a</option>
                        <option value="gaming">Gaming</option>
                        <option value="servicios">Servicios</option>
                        <option value="comida">Comida</option>
                        <option value="general">Negocio General</option>
                    </select>
                </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalAgregarProducto')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Agregar Servicio -->
    <div id="modalAgregarServicio" class="modal">
        <div class="modal-content">
            <div class="modal-header-accent">
                <button class="close-btn" onclick="cerrarModal('modalAgregarServicio')"></button>
                <h2><i class="fas fa-briefcase"></i> Agregar Nuevo Servicio</h2>
            </div>
            <form id="formAgregarServicio" name="formAgregarServicio">
                <div class="form-grid-2">
                <div class="mb-3">
                    <label for="nombreServicio" class="form-label">Nombre del Servicio</label>
                    <input type="text" id="nombreServicio" name="nombreServicio" class="form-control" placeholder="Nombre del servicio" required>
                </div>
                <div class="mb-3">
                    <label for="precioServicio" class="form-label">Precio</label>
                    <input type="number" id="precioServicio" name="precioServicio" class="form-control" placeholder="0.00" step="0.01" required>
                </div>
                <div class="mb-3">
                    <label for="duracionServicio" class="form-label">Duraci贸n</label>
                    <input type="text" id="duracionServicio" name="duracionServicio" class="form-control" placeholder="1 hora" required>
                </div>
                <div class="mb-3">
                    <label for="categoriaServicio" class="form-label">Categor铆a</label>
                    <select id="categoriaServicio" name="categoriaServicio" class="form-control" required>
                        <option value="">Selecciona categor铆a</option>
                        <option value="peluqueria">Peluquer铆a</option>
                        <option value="estetica">Est茅tica y Belleza</option>
                        <option value="transporte">Transporte</option>
                        <option value="lubricentro">Lubricentro</option>
                        <option value="detail">Detail y Limpieza</option>
                        <option value="distribucion">Distribuci贸n</option>
                        <option value="restaurante">Restaurante</option>
                        <option value="bar">Bar y Tragos</option>
                        <option value="cafe">Caf茅 y T茅</option>
                        <option value="panaderia">Panader铆a</option>
                        <option value="comida">Comida</option>
                        <option value="general">Negocio General</option>
                    </select>
                </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalAgregarServicio')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Gesti贸n de Turnos -->
    <div id="modalTurnos" class="modal">
        <div class="modal-content">
            <div class="modal-header-accent">
                <button class="close-btn" onclick="cerrarModal('modalTurnos')"></button>
                <h2><i class="fas fa-calendar-plus"></i> Gesti贸n de Turnos</h2>
            </div>
            <form id="formTurnos" name="formTurnos">
                <div class="form-grid-2">
                <div class="mb-3">
                    <label for="clienteTurno" class="form-label">Cliente</label>
                    <input type="text" id="clienteTurno" name="clienteTurno" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="servicioTurno" class="form-label">Servicio</label>
                    <input type="text" id="servicioTurno" name="servicioTurno" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="fechaTurno" class="form-label">Fecha</label>
                    <input type="date" id="fechaTurno" name="fechaTurno" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="horaTurno" class="form-label">Hora</label>
                    <input type="time" id="horaTurno" name="horaTurno" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="categoriaTurno" class="form-label">Categor铆a</label>
                    <select id="categoriaTurno" name="categoriaTurno" class="form-control" required>
                        <option value="general">General</option>
                        <option value="consulta">Consulta</option>
                        <option value="mantenimiento">Mantenimiento</option>
                        <option value="followup">Seguimiento</option>
                        <option value="otros">Otros</option>
                    </select>
                </div>
                </div>
            </form>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModal('modalTurnos')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarTurno()">Guardar Turno</button>
            </div>
        </div>
    </div>

    <!-- Modal de Sistema de Pagos -->
    <div id="modalSistemaPagos" class="modal">
        <div class="modal-content">
            <div class="modal-header-accent">
                <button class="close-btn" onclick="cerrarModal('modalSistemaPagos')"></button>
                <h2><i class="fas fa-credit-card"></i> Sistema de Pagos</h2>
            </div>
            <form id="formSistemaPagos" name="formSistemaPagos">
                <div class="form-grid-2">
                <div class="mb-3">
                    <label for="metodoPago" class="form-label">M茅todo de Pago Principal</label>
                    <select id="metodoPago" name="metodoPago" class="form-control" required>
                        <option value="mercadopago">MercadoPago</option>
                        <option value="stripe">Stripe</option>
                        <option value="paypal">PayPal</option>
                        <option value="transferencia">Transferencia Bancaria</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="monedaPago" class="form-label">Moneda</label>
                    <select id="monedaPago" name="monedaPago" class="form-control" required>
                        <option value="ARS">Peso Argentino (ARS)</option>
                        <option value="USD">D贸lar Americano (USD)</option>
                        <option value="EUR">Euro (EUR)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="comisionPago" class="form-label">Comisi贸n por Transacci贸n (%)</label>
                    <input type="number" id="comisionPago" name="comisionPago" class="form-control" value="6.17" step="0.01" min="0" max="10" required>
                    <small class="form-text text-muted">Comisi贸n actual de Mercado Pago (actualizada 2024)</small>
                </div>
                </div>
            </form>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModal('modalSistemaPagos')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarConfiguracionPagos()">Guardar Configuraci贸n</button>
            </div>
        </div>
    </div>

    <!-- Modal de Configuraci贸n de Agradecimientos -->
    <div id="modalConfiguracionAgradecimiento" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="cerrarModal('modalConfiguracionAgradecimiento')"></button>
            <h2>Configuraci贸n de Agradecimientos</h2>
            <form id="formConfiguracionAgradecimiento" name="formConfiguracionAgradecimiento">
                <div class="mb-3">
                    <label for="mensajeAgradecimiento" class="form-label">Mensaje de Agradecimiento</label>
                    <textarea id="mensajeAgradecimiento" name="mensajeAgradecimiento" class="form-control" rows="4" placeholder="隆Gracias por tu compra! Tu apoyo significa mucho para nosotros." required></textarea>
                </div>
                <div class="mb-3">
                    <label for="mostrarAgradecimiento" class="form-label">Mostrar Agradecimiento</label>
                    <select id="mostrarAgradecimiento" name="mostrarAgradecimiento" class="form-control" required>
                        <option value="siempre">Siempre</option>
                        <option value="primera_compra">Solo en Primera Compra</option>
                        <option value="nunca">Nunca</option>
                    </select>
                </div>
            </form>
            <div class="d-flex justify-content-end mt-3">
                <button class="btn btn-secondary" onclick="cerrarModal('modalConfiguracionAgradecimiento')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarConfiguracionAgradecimiento()">Guardar Configuraci贸n</button>
            </div>
        </div>
    </div>

    <!-- Modal de Medios de Pago -->
    <div id="modalMediosPago" class="modal">
        <div class="modal-content">
            <div class="modal-header-accent">
                <button class="close-btn" onclick="cerrarModal('modalMediosPago')"></button>
                <h2><i class="fas fa-wallet"></i> Configuraci贸n de Medios de Pago</h2>
            </div>
            <form id="formMediosPago" name="formMediosPago">
                <div class="mb-3">
                    <div class="form-check">
                        <input type="checkbox" id="aceptarEfectivo" name="aceptarEfectivo" class="form-check-input">
                        <label for="aceptarEfectivo" class="form-check-label">Aceptar Efectivo</label>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input type="checkbox" id="aceptarTarjeta" name="aceptarTarjeta" class="form-check-input">
                        <label for="aceptarTarjeta" class="form-check-label">Aceptar Tarjeta de Cr茅dito/D茅bito</label>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input type="checkbox" id="aceptarTransferencia" name="aceptarTransferencia" class="form-check-input">
                        <label for="aceptarTransferencia" class="form-check-label">Aceptar Transferencia Bancaria</label>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input type="checkbox" id="aceptarMercadoPago" name="aceptarMercadoPago" class="form-check-input">
                        <label for="aceptarMercadoPago" class="form-check-label">Aceptar MercadoPago</label>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input type="checkbox" id="aceptarQR" name="aceptarQR" class="form-check-input">
                        <label for="aceptarQR" class="form-check-label">Aceptar Pago con QR</label>
                    </div>
                </div>
                <div class="alert alert-info" style="margin-top: 1rem;">
                    <strong> Informaci贸n:</strong> Todas las comisiones van a tu cuenta de Mercado Pago. El sistema valida autom谩ticamente las tarjetas para prevenir fraude y robo de identidad.
                </div>
            </form>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModal('modalMediosPago')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarMediosPago()">Guardar Configuraci贸n</button>
            </div>
        </div>
    </div>

    <!-- Modal de Gesti贸n de Feedbacks -->
    <div id="modalGestionFeedbacks" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="cerrarModal('modalGestionFeedbacks')"></button>
            <h2>Gesti贸n de Feedbacks de Tienda</h2>
            <form id="formGestionFeedbacks" name="formGestionFeedbacks">
                <div class="mb-3">
                    <label for="habilitarFeedbacks" class="form-label">Habilitar Sistema de Feedbacks</label>
                    <select id="habilitarFeedbacks" name="habilitarFeedbacks" class="form-control" required>
                        <option value="si">S铆</option>
                        <option value="no">No</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="tipoFeedback" class="form-label">Tipo de Feedback</label>
                    <select id="tipoFeedback" name="tipoFeedback" class="form-control" required>
                        <option value="estrellas">Sistema de Estrellas</option>
                        <option value="numerico">Sistema Num茅rico (1-10)</option>
                        <option value="texto">Solo Comentarios</option>
                    </select>
                </div>
            </form>
            <div class="d-flex justify-content-end mt-3">
                <button class="btn btn-secondary" onclick="cerrarModal('modalGestionFeedbacks')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarConfiguracionFeedbacks()">Guardar Configuraci贸n</button>
            </div>
        </div>
    </div>

    <!-- Modal para Responder Feedback -->
    <div id="modalResponderFeedback" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="cerrarModal('modalResponderFeedback')"></button>
            <h2>Responder Feedback</h2>
            <form id="formResponderFeedback" name="formResponderFeedback">
                <div class="mb-3">
                    <label for="clienteFeedback" class="form-label">Cliente</label>
                    <input type="text" id="clienteFeedback" name="clienteFeedback" class="form-control" readonly>
                </div>
                <div class="mb-3">
                    <label for="comentarioOriginal" class="form-label">Comentario</label>
                    <textarea id="comentarioOriginal" name="comentarioOriginal" class="form-control" rows="3" readonly></textarea>
                </div>
                <div class="mb-3">
                    <label for="respuestaFeedback" class="form-label">Tu respuesta</label>
                    <textarea id="respuestaFeedback" name="respuestaFeedback" class="form-control" rows="4" required></textarea>
                </div>
            </form>
            <div class="d-flex justify-content-end mt-3">
                <button class="btn btn-secondary" onclick="cerrarModal('modalResponderFeedback')">Cancelar</button>
                <button class="btn btn-primary" onclick="enviarRespuestaFeedback()">Enviar Respuesta</button>
            </div>
        </div>
    </div>

    <!-- Modal de Gesti贸n de Puntos Comunes -->
    <div id="modalPuntosComunes" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="cerrarModal('modalPuntosComunes')"></button>
            <h2>Gesti贸n de Puntos Comunes</h2>
            <form id="formPuntosComunes" name="formPuntosComunes">
                <div class="mb-3">
                    <label for="habilitarPuntos" class="form-label">Habilitar Sistema de Puntos</label>
                    <select id="habilitarPuntos" name="habilitarPuntos" class="form-control" required>
                        <option value="si">S铆</option>
                        <option value="no">No</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="valorPunto" class="form-label">Valor del Punto (en $)</label>
                    <input type="number" id="valorPunto" name="valorPunto" class="form-control" value="1" step="0.01" min="0.01" required>
                </div>
                <div class="mb-3">
                    <label for="puntosPorCompra" class="form-label">Puntos por cada $100 de compra</label>
                    <input type="number" id="puntosPorCompra" name="puntosPorCompra" class="form-control" value="10" min="1" required>
                </div>
            </form>
            <div class="d-flex justify-content-end mt-3">
                <button class="btn btn-secondary" onclick="cerrarModal('modalPuntosComunes')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarConfiguracionPuntos()">Guardar Configuraci贸n</button>
            </div>
        </div>
    </div>

    <!-- Modal de Configuraci贸n de Env铆os a Domicilio -->
    <div id="modalEnviosDomicilio" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="cerrarModal('modalEnviosDomicilio')"></button>
            <h2>Configuraci贸n de Env铆os a Domicilio</h2>
            <form id="formEnviosDomicilio" name="formEnviosDomicilio">
                <div class="mb-3">
                    <label for="habilitarEnvios" class="form-label">Habilitar Env铆os a Domicilio</label>
                    <select id="habilitarEnvios" name="habilitarEnvios" class="form-control" required>
                        <option value="si">S铆</option>
                        <option value="no">No</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="costoEnvio" class="form-label">Costo de Env铆o</label>
                    <input type="number" id="costoEnvio" name="costoEnvio" class="form-control" value="500" step="0.01" min="0" required>
                </div>
                <div class="mb-3">
                    <label for="envioGratisDesde" class="form-label">Env铆o Gratis desde ($)</label>
                    <input type="number" id="envioGratisDesde" name="envioGratisDesde" class="form-control" value="5000" step="0.01" min="0" required>
                </div>
            </form>
            <div class="d-flex justify-content-end mt-3">
                <button class="btn btn-secondary" onclick="cerrarModal('modalEnviosDomicilio')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarConfiguracionEnvios()">Guardar Configuraci贸n</button>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script>
        // ============================================
        // SEGURIDAD CRESALIA: BLOQUEO Y PROTECCIN
        // (Aplica a TODOS los planes por igual)
        // ============================================

        // 1) Bloqueo de clic derecho y atajos comunes de devtools
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });
        document.addEventListener('keydown', (e) => {
            const key = e.key?.toLowerCase();
            const ctrl = e.ctrlKey || e.metaKey;
            // F12, Ctrl+Shift+I/J/C/U
            if (
                e.key === 'F12' ||
                (ctrl && e.shiftKey && ['i','j','c'].includes(key)) ||
                (ctrl && ['u'].includes(key))
            ) {
                e.preventDefault();
                e.stopPropagation();
                activarBloqueoSeguridad('Atajo de desarrollador bloqueado');
            }
        }, true);

        // 2) Detecci贸n de DevTools (heur铆sticas de tama帽o/performance)
        let devtoolsActivo = false;
        function detectarDevtools() {
            const threshold = 160; // ancho alto diferencial t铆pico al abrir panel
            const abiertoPorTamano = (
                (window.outerWidth - window.innerWidth) > threshold ||
                (window.outerHeight - window.innerHeight) > threshold
            );
            // Heur铆stica por tiempo de ejecuci贸n con 'debugger'
            let start = performance.now();
            // eslint-disable-next-line no-debugger
            debugger; // si est谩 abierto, a帽ade latencia perceptible
            const overhead = performance.now() - start;
            if (abiertoPorTamano || overhead > 100) {
                if (!devtoolsActivo) {
                    devtoolsActivo = true;
                    activarBloqueoSeguridad('Detecci贸n de herramientas de desarrollo');
                }
            } else if (devtoolsActivo) {
                // Mantener bloqueado hasta recarga para evitar fuga de informaci贸n
            }
        }
        setInterval(detectarDevtools, 1500);

        // 3) Overlay de bloqueo y difuminado de la interfaz
        function activarBloqueoSeguridad(motivo) {
            if (document.getElementById('seguridadOverlay')) return;
            const overlay = document.createElement('div');
            overlay.id = 'seguridadOverlay';
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);color:#fff;z-index:1000000;display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:24px;';
            overlay.innerHTML = '<div style="font-size:56px;line-height:1;"></div>'+
                                '<h2 style="margin:12px 0 8px;">Seguridad Cresalia activada</h2>'+
                                `<p style="opacity:.9;max-width:720px;">${motivo}. Por protecci贸n, el contenido se ha bloqueado temporalmente.</p>`;
            document.body.appendChild(overlay);
            const admin = document.querySelector('.admin-container');
            if (admin) {
                admin.style.filter = 'blur(8px)';
                admin.inert = true;
            }
            document.body.style.overflow = 'hidden';
        }

        // 4) Protecci贸n de datos sensibles en formularios y storage
        const SENSITIVE_KEYS = ['tarjeta','card','cvv','dni','documento','ssn','cuit','cuil','passport'];
        function esClaveSensible(clave) {
            const k = (clave || '').toString().toLowerCase();
            return SENSITIVE_KEYS.some(s => k.includes(s));
        }
        // Endurecer localStorage.setItem para evitar persistir datos sensibles
        (function endurecerStorage() {
            const originalSet = localStorage.setItem.bind(localStorage);
            localStorage.setItem = function(key, value) {
                try {
                    if (esClaveSensible(key)) {
                        console.warn('Bloqueado intento de almacenar datos sensibles:', key);
                        activarBloqueoSeguridad('Prevenci贸n de almacenamiento de datos sensibles');
                        return;
                    }
                    // Si es JSON y contiene claves sensibles, bloquear
                    if (typeof value === 'string' && value.trim().startsWith('{')) {
                        try {
                            const obj = JSON.parse(value);
                            for (const k of Object.keys(obj || {})) {
                                if (esClaveSensible(k)) {
                                    console.warn('Bloqueado JSON con campos sensibles:', k);
                                    activarBloqueoSeguridad('Prevenci贸n de almacenamiento de datos sensibles');
                                    return;
                                }
                            }
                        } catch (_) { /* ignorar parseo */ }
                    }
                } catch (_) { /* noop */ }
                return originalSet(key, value);
            };
        })();

        // Fortalecer inputs potencialmente sensibles
        function fortalecerInputsSensibles() {
            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(inp => {
                const name = (inp.name || inp.id || '').toLowerCase();
                if (!name) return;
                if (esClaveSensible(name)) {
                    if (inp.tagName === 'INPUT') {
                        inp.autocomplete = 'off';
                        inp.inputMode = 'numeric';
                        inp.maxLength = inp.maxLength && inp.maxLength > 0 ? inp.maxLength : 19;
                        inp.addEventListener('input', () => {
                            inp.value = inp.value.replace(/[^0-9]/g, '');
                        });
                    }
                    inp.setAttribute('data-sensitive', 'true');
                }
            });
        }
        document.addEventListener('DOMContentLoaded', fortalecerInputsSensibles);

        // 5) Anti-tamper: evitar que retiren el overlay de seguridad
        const observer = new MutationObserver(() => {
            const overlay = document.getElementById('seguridadOverlay');
            if (devtoolsActivo && !overlay) {
                activarBloqueoSeguridad('Protecci贸n persistente');
            }
        });
        observer.observe(document.documentElement, { childList: true, subtree: true });

        // ============================================
        // SISTEMA DE NAVEGACIN MVIL
        // ============================================
        
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }
        
        function closeSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
        }
        
        // Cerrar sidebar al hacer clic en un enlace en m贸vil
        function closeSidebarOnClick() {
            if (window.innerWidth <= 768) {
                closeSidebar();
            }
        }
        
        // ============================================
        // SISTEMA DE NAVEGACIN
        // ============================================
        
        function mostrarSeccion(seccionId) {
            // Cerrar todos los modales al cambiar de secci贸n
            cerrarTodosLosModales();
            
            // Cerrar modal de historial si est谩 abierto (por si se cre贸 din谩micamente)
            const modalHistorial = document.getElementById('modalHistorialVentasTurnos');
            if (modalHistorial) {
                modalHistorial.remove();
            }
            
            // Tambi茅n buscar modales creados din谩micamente que puedan estar en el body
            const modalesDinamicos = document.querySelectorAll('[id*="Historial"], [id*="historial"], [id*="Modal"], [id*="modal"]');
            modalesDinamicos.forEach(modal => {
                if (modal.style && (modal.style.display === 'flex' || modal.style.display === 'block')) {
                    modal.remove();
                }
            });
            
            // Ocultar todas las secciones
            const secciones = document.querySelectorAll('.content-section');
            secciones.forEach(seccion => {
                seccion.classList.remove('active');
            });
            
            // Mostrar la secci贸n seleccionada
            const seccion = document.getElementById(seccionId);
            if (seccion) {
                seccion.classList.add('active');
            }
            
            // Actualizar navegaci贸n
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.classList.remove('active');
            });
            
            const navLink = document.querySelector(`[onclick="mostrarSeccion('${seccionId}')"]`);
            if (navLink) {
                navLink.classList.add('active');
            }
            
            // Cerrar sidebar en m贸vil
            closeSidebarOnClick();
            
            console.log(` Navegando a: ${seccionId}`);
        }
        
        // ============================================
        // SISTEMA DE MODALES
        // ============================================
        
        function abrirModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
                
                // Cerrar modal al hacer clic fuera
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        cerrarModal(modalId);
                    }
                };
                
                console.log(` Modal abierto: ${modalId}`);
            }
        }
        
        function cerrarModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                // Remover clase show
                modal.classList.remove('show');
                
                // Asegurar que display sea none (por si tiene estilo inline)
                modal.style.display = 'none';
                
                // Restaurar overflow del body
                document.body.style.overflow = 'auto';
                
                // Remover cualquier listener de click que pueda estar interfiriendo
                modal.onclick = null;
                
                console.log(` Modal cerrado: ${modalId}`);
            }
        }
        
        // Funci贸n para cerrar todos los modales
        function cerrarTodosLosModales() {
            const modales = document.querySelectorAll('.modal');
            modales.forEach(modal => {
                modal.classList.remove('show');
                modal.style.display = 'none';
                modal.onclick = null;
            });
            document.body.style.overflow = 'auto';
            console.log(' Todos los modales cerrados');
        }
        
        function abrirModalBienestar() {
            const plan = (localStorage.getItem('plan-actual') || 'free').toLowerCase();
            if (!['free','basic'].includes(plan)) {
                mostrarNotificacion('癸 El sistema de bienestar est谩 disponible solo para planes FREE y BASIC', 'info');
                return;
            }
            const cfg = JSON.parse(localStorage.getItem('configuracion_bienestar') || '{}');
            const selectEstado = document.getElementById('estadoBienestar');
            if (selectEstado && cfg.estado) selectEstado.value = cfg.estado;
            const selectPriv = document.getElementById('privacidadBienestar');
            if (selectPriv && cfg.privacidad) selectPriv.value = cfg.privacidad;
            abrirModal('modalBienestar');
        }
        
        // Cerrar modales al hacer clic fuera
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                // Usar la funci贸n cerrarModal en lugar de manipular directamente
                const modalId = event.target.id;
                if (modalId) {
                    cerrarModal(modalId);
                } else {
                    // Si no tiene ID, cerrar directamente
                    event.target.classList.remove('show');
                    event.target.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
                console.log(' Modal cerrado al hacer clic fuera');
            }
        });
        
        // Cerrar modales con tecla Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modales = document.querySelectorAll('.modal');
                modales.forEach(modal => {
                    // Verificar si el modal est谩 visible (por clase o estilo)
                    const estaVisible = modal.classList.contains('show') || 
                                       modal.style.display === 'flex' ||
                                       window.getComputedStyle(modal).display === 'flex';
                    
                    if (estaVisible) {
                        const modalId = modal.id;
                        if (modalId) {
                            cerrarModal(modalId);
                        } else {
                            modal.classList.remove('show');
                            modal.style.display = 'none';
                            document.body.style.overflow = 'auto';
                        }
                        console.log(' Modal cerrado con Escape');
                    }
                });
            }
        });
        
        
        // ============================================
        // SISTEMA DE SUSCRIPCIONES
        // ============================================
        
        function cambiarPlan(nuevoPlan) {
            console.log(` Cambiando plan a: ${nuevoPlan}`);
            const selectPlan = document.getElementById('nuevoPlanSeleccionado');
            if (selectPlan) {
                selectPlan.value = nuevoPlan;
            }
            abrirModal('modalCambioPlan');
        }
        
        function confirmarCambioPlan() {
            const planActual = localStorage.getItem('plan-actual') || 'free';
            const nuevoPlan = document.getElementById('nuevoPlanSeleccionado')?.value || planActual;
            
            if (nuevoPlan === planActual) {
                mostrarNotificacion('Ya tienes este plan activo', 'info');
                cerrarModal('modalCambioPlan');
                return;
            }
            
            // Procesar pago de suscripci贸n (despu茅s del pago se actualizar谩 el plan)
            procesarPagoSuscripcion(nuevoPlan);
        }
        
        // Funci贸n para actualizar visibilidad de bienestar seg煤n plan
        function actualizarVisibilidadBienestar() {
            const planActual = (localStorage.getItem('plan-actual') || 'free').toLowerCase();
            console.log(' Verificando visibilidad de bienestar para plan:', planActual);
            
            // Actualizar men煤 lateral
            const navItemBienestar = document.getElementById('navItemBienestar');
            if (navItemBienestar) {
                if (['free', 'basic'].includes(planActual)) {
                    navItemBienestar.style.display = 'block';
                    navItemBienestar.style.visibility = 'visible';
                    console.log(' Men煤 de bienestar visible para plan:', planActual);
                } else {
                    navItemBienestar.style.display = 'none';
                    console.log('癸 Men煤 de bienestar oculto para plan:', planActual);
                }
            } else {
                console.warn('锔 navItemBienestar no encontrado en el DOM');
            }
            
            // Actualizar widget
            const widgetBienestar = document.getElementById('widgetBienestar');
            if (widgetBienestar) {
                if (['free', 'basic'].includes(planActual)) {
                    widgetBienestar.style.display = 'block';
                    widgetBienestar.style.visibility = 'visible';
                    console.log(' Widget de bienestar visible para plan:', planActual);
                } else {
                    widgetBienestar.style.display = 'none';
                    console.log('癸 Widget de bienestar oculto para plan:', planActual);
                }
            } else {
                console.warn('锔 widgetBienestar no encontrado en el DOM');
            }
        }
        
        // ============================================
        // SISTEMA DE BIENESTAR EMOCIONAL COMPLETO
        // ============================================
        
        class SistemaBienestarEmocional {
            constructor() {
                this.configuracion = this.cargarConfiguracion();
                this.estadosAnimo = this.cargarEstadosAnimo();
                this.desafios = this.cargarDesafios();
                this.logros = this.cargarLogros();
                this.recursos = this.cargarRecursos();
            }
            cargarConfiguracion() {
                const config = JSON.parse(localStorage.getItem('configuracion_bienestar') || '{}');
                return { activo: config.activo !== false, mostrarNotificaciones: config.mostrarNotificaciones !== false, musicaAutomatica: config.musicaAutomatica || false, recordatorios: config.recordatorios || true, privacidad: config.privacidad || 'privado', fechaCambio: config.fechaCambio || new Date().toISOString() };
            }
            cargarEstadosAnimo() { return JSON.parse(localStorage.getItem('estados_animo') || '[]'); }
            cargarDesafios() { return JSON.parse(localStorage.getItem('desafios_bienestar') || '[]'); }
            cargarLogros() { return JSON.parse(localStorage.getItem('logros_bienestar') || '[]'); }
            cargarRecursos() { return JSON.parse(localStorage.getItem('recursos_bienestar') || '[]'); }
            guardarConfiguracion() { localStorage.setItem('configuracion_bienestar', JSON.stringify(this.configuracion)); }
            guardarEstadosAnimo() { localStorage.setItem('estados_animo', JSON.stringify(this.estadosAnimo)); }
            guardarDesafios() { localStorage.setItem('desafios_bienestar', JSON.stringify(this.desafios)); }
            guardarLogros() { localStorage.setItem('logros_bienestar', JSON.stringify(this.logros)); }
            guardarRecursos() { localStorage.setItem('recursos_bienestar', JSON.stringify(this.recursos)); }
            
            toggleSistema(activo) {
                this.configuracion.activo = activo;
                this.configuracion.fechaCambio = new Date().toISOString();
                this.guardarConfiguracion();
                mostrarNotificacion(activo ? ' Sistema de bienestar emocional activado' : ' Sistema de bienestar emocional desactivado', activo ? 'success' : 'info');
            }
            
            registrarEstadoAnimo(estado, notas = '') {
                const nuevoEstado = { id: Date.now(), estado, notas, fecha: new Date().toISOString(), puntos: this.calcularPuntos(estado) };
                this.estadosAnimo.unshift(nuevoEstado);
                this.guardarEstadosAnimo();
                this.verificarDesafios();
                mostrarNotificacion(` Estado de 谩nimo registrado: ${estado}`, 'success');
                return nuevoEstado;
            }
            
            verificarDesafios() {
                const desafiosDisponibles = [
                    { id: 'primer_registro', nombre: 'Primer Paso', descripcion: 'Registra tu primer estado de 谩nimo', icono: '', puntos: 10, condicion: () => this.estadosAnimo.length === 1 },
                    { id: 'racha_3_dias', nombre: 'Racha de 3 D铆as', descripcion: 'Registra estados por 3 d铆as consecutivos', icono: '', puntos: 25, condicion: () => this.calcularRachaActual() >= 3 },
                    { id: 'racha_7_dias', nombre: 'Racha de 7 D铆as', descripcion: 'Registra estados por 7 d铆as consecutivos', icono: '猸', puntos: 50, condicion: () => this.calcularRachaActual() >= 7 },
                    { id: 'racha_30_dias', nombre: 'Racha de 30 D铆as', descripcion: 'Registra estados por 30 d铆as consecutivos', icono: '', puntos: 100, condicion: () => this.calcularRachaActual() >= 30 },
                    { id: 'estados_positivos', nombre: 'Optimista', descripcion: 'Registra 10 estados positivos', icono: '', puntos: 30, condicion: () => this.estadosAnimo.filter(e => [' Feliz', ' Tranquilo'].includes(e.estado)).length >= 10 }
                ];
                desafiosDisponibles.forEach(desafio => {
                    if (!this.logros.find(l => l.desafioId === desafio.id) && desafio.condicion()) this.desbloquearLogro(desafio);
                });
            }
            
            calcularRachaActual() {
                if (this.estadosAnimo.length === 0) return 0;
                let racha = 0;
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                for (let i = 0; i < this.estadosAnimo.length; i++) {
                    const fechaEstado = new Date(this.estadosAnimo[i].fecha);
                    fechaEstado.setHours(0, 0, 0, 0);
                    const diasDiferencia = Math.floor((hoy - fechaEstado) / (1000 * 60 * 60 * 24));
                    if (diasDiferencia === racha) racha++; else break;
                }
                return racha;
            }
            
            calcularPuntos(estado) {
                const puntosPorEstado = { ' Feliz': 5, ' Tranquilo': 3, ' Neutral': 1, ' Triste': 2, ' Ansioso': 2, ' Frustrado': 2 };
                return puntosPorEstado[estado] || 1;
            }
            
            desbloquearLogro(desafio) {
                const logro = { id: Date.now(), desafioId: desafio.id, nombre: desafio.nombre, descripcion: desafio.descripcion, icono: desafio.icono, puntos: desafio.puntos, fechaDesbloqueo: new Date().toISOString() };
                this.logros.unshift(logro);
                this.guardarLogros();
                mostrarNotificacion(` 隆Logro desbloqueado! ${logro.nombre} (+${logro.puntos} puntos)`, 'success');
            }
            
            obtenerEstadisticas() {
                const totalEstados = this.estadosAnimo.length;
                const rachaActual = this.calcularRachaActual();
                const totalLogros = this.logros.length;
                const puntosTotales = this.logros.reduce((sum, logro) => sum + logro.puntos, 0);
                return { totalEstados, rachaActual, totalLogros, puntosTotales, fechaUltimoRegistro: totalEstados > 0 ? this.estadosAnimo[0].fecha : null };
            }
            
            obtenerRecursos() {
                return [
                    { id: 'musica_relajante', nombre: ' M煤sica Relajante', descripcion: 'Canciones suaves para relajarte', tipo: 'audio' },
                    { id: 'consejos_mental', nombre: ' Consejos de Salud Mental', descripcion: 'Tips para tu bienestar mental', tipo: 'texto' },
                    { id: 'tecnicas_relajacion', nombre: '锔 T茅cnicas de Relajaci贸n', descripcion: 'Ejercicios de respiraci贸n', tipo: 'guia' },
                    { id: 'consejos_ventas', nombre: ' Consejos para Ventas', descripcion: 'Estrategias para crecer', tipo: 'texto' }
                ];
            }
        }
        
        let sistemaBienestarEmocional = new SistemaBienestarEmocional();
        
        function mostrarSistemaBienestar() {
            const plan = (localStorage.getItem('plan-actual') || 'free').toLowerCase();
            if (!['free', 'basic'].includes(plan)) {
                mostrarNotificacion('癸 El sistema de bienestar emocional est谩 disponible solo para planes FREE y BASIC', 'info');
                return;
            }
            console.log(' Mostrando sistema de bienestar emocional completo...');
            const modal = document.createElement('div');
            modal.id = 'modalBienestarCompleto';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999; overflow-y: auto;';
            const stats = sistemaBienestarEmocional.obtenerEstadisticas();
            const recursos = sistemaBienestarEmocional.obtenerRecursos();
            modal.innerHTML = `<div style="background: white; border-radius: 24px; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto; margin: 20px;"><div style="background: linear-gradient(135deg, #EC4899, #F9A8D4); color: white; padding: 32px; text-align: center; position: relative;"><button onclick="cerrarSistemaBienestar()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button><div style="font-size: 64px; margin-bottom: 16px;"></div><h2 style="margin: 0;">Mi Espacio de Bienestar</h2><p style="margin: 8px 0 0; opacity: 0.95;">Tu refugio emocional en Cresalia</p></div><div style="padding: 32px;"><div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); padding: 20px; border-radius: 16px; border: 2px solid #F59E0B; margin-bottom: 24px;"><h4 style="color: #92400E; margin: 0 0 12px; font-size: 1.1rem;"> Filosof铆a Cresalia</h4><p style="color: #92400E; margin: 0; font-size: 0.95rem; line-height: 1.5;">Tu bienestar emocional es tan importante como el 茅xito de tu negocio. Este espacio est谩 dise帽ado para ayudarte a mantener el equilibrio mientras emprendes, con recursos respetuosos y herramientas de crecimiento personal.</p></div><div style="background: ${sistemaBienestarEmocional.configuracion.activo ? '#F0FDF4' : '#FEF2F2'}; padding: 24px; border-radius: 16px; border: 2px solid ${sistemaBienestarEmocional.configuracion.activo ? '#22C55E' : '#EF4444'}; margin-bottom: 30px;"><div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;"><div style="width: 60px; height: 60px; background: ${sistemaBienestarEmocional.configuracion.activo ? '#22C55E' : '#EF4444'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem;">${sistemaBienestarEmocional.configuracion.activo ? '' : ''}</div><div style="flex: 1;"><h3 style="margin: 0; color: #374151; font-size: 1.5rem;">Estado: ${sistemaBienestarEmocional.configuracion.activo ? 'Activo' : 'Inactivo'}</h3><p style="margin: 5px 0 0; color: #6B7280; font-size: 1rem;">${sistemaBienestarEmocional.configuracion.activo ? 'El sistema de bienestar est谩 funcionando' : 'El sistema de bienestar est谩 desactivado'}</p></div></div><div style="display: flex; gap: 12px;"><button onclick="toggleSistemaBienestarCompleto(true)" style="background: #22C55E; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; ${sistemaBienestarEmocional.configuracion.activo ? 'opacity: 0.5; cursor: not-allowed;' : ''}" ${sistemaBienestarEmocional.configuracion.activo ? 'disabled' : ''}><i class="fas fa-heart"></i> Activar Sistema</button><button onclick="toggleSistemaBienestarCompleto(false)" style="background: #EF4444; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; ${!sistemaBienestarEmocional.configuracion.activo ? 'opacity: 0.5; cursor: not-allowed;' : ''}" ${!sistemaBienestarEmocional.configuracion.activo ? 'disabled' : ''}><i class="fas fa-heart-broken"></i> Desactivar Sistema</button></div></div><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;"><div style="background: #F0F9FF; padding: 20px; border-radius: 12px; border: 1px solid #BAE6FD; text-align: center;"><div style="font-size: 2rem; color: #0369A1; margin-bottom: 8px;"></div><h3 style="margin: 0; color: #0369A1; font-size: 1.5rem;">${stats.totalEstados}</h3><p style="margin: 0; color: #0369A1; font-size: 0.9rem;">Estados Registrados</p></div><div style="background: #F0FDF4; padding: 20px; border-radius: 12px; border: 1px solid #BBF7D0; text-align: center;"><div style="font-size: 2rem; color: #166534; margin-bottom: 8px;"></div><h3 style="margin: 0; color: #166534; font-size: 1.5rem;">${stats.rachaActual}</h3><p style="margin: 0; color: #166534; font-size: 0.9rem;">D铆as de Racha</p></div><div style="background: #FEF3C7; padding: 20px; border-radius: 12px; border: 1px solid #FDE68A; text-align: center;"><div style="font-size: 2rem; color: #92400E; margin-bottom: 8px;"></div><h3 style="margin: 0; color: #92400E; font-size: 1.5rem;">${stats.totalLogros}</h3><p style="margin: 0; color: #92400E; font-size: 0.9rem;">Logros Desbloqueados</p></div><div style="background: #FEF2F2; padding: 20px; border-radius: 12px; border: 1px solid #FECACA; text-align: center;"><div style="font-size: 2rem; color: #DC2626; margin-bottom: 8px;">猸</div><h3 style="margin: 0; color: #DC2626; font-size: 1.5rem;">${stats.puntosTotales}</h3><p style="margin: 0; color: #DC2626; font-size: 0.9rem;">Puntos Totales</p></div></div><div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;"><h3 style="margin: 0 0 20px; color: #374151;"> 驴C贸mo te sientes hoy?</h3><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;"><button onclick="registrarEstadoAnimo(' Feliz')" style="background: #F0FDF4; border: 2px solid #22C55E; color: #166534; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='#22C55E'; this.style.color='white'" onmouseout="this.style.background='#F0FDF4'; this.style.color='#166534'"> Feliz</button><button onclick="registrarEstadoAnimo(' Tranquilo')" style="background: #F0F9FF; border: 2px solid #3B82F6; color: #1E40AF; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='#3B82F6'; this.style.color='white'" onmouseout="this.style.background='#F0F9FF'; this.style.color='#1E40AF'"> Tranquilo</button><button onclick="registrarEstadoAnimo(' Neutral')" style="background: #F9FAFB; border: 2px solid #6B7280; color: #374151; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='#6B7280'; this.style.color='white'" onmouseout="this.style.background='#F9FAFB'; this.style.color='#374151'"> Neutral</button><button onclick="registrarEstadoAnimo(' Triste')" style="background: #FEF2F2; border: 2px solid #EF4444; color: #DC2626; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='#EF4444'; this.style.color='white'" onmouseout="this.style.background='#FEF2F2'; this.style.color='#DC2626'"> Triste</button><button onclick="registrarEstadoAnimo(' Ansioso')" style="background: #FEF3C7; border: 2px solid #F59E0B; color: #92400E; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='#F59E0B'; this.style.color='white'" onmouseout="this.style.background='#FEF3C7'; this.style.color='#92400E'"> Ansioso</button><button onclick="registrarEstadoAnimo(' Frustrado')" style="background: #FDF2F8; border: 2px solid #EC4899; color: #BE185D; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='#EC4899'; this.style.color='white'" onmouseout="this.style.background='#FDF2F8'; this.style.color='#BE185D'"> Frustrado</button></div><div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Notas adicionales (opcional)</label><textarea id="notasEstadoAnimo" placeholder="驴C贸mo te sientes hoy? 驴Hay algo que quieras compartir?" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem; resize: vertical; min-height: 80px;"></textarea></div><button onclick="registrarEstadoAnimoConNotas()" style="background: linear-gradient(135deg, #EC4899, #F9A8D4); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"><i class="fas fa-heart"></i> Registrar Estado</button></div><div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;"><h3 style="margin: 0 0 20px; color: #374151;"> Recursos para tu Bienestar</h3><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">${recursos.map(r => `<div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; text-align: center;"><div style="font-size: 2rem; margin-bottom: 12px;">${r.nombre.split(' ')[0]}</div><h4 style="margin: 0 0 8px; color: #374151; font-size: 1.1rem;">${r.nombre}</h4><p style="margin: 0 0 15px; color: #6B7280; font-size: 0.9rem;">${r.descripcion}</p><button onclick="usarRecursoBienestar('${r.id}')" style="background: #3B82F6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">Usar Recurso</button></div>`).join('')}</div></div><div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;"><h3 style="margin: 0 0 20px; color: #374151;"> Historial de Estados de nimo</h3><div id="historialEstadosAnimo" style="max-height: 300px; overflow-y: auto;">${sistemaBienestarEmocional.estadosAnimo.length > 0 ? sistemaBienestarEmocional.estadosAnimo.slice(0, 10).map(estado => `<div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 15px; margin-bottom: 10px;"><div style="display: flex; justify-content: space-between; align-items: center;"><div><h4 style="margin: 0; color: #374151; font-size: 1rem;">${estado.estado}</h4><p style="margin: 5px 0 0; color: #6B7280; font-size: 0.9rem;">${new Date(estado.fecha).toLocaleDateString('es-ES')} - ${new Date(estado.fecha).toLocaleTimeString('es-ES')}</p>${estado.notas ? `<p style="margin: 5px 0 0; color: #4B5563; font-size: 0.9rem; font-style: italic;">"${estado.notas}"</p>` : ''}</div></div></div>`).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><i class="fas fa-heart" style="font-size: 3rem; margin-bottom: 15px;"></i><p>No hay estados registrados a煤n</p></div>'}</div></div><div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;"><h3 style="margin: 0 0 20px; color: #374151;"> Logros Desbloqueados</h3><div id="logrosDesbloqueados" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">${sistemaBienestarEmocional.logros.length > 0 ? sistemaBienestarEmocional.logros.map(logro => `<div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); border: 2px solid #F59E0B; border-radius: 12px; padding: 15px; text-align: center;"><div style="font-size: 2rem; margin-bottom: 8px;">${logro.icono}</div><h4 style="margin: 0 0 5px; color: #92400E; font-size: 1rem;">${logro.nombre}</h4><p style="margin: 0 0 8px; color: #92400E; font-size: 0.9rem;">${logro.descripcion}</p><span style="background: #F59E0B; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">+${logro.puntos} pts</span></div>`).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><i class="fas fa-trophy" style="font-size: 3rem; margin-bottom: 15px;"></i><p>No hay logros desbloqueados a煤n</p></div>'}</div></div><div style="background: linear-gradient(135deg, #EC4899, #F9A8D4); padding: 30px; border-radius: 16px; border: 3px solid #BE185D; margin-bottom: 30px; text-align: center; box-shadow: 0 8px 24px rgba(236,72,153,0.3);"><div style="font-size: 4rem; margin-bottom: 16px;"></div><h3 style="margin: 0 0 15px; color: white; font-size: 1.5rem;">驴Necesitas Apoyo Emocional?</h3><p style="margin: 0 0 25px; color: white; opacity: 0.95; font-size: 1rem;">CRISLA est谩 aqu铆 para escucharte. Env铆a un mensaje y te responderemos.</p><button onclick="abrirChatCRISLA()" style="background: white; color: #EC4899; border: none; padding: 16px 32px; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 1.1rem; box-shadow: 0 8px 24px rgba(0,0,0,0.2); transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 12px 32px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.2)'"><i class="fas fa-comments"></i> Hablar con CRISLA</button></div><div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;"><h3 style="margin: 0 0 20px; color: #374151;"> Recursos Adicionales</h3><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;"><div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; text-align: center;"><div style="font-size: 2rem; margin-bottom: 12px;"></div><h4 style="margin: 0 0 8px; color: #374151; font-size: 1.1rem;">Biblioteca de Recursos</h4><p style="margin: 0 0 15px; color: #6B7280; font-size: 0.9rem;">Art铆culos y gu铆as para tu crecimiento personal</p><button onclick="abrirBibliotecaRecursos()" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"><i class="fas fa-book"></i> Explorar</button></div><div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; text-align: center;"><div style="font-size: 2rem; margin-bottom: 12px;"></div><h4 style="margin: 0 0 8px; color: #374151; font-size: 1.1rem;">Metas Personales</h4><p style="margin: 0 0 15px; color: #6B7280; font-size: 0.9rem;">Establece y sigue tus objetivos de bienestar</p><button onclick="configurarMetasPersonales()" style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"><i class="fas fa-target"></i> Configurar</button></div><div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; text-align: center;"><div style="font-size: 2rem; margin-bottom: 12px;"></div><h4 style="margin: 0 0 8px; color: #374151; font-size: 1.1rem;">Reportes Detallados</h4><p style="margin: 0 0 15px; color: #6B7280; font-size: 0.9rem;">An谩lisis profundo de tu progreso emocional</p><button onclick="generarReporteBienestar()" style="background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"><i class="fas fa-chart-bar"></i> Generar</button></div></div><div style="background: #FEF3C7; padding: 15px; border-radius: 8px; border-left: 4px solid #F59E0B; margin-top: 20px;"><h5 style="color: #92400E; margin-bottom: 10px;"> Informaci贸n Importante</h5><p style="color: #92400E; margin: 0; font-size: 0.9rem;">Todos tus datos de bienestar son completamente privados y seguros. Cresalia respeta tu privacidad y solo t煤 tienes acceso a esta informaci贸n.</p></div></div><div style="display: flex; gap: 16px; justify-content: center;"><button onclick="exportarDatosBienestar()" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Exportar Datos</button><button onclick="limpiarDatosBienestar()" style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">锔 Limpiar Datos</button><button onclick="cerrarSistemaBienestar()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Cerrar</button></div></div></div>`;
            document.body.appendChild(modal);
        }
        
        function registrarEstadoAnimo(estado) {
            const notas = document.getElementById('notasEstadoAnimo')?.value.trim() || '';
            sistemaBienestarEmocional.registrarEstadoAnimo(estado, notas);
            cerrarSistemaBienestar();
            setTimeout(() => mostrarSistemaBienestar(), 500);
        }
        
        function registrarEstadoAnimoConNotas() {
            const notas = document.getElementById('notasEstadoAnimo')?.value.trim() || '';
            if (!notas) {
                mostrarNotificacion('Por favor selecciona un estado de 谩nimo usando los botones de arriba', 'warning');
                return;
            }
            sistemaBienestarEmocional.registrarEstadoAnimo('Estado con notas', notas);
            cerrarSistemaBienestar();
            setTimeout(() => mostrarSistemaBienestar(), 500);
        }
        
        function usarRecursoBienestar(recursoId) {
            const recursos = sistemaBienestarEmocional.obtenerRecursos();
            const recurso = recursos.find(r => r.id === recursoId);
            if (recurso) {
                mostrarNotificacion(` Usando recurso: ${recurso.nombre}`, 'success');
                switch (recursoId) {
                    case 'musica_relajante':
                        const modalMusica = document.createElement('div');
                        modalMusica.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999999;';
                        modalMusica.innerHTML = `<div style="background: white; border-radius: 16px; padding: 30px; max-width: 600px; width: 90%;"><h3 style="margin: 0 0 20px; color: #374151;"> M煤sica Relajante</h3><p style="margin: 0 0 20px; color: #6B7280;">Aqu铆 puedes agregar enlaces a playlists de Spotify, YouTube, etc.</p><div style="background: #F8FAFC; padding: 20px; border-radius: 12px; margin-bottom: 20px;"><p style="margin: 0; color: #374151; font-weight: 600;"> Sugerencias:</p><ul style="margin: 10px 0 0; padding-left: 20px;"><li>M煤sica de meditaci贸n</li><li>Sonidos de la naturaleza</li><li>Lo-fi para concentraci贸n</li><li>M煤sica cl谩sica relajante</li></ul></div><button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="background: linear-gradient(135deg, #EC4899, #F9A8D4); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%;">Cerrar</button></div>`;
                        document.body.appendChild(modalMusica);
                        break;
                    case 'consejos_mental':
                        const modalConsejos = document.createElement('div');
                        modalConsejos.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999999; overflow-y: auto;';
                        modalConsejos.innerHTML = `<div style="background: white; border-radius: 16px; padding: 30px; max-width: 700px; width: 90%; margin: 20px;"><h3 style="margin: 0 0 20px; color: #374151;"> Consejos de Salud Mental</h3><div style="max-height: 500px; overflow-y: auto;"><div style="background: #EEF2FF; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #6366F1;"><h4 style="margin: 0 0 10px; color: #4338CA;"> Respira Profundo</h4><p style="margin: 0; color: #4338CA;">Toma 5 respiraciones profundas. Inhala por 4 segundos, mant茅n por 4, exhala por 4.</p></div><div style="background: #F0FDF4; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #22C55E;"><h4 style="margin: 0 0 10px; color: #166534;"> Toma Descansos</h4><p style="margin: 0; color: #166534;">Cada 50 minutos, toma 10 minutos de descanso. Estira, camina, hidr谩tate.</p></div><div style="background: #FEF3C7; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #F59E0B;"><h4 style="margin: 0 0 10px; color: #92400E;">锔 Practica Gratitud</h4><p style="margin: 0; color: #92400E;">Escribe 3 cosas por las que est茅s agradecido hoy. El bienestar empieza por apreciar lo que tienes.</p></div><div style="background: #FCE7F3; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #EC4899;"><h4 style="margin: 0 0 10px; color: #BE185D;"> S茅 Amable Contigo</h4><p style="margin: 0; color: #BE185D;">No te exijas perfecci贸n. Est谩 bien tener d铆as dif铆ciles. Eres humano y eso es hermoso.</p></div></div><button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="background: linear-gradient(135deg, #EC4899, #F9A8D4); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 20px;">Cerrar</button></div>`;
                        document.body.appendChild(modalConsejos);
                        break;
                    case 'tecnicas_relajacion':
                        const modalTecnicas = document.createElement('div');
                        modalTecnicas.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999999;';
                        modalTecnicas.innerHTML = `<div style="background: white; border-radius: 16px; padding: 30px; max-width: 600px; width: 90%;"><h3 style="margin: 0 0 20px; color: #374151;">锔 T茅cnica de Respiraci贸n 4-7-8</h3><div style="background: linear-gradient(135deg, #EEF2FF, #E0E7FF); padding: 30px; border-radius: 12px; text-align: center; margin-bottom: 20px;"><p style="margin: 0 0 20px; color: #4338CA; font-size: 1.1rem; font-weight: 600;">Sigue estos pasos:</p><div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px;"><p style="margin: 0; color: #1E40AF; font-size: 1.5rem; font-weight: 700;">1锔 Inhala</p><p style="margin: 5px 0 0; color: #6366F1;">por 4 segundos</p></div><div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px;"><p style="margin: 0; color: #7C3AED; font-size: 1.5rem; font-weight: 700;">2锔 Mant茅n</p><p style="margin: 5px 0 0; color: #8B5CF6;">por 7 segundos</p></div><div style="background: white; padding: 20px; border-radius: 12px;"><p style="margin: 0; color: #EC4899; font-size: 1.5rem; font-weight: 700;">3锔 Exhala</p><p style="margin: 5px 0 0; color: #F472B6;">por 8 segundos</p></div><p style="margin: 20px 0 0; color: #4338CA; font-size: 0.9rem;">Repite 4 veces</p></div><button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="background: linear-gradient(135deg, #EC4899, #F9A8D4); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%;">Cerrar</button></div>`;
                        document.body.appendChild(modalTecnicas);
                        break;
                    case 'consejos_ventas':
                        const modalVentas = document.createElement('div');
                        modalVentas.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999999; overflow-y: auto;';
                        modalVentas.innerHTML = `<div style="background: white; border-radius: 16px; padding: 30px; max-width: 700px; width: 90%; margin: 20px;"><h3 style="margin: 0 0 20px; color: #374151;"> Consejos para Crecer tus Ventas</h3><div style="max-height: 500px; overflow-y: auto;"><div style="background: #F0F9FF; padding: 20px; border-radius: 12px; margin-bottom: 15px;"><h4 style="margin: 0 0 10px; color: #0369A1;"> Fotos de Calidad</h4><p style="margin: 0; color: #0369A1;">Usa buena iluminaci贸n natural. Las fotos claras venden m谩s.</p></div><div style="background: #F0FDF4; padding: 20px; border-radius: 12px; margin-bottom: 15px;"><h4 style="margin: 0 0 10px; color: #059669;"> Responde R谩pido</h4><p style="margin: 0; color: #059669;">Los clientes valoran las respuestas r谩pidas. Intenta responder en menos de 2 horas.</p></div><div style="background: #FEF3C7; padding: 20px; border-radius: 12px; margin-bottom: 15px;"><h4 style="margin: 0 0 10px; color: #D97706;"> Ofrece Valor Extra</h4><p style="margin: 0; color: #D97706;">Un peque帽o regalo o descuento por volumen genera lealtad.</p></div><div style="background: #FDF2F8; padding: 20px; border-radius: 12px;"><h4 style="margin: 0 0 10px; color: #BE185D;"> Pide Feedbacks</h4><p style="margin: 0; color: #BE185D;">Los testimonios positivos generan confianza en nuevos clientes.</p></div></div><button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="background: linear-gradient(135deg, #EC4899, #F9A8D4); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 20px;">Cerrar</button></div>`;
                        document.body.appendChild(modalVentas);
                        break;
                }
            }
        }
        
        
        function exportarDatosBienestar() {
            const datos = { configuracion: sistemaBienestarEmocional.configuracion, estadosAnimo: sistemaBienestarEmocional.estadosAnimo, logros: sistemaBienestarEmocional.logros, estadisticas: sistemaBienestarEmocional.obtenerEstadisticas(), fechaExportacion: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bienestar-emocional-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            mostrarNotificacion(' Datos de bienestar exportados', 'success');
        }
        
        function limpiarDatosBienestar() {
            if (confirm('驴Est谩s seguro de que quieres limpiar todos los datos de bienestar? Esta acci贸n no se puede deshacer.')) {
                localStorage.removeItem('configuracion_bienestar');
                localStorage.removeItem('estados_animo');
                localStorage.removeItem('desafios_bienestar');
                localStorage.removeItem('logros_bienestar');
                localStorage.removeItem('recursos_bienestar');
                sistemaBienestarEmocional = new SistemaBienestarEmocional();
                mostrarNotificacion(' Datos de bienestar limpiados', 'success');
                cerrarSistemaBienestar();
                setTimeout(() => mostrarSistemaBienestar(), 500);
            }
        }
        
        function abrirBibliotecaRecursos() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999999; overflow-y: auto;';
            modal.innerHTML = `<div style="background: white; border-radius: 16px; padding: 30px; max-width: 800px; width: 90%; margin: 20px;"><h3 style="margin: 0 0 20px; color: #374151;"> Biblioteca de Recursos de Bienestar</h3><div style="max-height: 600px; overflow-y: auto;"><div style="background: #F0FDF4; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #10B981;"><h4 style="margin: 0 0 10px; color: #059669;"> Gesti贸n del Estr茅s</h4><p style="margin: 0; color: #059669;">Aprende t茅cnicas comprobadas para manejar el estr茅s del emprendimiento.</p></div><div style="background: #EEF2FF; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #6366F1;"><h4 style="margin: 0 0 10px; color: #4338CA;"> Mindfulness para Emprendedores</h4><p style="margin: 0; color: #4338CA;">Ejercicios de atenci贸n plena para mantener el enfoque y la calma.</p></div><div style="background: #FEF3C7; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #F59E0B;"><h4 style="margin: 0 0 10px; color: #D97706;"> Resiliencia Empresarial</h4><p style="margin: 0; color: #D97706;">C贸mo recuperarte de los desaf铆os y salir m谩s fuerte.</p></div><div style="background: #FCE7F3; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #EC4899;"><h4 style="margin: 0 0 10px; color: #BE185D;"> Autocuidado sin Culpa</h4><p style="margin: 0; color: #BE185D;">Por qu茅 cuidarte a ti mismo es cuidar tu negocio.</p></div><div style="background: #F0F9FF; padding: 20px; border-radius: 12px; border-left: 4px solid #3B82F6;"><h4 style="margin: 0 0 10px; color: #1E40AF;">锔 Balance Vida-Trabajo</h4><p style="margin: 0; color: #1E40AF;">Estrategias para equilibrar tu vida personal y profesional.</p></div></div><button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 20px;">Cerrar</button></div>`;
            document.body.appendChild(modal);
        }
        
        function configurarMetasPersonales() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999999;';
            modal.innerHTML = `<div style="background: white; border-radius: 16px; padding: 30px; max-width: 600px; width: 90%;"><h3 style="margin: 0 0 20px; color: #374151;"> Metas Personales de Bienestar</h3><div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Meta 1: Estados de nimo</label><input type="number" placeholder="Registros por semana" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div><div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Meta 2: Racha de D铆as</label><input type="number" placeholder="D铆as consecutivos" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div><div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Meta 3: Uso de Recursos</label><input type="number" placeholder="Recursos por semana" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div><div style="background: #F0F9FF; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p style="margin: 0; color: #1E40AF; font-size: 0.9rem;"> Establece metas alcanzables. El progreso constante es m谩s importante que la perfecci贸n.</p></div><button onclick="mostrarNotificacion(' Metas configuradas correctamente', 'success'); this.closest('div[style*=\\'position: fixed\\']').remove()" style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%;">Guardar Metas</button></div>`;
            document.body.appendChild(modal);
        }
        
        function generarReporteBienestar() {
            const stats = sistemaBienestarEmocional.obtenerEstadisticas();
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999999; overflow-y: auto;';
            modal.innerHTML = `<div style="background: white; border-radius: 16px; padding: 30px; max-width: 800px; width: 90%; margin: 20px;"><h3 style="margin: 0 0 20px; color: #374151;"> Reporte Detallado de Bienestar</h3><div style="max-height: 600px; overflow-y: auto;"><div style="background: linear-gradient(135deg, #EEF2FF, #E0E7FF); padding: 30px; border-radius: 12px; margin-bottom: 20px; text-align: center;"><h2 style="margin: 0 0 10px; color: #4338CA; font-size: 3rem;">${stats.totalEstados}</h2><p style="margin: 0; color: #6366F1; font-weight: 600;">Estados Registrados Totales</p></div><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;"><div style="background: #F0FDF4; padding: 20px; border-radius: 12px; text-align: center;"><div style="font-size: 2rem; margin-bottom: 8px;"></div><h3 style="margin: 0; color: #059669; font-size: 1.5rem;">${stats.rachaActual}</h3><p style="margin: 0; color: #059669; font-size: 0.9rem;">Racha Actual</p></div><div style="background: #FEF3C7; padding: 20px; border-radius: 12px; text-align: center;"><div style="font-size: 2rem; margin-bottom: 8px;"></div><h3 style="margin: 0; color: #D97706; font-size: 1.5rem;">${stats.totalLogros}</h3><p style="margin: 0; color: #D97706; font-size: 0.9rem;">Logros</p></div><div style="background: #FCE7F3; padding: 20px; border-radius: 12px; text-align: center;"><div style="font-size: 2rem; margin-bottom: 8px;">猸</div><h3 style="margin: 0; color: #BE185D; font-size: 1.5rem;">${stats.puntosTotales}</h3><p style="margin: 0; color: #BE185D; font-size: 0.9rem;">Puntos</p></div></div><div style="background: #F8FAFC; padding: 20px; border-radius: 12px; margin-bottom: 20px;"><h4 style="margin: 0 0 15px; color: #374151;"> An谩lisis</h4><p style="margin: 0 0 10px; color: #6B7280;"> Tu compromiso con el bienestar es ${stats.totalEstados > 10 ? 'excelente' : stats.totalEstados > 5 ? 'bueno' : 'moderado'}.</p><p style="margin: 0 0 10px; color: #6B7280;"> Mant茅n tu racha de ${stats.rachaActual} d铆as registrando a diario.</p><p style="margin: 0; color: #6B7280;"> Has desbloqueado ${stats.totalLogros} logros. 隆Sigue as铆!</p></div><div style="background: #FEF3C7; padding: 15px; border-radius: 8px; border-left: 4px solid #F59E0B;"><h5 style="color: #92400E; margin: 0 0 10px;"> Recomendaci贸n</h5><p style="color: #92400E; margin: 0; font-size: 0.9rem;">${stats.rachaActual < 3 ? 'Intenta registrar tu estado de 谩nimo diariamente para crear un h谩bito.' : stats.rachaActual < 7 ? 'Vas muy bien! Mant茅n tu racha para desbloquear el logro de 7 d铆as.' : '隆Incre铆ble! Tu constancia es admirable. Sigue cuidando tu bienestar.'}</p></div></div><button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 20px;">Cerrar</button></div>`;
            document.body.appendChild(modal);
        }
        
        function abrirChatCRISLA() {
            const modal = document.createElement('div');
            modal.id = 'modalChatCRISLA';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999999;';
            modal.innerHTML = `<div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; overflow: hidden;"><div style="background: linear-gradient(135deg, #EC4899, #F9A8D4); color: white; padding: 25px; text-align: center; position: relative;"><button onclick="cerrarChatCRISLA()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 18px; width: 36px; height: 36px;"></button><div style="font-size: 3rem; margin-bottom: 10px;"></div><h3 style="margin: 0 0 8px; font-size: 1.3rem;">CRISLA - Respaldo Emocional</h3><p style="margin: 0; opacity: 0.95; font-size: 0.9rem;">Estoy aqu铆 para escucharte</p></div><div style="padding: 30px;"><div style="background: #F8FAFC; padding: 20px; border-radius: 12px; margin-bottom: 20px; max-height: 200px; overflow-y: auto;"><div style="background: #EEF2FF; padding: 15px; border-radius: 12px; margin-bottom: 10px;"><p style="margin: 0; color: #4338CA; font-size: 0.9rem;"><strong>CRISLA:</strong> Hola  驴C贸mo te sientes hoy? Estoy aqu铆 para apoyarte.</p></div></div><form onsubmit="enviarMensajeCRISLA(event)" style="margin-bottom: 20px;"><div style="margin-bottom: 15px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Tu Mensaje</label><textarea id="mensajeCRISLA" required placeholder="Escribe c贸mo te sientes, qu茅 necesitas o cualquier cosa que quieras compartir..." style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem; resize: vertical; min-height: 100px;"></textarea></div><div style="background: #FEF3C7; padding: 15px; border-radius: 8px; margin-bottom: 15px;"><p style="margin: 0; color: #92400E; font-size: 0.85rem;"> Tu mensaje ser谩 guardado de forma privada. CRISLA revisar谩 tu mensaje y te responder谩 lo antes posible.</p></div><button type="submit" style="background: linear-gradient(135deg, #EC4899, #F9A8D4); color: white; border: none; padding: 14px 28px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1rem; width: 100%;"><i class="fas fa-paper-plane"></i> Enviar Mensaje a CRISLA</button></form></div></div>`;
            document.body.appendChild(modal);
        }
        
        function enviarMensajeCRISLA(event) {
            event.preventDefault();
            const mensaje = document.getElementById('mensajeCRISLA').value.trim();
            if (!mensaje) return;
            const mensajes = JSON.parse(localStorage.getItem('mensajes_crisla') || '[]');
            mensajes.push({ mensaje, fecha: new Date().toISOString(), leido: false });
            localStorage.setItem('mensajes_crisla', JSON.stringify(mensajes));
            mostrarNotificacion(' Mensaje enviado a CRISLA. Te responderemos pronto.', 'success');
            cerrarChatCRISLA();
        }
        
        function cerrarChatCRISLA() {
            const modal = document.getElementById('modalChatCRISLA');
            if (modal) modal.remove();
        }
        
        function toggleSistemaBienestarCompleto(activo) {
            sistemaBienestarEmocional.toggleSistema(activo);
            const widget = document.getElementById('widgetBienestar');
            if (widget) widget.style.display = activo ? 'block' : 'none';
            cerrarSistemaBienestar();
            setTimeout(() => mostrarSistemaBienestar(), 500);
        }
        
        function cerrarSistemaBienestar() {
            const modal = document.getElementById('modalBienestarCompleto');
            if (modal) modal.remove();
        }
        
        function guardarDiarioEmocional() {
            const textarea = document.getElementById('diarioEmocional');
            const texto = textarea ? textarea.value.trim() : '';
            if (!texto) { mostrarNotificacion('Por favor escribe algo en tu diario', 'warning'); return; }
            const registros = JSON.parse(localStorage.getItem('diario_emocional') || '[]');
            registros.push({ texto, fecha: new Date().toISOString() });
            localStorage.setItem('diario_emocional', JSON.stringify(registros));
            mostrarNotificacion(' Diario guardado', 'success');
            cerrarModal('modalBienestar');
            if (textarea) textarea.value = '';
        }
        
        function aplicarConfiguracionBienestar() {
            const plan = (localStorage.getItem('plan-actual') || 'free').toLowerCase();
            if (!['free','basic'].includes(plan)) { mostrarNotificacion('癸 El sistema de bienestar est谩 disponible solo para planes FREE y BASIC', 'info'); return; }
            const cfg = { estado: (document.getElementById('estadoBienestar')?.value || 'activo'), privacidad: (document.getElementById('privacidadBienestar')?.value || 'privado') };
            localStorage.setItem('configuracion_bienestar', JSON.stringify(cfg));
            mostrarNotificacion(` Bienestar ${cfg.estado}`, 'success');
            cerrarModal('modalBienestar');
        }
        
        // ============================================
        // SISTEMA DE PAGOS CON MERCADO PAGO
        // Comisiones: FREE 0.8%, BASIC/PRO 1.2%, ENTERPRISE 0.8%
        // Todas las comisiones van a tu cuenta de Mercado Pago
        // ============================================
        
        // Configuraci贸n de Mercado Pago (Usar configuraci贸n global o variables de entorno)
        const MERCADOPAGO_CONFIG = window.CONFIG_MERCADO_PAGO?.production || {
            publicKey: window?.MERCADOPAGO_PUBLIC_KEY || 'CONFIGURAR_EN_VERCEL',
            accessToken: window?.MERCADOPAGO_ACCESS_TOKEN || 'CONFIGURAR_EN_VERCEL'
        };
        
        // Comisiones por plan (igual para todos)
        const COMISIONES_PLANES = {
            'free': 0.008,    // 0.8%
            'basic': 0.012,   // 1.2%
            'pro': 0.012,     // 1.2%
            'enterprise': 0.008 // 0.8%
        };
        
        // Declarar mpInstance primero
        let mpInstance = null;
        
        // Cargar SDK de Mercado Pago
        function inicializarMercadoPago() {
            if (window.MercadoPago) {
                mpInstance = new MercadoPago(MERCADOPAGO_CONFIG.publicKey);
                console.log(' Mercado Pago inicializado correctamente');
            } else {
                console.log(' Esperando SDK de Mercado Pago...');
            }
        }
        
        // Intentar inicializar inmediatamente si ya est谩 cargado
        if (window.MercadoPago) {
            inicializarMercadoPago();
        } else {
            // Cargar SDK si no est谩 disponible
            const script = document.createElement('script');
            script.src = 'https://sdk.mercadopago.com/js/v2';
            script.async = true;
            document.head.appendChild(script);
            script.onload = () => {
                console.log(' Mercado Pago SDK cargado');
                inicializarMercadoPago();
            };
        }
        
        // Funci贸n para procesar pago de suscripci贸n
        function procesarPagoSuscripcion(planId) {
            const planActual = localStorage.getItem('plan-actual') || 'free';
            const planes = {
                'free': { nombre: 'FREE', precio: 0 },
                'basic': { nombre: 'BASIC', precio: 29000 },
                'pro': { nombre: 'PRO', precio: 79000 },
                'enterprise': { nombre: 'ENTERPRISE', precio: 199000 }
            };
            
            const plan = planes[planId];
            if (!plan) {
                mostrarNotificacion('Plan no v谩lido', 'error');
                return;
            }
            
            const comision = COMISIONES_PLANES[planId] || 0.012;
            const total = plan.precio;
            const comisionCresalia = total * comision;
            
            // Guardar plan pendiente antes de procesar el pago
            localStorage.setItem('plan_pendiente', planId);
            
            crearPreferenciaMercadoPago({
                title: `Suscripci贸n ${plan.nombre} - Cresalia`,
                price: total,
                tipo: 'suscripcion',
                planId: planId,
                comision: comisionCresalia
            });
        }
        
        // Funci贸n para procesar pago de producto/servicio
        function procesarPagoProducto(producto, monto, metodo = 'mercadopago') {
            const planActual = localStorage.getItem('plan-actual') || 'free';
            const comision = COMISIONES_PLANES[planActual] || 0.012;
            const comisionCresalia = monto * comision;
            const montoVendedor = monto - comisionCresalia;
            
            if (metodo === 'qr') {
                generarQRMercadoPago({
                    title: producto.nombre || 'Producto',
                    price: monto,
                    tipo: 'producto',
                    productoId: producto.id,
                    comision: comisionCresalia,
                    montoVendedor: montoVendedor
                });
            } else {
                crearPreferenciaMercadoPago({
                    title: producto.nombre || 'Producto',
                    price: monto,
                    tipo: 'producto',
                    productoId: producto.id,
                    comision: comisionCresalia,
                    montoVendedor: montoVendedor
                });
            }
        }
        
        // Crear preferencia de pago (para suscripciones y productos)
        function crearPreferenciaMercadoPago(datos) {
            const preferencia = {
                items: [{
                    title: datos.title,
                    quantity: 1,
                    unit_price: datos.price,
                    currency_id: 'ARS'
                }],
                back_urls: {
                    success: window.location.origin + '/success.html?tipo=' + datos.tipo,
                    failure: window.location.origin + '/failure.html',
                    pending: window.location.origin + '/pending.html'
                },
                auto_return: 'approved',
                external_reference: `cresalia_${datos.tipo}_${datos.planId || datos.productoId}_${Date.now()}`,
                notification_url: window.location.origin + '/webhook-mercadopago',
                statement_descriptor: 'CRESALIA',
                payment_methods: {
                    excluded_payment_methods: [],
                    excluded_payment_types: [],
                    installments: 12
                }
            };
            
            // Agregar comoneya para QR
            preferencia.payment_methods_id = ['account_money'];
            
            fetch('https://api.mercadopago.com/checkout/preferences', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${MERCADOPAGO_CONFIG.accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(preferencia)
            })
            .then(response => response.json())
            .then(data => {
                if (data.id) {
                    // Guardar datos de pago para webhook
                    localStorage.setItem('ultima_preferencia_pago', JSON.stringify({
                        ...datos,
                        preferenceId: data.id,
                        fecha: new Date().toISOString()
                    }));
                    
                    // Redirigir seg煤n m茅todo
                    if (datos.metodo === 'qr' && data.qr_code_base64) {
                        mostrarQRPago(data.qr_code_base64, datos);
                    } else if (data.point_of_interaction && data.point_of_interaction.transaction_data && data.point_of_interaction.transaction_data.qr_code_base64) {
                        mostrarQRPago(data.point_of_interaction.transaction_data.qr_code_base64, datos);
                    } else if (data.init_point) {
                        window.location.href = data.init_point;
                    }
                } else {
                    mostrarNotificacion(' Error al crear preferencia de pago', 'error');
                    console.error('Error MercadoPago:', data);
                }
            })
            .catch(error => {
                console.error('Error MercadoPago:', error);
                mostrarNotificacion(' Error de conexi贸n con MercadoPago', 'error');
            });
        }
        
        // Generar QR para pagos (Mercado seg煤n Pago Point)
        function generarQRMercadoPago(datos) {
            // Para QR, crear pago directamente con Mercado Pago Point
            const pagoQR = {
                transaction_amount: datos.price,
                description: datos.title,
                payment_method_id: 'account_money',
                payer: {
                    email: 'comprador@cresalia.com' // Se actualiza con el email real
                }
            };
            
            fetch('https://api.mercadopago.com/v1/payments', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${MERCADOPAGO_CONFIG.accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(pagoQR)
            })
            .then(response => response.json())
            .then(data => {
                if (data.point_of_interaction && data.point_of_interaction.transaction_data && data.point_of_interaction.transaction_data.qr_code_base64) {
                    mostrarQRPago(data.point_of_interaction.transaction_data.qr_code_base64, datos);
                } else {
                    // Si no hay QR, crear preferencia normal
                    crearPreferenciaMercadoPago(datos);
                }
            })
            .catch(error => {
                console.error('Error creando pago QR:', error);
                // Fallback a preferencia normal
                crearPreferenciaMercadoPago(datos);
            });
        }
        
        // Mostrar modal con QR
        function mostrarQRPago(qrCode, datos) {
            const modal = document.createElement('div');
            modal.id = 'modalQRPago';
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px; text-align: center;">
                    <button class="close-btn" onclick="cerrarModal('modalQRPago')"></button>
                    <h2><i class="fas fa-qrcode"></i> Escanea el QR para pagar</h2>
                    <div style="background: white; padding: 20px; border-radius: 12px; margin: 20px 0;">
                        <img src="${qrCode}" alt="QR de pago" style="max-width: 100%;">
                    </div>
                    <p><strong>Monto:</strong> $${datos.price.toFixed(2)}</p>
                    <p><strong>Comisi贸n Cresalia:</strong> $${datos.comision.toFixed(2)}</p>
                    ${datos.montoVendedor ? `<p><strong>Recibir谩s:</strong> $${datos.montoVendedor.toFixed(2)}</p>` : ''}
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="cerrarModal('modalQRPago')">Cerrar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Validaci贸n de tarjeta (anti-fraude)
        function validarTarjeta(numero, cvv, nombre, vencimiento) {
            // Validar formato de tarjeta (Luhn)
            if (!validarLuhn(numero)) {
                return { valida: false, error: 'N煤mero de tarjeta inv谩lido' };
            }
            
            // Validar CVV
            if (!/^\d{3,4}$/.test(cvv)) {
                return { valida: false, error: 'CVV inv谩lido' };
            }
            
            // Validar vencimiento
            const [mes, ano] = vencimiento.split('/');
            const hoy = new Date();
            const fechaVenc = new Date(2000 + parseInt(ano), parseInt(mes) - 1);
            if (fechaVenc < hoy) {
                return { valida: false, error: 'Tarjeta vencida' };
            }
            
            // Validar nombre (anti-robo identidad)
            if (!nombre || nombre.trim().length < 3) {
                return { valida: false, error: 'Nombre inv谩lido' };
            }
            
            // Detectar patrones sospechosos
            const tarjetasBloqueadas = localStorage.getItem('tarjetas_bloqueadas') || '[]';
            const bloqueadas = JSON.parse(tarjetasBloqueadas);
            if (bloqueadas.some(t => t.numero === numero.slice(-4))) {
                return { valida: false, error: 'Tarjeta bloqueada por seguridad' };
            }
            
            return { valida: true };
        }
        
        // Algoritmo de Luhn para validar tarjeta
        function validarLuhn(numero) {
            numero = numero.replace(/\D/g, '');
            let suma = 0;
            let esPar = false;
            
            for (let i = numero.length - 1; i >= 0; i--) {
                let digito = parseInt(numero[i]);
                
                if (esPar) {
                    digito *= 2;
                    if (digito > 9) digito -= 9;
                }
                
                suma += digito;
                esPar = !esPar;
            }
            
            return suma % 10 === 0;
        }
        
        // Actualizar funci贸n guardarConfiguracionPagos
        function guardarConfiguracionPagos() {
            const form = document.getElementById('formSistemaPagos');
            const formData = new FormData(form);
            const configuracion = Object.fromEntries(formData);
            
            // Validar que Mercado Pago est茅 configurado
            if (!MERCADOPAGO_CONFIG.accessToken) {
                mostrarNotificacion('锔 Configura primero tus claves de Mercado Pago', 'warning');
                return;
            }
            
            localStorage.setItem('configuracion_pagos', JSON.stringify({
                ...configuracion,
                mercadopago_configurado: true,
                fecha_configuracion: new Date().toISOString()
            }));
            
            mostrarNotificacion(' Configuraci贸n de pagos guardada. Todas las comisiones ir谩n a tu cuenta de Mercado Pago.', 'success');
            cerrarModal('modalSistemaPagos');
        }
        
        // ============================================
        // SISTEMA DE NOTIFICACIONES
        // ============================================
        
        function mostrarNotificacion(mensaje, tipo = 'info') {
            const notificacion = document.createElement('div');
            notificacion.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                max-width: 300px;
            `;
            
            const colores = {
                success: 'background: linear-gradient(135deg, #10B981, #059669);',
                error: 'background: linear-gradient(135deg, #EF4444, #DC2626);',
                warning: 'background: linear-gradient(135deg, #F59E0B, #D97706);',
                info: 'background: linear-gradient(135deg, #3B82F6, #1D4ED8);'
            };
            
            notificacion.style.cssText += colores[tipo] || colores.info;
            notificacion.textContent = mensaje;
            
            if (document.body) {
                document.body.appendChild(notificacion);
            }
            
            setTimeout(() => {
                notificacion.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notificacion.parentNode) {
                        notificacion.parentNode.removeChild(notificacion);
                    }
                }, 300);
            }, 3000);
        }
        
        // ============================================
        // FUNCIONES DE FORMULARIOS
        // ============================================
        
        function mostrarFormularioProducto() {
            abrirModal('modalAgregarProducto');
        }
        
        function mostrarFormularioServicio() {
            abrirModal('modalAgregarServicio');
        }
        
        // Event listeners para formularios
        document.addEventListener('DOMContentLoaded', function() {
            const formProducto = document.getElementById('formAgregarProducto');
            if (formProducto) {
                formProducto.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const nombre = document.getElementById('nombreProducto').value;
                    const precio = document.getElementById('precioProducto').value;
                    const stock = document.getElementById('stockProducto').value;
                    
                    if (nombre && precio && stock) {
                        mostrarNotificacion(`Producto "${nombre}" agregado correctamente`, 'success');
                        cerrarModal('modalAgregarProducto');
                        formProducto.reset();
                    } else {
                        mostrarNotificacion('Por favor completa todos los campos', 'warning');
                    }
                });
            }
            
            const formServicio = document.getElementById('formAgregarServicio');
            if (formServicio) {
                formServicio.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const nombre = document.getElementById('nombreServicio').value;
                    const precio = document.getElementById('precioServicio').value;
                    const duracion = document.getElementById('duracionServicio').value;
                    
                    if (nombre && precio && duracion) {
                        mostrarNotificacion(`Servicio "${nombre}" agregado correctamente`, 'success');
                        cerrarModal('modalAgregarServicio');
                        formServicio.reset();
                    } else {
                        mostrarNotificacion('Por favor completa todos los campos', 'warning');
                    }
                });
            }
        });
        
        // ============================================
        // FUNCIN PARA ABRIR COMUNIDAD DE VENDEDORES
        // ============================================
        
        function abrirComunidadVendedores() {
            const modal = document.createElement('div');
            modal.id = 'modalComunidadVendedores';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 0; border-radius: 16px; max-width: 95%; width: 1400px; max-height: 90vh; overflow: hidden; position: relative; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);">
                    <div style="position: absolute; top: 15px; right: 15px; z-index: 10001;">
                        <button onclick="cerrarModalComunidad()" style="background: #6B7280; color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 24px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: all 0.3s ease;">
                            
                        </button>
                    </div>
                    <iframe id="iframeComunidadModal" 
                            src="../../panel-comunidad-vendedores.html" 
                            style="width: 100%; height: 90vh; border: none; border-radius: 16px; background: white;" 
                            frameborder="0" 
                            allowtransparency="true">
                    </iframe>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
            
            // Cerrar al hacer click fuera
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    cerrarModalComunidad();
                }
            });
            
            // Cerrar con Escape
            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    cerrarModalComunidad();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }
        
        function cerrarModalComunidad() {
            const modal = document.getElementById('modalComunidadVendedores');
            if (modal) {
                modal.remove();
                document.body.style.overflow = 'auto';
            }
        }
        
        // Funci贸n para limpiar el iframe de la comunidad
        function limpiarIframeComunidad(iframe) {
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                // DESACTIVADA TEMPORALMENTE - No hacer limpieza agresiva
                // La comunidad ya tiene su propia limpieza interna
                console.log(' Iframe de comunidad cargado correctamente');
                
            } catch (e) {
                console.warn('锔 No se pudo acceder al contenido del iframe (CORS):', e);
            }
        }
        
        // ============================================
        // FUNCIONES DE SISTEMAS (PLACEHOLDERS)
        // ============================================
        
        function abrirSistemaPagos() {
            abrirModal('modalSistemaPagos');
        }
        
        function abrirConfiguracionAgradecimiento() {
            abrirModal('modalConfiguracionAgradecimiento');
        }
        
        function abrirConfiguracionMediosPago() {
            abrirModal('modalMediosPago');
        }
        
        function abrirGestionFeedbacksTienda() {
            abrirModal('modalGestionFeedbacks');
        }
        
        function abrirGestionPuntosComunes() {
            abrirModal('modalPuntosComunes');
        }
        
        function abrirConfiguracionEnviosDomicilio() {
            abrirModal('modalEnviosDomicilio');
        }
        
        // ============================================
        // SISTEMA DE HISTORIAL DE VENTAS Y TURNOS
        // ============================================
        
        class SistemaHistorialVentasTurnos {
            constructor() {
                this.ventas = this.cargarVentas();
                this.turnos = this.cargarTurnos();
                this.configuracion = this.cargarConfiguracion();
            }
            
            cargarVentas() {
                return JSON.parse(localStorage.getItem('historial_ventas') || '[]');
            }
            
            cargarTurnos() {
                return JSON.parse(localStorage.getItem('historial_turnos') || '[]');
            }
            
            cargarConfiguracion() {
                const config = JSON.parse(localStorage.getItem('configuracion_historial') || '{}');
                return {
                    mostrarDetalles: config.mostrarDetalles !== false,
                    exportarDatos: config.exportarDatos || false,
                    notificacionesVentas: config.notificacionesVentas !== false,
                    notificacionesTurnos: config.notificacionesTurnos !== false,
                    diasRetencion: config.diasRetencion || 365
                };
            }
            
            guardarVentas() {
                localStorage.setItem('historial_ventas', JSON.stringify(this.ventas));
            }
            
            guardarTurnos() {
                localStorage.setItem('historial_turnos', JSON.stringify(this.turnos));
            }
            
            guardarConfiguracion() {
                localStorage.setItem('configuracion_historial', JSON.stringify(this.configuracion));
                mostrarNotificacion(' Configuraci贸n de historial guardada', 'success');
            }
            
            agregarVenta(venta) {
                const nuevaVenta = {
                    id: Date.now().toString(),
                    cliente: venta.cliente,
                    producto: venta.producto,
                    cantidad: venta.cantidad,
                    precio: venta.precio,
                    total: venta.total,
                    fecha: new Date().toISOString(),
                    estado: venta.estado || 'completada',
                    metodoPago: venta.metodoPago || 'efectivo',
                    notas: venta.notas || ''
                };
                this.ventas.unshift(nuevaVenta);
                this.guardarVentas();
                return nuevaVenta;
            }
            
            agregarTurno(turno) {
                const nuevoTurno = {
                    id: Date.now().toString(),
                    cliente: turno.cliente,
                    servicio: turno.servicio,
                    fecha: turno.fecha,
                    hora: turno.hora,
                    estado: turno.estado || 'programado',
                    notas: turno.notas || '',
                    fechaCreacion: new Date().toISOString()
                };
                this.turnos.unshift(nuevoTurno);
                this.guardarTurnos();
                return nuevoTurno;
            }
            
            obtenerEstadisticasVentas() {
                const total = this.ventas.length;
                const completadas = this.ventas.filter(v => v.estado === 'completada').length;
                const pendientes = this.ventas.filter(v => v.estado === 'pendiente').length;
                const totalIngresos = this.ventas.reduce((sum, v) => sum + (parseFloat(v.total) || 0), 0);
                return { total, completadas, pendientes, totalIngresos };
            }
            
            obtenerEstadisticasTurnos() {
                const total = this.turnos.length;
                const programados = this.turnos.filter(t => t.estado === 'programado').length;
                const completados = this.turnos.filter(t => t.estado === 'completado').length;
                const cancelados = this.turnos.filter(t => t.estado === 'cancelado').length;
                return { total, programados, completados, cancelados };
            }
            
            filtrarVentas(filtro) {
                let ventasFiltradas = [...this.ventas];
                if (filtro.fechaDesde) {
                    ventasFiltradas = ventasFiltradas.filter(v => new Date(v.fecha) >= new Date(filtro.fechaDesde));
                }
                if (filtro.fechaHasta) {
                    ventasFiltradas = ventasFiltradas.filter(v => new Date(v.fecha) <= new Date(filtro.fechaHasta));
                }
                if (filtro.estado) {
                    ventasFiltradas = ventasFiltradas.filter(v => v.estado === filtro.estado);
                }
                if (filtro.cliente) {
                    ventasFiltradas = ventasFiltradas.filter(v => v.cliente.toLowerCase().includes(filtro.cliente.toLowerCase()));
                }
                return ventasFiltradas;
            }
            
            filtrarTurnos(filtro) {
                let turnosFiltrados = [...this.turnos];
                if (filtro.fechaDesde) {
                    turnosFiltrados = turnosFiltrados.filter(t => new Date(t.fecha) >= new Date(filtro.fechaDesde));
                }
                if (filtro.fechaHasta) {
                    turnosFiltrados = turnosFiltrados.filter(t => new Date(t.fecha) <= new Date(filtro.fechaHasta));
                }
                if (filtro.estado) {
                    turnosFiltrados = turnosFiltrados.filter(t => t.estado === filtro.estado);
                }
                if (filtro.cliente) {
                    turnosFiltrados = turnosFiltrados.filter(t => t.cliente.toLowerCase().includes(filtro.cliente.toLowerCase()));
                }
                return turnosFiltrados;
            }
        }
        
        // Instancia global
        let sistemaHistorialVentasTurnos = new SistemaHistorialVentasTurnos();
        
        function abrirHistorialVentasTurnos() {
            console.log(' Abriendo historial de ventas y turnos...');
            
            // Cerrar cualquier modal de historial existente antes de abrir uno nuevo
            const modalExistente = document.getElementById('modalHistorialVentasTurnos');
            if (modalExistente) {
                modalExistente.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'modalHistorialVentasTurnos';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            
            // Cerrar modal al hacer click fuera
            modal.onclick = function(e) {
                if (e.target === modal) {
                    cerrarHistorialVentasTurnos();
                }
            };
            
            const estadisticasVentas = sistemaHistorialVentasTurnos.obtenerEstadisticasVentas();
            const estadisticasTurnos = sistemaHistorialVentasTurnos.obtenerEstadisticasTurnos();
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #6366F1, #4F46E5); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarHistorialVentasTurnos()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;"></div>
                        <h2 style="margin: 0;">Historial de Ventas y Turnos</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Seguimiento completo de tu negocio</p>
                    </div>
                    
                    <div style="padding: 32px;">
                        <!-- Estad铆sticas Generales -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #F0F9FF; padding: 20px; border-radius: 12px; border: 1px solid #BAE6FD; text-align: center;">
                                <div style="font-size: 2rem; color: #0369A1; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #0369A1; font-size: 1.5rem;">$${estadisticasVentas.totalIngresos.toLocaleString()}</h3>
                                <p style="margin: 0; color: #0369A1; font-size: 0.9rem;">Total Ingresos</p>
                            </div>
                            <div style="background: #F0FDF4; padding: 20px; border-radius: 12px; border: 1px solid #BBF7D0; text-align: center;">
                                <div style="font-size: 2rem; color: #166534; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #166534; font-size: 1.5rem;">${estadisticasVentas.total}</h3>
                                <p style="margin: 0; color: #166534; font-size: 0.9rem;">Total Ventas</p>
                            </div>
                            <div style="background: #FEF3C7; padding: 20px; border-radius: 12px; border: 1px solid #FDE68A; text-align: center;">
                                <div style="font-size: 2rem; color: #92400E; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #92400E; font-size: 1.5rem;">${estadisticasTurnos.total}</h3>
                                <p style="margin: 0; color: #92400E; font-size: 0.9rem;">Total Turnos</p>
                            </div>
                            <div style="background: #FEF2F2; padding: 20px; border-radius: 12px; border: 1px solid #FECACA; text-align: center;">
                                <div style="font-size: 2rem; color: #DC2626; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #DC2626; font-size: 1.5rem;">${estadisticasVentas.pendientes + estadisticasTurnos.programados}</h3>
                                <p style="margin: 0; color: #DC2626; font-size: 0.9rem;">Pendientes</p>
                            </div>
                        </div>
                        
                        <!-- Pesta帽as -->
                        <div style="display: flex; gap: 8px; margin-bottom: 30px; border-bottom: 2px solid #E5E7EB;">
                            <button onclick="mostrarTabHistorial('ventas')" id="tabVentas" style="background: #6366F1; color: white; border: none; padding: 12px 24px; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600;"> Ventas</button>
                            <button onclick="mostrarTabHistorial('turnos')" id="tabTurnos" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 24px; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600;"> Turnos</button>
                        </div>
                        
                        <!-- Contenido de Ventas -->
                        <div id="contenidoVentas" style="display: block;">
                            <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                                <h3 style="margin: 0 0 20px; color: #374151;"> Historial de Ventas</h3>
                                <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #E5E7EB; margin-bottom: 20px;">
                                    <h4 style="margin: 0 0 15px; color: #374151;"> Filtros</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                        <div><label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Fecha Desde</label><input type="date" id="fechaDesdeVentas" style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;"></div>
                                        <div><label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Fecha Hasta</label><input type="date" id="fechaHastaVentas" style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;"></div>
                                        <div><label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Estado</label><select id="estadoVentas" style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;"><option value="">Todos</option><option value="completada">Completada</option><option value="pendiente">Pendiente</option><option value="cancelada">Cancelada</option></select></div>
                                        <div><label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Cliente</label><input type="text" id="clienteVentas" placeholder="Buscar cliente..." style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;"></div>
                                    </div>
                                    <div style="display: flex; gap: 12px;"><button onclick="aplicarFiltrosVentas()" style="background: #6366F1; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Aplicar Filtros</button><button onclick="limpiarFiltrosVentas()" style="background: #6B7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Limpiar</button></div>
                                </div>
                                <div id="listaVentasHistorial" style="max-height: 400px; overflow-y: auto;">
                                    ${sistemaHistorialVentasTurnos.ventas.length > 0 ? sistemaHistorialVentasTurnos.ventas.map(venta => `
                                        <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                                <div style="flex: 1;"><h4 style="margin: 0; color: #374151; font-size: 1.1rem;">${venta.cliente}</h4><p style="margin: 5px 0; color: #6B7280; font-size: 0.9rem;">${venta.producto || 'Producto'} x${venta.cantidad || 1}</p><p style="margin: 0; color: #6B7280; font-size: 0.9rem;">${new Date(venta.fecha).toLocaleDateString('es-ES')}</p></div>
                                                <div style="text-align: right;"><h3 style="margin: 0; color: #10B981; font-size: 1.2rem;">$${parseFloat(venta.total || 0).toLocaleString()}</h3><span style="background: ${venta.estado === 'completada' ? '#10B981' : venta.estado === 'pendiente' ? '#F59E0B' : '#DC2626'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${(venta.estado || 'completada').charAt(0).toUpperCase() + (venta.estado || 'completada').slice(1)}</span></div>
                                            </div>
                                        </div>
                                    `).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No hay ventas registradas a煤n</p></div>'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Contenido de Turnos -->
                        <div id="contenidoTurnos" style="display: none;">
                            <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                                <h3 style="margin: 0 0 20px; color: #374151;"> Historial de Turnos</h3>
                                <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #E5E7EB; margin-bottom: 20px;">
                                    <h4 style="margin: 0 0 15px; color: #374151;"> Filtros</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                        <div><label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Fecha Desde</label><input type="date" id="fechaDesdeTurnos" style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;"></div>
                                        <div><label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Fecha Hasta</label><input type="date" id="fechaHastaTurnos" style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;"></div>
                                        <div><label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Estado</label><select id="estadoTurnos" style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;"><option value="">Todos</option><option value="programado">Programado</option><option value="completado">Completado</option><option value="cancelado">Cancelado</option></select></div>
                                        <div><label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Cliente</label><input type="text" id="clienteTurnos" placeholder="Buscar cliente..." style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;"></div>
                                    </div>
                                    <div style="display: flex; gap: 12px;"><button onclick="aplicarFiltrosTurnos()" style="background: #6366F1; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Aplicar Filtros</button><button onclick="limpiarFiltrosTurnos()" style="background: #6B7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Limpiar</button></div>
                                </div>
                                <div id="listaTurnosHistorial" style="max-height: 400px; overflow-y: auto;">
                                    ${sistemaHistorialVentasTurnos.turnos.length > 0 ? sistemaHistorialVentasTurnos.turnos.map(turno => `
                                        <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                                <div style="flex: 1;"><h4 style="margin: 0; color: #374151; font-size: 1.1rem;">${turno.cliente || 'Cliente'}</h4><p style="margin: 5px 0; color: #6B7280; font-size: 0.9rem;">${turno.servicio || 'Servicio'}</p><p style="margin: 0; color: #6B7280; font-size: 0.9rem;">${new Date(turno.fecha || Date.now()).toLocaleDateString('es-ES')} - ${turno.hora || ''}</p></div>
                                                <div style="text-align: right;"><span style="background: ${turno.estado === 'completado' ? '#10B981' : turno.estado === 'programado' ? '#3B82F6' : '#DC2626'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${(turno.estado || 'programado').charAt(0).toUpperCase() + (turno.estado || 'programado').slice(1)}</span></div>
                                            </div>
                                        </div>
                                    `).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No hay turnos registrados a煤n</p></div>'}
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 16px; justify-content: center; margin-top: 30px;">
                            <button onclick="cerrarHistorialVentasTurnos()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function cerrarHistorialVentasTurnos() {
            const modal = document.getElementById('modalHistorialVentasTurnos');
            if (modal) modal.remove();
        }
        
        function mostrarTabHistorial(tab) {
            const contenidoVentas = document.getElementById('contenidoVentas');
            const contenidoTurnos = document.getElementById('contenidoTurnos');
            const tabVentas = document.getElementById('tabVentas');
            const tabTurnos = document.getElementById('tabTurnos');
            
            if (contenidoVentas && contenidoTurnos && tabVentas && tabTurnos) {
                contenidoVentas.style.display = tab === 'ventas' ? 'block' : 'none';
                contenidoTurnos.style.display = tab === 'turnos' ? 'block' : 'none';
                tabVentas.style.background = tab === 'ventas' ? '#6366F1' : '#E5E7EB';
                tabVentas.style.color = tab === 'ventas' ? 'white' : '#374151';
                tabTurnos.style.background = tab === 'turnos' ? '#6366F1' : '#E5E7EB';
                tabTurnos.style.color = tab === 'turnos' ? 'white' : '#374151';
            }
        }
        
        function aplicarFiltrosVentas() {
            const filtro = {
                fechaDesde: document.getElementById('fechaDesdeVentas')?.value || '',
                fechaHasta: document.getElementById('fechaHastaVentas')?.value || '',
                estado: document.getElementById('estadoVentas')?.value || '',
                cliente: document.getElementById('clienteVentas')?.value || ''
            };
            const ventasFiltradas = sistemaHistorialVentasTurnos.filtrarVentas(filtro);
            mostrarVentasFiltradas(ventasFiltradas);
        }
        
        function aplicarFiltrosTurnos() {
            const filtro = {
                fechaDesde: document.getElementById('fechaDesdeTurnos')?.value || '',
                fechaHasta: document.getElementById('fechaHastaTurnos')?.value || '',
                estado: document.getElementById('estadoTurnos')?.value || '',
                cliente: document.getElementById('clienteTurnos')?.value || ''
            };
            const turnosFiltrados = sistemaHistorialVentasTurnos.filtrarTurnos(filtro);
            mostrarTurnosFiltrados(turnosFiltrados);
        }
        
        function limpiarFiltrosVentas() {
            const fechaDesde = document.getElementById('fechaDesdeVentas');
            const fechaHasta = document.getElementById('fechaHastaVentas');
            const estado = document.getElementById('estadoVentas');
            const cliente = document.getElementById('clienteVentas');
            if (fechaDesde) fechaDesde.value = '';
            if (fechaHasta) fechaHasta.value = '';
            if (estado) estado.value = '';
            if (cliente) cliente.value = '';
            mostrarVentasFiltradas(sistemaHistorialVentasTurnos.ventas);
        }
        
        function limpiarFiltrosTurnos() {
            const fechaDesde = document.getElementById('fechaDesdeTurnos');
            const fechaHasta = document.getElementById('fechaHastaTurnos');
            const estado = document.getElementById('estadoTurnos');
            const cliente = document.getElementById('clienteTurnos');
            if (fechaDesde) fechaDesde.value = '';
            if (fechaHasta) fechaHasta.value = '';
            if (estado) estado.value = '';
            if (cliente) cliente.value = '';
            mostrarTurnosFiltrados(sistemaHistorialVentasTurnos.turnos);
        }
        
        function mostrarVentasFiltradas(ventas) {
            const lista = document.getElementById('listaVentasHistorial');
            if (!lista) return;
            lista.innerHTML = ventas.length > 0 ? ventas.map(venta => `
                <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div style="flex: 1;"><h4 style="margin: 0; color: #374151; font-size: 1.1rem;">${venta.cliente || 'Cliente'}</h4><p style="margin: 5px 0; color: #6B7280; font-size: 0.9rem;">${venta.producto || 'Producto'} x${venta.cantidad || 1}</p><p style="margin: 0; color: #6B7280; font-size: 0.9rem;">${new Date(venta.fecha || Date.now()).toLocaleDateString('es-ES')}</p></div>
                        <div style="text-align: right;"><h3 style="margin: 0; color: #10B981; font-size: 1.2rem;">$${parseFloat(venta.total || 0).toLocaleString()}</h3><span style="background: ${venta.estado === 'completada' ? '#10B981' : venta.estado === 'pendiente' ? '#F59E0B' : '#DC2626'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${(venta.estado || 'completada').charAt(0).toUpperCase() + (venta.estado || 'completada').slice(1)}</span></div>
                    </div>
                </div>
            `).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No se encontraron ventas</p></div>';
        }
        
        function mostrarTurnosFiltrados(turnos) {
            const lista = document.getElementById('listaTurnosHistorial');
            if (!lista) return;
            lista.innerHTML = turnos.length > 0 ? turnos.map(turno => `
                <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div style="flex: 1;"><h4 style="margin: 0; color: #374151; font-size: 1.1rem;">${turno.cliente || 'Cliente'}</h4><p style="margin: 5px 0; color: #6B7280; font-size: 0.9rem;">${turno.servicio || 'Servicio'}</p><p style="margin: 0; color: #6B7280; font-size: 0.9rem;">${new Date(turno.fecha || Date.now()).toLocaleDateString('es-ES')} - ${turno.hora || ''}</p></div>
                        <div style="text-align: right;"><span style="background: ${turno.estado === 'completado' ? '#10B981' : turno.estado === 'programado' ? '#3B82F6' : '#DC2626'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${(turno.estado || 'programado').charAt(0).toUpperCase() + (turno.estado || 'programado').slice(1)}</span></div>
                    </div>
                </div>
            `).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No se encontraron turnos</p></div>';
        }

        function abrirResponderFeedback(cliente, comentario) {
            const c = document.getElementById('clienteFeedback');
            const co = document.getElementById('comentarioOriginal');
            if (c && co) {
                c.value = cliente;
                co.value = comentario;
            }
            abrirModal('modalResponderFeedback');
        }

        function enviarRespuestaFeedback() {
            const form = document.getElementById('formResponderFeedback');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            const respuestas = JSON.parse(localStorage.getItem('respuestas_feedbacks') || '[]');
            respuestas.push({ ...data, fecha: new Date().toISOString() });
            localStorage.setItem('respuestas_feedbacks', JSON.stringify(respuestas));
            mostrarNotificacion(' Respuesta enviada al feedback', 'success');
            cerrarModal('modalResponderFeedback');
        }
        
        // ============================================
        // FUNCIONES DE GUARDADO DE FORMULARIOS
        // ============================================
        
        function guardarConfiguracionPagos() {
            const form = document.getElementById('formSistemaPagos');
            const formData = new FormData(form);
            const configuracion = Object.fromEntries(formData);
            
            localStorage.setItem('configuracion_pagos', JSON.stringify(configuracion));
            mostrarNotificacion(' Configuraci贸n de pagos guardada', 'success');
            cerrarModal('modalSistemaPagos');
        }
        
        function guardarConfiguracionAgradecimiento() {
            const form = document.getElementById('formConfiguracionAgradecimiento');
            const formData = new FormData(form);
            const configuracion = Object.fromEntries(formData);
            
            localStorage.setItem('configuracion_agradecimiento', JSON.stringify(configuracion));
            mostrarNotificacion(' Configuraci贸n de agradecimientos guardada', 'success');
            cerrarModal('modalConfiguracionAgradecimiento');
        }
        
        function guardarMediosPago() {
            const form = document.getElementById('formMediosPago');
            const formData = new FormData(form);
            const configuracion = Object.fromEntries(formData);
            
            localStorage.setItem('configuracion_medios_pago', JSON.stringify(configuracion));
            mostrarNotificacion(' Configuraci贸n de medios de pago guardada', 'success');
            cerrarModal('modalMediosPago');
        }
        
        function guardarConfiguracionFeedbacks() {
            const form = document.getElementById('formGestionFeedbacks');
            const formData = new FormData(form);
            const configuracion = Object.fromEntries(formData);
            
            localStorage.setItem('configuracion_feedbacks', JSON.stringify(configuracion));
            mostrarNotificacion(' Configuraci贸n de feedbacks guardada', 'success');
            cerrarModal('modalGestionFeedbacks');
        }
        
        function guardarConfiguracionPuntos() {
            const form = document.getElementById('formPuntosComunes');
            const formData = new FormData(form);
            const configuracion = Object.fromEntries(formData);
            
            localStorage.setItem('configuracion_puntos', JSON.stringify(configuracion));
            mostrarNotificacion(' Configuraci贸n de puntos guardada', 'success');
            cerrarModal('modalPuntosComunes');
        }
        
        function guardarConfiguracionEnvios() {
            const form = document.getElementById('formEnviosDomicilio');
            const formData = new FormData(form);
            const configuracion = Object.fromEntries(formData);
            
            localStorage.setItem('configuracion_envios', JSON.stringify(configuracion));
            mostrarNotificacion(' Configuraci贸n de env铆os guardada', 'success');
            cerrarModal('modalEnviosDomicilio');
        }
        
        // ============================================
        // SISTEMA DE HISTORIAL DE SESIONES
        // ============================================
        
        class SistemaHistorialSesiones {
            constructor() {
                this.sesiones = this.cargarSesiones();
                this.configuracion = this.cargarConfiguracion();
            }
            
            cargarSesiones() {
                return JSON.parse(localStorage.getItem('historial_sesiones') || '[]');
            }
            
            cargarConfiguracion() {
                const config = JSON.parse(localStorage.getItem('configuracion_sesiones') || '{}');
                return {
                    mostrarDetalles: config.mostrarDetalles !== false,
                    notificacionesAcceso: config.notificacionesAcceso !== false,
                    diasRetencion: config.diasRetencion || 90,
                    alertarAccesosSospechosos: config.alertarAccesosSospechosos !== false,
                    mostrarUbicacion: config.mostrarUbicacion || false
                };
            }
            
            guardarSesiones() {
                localStorage.setItem('historial_sesiones', JSON.stringify(this.sesiones));
            }
            
            guardarConfiguracion() {
                localStorage.setItem('configuracion_sesiones', JSON.stringify(this.configuracion));
                mostrarNotificacion(' Configuraci贸n de sesiones guardada', 'success');
            }
            
            registrarSesion(datos) {
                const nuevaSesion = {
                    id: Date.now().toString(),
                    fecha: new Date().toISOString(),
                    hora: new Date().toLocaleTimeString('es-ES'),
                    fechaCompleta: new Date().toLocaleString('es-ES'),
                    ip: datos.ip || 'No disponible',
                    navegador: datos.navegador || navigator.userAgent,
                    sistemaOperativo: datos.sistemaOperativo || 'No disponible',
                    ubicacion: datos.ubicacion || 'No disponible',
                    dispositivo: datos.dispositivo || 'No disponible',
                    estado: 'exitoso',
                    duracionSesion: 0,
                    accionesRealizadas: [],
                    notas: datos.notas || ''
                };
                this.sesiones.unshift(nuevaSesion);
                this.guardarSesiones();
                this.limpiarSesionesAntiguas();
                return nuevaSesion;
            }
            
            obtenerEstadisticas() {
                const total = this.sesiones.length;
                const exitosas = this.sesiones.filter(s => s.estado === 'exitoso' || s.estado === 'cerrada').length;
                const fallidas = this.sesiones.filter(s => s.estado === 'fallida').length;
                const activas = this.sesiones.filter(s => s.estado === 'exitoso').length;
                const promedioDuracion = this.sesiones.filter(s => s.duracionSesion > 0).reduce((sum, s) => sum + s.duracionSesion, 0) / this.sesiones.filter(s => s.duracionSesion > 0).length || 0;
                return { total, exitosas, fallidas, activas, promedioDuracion: Math.round(promedioDuracion) };
            }
            
            filtrarSesiones(filtro) {
                let sesionesFiltradas = [...this.sesiones];
                if (filtro.fechaDesde) {
                    sesionesFiltradas = sesionesFiltradas.filter(s => new Date(s.fecha) >= new Date(filtro.fechaDesde));
                }
                if (filtro.fechaHasta) {
                    sesionesFiltradas = sesionesFiltradas.filter(s => new Date(s.fecha) <= new Date(filtro.fechaHasta));
                }
                if (filtro.estado) {
                    sesionesFiltradas = sesionesFiltradas.filter(s => s.estado === filtro.estado);
                }
                if (filtro.dispositivo) {
                    sesionesFiltradas = sesionesFiltradas.filter(s => s.dispositivo.toLowerCase().includes(filtro.dispositivo.toLowerCase()));
                }
                return sesionesFiltradas;
            }
            
            detectarAccesosSospechosos() {
                const accesosSospechosos = [];
                const ultimas24Horas = this.sesiones.filter(s => {
                    const fechaSesion = new Date(s.fecha);
                    const ahora = new Date();
                    return (ahora - fechaSesion) <= 24 * 60 * 60 * 1000;
                });
                const ips = ultimas24Horas.map(s => s.ip);
                const ipsUnicas = [...new Set(ips)];
                if (ipsUnicas.length > 3) {
                    accesosSospechosos.push('M煤ltiples IPs en 24 horas');
                }
                const dispositivos = ultimas24Horas.map(s => s.dispositivo);
                const dispositivosUnicos = [...new Set(dispositivos)];
                if (dispositivosUnicos.length > 2) {
                    accesosSospechosos.push('M煤ltiples dispositivos en 24 horas');
                }
                return accesosSospechosos;
            }
            
            limpiarSesionesAntiguas() {
                const diasRetencion = this.configuracion.diasRetencion;
                const fechaLimite = new Date();
                fechaLimite.setDate(fechaLimite.getDate() - diasRetencion);
                this.sesiones = this.sesiones.filter(s => new Date(s.fecha) >= fechaLimite);
                this.guardarSesiones();
            }
        }
        
        let sistemaHistorialSesiones = new SistemaHistorialSesiones();
        
        function abrirHistorialSesiones() {
            console.log(' Abriendo historial de sesiones...');
            const modal = document.createElement('div');
            modal.id = 'modalHistorialSesiones';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            const estadisticas = sistemaHistorialSesiones.obtenerEstadisticas();
            const accesosSospechosos = sistemaHistorialSesiones.detectarAccesosSospechosos();
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #DC2626, #B91C1C); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarHistorialSesiones()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;"></div>
                        <h2 style="margin: 0;">Historial de Sesiones</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Seguimiento de accesos y seguridad</p>
                    </div>
                    <div style="padding: 32px;">
                        ${accesosSospechosos.length > 0 ? `
                            <div style="background: #FEF2F2; padding: 20px; border-radius: 16px; border: 2px solid #FECACA; margin-bottom: 24px;">
                                <h4 style="color: #DC2626; margin: 0 0 12px;">锔 Alertas de Seguridad</h4>
                                <div style="color: #DC2626;">
                                    ${accesosSospechosos.map(alerta => `<p style="margin: 5px 0;"> ${alerta}</p>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #F0F9FF; padding: 20px; border-radius: 12px; border: 1px solid #BAE6FD; text-align: center;">
                                <div style="font-size: 2rem; color: #0369A1; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #0369A1; font-size: 1.5rem;">${estadisticas.total}</h3>
                                <p style="margin: 0; color: #0369A1; font-size: 0.9rem;">Total Sesiones</p>
                            </div>
                            <div style="background: #F0FDF4; padding: 20px; border-radius: 12px; border: 1px solid #BBF7D0; text-align: center;">
                                <div style="font-size: 2rem; color: #166534; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #166534; font-size: 1.5rem;">${estadisticas.exitosas}</h3>
                                <p style="margin: 0; color: #166534; font-size: 0.9rem;">Exitosas</p>
                            </div>
                            <div style="background: #FEF2F2; padding: 20px; border-radius: 12px; border: 1px solid #FECACA; text-align: center;">
                                <div style="font-size: 2rem; color: #DC2626; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #DC2626; font-size: 1.5rem;">${estadisticas.fallidas}</h3>
                                <p style="margin: 0; color: #DC2626; font-size: 0.9rem;">Fallidas</p>
                            </div>
                            <div style="background: #FEF3C7; padding: 20px; border-radius: 12px; border: 1px solid #FDE68A; text-align: center;">
                                <div style="font-size: 2rem; color: #92400E; margin-bottom: 8px;">憋</div>
                                <h3 style="margin: 0; color: #92400E; font-size: 1.5rem;">${estadisticas.promedioDuracion}</h3>
                                <p style="margin: 0; color: #92400E; font-size: 0.9rem;">Min Promedio</p>
                            </div>
                        </div>
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                            <h3 style="margin: 0 0 20px; color: #374151;"> Filtros</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                <div><label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Fecha Desde</label><input type="date" id="fechaDesdeSesiones" style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;"></div>
                                <div><label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Fecha Hasta</label><input type="date" id="fechaHastaSesiones" style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;"></div>
                                <div><label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Estado</label><select id="estadoSesiones" style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;"><option value="">Todos</option><option value="exitoso">Exitoso</option><option value="cerrada">Cerrada</option><option value="fallida">Fallida</option></select></div>
                                <div><label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Dispositivo</label><input type="text" id="dispositivoSesiones" placeholder="Buscar dispositivo..." style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;"></div>
                            </div>
                            <div style="display: flex; gap: 12px;"><button onclick="aplicarFiltrosSesiones()" style="background: #DC2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Aplicar Filtros</button><button onclick="limpiarFiltrosSesiones()" style="background: #6B7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Limpiar</button></div>
                        </div>
                        <div id="listaSesionesHistorial" style="max-height: 400px; overflow-y: auto; background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                            ${sistemaHistorialSesiones.sesiones.length > 0 ? sistemaHistorialSesiones.sesiones.map(sesion => `
                                <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                        <div style="flex: 1;"><h4 style="margin: 0; color: #374151; font-size: 1.1rem;">${sesion.fechaCompleta || new Date(sesion.fecha || Date.now()).toLocaleString('es-ES')}</h4><p style="margin: 5px 0; color: #6B7280; font-size: 0.9rem;">${sesion.dispositivo || 'Dispositivo'} | ${sesion.sistemaOperativo || 'OS'}</p><p style="margin: 0; color: #6B7280; font-size: 0.9rem;">IP: ${sesion.ip || 'No disponible'}</p></div>
                                        <div style="text-align: right;"><span style="background: ${sesion.estado === 'exitoso' ? '#10B981' : sesion.estado === 'cerrada' ? '#3B82F6' : '#DC2626'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${(sesion.estado || 'exitoso').charAt(0).toUpperCase() + (sesion.estado || 'exitoso').slice(1)}</span>${sesion.duracionSesion > 0 ? `<p style="margin: 5px 0 0; color: #6B7280; font-size: 0.8rem;">${sesion.duracionSesion} min</p>` : ''}</div>
                                    </div>
                                </div>
                            `).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No hay sesiones registradas a煤n</p></div>'}
                        </div>
                        <div style="display: flex; gap: 16px; justify-content: center;">
                            <button onclick="cerrarHistorialSesiones()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function cerrarHistorialSesiones() {
            const modal = document.getElementById('modalHistorialSesiones');
            if (modal) modal.remove();
        }
        
        function aplicarFiltrosSesiones() {
            const filtro = {
                fechaDesde: document.getElementById('fechaDesdeSesiones')?.value || '',
                fechaHasta: document.getElementById('fechaHastaSesiones')?.value || '',
                estado: document.getElementById('estadoSesiones')?.value || '',
                dispositivo: document.getElementById('dispositivoSesiones')?.value || ''
            };
            const sesionesFiltradas = sistemaHistorialSesiones.filtrarSesiones(filtro);
            mostrarSesionesFiltradas(sesionesFiltradas);
        }
        
        function limpiarFiltrosSesiones() {
            const fechaDesde = document.getElementById('fechaDesdeSesiones');
            const fechaHasta = document.getElementById('fechaHastaSesiones');
            const estado = document.getElementById('estadoSesiones');
            const dispositivo = document.getElementById('dispositivoSesiones');
            if (fechaDesde) fechaDesde.value = '';
            if (fechaHasta) fechaHasta.value = '';
            if (estado) estado.value = '';
            if (dispositivo) dispositivo.value = '';
            mostrarSesionesFiltradas(sistemaHistorialSesiones.sesiones);
        }
        
        function mostrarSesionesFiltradas(sesiones) {
            const lista = document.getElementById('listaSesionesHistorial');
            if (!lista) return;
            lista.innerHTML = sesiones.length > 0 ? sesiones.map(sesion => `
                <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div style="flex: 1;"><h4 style="margin: 0; color: #374151; font-size: 1.1rem;">${sesion.fechaCompleta || new Date(sesion.fecha || Date.now()).toLocaleString('es-ES')}</h4><p style="margin: 5px 0; color: #6B7280; font-size: 0.9rem;">${sesion.dispositivo || 'Dispositivo'} | ${sesion.sistemaOperativo || 'OS'}</p><p style="margin: 0; color: #6B7280; font-size: 0.9rem;">IP: ${sesion.ip || 'No disponible'}</p></div>
                        <div style="text-align: right;"><span style="background: ${sesion.estado === 'exitoso' ? '#10B981' : sesion.estado === 'cerrada' ? '#3B82F6' : '#DC2626'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${(sesion.estado || 'exitoso').charAt(0).toUpperCase() + (sesion.estado || 'exitoso').slice(1)}</span>${sesion.duracionSesion > 0 ? `<p style="margin: 5px 0 0; color: #6B7280; font-size: 0.8rem;">${sesion.duracionSesion} min</p>` : ''}</div>
                    </div>
                </div>
            `).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No se encontraron sesiones</p></div>';
        }
        
        // ============================================
        // SISTEMA DE GARANTAS Y DEVOLUCIONES
        // ============================================
        
        class SistemaGarantiasDevoluciones {
            constructor() {
                this.configuracion = this.cargarConfiguracion();
            }
            
            cargarConfiguracion() {
                const config = JSON.parse(localStorage.getItem('configuracion_garantias_devoluciones') || '{}');
                return {
                    garantias: {
                        activo: config.garantias?.activo !== false,
                        diasGarantia: config.garantias?.diasGarantia || 30,
                        condiciones: config.garantias?.condiciones || 'Producto debe estar en perfecto estado y con etiquetas originales',
                        productosIncluidos: config.garantias?.productosIncluidos || 'Todos los productos',
                        productosExcluidos: config.garantias?.productosExcluidos || 'Productos personalizados y alimentos',
                        procesoDevolucion: config.garantias?.procesoDevolucion || 'Contactar al vendedor dentro del plazo establecido',
                        tiempoProcesamiento: config.garantias?.tiempoProcesamiento || '5-7 d铆as h谩biles'
                    },
                    devoluciones: {
                        activo: config.devoluciones?.activo !== false,
                        diasDevolucion: config.devoluciones?.diasDevolucion || 15,
                        condiciones: config.devoluciones?.condiciones || 'Producto sin usar y en empaque original',
                        costoEnvio: config.devoluciones?.costoEnvio || 'A cargo del cliente',
                        metodoReembolso: config.devoluciones?.metodoReembolso || 'Mismo m茅todo de pago utilizado',
                        tiempoReembolso: config.devoluciones?.tiempoReembolso || '3-5 d铆as h谩biles',
                        productosNoDevolubles: config.devoluciones?.productosNoDevolubles || 'Productos personalizados, alimentos perecederos'
                    },
                    politicasGenerales: {
                        contacto: config.politicasGenerales?.contacto || 'WhatsApp: +54 9 11 1234-5678',
                        horarioAtencion: config.politicasGenerales?.horarioAtencion || 'Lunes a Viernes 9:00-18:00',
                        idioma: config.politicasGenerales?.idioma || 'Espa帽ol',
                        jurisdiccion: config.politicasGenerales?.jurisdiccion || 'Argentina',
                        fechaActualizacion: config.politicasGenerales?.fechaActualizacion || new Date().toISOString()
                    }
                };
            }
            
            guardarConfiguracion() {
                localStorage.setItem('configuracion_garantias_devoluciones', JSON.stringify(this.configuracion));
            }
            
            actualizarGarantias(datos) {
                this.configuracion.garantias = { ...this.configuracion.garantias, ...datos };
                this.configuracion.politicasGenerales.fechaActualizacion = new Date().toISOString();
                this.guardarConfiguracion();
            }
            
            actualizarDevoluciones(datos) {
                this.configuracion.devoluciones = { ...this.configuracion.devoluciones, ...datos };
                this.configuracion.politicasGenerales.fechaActualizacion = new Date().toISOString();
                this.guardarConfiguracion();
            }
            
            actualizarPoliticasGenerales(datos) {
                this.configuracion.politicasGenerales = { ...this.configuracion.politicasGenerales, ...datos };
                this.configuracion.politicasGenerales.fechaActualizacion = new Date().toISOString();
                this.guardarConfiguracion();
            }
            
            generarCodigoFooter() {
                const garantias = this.configuracion.garantias;
                const devoluciones = this.configuracion.devoluciones;
                const politicas = this.configuracion.politicasGenerales;
                return `
                    <div class="garantias-devoluciones-footer" style="background: #F8FAFC; padding: 20px; border-radius: 12px; margin-top: 20px; border: 1px solid #E5E7EB;">
                        <h4 style="color: #374151; margin-bottom: 15px;">★ Garant铆as y Devoluciones</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #E5E7EB;">
                                <h5 style="color: #059669; margin-bottom: 10px;"> Garant铆as</h5>
                                <p style="color: #6B7280; font-size: 0.9rem; margin: 0;">
                                    <strong>Duraci贸n:</strong> ${garantias.diasGarantia} d铆as<br>
                                    <strong>Condiciones:</strong> ${garantias.condiciones}<br>
                                    <strong>Proceso:</strong> ${garantias.procesoDevolucion}
                                </p>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #E5E7EB;">
                                <h5 style="color: #DC2626; margin-bottom: 10px;"> Devoluciones</h5>
                                <p style="color: #6B7280; font-size: 0.9rem; margin: 0;">
                                    <strong>Plazo:</strong> ${devoluciones.diasDevolucion} d铆as<br>
                                    <strong>Condiciones:</strong> ${devoluciones.condiciones}<br>
                                    <strong>Reembolso:</strong> ${devoluciones.tiempoReembolso}
                                </p>
                            </div>
                        </div>
                        <div style="background: #FEF3C7; padding: 12px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #F59E0B;">
                            <p style="color: #92400E; font-size: 0.9rem; margin: 0;">
                                <strong> Contacto:</strong> ${politicas.contacto}<br>
                                <strong> Horario:</strong> ${politicas.horarioAtencion}
                            </p>
                        </div>
                    </div>
                `;
            }
            
            obtenerEstadisticas() {
                return {
                    garantiasActivas: this.configuracion.garantias.activo,
                    devolucionesActivas: this.configuracion.devoluciones.activo,
                    diasGarantia: this.configuracion.garantias.diasGarantia,
                    diasDevolucion: this.configuracion.devoluciones.diasDevolucion,
                    ultimaActualizacion: this.configuracion.politicasGenerales.fechaActualizacion
                };
            }
        }
        
        let sistemaGarantiasDevoluciones = new SistemaGarantiasDevoluciones();
        
        function abrirConfiguracionGarantiasDevoluciones() {
            console.log('★ Abriendo configuraci贸n de garant铆as y devoluciones...');
            const modal = document.createElement('div');
            modal.id = 'modalConfiguracionGarantiasDevoluciones';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            const estadisticas = sistemaGarantiasDevoluciones.obtenerEstadisticas();
            const config = sistemaGarantiasDevoluciones.configuracion;
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #059669, #10B981); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarConfiguracionGarantiasDevoluciones()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;">★</div>
                        <h2 style="margin: 0;">Configuraci贸n de Garant铆as y Devoluciones</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Protege a tus clientes con pol铆ticas claras</p>
                    </div>
                    <div style="padding: 32px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #F0FDF4; padding: 20px; border-radius: 12px; border: 1px solid #BBF7D0; text-align: center;">
                                <div style="font-size: 2rem; color: #059669; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #059669; font-size: 1.5rem;">${estadisticas.garantiasActivas ? 'Activo' : 'Inactivo'}</h3>
                                <p style="margin: 0; color: #059669; font-size: 0.9rem;">Sistema de Garant铆as</p>
                            </div>
                            <div style="background: #FEF2F2; padding: 20px; border-radius: 12px; border: 1px solid #FECACA; text-align: center;">
                                <div style="font-size: 2rem; color: #DC2626; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #DC2626; font-size: 1.5rem;">${estadisticas.devolucionesActivas ? 'Activo' : 'Inactivo'}</h3>
                                <p style="margin: 0; color: #DC2626; font-size: 0.9rem;">Sistema de Devoluciones</p>
                            </div>
                            <div style="background: #F0F9FF; padding: 20px; border-radius: 12px; border: 1px solid #BAE6FD; text-align: center;">
                                <div style="font-size: 2rem; color: #0369A1; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #0369A1; font-size: 1.5rem;">${estadisticas.diasGarantia}</h3>
                                <p style="margin: 0; color: #0369A1; font-size: 0.9rem;">D铆as de Garant铆a</p>
                            </div>
                            <div style="background: #FDF2F8; padding: 20px; border-radius: 12px; border: 1px solid #FBCFE8; text-align: center;">
                                <div style="font-size: 2rem; color: #BE185D; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #BE185D; font-size: 1.5rem;">${estadisticas.diasDevolucion}</h3>
                                <p style="margin: 0; color: #BE185D; font-size: 0.9rem;">D铆as de Devoluci贸n</p>
                            </div>
                        </div>
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                            <h3 style="margin: 0 0 20px; color: #374151;"> Configuraci贸n de Garant铆as</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Activar Garant铆as</label><label style="display: flex; align-items: center; gap: 10px; cursor: pointer;"><input type="checkbox" id="garantiasActivo" ${config.garantias.activo ? 'checked' : ''} style="transform: scale(1.2);"><span style="color: #6B7280;">Ofrecer garant铆as</span></label></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">D铆as de Garant铆a</label><input type="number" id="diasGarantia" value="${config.garantias.diasGarantia}" min="1" max="365" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Condiciones</label><textarea id="condicionesGarantia" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px; resize: vertical; min-height: 80px;">${config.garantias.condiciones}</textarea></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Productos Incluidos</label><textarea id="productosIncluidos" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px; resize: vertical; min-height: 60px;">${config.garantias.productosIncluidos}</textarea></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Productos Excluidos</label><textarea id="productosExcluidos" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px; resize: vertical; min-height: 60px;">${config.garantias.productosExcluidos}</textarea></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Tiempo Procesamiento</label><input type="text" id="tiempoProcesamiento" value="${config.garantias.tiempoProcesamiento}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            </div>
                        </div>
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                            <h3 style="margin: 0 0 20px; color: #374151;"> Configuraci贸n de Devoluciones</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Activar Devoluciones</label><label style="display: flex; align-items: center; gap: 10px; cursor: pointer;"><input type="checkbox" id="devolucionesActivo" ${config.devoluciones.activo ? 'checked' : ''} style="transform: scale(1.2);"><span style="color: #6B7280;">Permitir devoluciones</span></label></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">D铆as para Devoluci贸n</label><input type="number" id="diasDevolucion" value="${config.devoluciones.diasDevolucion}" min="1" max="30" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Condiciones</label><textarea id="condicionesDevolucion" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px; resize: vertical; min-height: 80px;">${config.devoluciones.condiciones}</textarea></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Costo de Env铆o</label><select id="costoEnvio" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"><option value="A cargo del cliente" ${config.devoluciones.costoEnvio === 'A cargo del cliente' ? 'selected' : ''}>A cargo del cliente</option><option value="A cargo del vendedor" ${config.devoluciones.costoEnvio === 'A cargo del vendedor' ? 'selected' : ''}>A cargo del vendedor</option><option value="Gratis" ${config.devoluciones.costoEnvio === 'Gratis' ? 'selected' : ''}>Gratis</option></select></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">M茅todo Reembolso</label><select id="metodoReembolso" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"><option value="Mismo m茅todo de pago utilizado" ${config.devoluciones.metodoReembolso === 'Mismo m茅todo de pago utilizado' ? 'selected' : ''}>Mismo m茅todo de pago</option><option value="Transferencia bancaria" ${config.devoluciones.metodoReembolso === 'Transferencia bancaria' ? 'selected' : ''}>Transferencia bancaria</option><option value="Efectivo" ${config.devoluciones.metodoReembolso === 'Efectivo' ? 'selected' : ''}>Efectivo</option></select></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Tiempo Reembolso</label><input type="text" id="tiempoReembolso" value="${config.devoluciones.tiempoReembolso}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Productos No Devolubles</label><textarea id="productosNoDevolubles" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px; resize: vertical; min-height: 80px;">${config.devoluciones.productosNoDevolubles}</textarea></div>
                            </div>
                        </div>
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                            <h3 style="margin: 0 0 20px; color: #374151;"> Pol铆ticas Generales</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Contacto</label><input type="text" id="contactoGarantias" value="${config.politicasGenerales.contacto}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Horario Atenci贸n</label><input type="text" id="horarioAtencionGarantias" value="${config.politicasGenerales.horarioAtencion}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Idioma</label><select id="idiomaGarantias" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"><option value="Espa帽ol" ${config.politicasGenerales.idioma === 'Espa帽ol' ? 'selected' : ''}>Espa帽ol</option><option value="English" ${config.politicasGenerales.idioma === 'English' ? 'selected' : ''}>English</option><option value="Portugu锚s" ${config.politicasGenerales.idioma === 'Portugu锚s' ? 'selected' : ''}>Portugu锚s</option></select></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Jurisdicci贸n</label><input type="text" id="jurisdiccionGarantias" value="${config.politicasGenerales.jurisdiccion}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; justify-content: center;">
                            <button onclick="guardarConfiguracionGarantiasDevoluciones()" style="background: linear-gradient(135deg, #059669, #10B981); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Guardar</button>
                            <button onclick="cerrarConfiguracionGarantiasDevoluciones()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function guardarConfiguracionGarantiasDevoluciones() {
            const garantias = {
                activo: document.getElementById('garantiasActivo')?.checked || false,
                diasGarantia: parseInt(document.getElementById('diasGarantia')?.value || '30'),
                condiciones: document.getElementById('condicionesGarantia')?.value || '',
                productosIncluidos: document.getElementById('productosIncluidos')?.value || '',
                productosExcluidos: document.getElementById('productosExcluidos')?.value || '',
                tiempoProcesamiento: document.getElementById('tiempoProcesamiento')?.value || ''
            };
            const devoluciones = {
                activo: document.getElementById('devolucionesActivo')?.checked || false,
                diasDevolucion: parseInt(document.getElementById('diasDevolucion')?.value || '15'),
                condiciones: document.getElementById('condicionesDevolucion')?.value || '',
                costoEnvio: document.getElementById('costoEnvio')?.value || '',
                metodoReembolso: document.getElementById('metodoReembolso')?.value || '',
                tiempoReembolso: document.getElementById('tiempoReembolso')?.value || '',
                productosNoDevolubles: document.getElementById('productosNoDevolubles')?.value || ''
            };
            const politicasGenerales = {
                contacto: document.getElementById('contactoGarantias')?.value || '',
                horarioAtencion: document.getElementById('horarioAtencionGarantias')?.value || '',
                idioma: document.getElementById('idiomaGarantias')?.value || 'Espa帽ol',
                jurisdiccion: document.getElementById('jurisdiccionGarantias')?.value || ''
            };
            sistemaGarantiasDevoluciones.actualizarGarantias(garantias);
            sistemaGarantiasDevoluciones.actualizarDevoluciones(devoluciones);
            sistemaGarantiasDevoluciones.actualizarPoliticasGenerales(politicasGenerales);
            mostrarNotificacion(' Configuraci贸n guardada', 'success');
        }
        
        function cerrarConfiguracionGarantiasDevoluciones() {
            const modal = document.getElementById('modalConfiguracionGarantiasDevoluciones');
            if (modal) modal.remove();
        }
        
        // ============================================
        // SISTEMA DE CONFIGURACIN COMPLETA DE TIENDA
        // ============================================
        
        class SistemaConfiguracionTienda {
            constructor() {
                this.configuracion = this.cargarConfiguracion();
            }
            
            cargarConfiguracion() {
                const config = JSON.parse(localStorage.getItem('configuracion_tienda_completa') || '{}');
                return {
                    informacionTienda: {
                        nombre: config.informacionTienda?.nombre || 'Mi Tienda',
                        descripcion: config.informacionTienda?.descripcion || 'Descripci贸n de mi tienda',
                        email: config.informacionTienda?.email || '',
                        telefono: config.informacionTienda?.telefono || '',
                        sitioWeb: config.informacionTienda?.sitioWeb || ''
                    },
                    redesSociales: {
                        instagram: config.redesSociales?.instagram || '',
                        facebook: config.redesSociales?.facebook || '',
                        twitter: config.redesSociales?.twitter || '',
                        tiktok: config.redesSociales?.tiktok || '',
                        youtube: config.redesSociales?.youtube || '',
                        linkedin: config.redesSociales?.linkedin || '',
                        whatsapp: config.redesSociales?.whatsapp || ''
                    },
                    ubicacion: {
                        direccion: config.ubicacion?.direccion || '',
                        ciudad: config.ubicacion?.ciudad || '',
                        provincia: config.ubicacion?.provincia || '',
                        codigoPostal: config.ubicacion?.codigoPostal || '',
                        pais: config.ubicacion?.pais || 'Argentina'
                    },
                    informacionEmpresa: {
                        a帽oCreacion: config.informacionEmpresa?.a帽oCreacion || new Date().getFullYear(),
                        razonSocial: config.informacionEmpresa?.razonSocial || '',
                        cuit: config.informacionEmpresa?.cuit || '',
                        rubro: config.informacionEmpresa?.rubro || ''
                    },
                    imagenesVideos: {
                        bannerPrincipal: config.imagenesVideos?.bannerPrincipal || '',
                        logo: config.imagenesVideos?.logo || '',
                        videoPresentacion: config.imagenesVideos?.videoPresentacion || '',
                        galeriaImagenes: config.imagenesVideos?.galeriaImagenes || []
                    },
                    cresaliaBot: {
                        activo: config.cresaliaBot?.activo || false,
                        mensajeBienvenida: config.cresaliaBot?.mensajeBienvenida || '隆Hola! Soy Cresalia-Bot, tu asistente virtual. 驴En qu茅 puedo ayudarte?',
                        horarioAtencion: config.cresaliaBot?.horarioAtencion || '24/7',
                        respuestasAutomaticas: config.cresaliaBot?.respuestasAutomaticas || []
                    },
                    packInicio: {
                        descargado: config.packInicio?.descargado || false,
                        recursosUtilizados: config.packInicio?.recursosUtilizados || []
                    },
                    servicioAyuda: {
                        activo: config.servicioAyuda?.activo !== false,
                        colorPrimario: config.servicioAyuda?.colorPrimario || '#EC4899',
                        colorSecundario: config.servicioAyuda?.colorSecundario || '#F9A8D4',
                        mensajePersonalizado: config.servicioAyuda?.mensajePersonalizado || '隆Estamos aqu铆 para ayudarte!'
                    },
                    contenidoEmpresa: {
                        nosotros: config.contenidoEmpresa?.nosotros || '',
                        terminosCondiciones: config.contenidoEmpresa?.terminosCondiciones || '',
                        prensa: config.contenidoEmpresa?.prensa || '',
                        trabajaConNosotros: config.contenidoEmpresa?.trabajaConNosotros || ''
                    }
                };
            }
            
            guardarConfiguracion() {
                localStorage.setItem('configuracion_tienda_completa', JSON.stringify(this.configuracion));
                // Actualizar timestamp de sincronizaci贸n para que la tienda detecte cambios
                localStorage.setItem('tienda_ultima_sincronizacion', new Date().toISOString());
                
                // Mostrar mensaje de sincronizaci贸n
                this.mostrarMensajeSincronizacion();
            }
            
            mostrarMensajeSincronizacion() {
                // Crear o actualizar mensaje de sincronizaci贸n
                let mensajeSincronizacion = document.getElementById('mensajeSincronizacionTienda');
                if (!mensajeSincronizacion) {
                    mensajeSincronizacion = document.createElement('div');
                    mensajeSincronizacion.id = 'mensajeSincronizacionTienda';
                    mensajeSincronizacion.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #10B981, #059669);
                        color: white;
                        padding: 16px 24px;
                        border-radius: 12px;
                        box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
                        z-index: 999999;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        font-weight: 600;
                        animation: slideInUp 0.3s ease-out;
                        max-width: 350px;
                    `;
                    document.body.appendChild(mensajeSincronizacion);
                }
                
                mensajeSincronizacion.innerHTML = `
                    <i class="fas fa-sync-alt" style="animation: spin 1s linear infinite;"></i>
                    <div>
                        <div style="font-size: 0.9rem; opacity: 0.95;"> Cambios guardados</div>
                        <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 4px;">Sincronizaci贸n autom谩tica activa</div>
                    </div>
                `;
                
                // Ocultar despu茅s de 3 segundos
                setTimeout(() => {
                    if (mensajeSincronizacion) {
                        mensajeSincronizacion.style.animation = 'slideOutDown 0.3s ease-out';
                        setTimeout(() => {
                            if (mensajeSincronizacion && mensajeSincronizacion.parentNode) {
                                mensajeSincronizacion.remove();
                            }
                        }, 300);
                    }
                }, 3000);
            }
            
            actualizarInformacionTienda(datos) {
                this.configuracion.informacionTienda = { ...this.configuracion.informacionTienda, ...datos };
                this.guardarConfiguracion();
            }
            
            actualizarRedesSociales(datos) {
                this.configuracion.redesSociales = { ...this.configuracion.redesSociales, ...datos };
                this.guardarConfiguracion();
            }
            
            actualizarUbicacion(datos) {
                this.configuracion.ubicacion = { ...this.configuracion.ubicacion, ...datos };
                this.guardarConfiguracion();
            }
            
            actualizarInformacionEmpresa(datos) {
                this.configuracion.informacionEmpresa = { ...this.configuracion.informacionEmpresa, ...datos };
                this.guardarConfiguracion();
            }
            
            actualizarImagenesVideos(datos) {
                this.configuracion.imagenesVideos = { ...this.configuracion.imagenesVideos, ...datos };
                this.guardarConfiguracion();
            }
            
            actualizarCresaliaBot(datos) {
                this.configuracion.cresaliaBot = { ...this.configuracion.cresaliaBot, ...datos };
                this.guardarConfiguracion();
            }
            
            actualizarServicioAyuda(datos) {
                this.configuracion.servicioAyuda = { ...this.configuracion.servicioAyuda, ...datos };
                this.guardarConfiguracion();
            }
            
            actualizarContenidoEmpresa(datos) {
                this.configuracion.contenidoEmpresa = { ...this.configuracion.contenidoEmpresa, ...datos };
                this.guardarConfiguracion();
            }
            
            obtenerEstadisticas() {
                return {
                    configuracionCompleta: Object.keys(this.configuracion).length,
                    informacionCompleta: Object.values(this.configuracion.informacionTienda).filter(v => v).length,
                    ubicacionCompleta: Object.values(this.configuracion.ubicacion).filter(v => v).length,
                    botActivo: this.configuracion.cresaliaBot.activo,
                    servicioAyudaActivo: this.configuracion.servicioAyuda.activo
                };
            }
        }
        
        let sistemaConfiguracionTienda = new SistemaConfiguracionTienda();
        
        function abrirConfiguracionTiendaCompleta() {
            console.log('锔 Abriendo configuraci贸n completa de tienda...');
            const modal = document.createElement('div');
            modal.id = 'modalConfiguracionTiendaCompleta';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            const estadisticas = sistemaConfiguracionTienda.obtenerEstadisticas();
            const config = sistemaConfiguracionTienda.configuracion;
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 1400px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarConfiguracionTiendaCompleta()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;">锔</div>
                        <h2 style="margin: 0;">Configuraci贸n Completa de Tienda</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Personaliza todos los aspectos de tu tienda</p>
                    </div>
                    <div style="padding: 32px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #F0FDF4; padding: 20px; border-radius: 12px; border: 1px solid #BBF7D0; text-align: center;">
                                <div style="font-size: 2rem; color: #059669; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #059669; font-size: 1.5rem;">${estadisticas.configuracionCompleta}</h3>
                                <p style="margin: 0; color: #059669; font-size: 0.9rem;">Secciones Configuradas</p>
                            </div>
                            <div style="background: #F0F9FF; padding: 20px; border-radius: 12px; border: 1px solid #BAE6FD; text-align: center;">
                                <div style="font-size: 2rem; color: #0369A1; margin-bottom: 8px;">癸</div>
                                <h3 style="margin: 0; color: #0369A1; font-size: 1.5rem;">${estadisticas.informacionCompleta}/5</h3>
                                <p style="margin: 0; color: #0369A1; font-size: 0.9rem;">Informaci贸n Completa</p>
                            </div>
                            <div style="background: #FEF2F2; padding: 20px; border-radius: 12px; border: 1px solid #FECACA; text-align: center;">
                                <div style="font-size: 2rem; color: #DC2626; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #DC2626; font-size: 1.5rem;">${estadisticas.ubicacionCompleta}/5</h3>
                                <p style="margin: 0; color: #DC2626; font-size: 0.9rem;">Ubicaci贸n Completa</p>
                            </div>
                            <div style="background: #FDF2F8; padding: 20px; border-radius: 12px; border: 1px solid #FBCFE8; text-align: center;">
                                <div style="font-size: 2rem; color: #BE185D; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #BE185D; font-size: 1.5rem;">${estadisticas.botActivo ? 'Activo' : 'Inactivo'}</h3>
                                <p style="margin: 0; color: #BE185D; font-size: 0.9rem;">Cresalia-Bot</p>
                            </div>
                        </div>
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                                <button onclick="mostrarTabConfiguracion('informacion')" id="tabInformacion" style="background: #667eea; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Informaci贸n</button>
                                <button onclick="mostrarTabConfiguracion('ubicacion')" id="tabUbicacion" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Ubicaci贸n</button>
                                <button onclick="mostrarTabConfiguracion('empresa')" id="tabEmpresa" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Empresa</button>
                                <button onclick="mostrarTabConfiguracion('multimedia')" id="tabMultimedia" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Multimedia</button>
                                <button onclick="mostrarTabConfiguracion('notificaciones')" id="tabNotificaciones" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Notificaciones</button>
                                <button onclick="mostrarTabConfiguracion('bot')" id="tabBot" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Bot</button>
                                <button onclick="mostrarTabConfiguracion('ayuda')" id="tabAyuda" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Ayuda</button>
                                <button onclick="mostrarTabConfiguracion('contenido')" id="tabContenido" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Contenido</button>
                            </div>
                            <div id="contenidoConfiguracion">
                                <div id="tabContenidoInformacion" style="display: block;">
                                    <h3 style="margin: 0 0 20px; color: #374151;"> Informaci贸n de la Tienda</h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Nombre de la Tienda</label><input type="text" id="nombreTiendaConfig" value="${config.informacionTienda.nombre}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Email de Contacto</label><input type="email" id="emailTiendaConfig" value="${config.informacionTienda.email}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Tel茅fono</label><input type="tel" id="telefonoTiendaConfig" value="${config.informacionTienda.telefono}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Sitio Web</label><input type="url" id="sitioWebTiendaConfig" value="${config.informacionTienda.sitioWeb}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                        <div style="grid-column: 1 / -1;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Descripci贸n de la Tienda</label><textarea id="descripcionTiendaConfig" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px; resize: vertical; min-height: 100px;">${config.informacionTienda.descripcion}</textarea></div>
                                    </div>
                                    
                                    <!-- Redes Sociales -->
                                    <div style="margin-top: 30px; padding: 24px; background: #F8FAFC; border-radius: 16px; border: 1px solid #E5E7EB;">
                                        <h4 style="margin: 0 0 20px; color: #374151; display: flex; align-items: center; gap: 10px;">
                                            <i class="fas fa-share-alt"></i> Redes Sociales
                                        </h4>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                            <div>
                                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                                    <i class="fab fa-instagram" style="color: #E4405F;"></i> Instagram:
                                                </label>
                                                <input type="url" id="instagramConfig" value="${config.redesSociales?.instagram || ''}" placeholder="https://instagram.com/tu_tienda" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem;">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                                    <i class="fab fa-facebook" style="color: #1877F2;"></i> Facebook:
                                                </label>
                                                <input type="url" id="facebookConfig" value="${config.redesSociales?.facebook || ''}" placeholder="https://facebook.com/tu_tienda" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem;">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                                    <i class="fab fa-twitter" style="color: #1DA1F2;"></i> X (Twitter):
                                                </label>
                                                <input type="url" id="twitterConfig" value="${config.redesSociales?.twitter || ''}" placeholder="https://x.com/tu_tienda" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem;">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                                    <i class="fab fa-tiktok" style="color: #000000;"></i> TikTok:
                                                </label>
                                                <input type="url" id="tiktokConfig" value="${config.redesSociales?.tiktok || ''}" placeholder="https://tiktok.com/@tu_tienda" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem;">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                                    <i class="fab fa-youtube" style="color: #FF0000;"></i> YouTube:
                                                </label>
                                                <input type="url" id="youtubeConfig" value="${config.redesSociales?.youtube || ''}" placeholder="https://youtube.com/@tu_tienda" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem;">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                                    <i class="fab fa-linkedin" style="color: #0077B5;"></i> LinkedIn:
                                                </label>
                                                <input type="url" id="linkedinConfig" value="${config.redesSociales?.linkedin || ''}" placeholder="https://linkedin.com/company/tu_tienda" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem;">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                                    <i class="fab fa-whatsapp" style="color: #25D366;"></i> WhatsApp:
                                                </label>
                                                <input type="tel" id="whatsappConfig" value="${config.redesSociales?.whatsapp || ''}" placeholder="+54 9 11 1234-5678" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="tabContenidoUbicacion" style="display: none;">
                                    <h3 style="margin: 0 0 20px; color: #374151;"> Ubicaci贸n y Contacto</h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Direcci贸n</label><input type="text" id="direccionTiendaConfig" value="${config.ubicacion.direccion}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Ciudad</label><input type="text" id="ciudadTiendaConfig" value="${config.ubicacion.ciudad}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Provincia</label><input type="text" id="provinciaTiendaConfig" value="${config.ubicacion.provincia}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">C贸digo Postal</label><input type="text" id="codigoPostalTiendaConfig" value="${config.ubicacion.codigoPostal}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Pa铆s</label><select id="paisTiendaConfig" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"><option value="Argentina" ${config.ubicacion.pais === 'Argentina' ? 'selected' : ''}>Argentina </option><option value="Bolivia" ${config.ubicacion.pais === 'Bolivia' ? 'selected' : ''}>Bolivia ю</option><option value="Chile" ${config.ubicacion.pais === 'Chile' ? 'selected' : ''}>Chile </option><option value="Colombia" ${config.ubicacion.pais === 'Colombia' ? 'selected' : ''}>Colombia </option><option value="Costa Rica" ${config.ubicacion.pais === 'Costa Rica' ? 'selected' : ''}>Costa Rica </option><option value="Cuba" ${config.ubicacion.pais === 'Cuba' ? 'selected' : ''}>Cuba </option><option value="Rep煤blica Dominicana" ${config.ubicacion.pais === 'Rep煤blica Dominicana' ? 'selected' : ''}>Rep煤blica Dominicana </option><option value="Ecuador" ${config.ubicacion.pais === 'Ecuador' ? 'selected' : ''}>Ecuador </option><option value="El Salvador" ${config.ubicacion.pais === 'El Salvador' ? 'selected' : ''}>El Salvador 葛</option><option value="Espa帽a" ${config.ubicacion.pais === 'Espa帽a' ? 'selected' : ''}>Espa帽a </option><option value="Guinea Ecuatorial" ${config.ubicacion.pais === 'Guinea Ecuatorial' ? 'selected' : ''}>Guinea Ecuatorial </option><option value="Guatemala" ${config.ubicacion.pais === 'Guatemala' ? 'selected' : ''}>Guatemala </option><option value="Honduras" ${config.ubicacion.pais === 'Honduras' ? 'selected' : ''}>Honduras </option><option value="M茅xico" ${config.ubicacion.pais === 'M茅xico' ? 'selected' : ''}>M茅xico 拆</option><option value="Nicaragua" ${config.ubicacion.pais === 'Nicaragua' ? 'selected' : ''}>Nicaragua 仇</option><option value="Panam谩" ${config.ubicacion.pais === 'Panam谩' ? 'selected' : ''}>Panam谩 叼</option><option value="Paraguay" ${config.ubicacion.pais === 'Paraguay' ? 'selected' : ''}>Paraguay 叼</option><option value="Per煤" ${config.ubicacion.pais === 'Per煤' ? 'selected' : ''}>Per煤 叼</option><option value="Puerto Rico" ${config.ubicacion.pais === 'Puerto Rico' ? 'selected' : ''}>Puerto Rico 叼</option><option value="Uruguay" ${config.ubicacion.pais === 'Uruguay' ? 'selected' : ''}>Uruguay 吼</option><option value="Venezuela" ${config.ubicacion.pais === 'Venezuela' ? 'selected' : ''}>Venezuela 火</option></select></div>
                                    </div>
                                </div>
                                <div id="tabContenidoEmpresa" style="display: none;">
                                    <h3 style="margin: 0 0 20px; color: #374151;"> Informaci贸n de la Empresa</h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">A帽o de Creaci贸n</label><input type="number" id="a帽oCreacionConfig" value="${config.informacionEmpresa.a帽oCreacion}" min="1900" max="${new Date().getFullYear()}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Raz贸n Social</label><input type="text" id="razonSocialConfig" value="${config.informacionEmpresa.razonSocial}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">CUIT/CUIL</label><input type="text" id="cuitConfig" value="${config.informacionEmpresa.cuit}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Rubro</label><select id="rubroConfig" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"><option value="Comercio" ${config.informacionEmpresa.rubro === 'Comercio' ? 'selected' : ''}>Comercio</option><option value="Servicios" ${config.informacionEmpresa.rubro === 'Servicios' ? 'selected' : ''}>Servicios</option><option value="Manufactura" ${config.informacionEmpresa.rubro === 'Manufactura' ? 'selected' : ''}>Manufactura</option><option value="Tecnolog铆a" ${config.informacionEmpresa.rubro === 'Tecnolog铆a' ? 'selected' : ''}>Tecnolog铆a</option><option value="Salud" ${config.informacionEmpresa.rubro === 'Salud' ? 'selected' : ''}>Salud</option><option value="Educaci贸n" ${config.informacionEmpresa.rubro === 'Educaci贸n' ? 'selected' : ''}>Educaci贸n</option></select></div>
                                    </div>
                                </div>
                                <div id="tabContenidoMultimedia" style="display: none;">
                                    <h3 style="margin: 0 0 20px; color: #374151;"> Im谩genes y Videos</h3>
                                    <p style="color: #6B7280; margin-bottom: 20px; font-size: 0.9rem;">Puedes usar una URL o subir un archivo desde tu dispositivo</p>
                                    
                                    <!-- Banner Principal -->
                                    <div style="margin-bottom: 30px; padding: 20px; background: #F9FAFB; border-radius: 12px; border: 1px solid #E5E7EB;">
                                        <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #374151;">Banner Principal</label>
                                        <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                                            <button type="button" onclick="cambiarModoMultimedia('banner', 'url')" id="btnBannerURL" class="btn-modo-multimedia active" data-activo="true" style="padding: 8px 16px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-weight: 500;"> Usar URL</button>
                                            <button type="button" onclick="cambiarModoMultimedia('banner', 'archivo')" id="btnBannerArchivo" class="btn-modo-multimedia" data-activo="false" style="padding: 8px 16px; border: 2px solid #D1D5DB; background: white; color: #374151; border-radius: 6px; cursor: pointer; font-weight: 500;"> Subir Archivo</button>
                                        </div>
                                        <div id="bannerURLContainer" style="display: block;">
                                            <input type="url" id="bannerPrincipalConfig" value="${config.imagenesVideos.bannerPrincipal || ''}" placeholder="https://ejemplo.com/imagen.jpg" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;">
                                        </div>
                                        <div id="bannerArchivoContainer" style="display: none;">
                                            <input type="file" id="bannerPrincipalFile" accept="image/*" onchange="previsualizarArchivo('banner', this)" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;">
                                            <div id="previewBanner" style="margin-top: 10px; max-width: 300px; max-height: 150px; border-radius: 8px; overflow: hidden; display: none;">
                                                <img id="imgPreviewBanner" src="" alt="Vista previa" style="width: 100%; height: auto; display: block;">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Logo -->
                                    <div style="margin-bottom: 30px; padding: 20px; background: #F9FAFB; border-radius: 12px; border: 1px solid #E5E7EB;">
                                        <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #374151;">Logo</label>
                                        <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                                            <button type="button" onclick="cambiarModoMultimedia('logo', 'url')" id="btnLogoURL" class="btn-modo-multimedia active" data-activo="true" style="padding: 8px 16px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-weight: 500;"> Usar URL</button>
                                            <button type="button" onclick="cambiarModoMultimedia('logo', 'archivo')" id="btnLogoArchivo" class="btn-modo-multimedia" data-activo="false" style="padding: 8px 16px; border: 2px solid #D1D5DB; background: white; color: #374151; border-radius: 6px; cursor: pointer; font-weight: 500;"> Subir Archivo</button>
                                        </div>
                                        <div id="logoURLContainer" style="display: block;">
                                            <input type="url" id="logoConfig" value="${config.imagenesVideos.logo || ''}" placeholder="https://ejemplo.com/logo.png" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;">
                                        </div>
                                        <div id="logoArchivoContainer" style="display: none;">
                                            <input type="file" id="logoFile" accept="image/*" onchange="previsualizarArchivo('logo', this)" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;">
                                            <div id="previewLogo" style="margin-top: 10px; max-width: 200px; max-height: 200px; border-radius: 8px; overflow: hidden; display: none;">
                                                <img id="imgPreviewLogo" src="" alt="Vista previa" style="width: 100%; height: auto; display: block;">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Video de Presentaci贸n -->
                                    <div style="margin-bottom: 30px; padding: 20px; background: #F9FAFB; border-radius: 12px; border: 1px solid #E5E7EB;">
                                        <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #374151;">Video de Presentaci贸n</label>
                                        <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                                            <button type="button" onclick="cambiarModoMultimedia('video', 'url')" id="btnVideoURL" class="btn-modo-multimedia active" data-activo="true" style="padding: 8px 16px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-weight: 500;"> Usar URL (YouTube/Vimeo)</button>
                                            <button type="button" onclick="cambiarModoMultimedia('video', 'archivo')" id="btnVideoArchivo" class="btn-modo-multimedia" data-activo="false" style="padding: 8px 16px; border: 2px solid #D1D5DB; background: white; color: #374151; border-radius: 6px; cursor: pointer; font-weight: 500;"> Subir Video</button>
                                        </div>
                                        <div id="videoURLContainer" style="display: block;">
                                            <input type="url" id="videoPresentacionConfig" value="${config.imagenesVideos.videoPresentacion || ''}" placeholder="https://youtube.com/watch?v=..." style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;">
                                        </div>
                                        <div id="videoArchivoContainer" style="display: none;">
                                            <input type="file" id="videoPresentacionFile" accept="video/*" onchange="previsualizarArchivo('video', this)" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;">
                                            <div id="previewVideo" style="margin-top: 10px; max-width: 400px; display: none;">
                                                <video id="videoPreviewVideo" controls style="width: 100%; border-radius: 8px; display: block;"></video>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="tabContenidoBot" style="display: none;">
                                    <h3 style="margin: 0 0 20px; color: #374151;"> Cresalia-Bot</h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Activar Bot</label><label style="display: flex; align-items: center; gap: 10px; cursor: pointer;"><input type="checkbox" id="botActivoConfig" ${config.cresaliaBot.activo ? 'checked' : ''} style="transform: scale(1.2);"><span style="color: #6B7280;">Activar asistente virtual</span></label></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Horario de Atenci贸n</label><input type="text" id="horarioAtencionBotConfig" value="${config.cresaliaBot.horarioAtencion}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                        <div style="grid-column: 1 / -1;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Mensaje de Bienvenida</label><textarea id="mensajeBienvenidaBotConfig" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px; resize: vertical; min-height: 80px;">${config.cresaliaBot.mensajeBienvenida}</textarea></div>
                                    </div>
                                </div>
                                <div id="tabContenidoAyuda" style="display: none;">
                                    <h3 style="margin: 0 0 20px; color: #374151;"> Servicio de Ayuda</h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Activar Servicio</label><label style="display: flex; align-items: center; gap: 10px; cursor: pointer;"><input type="checkbox" id="servicioAyudaActivoConfig" ${config.servicioAyuda.activo ? 'checked' : ''} style="transform: scale(1.2);"><span style="color: #6B7280;">Activar sistema de ayuda</span></label></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Color Primario</label><input type="color" id="colorPrimarioAyudaConfig" value="${config.servicioAyuda.colorPrimario}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Color Secundario</label><input type="color" id="colorSecundarioAyudaConfig" value="${config.servicioAyuda.colorSecundario}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                        <div style="grid-column: 1 / -1;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Mensaje Personalizado</label><textarea id="mensajePersonalizadoAyudaConfig" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px; resize: vertical; min-height: 80px;">${config.servicioAyuda.mensajePersonalizado}</textarea></div>
                                    </div>
                                </div>
                                <div id="tabContenidoContenido" style="display: none;">
                                    <h3 style="margin: 0 0 20px; color: #374151;"> Contenido de la Empresa</h3>
                                    <p style="color: #6B7280; margin-bottom: 20px; font-size: 0.9rem;">Estos contenidos se mostrar谩n autom谩ticamente en el footer y en las secciones correspondientes de tu tienda.</p>
                                    
                                    <div style="margin-bottom: 30px; padding: 20px; background: #F9FAFB; border-radius: 12px; border: 1px solid #E5E7EB;">
                                        <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #374151;">
                                            <i class="fas fa-users"></i> Nosotros
                                        </label>
                                        <textarea id="nosotrosConfig" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; resize: vertical; min-height: 150px; font-size: 1rem;" placeholder="Cu茅ntale a tus clientes sobre tu empresa, tu historia, misi贸n, visi贸n y valores...">${config.contenidoEmpresa?.nosotros || ''}</textarea>
                                        <small style="color: #6B7280; font-size: 0.85rem; display: block; margin-top: 8px;">
                                            <i class="fas fa-info-circle"></i> Este contenido aparecer谩 en la secci贸n "Nosotros" del footer y en la p谩gina correspondiente.
                                        </small>
                                    </div>
                                    
                                    <div style="margin-bottom: 30px; padding: 20px; background: #F9FAFB; border-radius: 12px; border: 1px solid #E5E7EB;">
                                        <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #374151;">
                                            <i class="fas fa-file-contract"></i> T茅rminos y Condiciones
                                        </label>
                                        <textarea id="terminosCondicionesConfig" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; resize: vertical; min-height: 200px; font-size: 1rem;" placeholder="Establece los t茅rminos y condiciones de uso de tu tienda, pol铆ticas de devoluci贸n, garant铆as, etc...">${config.contenidoEmpresa?.terminosCondiciones || ''}</textarea>
                                        <small style="color: #6B7280; font-size: 0.85rem; display: block; margin-top: 8px;">
                                            <i class="fas fa-info-circle"></i> Este contenido aparecer谩 en la secci贸n "T茅rminos" del footer y en la p谩gina correspondiente.
                                        </small>
                                    </div>
                                    
                                    <div style="margin-bottom: 30px; padding: 20px; background: #F9FAFB; border-radius: 12px; border: 1px solid #E5E7EB;">
                                        <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #374151;">
                                            <i class="fas fa-newspaper"></i> Prensa
                                        </label>
                                        <textarea id="prensaConfig" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; resize: vertical; min-height: 150px; font-size: 1rem;" placeholder="Informaci贸n para medios de comunicaci贸n: notas de prensa, comunicados, material para periodistas, reconocimientos, etc...">${config.contenidoEmpresa?.prensa || ''}</textarea>
                                        <small style="color: #6B7280; font-size: 0.85rem; display: block; margin-top: 8px;">
                                            <i class="fas fa-info-circle"></i> Esta secci贸n es 煤til para compartir informaci贸n con medios de comunicaci贸n, notas de prensa, comunicados oficiales, material para periodistas (logos, fotos, contacto), reconocimientos y menciones en medios.
                                        </small>
                                    </div>
                                    
                                    <div style="margin-bottom: 30px; padding: 20px; background: #F9FAFB; border-radius: 12px; border: 1px solid #E5E7EB;">
                                        <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #374151;">
                                            <i class="fas fa-briefcase"></i> Trabaja con Nosotros
                                        </label>
                                        <textarea id="trabajaConNosotrosConfig" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; resize: vertical; min-height: 150px; font-size: 1rem;" placeholder="Informaci贸n sobre oportunidades laborales, c贸mo aplicar, requisitos, beneficios, etc...">${config.contenidoEmpresa?.trabajaConNosotros || ''}</textarea>
                                        <small style="color: #6B7280; font-size: 0.85rem; display: block; margin-top: 8px;">
                                            <i class="fas fa-info-circle"></i> Este contenido aparecer谩 en la secci贸n "Trabaja con nosotros" del footer y en la p谩gina correspondiente.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="guardarConfiguracionTiendaCompleta()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Guardar</button>
                            <button onclick="exportarConfiguracionTienda()" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Exportar</button>
                            <button onclick="importarConfiguracionTienda()" style="background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Importar</button>
                            <button onclick="cerrarConfiguracionTiendaCompleta()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Variables para almacenar archivos convertidos a base64
        const archivosMultimedia = {
            banner: null,
            logo: null,
            video: null
        };
        
        function cambiarModoMultimedia(tipo, modo) {
            // Actualizar botones
            const btnURL = document.getElementById(`btn${tipo.charAt(0).toUpperCase() + tipo.slice(1)}URL`);
            const btnArchivo = document.getElementById(`btn${tipo.charAt(0).toUpperCase() + tipo.slice(1)}Archivo`);
            
            if (modo === 'url') {
                btnURL.style.background = '#667eea';
                btnURL.style.borderColor = '#667eea';
                btnURL.style.color = 'white';
                btnArchivo.style.background = 'white';
                btnArchivo.style.borderColor = '#D1D5DB';
                btnArchivo.style.color = '#374151';
                
                document.getElementById(`${tipo}URLContainer`).style.display = 'block';
                document.getElementById(`${tipo}ArchivoContainer`).style.display = 'none';
                
                // Limpiar archivo guardado
                archivosMultimedia[tipo] = null;
            } else {
                btnURL.style.background = 'white';
                btnURL.style.borderColor = '#D1D5DB';
                btnURL.style.color = '#374151';
                btnArchivo.style.background = '#667eea';
                btnArchivo.style.borderColor = '#667eea';
                btnArchivo.style.color = 'white';
                
                document.getElementById(`${tipo}URLContainer`).style.display = 'none';
                document.getElementById(`${tipo}ArchivoContainer`).style.display = 'block';
            }
        }
        
        function previsualizarArchivo(tipo, input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const previewId = tipo === 'video' ? 'videoPreviewVideo' : `imgPreview${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`;
                const previewContainer = document.getElementById(`preview${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
                
                if (tipo === 'video') {
                    const video = document.getElementById(previewId);
                    video.src = e.target.result;
                    previewContainer.style.display = 'block';
                } else {
                    const img = document.getElementById(previewId);
                    img.src = e.target.result;
                    previewContainer.style.display = 'block';
                }
                
                // Guardar como base64 para localStorage
                archivosMultimedia[tipo] = e.target.result;
            };
            
            reader.readAsDataURL(file);
        }
        
        async function obtenerValorMultimedia(tipo) {
            const btnURL = document.getElementById(`btn${tipo.charAt(0).toUpperCase() + tipo.slice(1)}URL`);
            const estaEnModoURL = btnURL && btnURL.getAttribute('data-activo') === 'true';
            
            if (estaEnModoURL) {
                // Usar URL
                const inputId = tipo === 'banner' ? 'bannerPrincipalConfig' : 
                               tipo === 'logo' ? 'logoConfig' : 
                               'videoPresentacionConfig';
                const inputURL = document.getElementById(inputId);
                return inputURL?.value || '';
            } else {
                // Usar archivo (base64)
                if (archivosMultimedia[tipo]) {
                    return archivosMultimedia[tipo];
                }
                // Si no hay archivo nuevo, intentar obtener el guardado anterior
                const config = sistemaConfiguracionTienda.configuracion;
                const valorAnterior = tipo === 'banner' ? config.imagenesVideos?.bannerPrincipal : 
                                     tipo === 'logo' ? config.imagenesVideos?.logo : 
                                     config.imagenesVideos?.videoPresentacion;
                // Si es base64 (empieza con data:), devolverlo
                if (valorAnterior && valorAnterior.startsWith('data:')) {
                    return valorAnterior;
                }
                return '';
            }
        }
        
        function mostrarTabConfiguracion(tab) {
            document.querySelectorAll('[id^="tabContenido"]').forEach(contenido => {
                contenido.style.display = 'none';
            });
            document.querySelectorAll('[id^="tab"]').forEach(tabBtn => {
                if (tabBtn.id.startsWith('tab')) {
                    tabBtn.style.background = '#E5E7EB';
                    tabBtn.style.color = '#374151';
                }
            });
            const contenido = document.getElementById('tabContenido' + tab.charAt(0).toUpperCase() + tab.slice(1));
            const tabBtn = document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1));
            if (contenido) contenido.style.display = 'block';
            if (tabBtn) {
                tabBtn.style.background = '#667eea';
                tabBtn.style.color = 'white';
            }
        }
        
        function guardarConfiguracionTiendaCompleta() {
            const informacionTienda = {
                nombre: document.getElementById('nombreTiendaConfig')?.value || '',
                descripcion: document.getElementById('descripcionTiendaConfig')?.value || '',
                email: document.getElementById('emailTiendaConfig')?.value || '',
                telefono: document.getElementById('telefonoTiendaConfig')?.value || '',
                sitioWeb: document.getElementById('sitioWebTiendaConfig')?.value || ''
            };
            const ubicacion = {
                direccion: document.getElementById('direccionTiendaConfig')?.value || '',
                ciudad: document.getElementById('ciudadTiendaConfig')?.value || '',
                provincia: document.getElementById('provinciaTiendaConfig')?.value || '',
                codigoPostal: document.getElementById('codigoPostalTiendaConfig')?.value || '',
                pais: document.getElementById('paisTiendaConfig')?.value || 'Argentina'
            };
            const informacionEmpresa = {
                a帽oCreacion: parseInt(document.getElementById('a帽oCreacionConfig')?.value || new Date().getFullYear()),
                razonSocial: document.getElementById('razonSocialConfig')?.value || '',
                cuit: document.getElementById('cuitConfig')?.value || '',
                rubro: document.getElementById('rubroConfig')?.value || ''
            };
            const redesSociales = {
                instagram: document.getElementById('instagramConfig')?.value || '',
                facebook: document.getElementById('facebookConfig')?.value || '',
                twitter: document.getElementById('twitterConfig')?.value || '',
                tiktok: document.getElementById('tiktokConfig')?.value || '',
                youtube: document.getElementById('youtubeConfig')?.value || '',
                linkedin: document.getElementById('linkedinConfig')?.value || '',
                whatsapp: document.getElementById('whatsappConfig')?.value || ''
            };
            
            // Obtener valores de multimedia (URL o archivo)
            Promise.all([
                obtenerValorMultimedia('banner'),
                obtenerValorMultimedia('logo'),
                obtenerValorMultimedia('video')
            ]).then(valores => {
                const imagenesVideos = {
                    bannerPrincipal: valores[0] || '',
                    logo: valores[1] || '',
                    videoPresentacion: valores[2] || ''
                };
                const cresaliaBot = {
                    activo: document.getElementById('botActivoConfig')?.checked || false,
                    horarioAtencion: document.getElementById('horarioAtencionBotConfig')?.value || '',
                    mensajeBienvenida: document.getElementById('mensajeBienvenidaBotConfig')?.value || ''
                };
                const servicioAyuda = {
                    activo: document.getElementById('servicioAyudaActivoConfig')?.checked !== false,
                    colorPrimario: document.getElementById('colorPrimarioAyudaConfig')?.value || '#EC4899',
                    colorSecundario: document.getElementById('colorSecundarioAyudaConfig')?.value || '#F9A8D4',
                    mensajePersonalizado: document.getElementById('mensajePersonalizadoAyudaConfig')?.value || ''
                };
                const contenidoEmpresa = {
                    nosotros: document.getElementById('nosotrosConfig')?.value || '',
                    terminosCondiciones: document.getElementById('terminosCondicionesConfig')?.value || '',
                    prensa: document.getElementById('prensaConfig')?.value || '',
                    trabajaConNosotros: document.getElementById('trabajaConNosotrosConfig')?.value || ''
                };
                sistemaConfiguracionTienda.actualizarInformacionTienda(informacionTienda);
                sistemaConfiguracionTienda.actualizarRedesSociales(redesSociales);
                sistemaConfiguracionTienda.actualizarUbicacion(ubicacion);
                sistemaConfiguracionTienda.actualizarInformacionEmpresa(informacionEmpresa);
                sistemaConfiguracionTienda.actualizarImagenesVideos(imagenesVideos);
                sistemaConfiguracionTienda.actualizarCresaliaBot(cresaliaBot);
                sistemaConfiguracionTienda.actualizarServicioAyuda(servicioAyuda);
                sistemaConfiguracionTienda.actualizarContenidoEmpresa(contenidoEmpresa);
                mostrarNotificacion(' Configuraci贸n guardada. Los cambios se actualizar谩n autom谩ticamente en tu tienda.', 'success');
            }).catch(error => {
                console.error('Error guardando multimedia:', error);
                mostrarNotificacion('锔 Error al guardar multimedia', 'error');
            });
        }
        
        function exportarConfiguracionTienda() {
            const configuracion = sistemaConfiguracionTienda.configuracion;
            const blob = new Blob([JSON.stringify(configuracion, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'configuracion-tienda-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            mostrarNotificacion(' Configuraci贸n exportada', 'success');
        }
        
        function importarConfiguracionTienda() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const configuracion = JSON.parse(e.target.result);
                            sistemaConfiguracionTienda.configuracion = configuracion;
                            sistemaConfiguracionTienda.guardarConfiguracion();
                            mostrarNotificacion(' Configuraci贸n importada', 'success');
                            cerrarConfiguracionTiendaCompleta();
                            setTimeout(() => abrirConfiguracionTiendaCompleta(), 500);
                        } catch (error) {
                            mostrarNotificacion('锔 Error al importar', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        function cerrarConfiguracionTiendaCompleta() {
            const modal = document.getElementById('modalConfiguracionTiendaCompleta');
            if (modal) modal.remove();
        }
        
        // ============================================
        // SISTEMA DE CONFIGURACIN DE REMISERA
        // ============================================
        
        class SistemaRemiseria {
            constructor() {
                this.configuracion = this.cargarConfiguracion();
                this.remiseros = this.cargarRemiseros();
                this.tarifas = this.cargarTarifas();
            }
            
            cargarConfiguracion() {
                const config = JSON.parse(localStorage.getItem('configuracion_remiseria') || '{}');
                return {
                    zonaOperacion: config.zonaOperacion || 'rural',
                    tipoCobro: config.tipoCobro || 'por_lugar',
                    lugaresDisponibles: config.lugaresDisponibles || 4,
                    lugarOpcional: config.lugarOpcional || false,
                    horarioAtencion: config.horarioAtencion || '24/7',
                    contacto: config.contacto || '',
                    provincia: config.provincia || '',
                    ciudad: config.ciudad || '',
                    zonaCobertura: config.zonaCobertura || []
                };
            }
            
            cargarRemiseros() {
                return JSON.parse(localStorage.getItem('remiseros_registrados') || '[]');
            }
            
            cargarTarifas() {
                return JSON.parse(localStorage.getItem('tarifas_remiseria') || '[]');
            }
            
            guardarConfiguracion() {
                localStorage.setItem('configuracion_remiseria', JSON.stringify(this.configuracion));
            }
            
            guardarRemiseros() {
                localStorage.setItem('remiseros_registrados', JSON.stringify(this.remiseros));
            }
            
            guardarTarifas() {
                localStorage.setItem('tarifas_remiseria', JSON.stringify(this.tarifas));
            }
            
            actualizarConfiguracion(datos) {
                this.configuracion = { ...this.configuracion, ...datos };
                this.guardarConfiguracion();
            }
            
            registrarRemisero(datos) {
                const remisero = {
                    id: Date.now(),
                    nombre: datos.nombre,
                    telefono: datos.telefono,
                    email: datos.email || '',
                    zonaOperacion: datos.zonaOperacion,
                    tipoCobro: datos.tipoCobro,
                    lugaresDisponibles: datos.lugaresDisponibles,
                    lugarOpcional: datos.lugarOpcional || false,
                    servicios: datos.servicios || [],
                    mediosPago: datos.mediosPago || [],
                    tarifaPagada: datos.tarifaPagada || false,
                    fechaRegistro: new Date().toISOString(),
                    estado: 'activo',
                    calificacion: 0,
                    viajesCompletados: 0,
                    disponibilidad: datos.disponibilidad || {}
                };
                this.remiseros.push(remisero);
                this.guardarRemiseros();
                return remisero;
            }
            
            actualizarRemisero(remiseroId, datos) {
                const index = this.remiseros.findIndex(r => r.id === remiseroId);
                if (index !== -1) {
                    this.remiseros[index] = { ...this.remiseros[index], ...datos };
                    this.guardarRemiseros();
                    return this.remiseros[index];
                }
                return null;
            }
            
            eliminarRemisero(remiseroId) {
                this.remiseros = this.remiseros.filter(r => r.id !== remiseroId);
                this.guardarRemiseros();
            }
            
            marcarTarifaPagada(remiseroId, pagada) {
                const remisero = this.remiseros.find(r => r.id === remiseroId);
                if (remisero) {
                    remisero.tarifaPagada = pagada;
                    remisero.fechaActualizacionTarifa = new Date().toISOString();
                    this.guardarRemiseros();
                }
            }
            
            agregarTarifa(tarifa) {
                const nuevaTarifa = {
                    id: Date.now(),
                    zonaOperacion: tarifa.zonaOperacion,
                    tipoCobro: tarifa.tipoCobro,
                    precioBase: tarifa.precioBase,
                    precioPorKm: tarifa.precioPorKm || 0,
                    precioPorLugar: tarifa.precioPorLugar || 0,
                    serviciosAdicionales: tarifa.serviciosAdicionales || [],
                    fechaCreacion: new Date().toISOString(),
                    activa: true
                };
                this.tarifas.push(nuevaTarifa);
                this.guardarTarifas();
                return nuevaTarifa;
            }
            
            obtenerEstadisticas() {
                const totalRemiseros = this.remiseros.length;
                const remiserosActivos = this.remiseros.filter(r => r.estado === 'activo').length;
                const tarifasPagadas = this.remiseros.filter(r => r.tarifaPagada).length;
                const tarifasPendientes = totalRemiseros - tarifasPagadas;
                const promedioCalificacion = this.remiseros.length > 0 ? 
                    this.remiseros.reduce((sum, r) => sum + r.calificacion, 0) / this.remiseros.length : 0;
                return {
                    totalRemiseros,
                    remiserosActivos,
                    tarifasPagadas,
                    tarifasPendientes,
                    promedioCalificacion: Math.round(promedioCalificacion * 10) / 10,
                    zonaOperacion: this.configuracion.zonaOperacion,
                    tipoCobro: this.configuracion.tipoCobro
                };
            }
            
            obtenerRemiserosPorZona(zona) {
                return this.remiseros.filter(r => r.zonaOperacion === zona);
            }
            
            obtenerRemiserosConTarifaPendiente() {
                return this.remiseros.filter(r => !r.tarifaPagada);
            }
        }
        
        let sistemaRemiseria = new SistemaRemiseria();
        
        function abrirConfiguracionRemiseria() {
            console.log(' Abriendo configuraci贸n de remiser铆a...');
            const modal = document.createElement('div');
            modal.id = 'modalConfiguracionRemiseria';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            const estadisticas = sistemaRemiseria.obtenerEstadisticas();
            const config = sistemaRemiseria.configuracion;
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 1400px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarConfiguracionRemiseria()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;"></div>
                        <h2 style="margin: 0;">Sistema de Remiser铆a</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Gesti贸n completa de servicios de transporte</p>
                    </div>
                    <div style="padding: 32px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #F0FDF4; padding: 20px; border-radius: 12px; border: 1px solid #BBF7D0; text-align: center;">
                                <div style="font-size: 2rem; color: #059669; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #059669; font-size: 1.5rem;">${estadisticas.totalRemiseros}</h3>
                                <p style="margin: 0; color: #059669; font-size: 0.9rem;">Total Remiseros</p>
                            </div>
                            <div style="background: #F0F9FF; padding: 20px; border-radius: 12px; border: 1px solid #BAE6FD; text-align: center;">
                                <div style="font-size: 2rem; color: #0369A1; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #0369A1; font-size: 1.5rem;">${estadisticas.remiserosActivos}</h3>
                                <p style="margin: 0; color: #0369A1; font-size: 0.9rem;">Activos</p>
                            </div>
                            <div style="background: #FEF2F2; padding: 20px; border-radius: 12px; border: 1px solid #FECACA; text-align: center;">
                                <div style="font-size: 2rem; color: #DC2626; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #DC2626; font-size: 1.5rem;">${estadisticas.tarifasPagadas}</h3>
                                <p style="margin: 0; color: #DC2626; font-size: 0.9rem;">Tarifas Pagadas</p>
                            </div>
                            <div style="background: #FDF2F8; padding: 20px; border-radius: 12px; border: 1px solid #FBCFE8; text-align: center;">
                                <div style="font-size: 2rem; color: #BE185D; margin-bottom: 8px;">锔</div>
                                <h3 style="margin: 0; color: #BE185D; font-size: 1.5rem;">${estadisticas.tarifasPendientes}</h3>
                                <p style="margin: 0; color: #BE185D; font-size: 0.9rem;">Tarifas Pendientes</p>
                            </div>
                        </div>
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                                <button onclick="mostrarTabRemiseria('configuracion')" id="tabRemiseriaConfiguracion" style="background: #10B981; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">锔 Configuraci贸n</button>
                                <button onclick="mostrarTabRemiseria('remiseros')" id="tabRemiseriaRemiseros" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Remiseros</button>
                                <button onclick="mostrarTabRemiseria('tarifas')" id="tabRemiseriaTarifas" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Tarifas</button>
                                <button onclick="mostrarTabRemiseria('pendientes')" id="tabRemiseriaPendientes" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">锔 Pendientes</button>
                            </div>
                            <div id="contenidoRemiseria">
                                <div id="tabContenidoRemiseriaConfiguracion" style="display: block;">
                                    <h3 style="margin: 0 0 20px; color: #374151;">锔 Configuraci贸n General</h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Zona de Operaci贸n</label><select id="zonaOperacionRemiseria" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"><option value="rural" ${config.zonaOperacion === 'rural' ? 'selected' : ''}>Rural (Pueblo)</option><option value="urbano" ${config.zonaOperacion === 'urbano' ? 'selected' : ''}>Urbano (Ciudad)</option></select></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Tipo de Cobro</label><select id="tipoCobroRemiseria" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"><option value="por_lugar" ${config.tipoCobro === 'por_lugar' ? 'selected' : ''}>Por Lugar/Asiento</option><option value="por_kilometro" ${config.tipoCobro === 'por_kilometro' ? 'selected' : ''}>Por Kil贸metro</option></select></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Lugares Disponibles</label><input type="number" id="lugaresDisponiblesRemiseria" value="${config.lugaresDisponibles}" min="1" max="6" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">5to Lugar Opcional</label><label style="display: flex; align-items: center; gap: 10px; cursor: pointer;"><input type="checkbox" id="lugarOpcionalRemiseria" ${config.lugarOpcional ? 'checked' : ''} style="transform: scale(1.2);"><span style="color: #6B7280;">Permitir 5to lugar opcional</span></label></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Provincia</label><input type="text" id="provinciaRemiseria" value="${config.provincia}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Ciudad/Pueblo</label><input type="text" id="ciudadRemiseria" value="${config.ciudad}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Horario de Atenci贸n</label><input type="text" id="horarioAtencionRemiseria" value="${config.horarioAtencion}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                        <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Contacto</label><input type="text" id="contactoRemiseria" value="${config.contacto}" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                    </div>
                                </div>
                                <div id="tabContenidoRemiseriaRemiseros" style="display: none;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                        <h3 style="margin: 0; color: #374151;"> Gesti贸n de Remiseros</h3>
                                        <button onclick="mostrarFormularioRemisero()" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Agregar Remisero</button>
                                    </div>
                                    <div id="listaRemiseros" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                        ${sistemaRemiseria.remiseros.length > 0 ? sistemaRemiseria.remiseros.map(remisero => `
                                            <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px;">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                                    <div><h4 style="margin: 0; color: #374151; font-size: 1.1rem;">${remisero.nombre || 'Remisero'}</h4><p style="margin: 5px 0 0; color: #6B7280; font-size: 0.9rem;">${remisero.telefono || 'Sin tel茅fono'}</p></div>
                                                    <div style="display: flex; gap: 5px;"><span style="background: ${remisero.tarifaPagada ? '#10B981' : '#EF4444'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${remisero.tarifaPagada ? 'Pagado' : 'Pendiente'}</span><span style="background: ${remisero.zonaOperacion === 'rural' ? '#F59E0B' : '#3B82F6'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${remisero.zonaOperacion === 'rural' ? 'Rural' : 'Urbano'}</span></div>
                                                </div>
                                                <div style="margin-bottom: 15px;"><p style="margin: 0; color: #6B7280; font-size: 0.9rem;"><strong>Tipo:</strong> ${remisero.tipoCobro === 'por_lugar' ? 'Por Lugar' : 'Por Km'}<br><strong>Lugares:</strong> ${remisero.lugaresDisponibles || 4}<br><strong>Calificaci贸n:</strong> ${remisero.calificacion || 0}/5 猸</p></div>
                                                <div style="display: flex; gap: 10px;">
                                                    <button onclick="marcarTarifaRemisero(${remisero.id}, ${!remisero.tarifaPagada})" style="background: ${remisero.tarifaPagada ? '#EF4444' : '#10B981'}; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">${remisero.tarifaPagada ? 'Marcar Pendiente' : 'Marcar Pagado'}</button>
                                                    <button onclick="eliminarRemisero(${remisero.id})" style="background: #EF4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">锔 Eliminar</button>
                                                </div>
                                            </div>
                                        `).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No hay remiseros registrados</p></div>'}
                                    </div>
                                </div>
                                <div id="tabContenidoRemiseriaTarifas" style="display: none;">
                                    <h3 style="margin: 0 0 20px; color: #374151;"> Gesti贸n de Tarifas</h3>
                                    <div id="listaTarifas" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                        ${sistemaRemiseria.tarifas.length > 0 ? sistemaRemiseria.tarifas.map(tarifa => `
                                            <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px;">
                                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                                    <div><h4 style="margin: 0; color: #374151;">${tarifa.zonaOperacion === 'rural' ? 'Rural' : 'Urbano'}</h4><p style="margin: 5px 0; color: #6B7280;">${tarifa.tipoCobro === 'por_lugar' ? 'Por Lugar' : 'Por Km'}</p></div>
                                                    <span style="background: ${tarifa.activa ? '#10B981' : '#6B7280'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${tarifa.activa ? 'Activa' : 'Inactiva'}</span>
                                                </div>
                                                <p style="margin: 0; color: #6B7280; font-size: 0.9rem;"><strong>Precio Base:</strong> $${tarifa.precioBase || 0}</p>
                                            </div>
                                        `).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No hay tarifas configuradas</p></div>'}
                                    </div>
                                </div>
                                <div id="tabContenidoRemiseriaPendientes" style="display: none;">
                                    <h3 style="margin: 0 0 20px; color: #374151;">锔 Tarifas Pendientes</h3>
                                    <div id="listaPendientes" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                        ${sistemaRemiseria.obtenerRemiserosConTarifaPendiente().length > 0 ? sistemaRemiseria.obtenerRemiserosConTarifaPendiente().map(remisero => `
                                            <div style="background: #FEF2F2; border: 2px solid #FECACA; border-radius: 12px; padding: 20px;">
                                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                                    <div><h4 style="margin: 0; color: #DC2626;">${remisero.nombre}</h4><p style="margin: 5px 0; color: #DC2626;">${remisero.telefono}</p></div>
                                                    <span style="background: #EF4444; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">PENDIENTE</span>
                                                </div>
                                                <div style="display: flex; gap: 10px;">
                                                    <button onclick="marcarTarifaRemisero(${remisero.id}, true)" style="background: #10B981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;"> Marcar Pagado</button>
                                                </div>
                                            </div>
                                        `).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No hay tarifas pendientes</p></div>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="guardarConfiguracionRemiseria()" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Guardar</button>
                            <button onclick="exportarDatosRemiseria()" style="background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Exportar</button>
                            <button onclick="cerrarConfiguracionRemiseria()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function mostrarTabRemiseria(tab) {
            document.querySelectorAll('[id^="tabContenidoRemiseria"]').forEach(contenido => {
                contenido.style.display = 'none';
            });
            document.querySelectorAll('[id^="tabRemiseria"]').forEach(tabBtn => {
                if (tabBtn.id.startsWith('tabRemiseria')) {
                    tabBtn.style.background = '#E5E7EB';
                    tabBtn.style.color = '#374151';
                }
            });
            const contenido = document.getElementById('tabContenidoRemiseria' + tab.charAt(0).toUpperCase() + tab.slice(1));
            const tabBtn = document.getElementById('tabRemiseria' + tab.charAt(0).toUpperCase() + tab.slice(1));
            if (contenido) contenido.style.display = 'block';
            if (tabBtn) {
                tabBtn.style.background = '#10B981';
                tabBtn.style.color = 'white';
            }
        }
        
        function mostrarFormularioRemisero() {
            const modal = document.createElement('div');
            modal.id = 'modalFormularioRemisero';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; padding: 30px;">
                    <h3 style="margin: 0 0 20px; color: #374151;"> Registrar Nuevo Remisero</h3>
                    <form id="formularioRemisero">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div><label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Nombre Completo</label><input type="text" id="nombreRemisero" required style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            <div><label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Tel茅fono</label><input type="tel" id="telefonoRemisero" required style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            <div><label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Email</label><input type="email" id="emailRemisero" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            <div><label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Zona</label><select id="zonaOperacionRemisero" required style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"><option value="rural">Rural</option><option value="urbano">Urbano</option></select></div>
                            <div><label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Tipo Cobro</label><select id="tipoCobroRemisero" required style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"><option value="por_lugar">Por Lugar</option><option value="por_kilometro">Por Km</option></select></div>
                            <div><label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Lugares</label><input type="number" id="lugaresDisponiblesRemisero" value="4" min="1" max="6" required style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            <div><label style="display: flex; align-items: center; gap: 10px; cursor: pointer;"><input type="checkbox" id="lugarOpcionalRemisero" style="transform: scale(1.2);"><span>5to lugar opcional</span></label></div>
                            <div><label style="display: flex; align-items: center; gap: 10px; cursor: pointer;"><input type="checkbox" id="tarifaPagadaRemisero" style="transform: scale(1.2);"><span>Tarifa pagada</span></label></div>
                        </div>
                        <div style="display: flex; gap: 15px; justify-content: flex-end;">
                            <button type="button" onclick="cerrarFormularioRemisero()" style="padding: 10px 20px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer;">Cancelar</button>
                            <button type="submit" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;"> Registrar</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('formularioRemisero').addEventListener('submit', function(e) {
                e.preventDefault();
                const datosRemisero = {
                    nombre: document.getElementById('nombreRemisero').value,
                    telefono: document.getElementById('telefonoRemisero').value,
                    email: document.getElementById('emailRemisero').value,
                    zonaOperacion: document.getElementById('zonaOperacionRemisero').value,
                    tipoCobro: document.getElementById('tipoCobroRemisero').value,
                    lugaresDisponibles: parseInt(document.getElementById('lugaresDisponiblesRemisero').value),
                    lugarOpcional: document.getElementById('lugarOpcionalRemisero').checked,
                    servicios: [],
                    mediosPago: [],
                    tarifaPagada: document.getElementById('tarifaPagadaRemisero').checked
                };
                sistemaRemiseria.registrarRemisero(datosRemisero);
                mostrarNotificacion(' Remisero registrado', 'success');
                cerrarFormularioRemisero();
                cerrarConfiguracionRemiseria();
                setTimeout(() => abrirConfiguracionRemiseria(), 500);
            });
        }
        
        function cerrarFormularioRemisero() {
            const modal = document.getElementById('modalFormularioRemisero');
            if (modal) modal.remove();
        }
        
        function guardarConfiguracionRemiseria() {
            const configuracion = {
                zonaOperacion: document.getElementById('zonaOperacionRemiseria')?.value || 'rural',
                tipoCobro: document.getElementById('tipoCobroRemiseria')?.value || 'por_lugar',
                lugaresDisponibles: parseInt(document.getElementById('lugaresDisponiblesRemiseria')?.value || '4'),
                lugarOpcional: document.getElementById('lugarOpcionalRemiseria')?.checked || false,
                provincia: document.getElementById('provinciaRemiseria')?.value || '',
                ciudad: document.getElementById('ciudadRemiseria')?.value || '',
                horarioAtencion: document.getElementById('horarioAtencionRemiseria')?.value || '',
                contacto: document.getElementById('contactoRemiseria')?.value || ''
            };
            sistemaRemiseria.actualizarConfiguracion(configuracion);
            mostrarNotificacion(' Configuraci贸n guardada', 'success');
        }
        
        function marcarTarifaRemisero(remiseroId, pagada) {
            sistemaRemiseria.marcarTarifaPagada(remiseroId, pagada);
            mostrarNotificacion(' Tarifa actualizada', 'success');
            cerrarConfiguracionRemiseria();
            setTimeout(() => abrirConfiguracionRemiseria(), 500);
        }
        
        function eliminarRemisero(remiseroId) {
            if (confirm('驴Eliminar este remisero?')) {
                sistemaRemiseria.eliminarRemisero(remiseroId);
                mostrarNotificacion(' Remisero eliminado', 'success');
                cerrarConfiguracionRemiseria();
                setTimeout(() => abrirConfiguracionRemiseria(), 500);
            }
        }
        
        function exportarDatosRemiseria() {
            const datos = {
                configuracion: sistemaRemiseria.configuracion,
                remiseros: sistemaRemiseria.remiseros,
                tarifas: sistemaRemiseria.tarifas,
                estadisticas: sistemaRemiseria.obtenerEstadisticas(),
                fechaExportacion: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'datos-remiseria-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            mostrarNotificacion(' Datos exportados', 'success');
        }
        
        function cerrarConfiguracionRemiseria() {
            const modal = document.getElementById('modalConfiguracionRemiseria');
            if (modal) modal.remove();
        }
        
        // ============================================
        // SISTEMA DE GESTIN DE BACKUP
        // ============================================
        
        class SistemaBackup {
            constructor() {
                this.backups = this.cargarBackups();
                this.configuracion = this.cargarConfiguracion();
                this.inicializar();
            }
            
            cargarBackups() {
                return JSON.parse(localStorage.getItem('backups_cresalia') || '[]');
            }
            
            cargarConfiguracion() {
                return JSON.parse(localStorage.getItem('configuracion_backup') || '{}');
            }
            
            guardarBackups() {
                localStorage.setItem('backups_cresalia', JSON.stringify(this.backups));
            }
            
            guardarConfiguracion() {
                localStorage.setItem('configuracion_backup', JSON.stringify(this.configuracion));
            }
            
            inicializar() {
                console.log(' Sistema de Backup inicializado');
                this.configurarBackupAutomatico();
            }
            
            configurarBackupAutomatico() {
                setInterval(() => {
                    if (this.configuracion.automatico !== false) {
                        this.crearBackup('automatico');
                    }
                }, 30 * 60 * 1000);
            }
            
            crearBackup(tipo = 'manual') {
                const backup = {
                    id: Date.now(),
                    fecha: new Date().toISOString(),
                    tipo: tipo,
                    datos: {
                        productos: JSON.parse(localStorage.getItem('productos') || '[]'),
                        servicios: JSON.parse(localStorage.getItem('servicios') || '[]'),
                        ventas: JSON.parse(localStorage.getItem('ventas') || '[]'),
                        turnos: JSON.parse(localStorage.getItem('turnos') || '[]'),
                        configuracionTienda: JSON.parse(localStorage.getItem('configuracionTienda') || '{}'),
                        analytics: JSON.parse(localStorage.getItem('analytics') || '{}'),
                        configuracionRemiseria: JSON.parse(localStorage.getItem('configuracion_remiseria') || '{}'),
                        remiseros: JSON.parse(localStorage.getItem('remiseros_registrados') || '[]'),
                        estadosAnimo: JSON.parse(localStorage.getItem('estados_animo') || '[]'),
                        logros: JSON.parse(localStorage.getItem('logros_bienestar') || '[]')
                    },
                    tama帽o: 0,
                    version: '1.0'
                };
                backup.tama帽o = JSON.stringify(backup.datos).length;
                this.backups.unshift(backup);
                if (this.backups.length > 20) {
                    this.backups = this.backups.slice(0, 20);
                }
                this.guardarBackups();
                if (tipo === 'manual') {
                    mostrarNotificacion(' Backup creado exitosamente', 'success');
                } else {
                    console.log(' Backup autom谩tico creado');
                }
                return backup;
            }
            
            restaurarBackup(backupId) {
                const backup = this.backups.find(b => b.id === backupId);
                if (!backup) {
                    mostrarNotificacion(' Backup no encontrado', 'error');
                    return false;
                }
                if (confirm(`驴Restaurar backup del ${new Date(backup.fecha).toLocaleDateString('es-ES')}? Esto sobrescribir谩 todos los datos actuales.`)) {
                    try {
                        Object.keys(backup.datos).forEach(key => {
                            if (backup.datos[key] !== null) {
                                localStorage.setItem(key, JSON.stringify(backup.datos[key]));
                            }
                        });
                        mostrarNotificacion(' Backup restaurado exitosamente', 'success');
                        setTimeout(() => { window.location.reload(); }, 2000);
                        return true;
                    } catch (error) {
                        mostrarNotificacion(' Error al restaurar backup', 'error');
                        console.error('Error restaurando backup:', error);
                        return false;
                    }
                }
                return false;
            }
            
            eliminarBackup(backupId) {
                const index = this.backups.findIndex(b => b.id === backupId);
                if (index !== -1) {
                    this.backups.splice(index, 1);
                    this.guardarBackups();
                    mostrarNotificacion('锔 Backup eliminado', 'success');
                    cerrarGestionBackup();
                    setTimeout(() => abrirGestionBackup(), 500);
                    return true;
                }
                return false;
            }
            
            exportarBackup(backupId) {
                const backup = this.backups.find(b => b.id === backupId);
                if (!backup) {
                    mostrarNotificacion(' Backup no encontrado', 'error');
                    return false;
                }
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'backup-cresalia-' + new Date(backup.fecha).toISOString().split('T')[0] + '.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                mostrarNotificacion(' Backup exportado', 'success');
                return true;
            }
            
            obtenerEstadisticas() {
                const totalBackups = this.backups.length;
                const tama帽oTotal = this.backups.reduce((sum, b) => sum + b.tama帽o, 0);
                const ultimoBackup = this.backups.length > 0 ? this.backups[0].fecha : null;
                return {
                    totalBackups,
                    tama帽oTotal: Math.round(tama帽oTotal / 1024),
                    ultimoBackup,
                    automaticoActivo: this.configuracion.automatico !== false
                };
            }
        }
        
        let sistemaBackup = new SistemaBackup();
        
        function abrirGestionBackup() {
            console.log(' Abriendo gesti贸n de backup...');
            const modal = document.createElement('div');
            modal.id = 'modalGestionBackup';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            const estadisticas = sistemaBackup.obtenerEstadisticas();
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarGestionBackup()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;"></div>
                        <h2 style="margin: 0;">Sistema de Backup y Restauraci贸n</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Protecci贸n completa de tus datos</p>
                    </div>
                    <div style="padding: 32px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #F0FDF4; padding: 20px; border-radius: 12px; border: 1px solid #BBF7D0; text-align: center;">
                                <div style="font-size: 2rem; color: #059669; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #059669; font-size: 1.5rem;">${estadisticas.totalBackups}</h3>
                                <p style="margin: 0; color: #059669; font-size: 0.9rem;">Backups Totales</p>
                            </div>
                            <div style="background: #F0F9FF; padding: 20px; border-radius: 12px; border: 1px solid #BAE6FD; text-align: center;">
                                <div style="font-size: 2rem; color: #0369A1; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #0369A1; font-size: 1.5rem;">${estadisticas.tama帽oTotal} KB</h3>
                                <p style="margin: 0; color: #0369A1; font-size: 0.9rem;">Tama帽o Total</p>
                            </div>
                            <div style="background: #FEF2F2; padding: 20px; border-radius: 12px; border: 1px solid #FECACA; text-align: center;">
                                <div style="font-size: 2rem; color: #DC2626; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #DC2626; font-size: 1.5rem;">${estadisticas.automaticoActivo ? 'Activo' : 'Inactivo'}</h3>
                                <p style="margin: 0; color: #DC2626; font-size: 0.9rem;">Backup Autom谩tico</p>
                            </div>
                            <div style="background: #FDF2F8; padding: 20px; border-radius: 12px; border: 1px solid #FBCFE8; text-align: center;">
                                <div style="font-size: 2rem; color: #BE185D; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #BE185D; font-size: 1.5rem;">${estadisticas.ultimoBackup ? new Date(estadisticas.ultimoBackup).toLocaleDateString('es-ES') : 'Nunca'}</h3>
                                <p style="margin: 0; color: #BE185D; font-size: 0.9rem;">ltimo Backup</p>
                            </div>
                        </div>
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; color: #374151;"> Historial de Backups</h3>
                                <button onclick="crearBackupManual()" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Crear Backup</button>
                            </div>
                            <div id="listaBackups" style="max-height: 400px; overflow-y: auto;">
                                ${sistemaBackup.backups.length > 0 ? sistemaBackup.backups.map(backup => `
                                    <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                            <div><h4 style="margin: 0; color: #374151; font-size: 1.1rem;">Backup ${backup.tipo === 'manual' ? 'Manual' : 'Autom谩tico'}</h4><p style="margin: 5px 0 0; color: #6B7280; font-size: 0.9rem;">${new Date(backup.fecha).toLocaleString('es-ES')}</p></div>
                                            <div style="display: flex; gap: 5px;"><span style="background: ${backup.tipo === 'manual' ? '#3B82F6' : '#10B981'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${backup.tipo === 'manual' ? 'Manual' : 'Auto'}</span><span style="background: #6B7280; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${Math.round(backup.tama帽o / 1024) || 0} KB</span></div>
                                        </div>
                                        <div style="display: flex; gap: 10px;">
                                            <button onclick="restaurarBackupDesdeModal(${backup.id})" style="background: #10B981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;"> Restaurar</button>
                                            <button onclick="exportarBackupDesdeModal(${backup.id})" style="background: #3B82F6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;"> Exportar</button>
                                            <button onclick="eliminarBackupDesdeModal(${backup.id})" style="background: #EF4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">锔 Eliminar</button>
                                        </div>
                                    </div>
                                `).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No hay backups creados a煤n</p></div>'}
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="crearBackupManual()" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Crear Backup Manual</button>
                            <button onclick="exportarTodosBackups()" style="background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Exportar Todos</button>
                            <button onclick="cerrarGestionBackup()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function crearBackupManual() {
            sistemaBackup.crearBackup('manual');
            cerrarGestionBackup();
            setTimeout(() => abrirGestionBackup(), 500);
        }
        
        function restaurarBackupDesdeModal(backupId) {
            sistemaBackup.restaurarBackup(backupId);
        }
        
        function exportarBackupDesdeModal(backupId) {
            sistemaBackup.exportarBackup(backupId);
        }
        
        function eliminarBackupDesdeModal(backupId) {
            sistemaBackup.eliminarBackup(backupId);
        }
        
        function exportarTodosBackups() {
            const datos = {
                backups: sistemaBackup.backups,
                estadisticas: sistemaBackup.obtenerEstadisticas(),
                fechaExportacion: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'todos-backups-cresalia-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            mostrarNotificacion(' Todos los backups exportados', 'success');
        }
        
        function cerrarGestionBackup() {
            const modal = document.getElementById('modalGestionBackup');
            if (modal) modal.remove();
        }
        
        // ============================================
        // SISTEMA DE OFERTAS Y COMBOS
        // ============================================
        
        class SistemaOfertasCombos {
            constructor() {
                this.ofertas = this.cargarOfertas();
                this.combos = this.cargarCombos();
                this.categorias = this.cargarCategorias();
                this.inicializar();
            }
            
            cargarOfertas() {
                return JSON.parse(localStorage.getItem('ofertas_tienda') || '[]');
            }
            
            cargarCombos() {
                return JSON.parse(localStorage.getItem('combos_tienda') || '[]');
            }
            
            cargarCategorias() {
                return JSON.parse(localStorage.getItem('categorias_ofertas') || '[]');
            }
            
            guardarOfertas() {
                localStorage.setItem('ofertas_tienda', JSON.stringify(this.ofertas));
            }
            
            guardarCombos() {
                localStorage.setItem('combos_tienda', JSON.stringify(this.combos));
            }
            
            guardarCategorias() {
                localStorage.setItem('categorias_ofertas', JSON.stringify(this.categorias));
            }
            
            inicializar() {
                console.log(' Sistema de Ofertas y Combos inicializado');
                this.inicializarCategorias();
            }
            
            inicializarCategorias() {
                if (this.categorias.length === 0) {
                    this.categorias = [
                        { id: 'descuentos', nombre: 'Descuentos', icono: '凤', color: '#EF4444' },
                        { id: 'temporada', nombre: 'Temporada', icono: '', color: '#EC4899' },
                        { id: 'flash', nombre: 'Flash Sale', icono: '', color: '#F59E0B' },
                        { id: 'combo', nombre: 'Combos', icono: '', color: '#10B981' },
                        { id: 'nuevos', nombre: 'Nuevos', icono: '', color: '#3B82F6' },
                        { id: 'liquidacion', nombre: 'Liquidaci贸n', icono: '', color: '#DC2626' }
                    ];
                    this.guardarCategorias();
                }
            }
            
            crearOferta(datos) {
                const oferta = {
                    id: Date.now(),
                    nombre: datos.nombre,
                    descripcion: datos.descripcion,
                    tipo: datos.tipo,
                    valor: datos.valor,
                    categoria: datos.categoria,
                    productos: datos.productos || [],
                    servicios: datos.servicios || [],
                    fechaInicio: datos.fechaInicio,
                    fechaFin: datos.fechaFin,
                    activa: datos.activa !== false,
                    limiteUsos: datos.limiteUsos || null,
                    usosActuales: 0,
                    imagen: datos.imagen || '',
                    condiciones: datos.condiciones || '',
                    fechaCreacion: new Date().toISOString(),
                    creadaPor: 'admin'
                };
                this.ofertas.unshift(oferta);
                this.guardarOfertas();
                return oferta;
            }
            
            crearCombo(datos) {
                const combo = {
                    id: Date.now(),
                    nombre: datos.nombre,
                    descripcion: datos.descripcion,
                    productos: datos.productos || [],
                    servicios: datos.servicios || [],
                    precioOriginal: datos.precioOriginal,
                    precioCombo: datos.precioCombo,
                    descuento: datos.descuento,
                    categoria: datos.categoria,
                    imagen: datos.imagen || '',
                    activo: datos.activo !== false,
                    limiteStock: datos.limiteStock || null,
                    stockActual: datos.stockActual || 0,
                    fechaCreacion: new Date().toISOString(),
                    creadoPor: 'admin'
                };
                this.combos.unshift(combo);
                this.guardarCombos();
                return combo;
            }
            
            actualizarOferta(ofertaId, datos) {
                const index = this.ofertas.findIndex(o => o.id === ofertaId);
                if (index !== -1) {
                    this.ofertas[index] = { ...this.ofertas[index], ...datos };
                    this.guardarOfertas();
                    return this.ofertas[index];
                }
                return null;
            }
            
            actualizarCombo(comboId, datos) {
                const index = this.combos.findIndex(c => c.id === comboId);
                if (index !== -1) {
                    this.combos[index] = { ...this.combos[index], ...datos };
                    this.guardarCombos();
                    return this.combos[index];
                }
                return null;
            }
            
            eliminarOferta(ofertaId) {
                const index = this.ofertas.findIndex(o => o.id === ofertaId);
                if (index !== -1) {
                    this.ofertas.splice(index, 1);
                    this.guardarOfertas();
                    return true;
                }
                return false;
            }
            
            eliminarCombo(comboId) {
                const index = this.combos.findIndex(c => c.id === comboId);
                if (index !== -1) {
                    this.combos.splice(index, 1);
                    this.guardarCombos();
                    return true;
                }
                return false;
            }
            
            toggleOferta(ofertaId) {
                const oferta = this.ofertas.find(o => o.id === ofertaId);
                if (oferta) {
                    oferta.activa = !oferta.activa;
                    this.guardarOfertas();
                    return oferta;
                }
                return null;
            }
            
            toggleCombo(comboId) {
                const combo = this.combos.find(c => c.id === comboId);
                if (combo) {
                    combo.activo = !combo.activo;
                    this.guardarCombos();
                    return combo;
                }
                return null;
            }
            
            obtenerOfertasActivas() {
                return this.ofertas.filter(o => o.activa);
            }
            
            obtenerCombosActivos() {
                return this.combos.filter(c => c.activo);
            }
            
            obtenerEstadisticas() {
                const ofertasActivas = this.ofertas.filter(o => o.activa).length;
                const combosActivos = this.combos.filter(c => c.activo).length;
                const totalUsos = this.ofertas.reduce((sum, o) => sum + o.usosActuales, 0);
                const ofertasExpiradas = this.ofertas.filter(o => new Date(o.fechaFin) < new Date()).length;
                return {
                    totalOfertas: this.ofertas.length,
                    ofertasActivas,
                    totalCombos: this.combos.length,
                    combosActivos,
                    totalUsos,
                    ofertasExpiradas,
                    categorias: this.categorias.length
                };
            }
        }
        
        let sistemaOfertasCombos = new SistemaOfertasCombos();
        
        function abrirGestionOfertasCombos() {
            console.log(' Abriendo gesti贸n de ofertas y combos...');
            const modal = document.createElement('div');
            modal.id = 'modalGestionOfertasCombos';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            const estadisticas = sistemaOfertasCombos.obtenerEstadisticas();
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 1400px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarGestionOfertasCombos()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;"></div>
                        <h2 style="margin: 0;">Sistema de Ofertas y Combos</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Crea ofertas irresistibles para tus clientes</p>
                    </div>
                    <div style="padding: 32px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #F0FDF4; padding: 20px; border-radius: 12px; border: 1px solid #BBF7D0; text-align: center;">
                                <div style="font-size: 2rem; color: #059669; margin-bottom: 8px;">凤</div>
                                <h3 style="margin: 0; color: #059669; font-size: 1.5rem;">${estadisticas.ofertasActivas}</h3>
                                <p style="margin: 0; color: #059669; font-size: 0.9rem;">Ofertas Activas</p>
                            </div>
                            <div style="background: #F0F9FF; padding: 20px; border-radius: 12px; border: 1px solid #BAE6FD; text-align: center;">
                                <div style="font-size: 2rem; color: #0369A1; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #0369A1; font-size: 1.5rem;">${estadisticas.combosActivos}</h3>
                                <p style="margin: 0; color: #0369A1; font-size: 0.9rem;">Combos Activos</p>
                            </div>
                            <div style="background: #FEF2F2; padding: 20px; border-radius: 12px; border: 1px solid #FECACA; text-align: center;">
                                <div style="font-size: 2rem; color: #DC2626; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #DC2626; font-size: 1.5rem;">${estadisticas.totalUsos}</h3>
                                <p style="margin: 0; color: #DC2626; font-size: 0.9rem;">Usos Totales</p>
                            </div>
                            <div style="background: #FDF2F8; padding: 20px; border-radius: 12px; border: 1px solid #FBCFE8; text-align: center;">
                                <div style="font-size: 2rem; color: #BE185D; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #BE185D; font-size: 1.5rem;">${estadisticas.ofertasExpiradas}</h3>
                                <p style="margin: 0; color: #BE185D; font-size: 0.9rem;">Ofertas Expiradas</p>
                            </div>
                        </div>
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                                <button onclick="mostrarTabOfertas('ofertas')" id="tabOfertasOfertas" style="background: #F59E0B; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">凤 Ofertas</button>
                                <button onclick="mostrarTabOfertas('combos')" id="tabOfertasCombos" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Combos</button>
                                <button onclick="mostrarTabOfertas('categorias')" id="tabOfertasCategorias" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Categor铆as</button>
                            </div>
                            <div id="contenidoOfertas">
                                <div id="tabContenidoOfertasOfertas" style="display: block;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                        <h3 style="margin: 0; color: #374151;">凤 Gesti贸n de Ofertas</h3>
                                        <button onclick="mostrarFormularioOferta()" style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Crear Oferta</button>
                                    </div>
                                    <div id="listaOfertas" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                                        ${sistemaOfertasCombos.ofertas.length > 0 ? sistemaOfertasCombos.ofertas.map(oferta => `
                                            <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px;">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                                    <div><h4 style="margin: 0; color: #374151; font-size: 1.1rem;">${oferta.nombre || 'Oferta'}</h4><p style="margin: 5px 0 0; color: #6B7280; font-size: 0.9rem;">${oferta.descripcion || ''}</p></div>
                                                    <div style="display: flex; gap: 5px;"><span style="background: ${oferta.activa ? '#10B981' : '#6B7280'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${oferta.activa ? 'Activa' : 'Inactiva'}</span></div>
                                                </div>
                                                <div style="margin-bottom: 15px;"><p style="margin: 0; color: #6B7280; font-size: 0.9rem;"><strong>Tipo:</strong> ${oferta.tipo || 'N/A'}<br><strong>Valor:</strong> ${oferta.valor || 'N/A'}</p></div>
                                                <div style="display: flex; gap: 10px;">
                                                    <button onclick="toggleOferta(${oferta.id})" style="background: ${oferta.activa ? '#EF4444' : '#10B981'}; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">${oferta.activa ? 'Desactivar' : 'Activar'}</button>
                                                    <button onclick="eliminarOferta(${oferta.id})" style="background: #EF4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">锔 Eliminar</button>
                                                </div>
                                            </div>
                                        `).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No hay ofertas creadas</p></div>'}
                                    </div>
                                </div>
                                <div id="tabContenidoOfertasCombos" style="display: none;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                        <h3 style="margin: 0; color: #374151;"> Gesti贸n de Combos</h3>
                                        <button onclick="mostrarFormularioCombo()" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Crear Combo</button>
                                    </div>
                                    <div id="listaCombos" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                                        ${sistemaOfertasCombos.combos.length > 0 ? sistemaOfertasCombos.combos.map(combo => `
                                            <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px;">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                                    <div><h4 style="margin: 0; color: #374151; font-size: 1.1rem;">${combo.nombre || 'Combo'}</h4><p style="margin: 5px 0 0; color: #6B7280; font-size: 0.9rem;">${combo.descripcion || ''}</p></div>
                                                    <div style="display: flex; gap: 5px;"><span style="background: ${combo.activo ? '#10B981' : '#6B7280'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${combo.activo ? 'Activo' : 'Inactivo'}</span></div>
                                                </div>
                                                <div style="margin-bottom: 15px;"><p style="margin: 0; color: #6B7280; font-size: 0.9rem;"><strong>Precio Original:</strong> $${combo.precioOriginal || 0}<br><strong>Precio Combo:</strong> $${combo.precioCombo || 0}<br><strong>Descuento:</strong> ${combo.descuento || 0}%</p></div>
                                                <div style="display: flex; gap: 10px;">
                                                    <button onclick="toggleCombo(${combo.id})" style="background: ${combo.activo ? '#EF4444' : '#10B981'}; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">${combo.activo ? 'Desactivar' : 'Activar'}</button>
                                                    <button onclick="eliminarCombo(${combo.id})" style="background: #EF4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">锔 Eliminar</button>
                                                </div>
                                            </div>
                                        `).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No hay combos creados</p></div>'}
                                    </div>
                                </div>
                                <div id="tabContenidoOfertasCategorias" style="display: none;">
                                    <h3 style="margin: 0 0 20px; color: #374151;"> Categor铆as de Ofertas</h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                        ${sistemaOfertasCombos.categorias.map(categoria => `
                                            <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; text-align: center;">
                                                <div style="font-size: 2rem; margin-bottom: 10px;">${categoria.icono}</div>
                                                <h4 style="margin: 0; color: #374151; font-size: 1rem;">${categoria.nombre}</h4>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="exportarOfertasCombos()" style="background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Exportar</button>
                            <button onclick="cerrarGestionOfertasCombos()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function mostrarTabOfertas(tab) {
            document.querySelectorAll('[id^="tabContenidoOfertas"]').forEach(contenido => {
                contenido.style.display = 'none';
            });
            document.querySelectorAll('[id^="tabOfertas"]').forEach(tabBtn => {
                if (tabBtn.id.startsWith('tabOfertas')) {
                    tabBtn.style.background = '#E5E7EB';
                    tabBtn.style.color = '#374151';
                }
            });
            const contenido = document.getElementById('tabContenidoOfertas' + tab.charAt(0).toUpperCase() + tab.slice(1));
            const tabBtn = document.getElementById('tabOfertas' + tab.charAt(0).toUpperCase() + tab.slice(1));
            if (contenido) contenido.style.display = 'block';
            if (tabBtn) {
                tabBtn.style.background = '#F59E0B';
                tabBtn.style.color = 'white';
            }
        }
        
        function mostrarFormularioOferta() {
            // Cargar productos y servicios para seleccionar im谩genes
            const productos = sistemaProductos.cargarProductos();
            const servicios = sistemaServicios.cargarServicios();
            const config = window.sistemaConfiguracionTienda?.configuracion || {};
            const imagenesPerfil = config.imagenesVideos || {};
            
            // Obtener todas las im谩genes disponibles
            const imagenesDisponibles = [];
            
            // Im谩genes de productos
            productos.forEach(p => {
                if (p.imagen) imagenesDisponibles.push({ tipo: 'producto', nombre: p.nombre, url: p.imagen, id: p.id });
            });
            
            // Im谩genes de servicios
            servicios.forEach(s => {
                if (s.imagen) imagenesDisponibles.push({ tipo: 'servicio', nombre: s.nombre, url: s.imagen, id: s.id });
            });
            
            // Im谩genes del perfil de la tienda
            if (imagenesPerfil.bannerPrincipal) imagenesDisponibles.push({ tipo: 'perfil', nombre: 'Banner Principal', url: imagenesPerfil.bannerPrincipal, id: 'banner' });
            if (imagenesPerfil.logo) imagenesDisponibles.push({ tipo: 'perfil', nombre: 'Logo', url: imagenesPerfil.logo, id: 'logo' });
            if (imagenesPerfil.galeriaImagenes && Array.isArray(imagenesPerfil.galeriaImagenes)) {
                imagenesPerfil.galeriaImagenes.forEach((img, idx) => {
                    if (img) imagenesDisponibles.push({ tipo: 'perfil', nombre: `Galer铆a ${idx + 1}`, url: img, id: `galeria_${idx}` });
                });
            }
            
            const modal = document.createElement('div');
            modal.id = 'modalFormularioOferta';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 700px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; padding: 24px; text-align: center; position: relative;">
                        <button onclick="cerrarFormularioOferta()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <h3 style="margin: 0;">凤 Crear Nueva Oferta</h3>
                    </div>
                    <div style="padding: 24px;">
                        <form id="formularioOferta" onsubmit="guardarOferta(event); return false;">
                            <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Nombre</label><input type="text" id="nombreOferta" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Descripci贸n</label><textarea id="descripcionOferta" rows="3" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></textarea></div>
                            
                            <!-- Secci贸n de Imagen -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;"> Imagen de la Oferta</label>
                                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <button type="button" onclick="cambiarModoImagenOferta('subir')" id="btnSubirImagenOferta" style="flex: 1; background: #F59E0B; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Subir Nueva</button>
                                    <button type="button" onclick="cambiarModoImagenOferta('existente')" id="btnUsarExistenteOferta" style="flex: 1; background: #E5E7EB; color: #374151; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600;">硷 Usar Existente</button>
                                </div>
                                
                                <!-- Modo Subir Nueva -->
                                <div id="modoSubirImagenOferta" style="display: block;">
                                    <input type="file" id="imagenOfertaFile" accept="image/*" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; margin-bottom: 10px;" onchange="previsualizarImagenOferta(this)">
                                    <div id="previewImagenOferta" style="display: none; margin-top: 10px;">
                                        <img id="previewImgOferta" src="" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid #D1D5DB;">
                                    </div>
                                </div>
                                
                                <!-- Modo Usar Existente -->
                                <div id="modoExistenteImagenOferta" style="display: none;">
                                    ${imagenesDisponibles.length > 0 ? `
                                        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #D1D5DB; border-radius: 8px; padding: 10px;">
                                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;">
                                                ${imagenesDisponibles.map((img, idx) => `
                                                    <div onclick="seleccionarImagenExistenteOferta('${img.url}', '${img.nombre}')" style="cursor: pointer; border: 2px solid #E5E7EB; border-radius: 8px; overflow: hidden; transition: all 0.2s;" onmouseover="this.style.borderColor='#F59E0B'" onmouseout="this.style.borderColor='#E5E7EB'">
                                                        <img src="${img.url}" alt="${img.nombre}" style="width: 100%; height: 100px; object-fit: cover;">
                                                        <div style="padding: 5px; font-size: 0.75rem; color: #6B7280; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${img.nombre}</div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        <input type="hidden" id="imagenOfertaExistente" value="">
                                        <div id="imagenSeleccionadaOferta" style="display: none; margin-top: 10px; padding: 10px; background: #F0FDF4; border-radius: 8px;">
                                            <p style="margin: 0; color: #059669; font-size: 0.9rem;"> Imagen seleccionada: <span id="nombreImagenSeleccionadaOferta"></span></p>
                                        </div>
                                    ` : `
                                        <div style="padding: 20px; background: #FEF2F2; border-radius: 8px; text-align: center; color: #DC2626;">
                                            <p style="margin: 0;">锔 No hay im谩genes disponibles en tu perfil. Por favor, sube una nueva imagen.</p>
                                        </div>
                                    `}
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Tipo</label><select id="tipoOferta" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"><option value="porcentaje">Porcentaje</option><option value="fijo">Fijo</option><option value="2x1">2x1</option></select></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Valor</label><input type="number" id="valorOferta" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Fecha Inicio</label><input type="datetime-local" id="fechaInicioOferta" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Fecha Fin</label><input type="datetime-local" id="fechaFinOferta" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            </div>
                            <div style="display: flex; gap: 16px; justify-content: center;">
                                <button type="submit" style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Crear</button>
                                <button type="button" onclick="cerrarFormularioOferta()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer;">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function cambiarModoImagenOferta(modo) {
            const modoSubir = document.getElementById('modoSubirImagenOferta');
            const modoExistente = document.getElementById('modoExistenteImagenOferta');
            const btnSubir = document.getElementById('btnSubirImagenOferta');
            const btnExistente = document.getElementById('btnUsarExistenteOferta');
            
            if (modo === 'subir') {
                modoSubir.style.display = 'block';
                modoExistente.style.display = 'none';
                btnSubir.style.background = '#F59E0B';
                btnSubir.style.color = 'white';
                btnExistente.style.background = '#E5E7EB';
                btnExistente.style.color = '#374151';
            } else {
                modoSubir.style.display = 'none';
                modoExistente.style.display = 'block';
                btnSubir.style.background = '#E5E7EB';
                btnSubir.style.color = '#374151';
                btnExistente.style.background = '#F59E0B';
                btnExistente.style.color = 'white';
            }
        }
        
        function previsualizarImagenOferta(input) {
            const preview = document.getElementById('previewImagenOferta');
            const previewImg = document.getElementById('previewImgOferta');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function seleccionarImagenExistenteOferta(url, nombre) {
            document.getElementById('imagenOfertaExistente').value = url;
            document.getElementById('nombreImagenSeleccionadaOferta').textContent = nombre;
            document.getElementById('imagenSeleccionadaOferta').style.display = 'block';
            
            // Resaltar la imagen seleccionada
            document.querySelectorAll('#modoExistenteImagenOferta img').forEach(img => {
                img.parentElement.style.borderColor = '#E5E7EB';
            });
            event.target.closest('div').style.borderColor = '#F59E0B';
            event.target.closest('div').style.borderWidth = '3px';
        }
        
        function mostrarFormularioCombo() {
            const modal = document.createElement('div');
            modal.id = 'modalFormularioCombo';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 24px; text-align: center; position: relative;">
                        <button onclick="cerrarFormularioCombo()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <h3 style="margin: 0;"> Crear Nuevo Combo</h3>
                    </div>
                    <div style="padding: 24px;">
                        <form id="formularioCombo" onsubmit="guardarCombo(event); return false;">
                            <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Nombre</label><input type="text" id="nombreCombo" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Descripci贸n</label><textarea id="descripcionCombo" rows="3" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></textarea></div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Precio Original</label><input type="number" id="precioOriginalCombo" required min="0" step="0.01" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Precio Combo</label><input type="number" id="precioCombo" required min="0" step="0.01" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            </div>
                            <div style="display: flex; gap: 16px; justify-content: center;">
                                <button type="submit" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Crear</button>
                                <button type="button" onclick="cerrarFormularioCombo()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer;">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function guardarOferta(event) {
            event.preventDefault();
            
            // Obtener imagen (subida o existente)
            let imagenUrl = '';
            const imagenFile = document.getElementById('imagenOfertaFile');
            const imagenExistente = document.getElementById('imagenOfertaExistente');
            
            if (imagenFile && imagenFile.files && imagenFile.files[0]) {
                // Convertir archivo a Base64
                const file = imagenFile.files[0];
                imagenUrl = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            } else if (imagenExistente && imagenExistente.value) {
                imagenUrl = imagenExistente.value;
            }
            
            const datos = {
                nombre: document.getElementById('nombreOferta').value,
                descripcion: document.getElementById('descripcionOferta').value,
                tipo: document.getElementById('tipoOferta').value,
                valor: document.getElementById('valorOferta').value,
                categoria: '',
                fechaInicio: document.getElementById('fechaInicioOferta').value,
                fechaFin: document.getElementById('fechaFinOferta').value,
                limiteUsos: null,
                condiciones: '',
                imagen: imagenUrl
            };
            const oferta = sistemaOfertasCombos.crearOferta(datos);
            if (oferta) {
                mostrarNotificacion(' Oferta creada', 'success');
                cerrarFormularioOferta();
                cerrarGestionOfertasCombos();
                setTimeout(() => abrirGestionOfertasCombos(), 500);
            }
        }
        
        function guardarCombo(event) {
            event.preventDefault();
            const precioOriginal = parseFloat(document.getElementById('precioOriginalCombo').value);
            const precioCombo = parseFloat(document.getElementById('precioCombo').value);
            const descuento = ((precioOriginal - precioCombo) / precioOriginal) * 100;
            const datos = {
                nombre: document.getElementById('nombreCombo').value,
                descripcion: document.getElementById('descripcionCombo').value,
                precioOriginal: precioOriginal,
                precioCombo: precioCombo,
                descuento: Math.round(descuento),
                categoria: '',
                stockActual: 0
            };
            const combo = sistemaOfertasCombos.crearCombo(datos);
            if (combo) {
                mostrarNotificacion(' Combo creado', 'success');
                cerrarFormularioCombo();
                cerrarGestionOfertasCombos();
                setTimeout(() => abrirGestionOfertasCombos(), 500);
            }
        }
        
        function cerrarFormularioOferta() {
            const modal = document.getElementById('modalFormularioOferta');
            if (modal) modal.remove();
        }
        
        function cerrarFormularioCombo() {
            const modal = document.getElementById('modalFormularioCombo');
            if (modal) modal.remove();
        }
        
        function toggleOferta(ofertaId) {
            const oferta = sistemaOfertasCombos.toggleOferta(ofertaId);
            if (oferta) {
                mostrarNotificacion(' Oferta actualizada', 'success');
                cerrarGestionOfertasCombos();
                setTimeout(() => abrirGestionOfertasCombos(), 500);
            }
        }
        
        function toggleCombo(comboId) {
            const combo = sistemaOfertasCombos.toggleCombo(comboId);
            if (combo) {
                mostrarNotificacion(' Combo actualizado', 'success');
                cerrarGestionOfertasCombos();
                setTimeout(() => abrirGestionOfertasCombos(), 500);
            }
        }
        
        function eliminarOferta(ofertaId) {
            if (confirm('驴Eliminar esta oferta?')) {
                const eliminada = sistemaOfertasCombos.eliminarOferta(ofertaId);
                if (eliminada) {
                    mostrarNotificacion(' Oferta eliminada', 'success');
                    cerrarGestionOfertasCombos();
                    setTimeout(() => abrirGestionOfertasCombos(), 500);
                }
            }
        }
        
        function eliminarCombo(comboId) {
            if (confirm('驴Eliminar este combo?')) {
                const eliminado = sistemaOfertasCombos.eliminarCombo(comboId);
                if (eliminado) {
                    mostrarNotificacion(' Combo eliminado', 'success');
                    cerrarGestionOfertasCombos();
                    setTimeout(() => abrirGestionOfertasCombos(), 500);
                }
            }
        }
        
        function exportarOfertasCombos() {
            const datos = {
                ofertas: sistemaOfertasCombos.ofertas,
                combos: sistemaOfertasCombos.combos,
                categorias: sistemaOfertasCombos.categorias,
                estadisticas: sistemaOfertasCombos.obtenerEstadisticas(),
                fechaExportacion: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ofertas-combos-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            mostrarNotificacion(' Datos exportados', 'success');
        }
        
        function cerrarGestionOfertasCombos() {
            const modal = document.getElementById('modalGestionOfertasCombos');
            if (modal) modal.remove();
        }
        
        // ============================================
        // SISTEMA DE MENSAJERA CON CRISLA
        // ============================================
        
        class SistemaMensajeriaCrisla {
            constructor() {
                this.mensajes = this.cargarMensajes();
                this.configuracion = this.cargarConfiguracion();
                this.inicializar();
            }
            
            cargarMensajes() {
                return JSON.parse(localStorage.getItem('mensajes_crisla') || '[]');
            }
            
            cargarConfiguracion() {
                return JSON.parse(localStorage.getItem('configuracion_mensajeria_crisla') || '{}');
            }
            
            guardarMensajes() {
                localStorage.setItem('mensajes_crisla', JSON.stringify(this.mensajes));
            }
            
            guardarConfiguracion() {
                localStorage.setItem('configuracion_mensajeria_crisla', JSON.stringify(this.configuracion));
            }
            
            inicializar() {
                console.log(' Sistema de Mensajer铆a con Crisla inicializado');
                this.configurarRespuestasAutomaticas();
            }
            
            configurarRespuestasAutomaticas() {
                if (!this.configuracion.respuestasAutomaticas) {
                    this.configuracion.respuestasAutomaticas = {
                        problemas: "Hola! He recibido tu reporte de problema. Estoy revisando la situaci贸n y te responder茅 pronto con una soluci贸n. Mientras tanto, puedes intentar refrescar la p谩gina o contactarme directamente si es urgente. 隆Gracias por tu paciencia! ",
                        sugerencias: "隆Excelente sugerencia! Me encanta que participes en el crecimiento de Cresalia. Voy a revisar tu propuesta y la considerar茅 para futuras mejoras. 隆Tu opini贸n es muy valiosa para nosotros! ",
                        urgencias: "隆URGENCIA RECIBIDA! Estoy aqu铆 para ayudarte inmediatamente. He priorizado tu mensaje y te responder茅 en menos de 5 minutos. Si no ves mi respuesta pronto, puedes contactarme directamente. 隆No te preocupes, juntos lo solucionaremos! ",
                        general: "隆Hola! He recibido tu mensaje y estoy aqu铆 para ayudarte. Te responder茅 lo antes posible. 隆Gracias por contactarme! "
                    };
                    this.guardarConfiguracion();
                }
            }
            
            enviarMensaje(datos) {
                const mensaje = {
                    id: Date.now(),
                    tipo: datos.tipo,
                    asunto: datos.asunto,
                    mensaje: datos.mensaje,
                    prioridad: datos.prioridad || 'normal',
                    estado: 'enviado',
                    fechaEnvio: new Date().toISOString(),
                    respuesta: null,
                    fechaRespuesta: null,
                    leido: false,
                    adjuntos: datos.adjuntos || [],
                    tienda: datos.tienda || 'Tienda Principal',
                    usuario: datos.usuario || 'Admin'
                };
                this.mensajes.unshift(mensaje);
                this.guardarMensajes();
                this.simularRespuestaAutomatica(mensaje);
                return mensaje;
            }
            
            simularRespuestaAutomatica(mensaje) {
                setTimeout(() => {
                    const respuesta = this.generarRespuestaAutomatica(mensaje);
                    this.responderMensaje(mensaje.id, respuesta);
                }, 2000 + Math.random() * 3000);
            }
            
            generarRespuestaAutomatica(mensaje) {
                const respuestas = this.configuracion.respuestasAutomaticas;
                switch (mensaje.tipo) {
                    case 'problema':
                        return respuestas.problemas;
                    case 'sugerencia':
                        return respuestas.sugerencias;
                    case 'urgencia':
                        return respuestas.urgencias;
                    default:
                        return respuestas.general;
                }
            }
            
            responderMensaje(mensajeId, respuesta) {
                const mensaje = this.mensajes.find(m => m.id === mensajeId);
                if (mensaje) {
                    mensaje.respuesta = respuesta;
                    mensaje.fechaRespuesta = new Date().toISOString();
                    mensaje.estado = 'respondido';
                    this.guardarMensajes();
                    mostrarNotificacion(' Crisla ha respondido tu mensaje', 'success');
                }
            }
            
            marcarComoLeido(mensajeId) {
                const mensaje = this.mensajes.find(m => m.id === mensajeId);
                if (mensaje) {
                    mensaje.leido = true;
                    this.guardarMensajes();
                }
            }
            
            eliminarMensaje(mensajeId) {
                const index = this.mensajes.findIndex(m => m.id === mensajeId);
                if (index !== -1) {
                    this.mensajes.splice(index, 1);
                    this.guardarMensajes();
                    return true;
                }
                return false;
            }
            
            obtenerEstadisticas() {
                const total = this.mensajes.length;
                const sinResponder = this.mensajes.filter(m => m.estado === 'enviado').length;
                const respondidos = this.mensajes.filter(m => m.estado === 'respondido').length;
                const urgencias = this.mensajes.filter(m => m.prioridad === 'alta').length;
                const noLeidos = this.mensajes.filter(m => !m.leido).length;
                return {
                    total,
                    sinResponder,
                    respondidos,
                    urgencias,
                    noLeidos
                };
            }
        }
        
        let sistemaMensajeriaCrisla = new SistemaMensajeriaCrisla();
        
        function abrirMensajeriaCrisla() {
            console.log(' Abriendo mensajer铆a con Crisla...');
            const modal = document.createElement('div');
            modal.id = 'modalMensajeriaCrisla';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            const estadisticas = sistemaMensajeriaCrisla.obtenerEstadisticas();
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarMensajeriaCrisla()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;"></div>
                        <h2 style="margin: 0;">Mensajer铆a con Crisla</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Tu canal directo de comunicaci贸n con el soporte</p>
                    </div>
                    <div style="padding: 32px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #F0FDF4; padding: 20px; border-radius: 12px; border: 1px solid #BBF7D0; text-align: center;">
                                <div style="font-size: 2rem; color: #059669; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #059669; font-size: 1.5rem;">${estadisticas.total}</h3>
                                <p style="margin: 0; color: #059669; font-size: 0.9rem;">Mensajes Totales</p>
                            </div>
                            <div style="background: #FEF2F2; padding: 20px; border-radius: 12px; border: 1px solid #FECACA; text-align: center;">
                                <div style="font-size: 2rem; color: #DC2626; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #DC2626; font-size: 1.5rem;">${estadisticas.sinResponder}</h3>
                                <p style="margin: 0; color: #DC2626; font-size: 0.9rem;">Pendientes</p>
                            </div>
                            <div style="background: #F0F9FF; padding: 20px; border-radius: 12px; border: 1px solid #BAE6FD; text-align: center;">
                                <div style="font-size: 2rem; color: #0369A1; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #0369A1; font-size: 1.5rem;">${estadisticas.respondidos}</h3>
                                <p style="margin: 0; color: #0369A1; font-size: 0.9rem;">Respondidos</p>
                            </div>
                            <div style="background: #FDF2F8; padding: 20px; border-radius: 12px; border: 1px solid #FBCFE8; text-align: center;">
                                <div style="font-size: 2rem; color: #BE185D; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #BE185D; font-size: 1.5rem;">${estadisticas.urgencias}</h3>
                                <p style="margin: 0; color: #BE185D; font-size: 0.9rem;">Urgencias</p>
                            </div>
                        </div>
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                                <button onclick="mostrarTabMensajeria('nuevo')" id="tabMensajeriaNuevo" style="background: #8B5CF6; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">锔 Nuevo Mensaje</button>
                                <button onclick="mostrarTabMensajeria('historial')" id="tabMensajeriaHistorial" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Historial</button>
                                <button onclick="mostrarTabMensajeria('configuracion')" id="tabMensajeriaConfiguracion" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">锔 Configuraci贸n</button>
                            </div>
                            <div id="contenidoMensajeria">
                                <div id="tabContenidoMensajeriaNuevo" style="display: block;">
                                    <h3 style="margin: 0 0 20px; color: #374151;">锔 Enviar Mensaje a Crisla</h3>
                                    <form id="formularioMensajeCrisla" onsubmit="enviarMensajeCrisla(event); return false;">
                                        <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Tipo de Mensaje</label><select id="tipoMensaje" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"><option value="">Seleccionar...</option><option value="problema"> Problema</option><option value="sugerencia"> Sugerencia</option><option value="urgencia"> Urgencia</option><option value="consulta"> Consulta</option></select></div>
                                        <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Asunto</label><input type="text" id="asuntoMensaje" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;" placeholder="Resume tu mensaje"></div>
                                        <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Mensaje</label><textarea id="contenidoMensaje" rows="6" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;" placeholder="Describe tu consulta..."></textarea></div>
                                        <div style="display: flex; gap: 16px; justify-content: center;">
                                            <button type="submit" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Enviar</button>
                                            <button type="button" onclick="cerrarMensajeriaCrisla()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer;">Cancelar</button>
                                        </div>
                                    </form>
                                </div>
                                <div id="tabContenidoMensajeriaHistorial" style="display: none;">
                                    <h3 style="margin: 0 0 20px; color: #374151;"> Historial de Mensajes</h3>
                                    <div id="listaMensajes" style="display: grid; gap: 16px;">
                                        ${sistemaMensajeriaCrisla.mensajes.length > 0 ? sistemaMensajeriaCrisla.mensajes.map(mensaje => `
                                            <div style="background: ${mensaje.estado === 'respondido' ? '#F0FDF4' : '#FEF2F2'}; border: 1px solid ${mensaje.estado === 'respondido' ? '#BBF7D0' : '#FECACA'}; border-radius: 12px; padding: 20px;">
                                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                                    <div><h4 style="margin: 0; color: #374151;">${mensaje.asunto || 'Sin asunto'}</h4><p style="margin: 5px 0; color: #6B7280; font-size: 0.9rem;">${new Date(mensaje.fechaEnvio || Date.now()).toLocaleString('es-ES')}</p></div>
                                                    <span style="background: ${mensaje.estado === 'respondido' ? '#10B981' : '#F59E0B'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${mensaje.estado === 'respondido' ? ' Respondido' : ' Pendiente'}</span>
                                                </div>
                                                <div style="margin-bottom: 12px;"><p style="margin: 0; color: #374151;">${mensaje.mensaje || ''}</p></div>
                                                ${mensaje.respuesta ? `<div style="background: #F8FAFC; border-left: 4px solid #8B5CF6; padding: 16px; border-radius: 8px; margin-top: 12px;"><h5 style="margin: 0 0 8px; color: #6B21A8;"> Respuesta de Crisla:</h5><p style="margin: 0; color: #374151;">${mensaje.respuesta}</p></div>` : ''}
                                                <div style="display: flex; gap: 10px; margin-top: 12px;">
                                                    <button onclick="eliminarMensajeCrisla(${mensaje.id})" style="background: #EF4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">锔 Eliminar</button>
                                                </div>
                                            </div>
                                        `).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No hay mensajes</p></div>'}
                                    </div>
                                </div>
                                <div id="tabContenidoMensajeriaConfiguracion" style="display: none;">
                                    <h3 style="margin: 0 0 20px; color: #374151;">锔 Configuraci贸n</h3>
                                    <div style="margin-bottom: 16px;">
                                        <label style="display: flex; align-items: center; gap: 12px;"><input type="checkbox" id="notificacionesMensajeria" ${sistemaMensajeriaCrisla.configuracion.notificaciones !== false ? 'checked' : ''} style="transform: scale(1.2);"><span>Recibir notificaciones</span></label>
                                    </div>
                                    <div style="margin-bottom: 16px;">
                                        <label style="display: flex; align-items: center; gap: 12px;"><input type="checkbox" id="respuestasAutomaticas" ${sistemaMensajeriaCrisla.configuracion.respuestasAutomaticas !== false ? 'checked' : ''} style="transform: scale(1.2);"><span>Respuestas autom谩ticas</span></label>
                                    </div>
                                    <button onclick="guardarConfiguracionMensajeria()" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Guardar</button>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="exportarMensajesCrisla()" style="background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Exportar</button>
                            <button onclick="cerrarMensajeriaCrisla()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function mostrarTabMensajeria(tab) {
            document.querySelectorAll('[id^="tabContenidoMensajeria"]').forEach(contenido => {
                contenido.style.display = 'none';
            });
            document.querySelectorAll('[id^="tabMensajeria"]').forEach(tabBtn => {
                if (tabBtn.id.startsWith('tabMensajeria')) {
                    tabBtn.style.background = '#E5E7EB';
                    tabBtn.style.color = '#374151';
                }
            });
            const contenido = document.getElementById('tabContenidoMensajeria' + tab.charAt(0).toUpperCase() + tab.slice(1));
            const tabBtn = document.getElementById('tabMensajeria' + tab.charAt(0).toUpperCase() + tab.slice(1));
            if (contenido) contenido.style.display = 'block';
            if (tabBtn) {
                tabBtn.style.background = '#8B5CF6';
                tabBtn.style.color = 'white';
            }
        }
        
        function enviarMensajeCrisla(event) {
            event.preventDefault();
            const datos = {
                tipo: document.getElementById('tipoMensaje').value,
                asunto: document.getElementById('asuntoMensaje').value,
                mensaje: document.getElementById('contenidoMensaje').value,
                prioridad: document.getElementById('tipoMensaje').value === 'urgencia' ? 'alta' : 'normal'
            };
            const mensaje = sistemaMensajeriaCrisla.enviarMensaje(datos);
            if (mensaje) {
                mostrarNotificacion(' Mensaje enviado a Crisla', 'success');
                document.getElementById('formularioMensajeCrisla').reset();
                mostrarTabMensajeria('historial');
                cerrarMensajeriaCrisla();
                setTimeout(() => abrirMensajeriaCrisla(), 500);
            }
        }
        
        function eliminarMensajeCrisla(mensajeId) {
            if (confirm('驴Eliminar este mensaje?')) {
                const eliminado = sistemaMensajeriaCrisla.eliminarMensaje(mensajeId);
                if (eliminado) {
                    mostrarNotificacion(' Mensaje eliminado', 'success');
                    cerrarMensajeriaCrisla();
                    setTimeout(() => abrirMensajeriaCrisla(), 500);
                }
            }
        }
        
        function guardarConfiguracionMensajeria() {
            sistemaMensajeriaCrisla.configuracion.notificaciones = document.getElementById('notificacionesMensajeria')?.checked !== false;
            sistemaMensajeriaCrisla.configuracion.respuestasAutomaticas = document.getElementById('respuestasAutomaticas')?.checked !== false;
            sistemaMensajeriaCrisla.guardarConfiguracion();
            mostrarNotificacion(' Configuraci贸n guardada', 'success');
        }
        
        function exportarMensajesCrisla() {
            const datos = {
                mensajes: sistemaMensajeriaCrisla.mensajes,
                estadisticas: sistemaMensajeriaCrisla.obtenerEstadisticas(),
                fechaExportacion: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mensajes-crisla-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            mostrarNotificacion(' Mensajes exportados', 'success');
        }
        
        function cerrarMensajeriaCrisla() {
            const modal = document.getElementById('modalMensajeriaCrisla');
            if (modal) modal.remove();
        }
        
        // ============================================
        // SISTEMA DE GESTIN DE SOPORTE
        // ============================================
        
        class SistemaSoporte {
            constructor() {
                this.tickets = this.cargarTickets();
                this.configuracion = this.cargarConfiguracion();
                this.inicializar();
            }
            
            cargarTickets() {
                return JSON.parse(localStorage.getItem('tickets_soporte') || '[]');
            }
            
            cargarConfiguracion() {
                return JSON.parse(localStorage.getItem('configuracion_soporte') || '{}');
            }
            
            guardarTickets() {
                localStorage.setItem('tickets_soporte', JSON.stringify(this.tickets));
            }
            
            guardarConfiguracion() {
                localStorage.setItem('configuracion_soporte', JSON.stringify(this.configuracion));
            }
            
            inicializar() {
                console.log(' Sistema de Soporte inicializado');
                this.inicializarConfiguracionDefault();
            }
            
            inicializarConfiguracionDefault() {
                if (!this.configuracion.horarios) {
                    this.configuracion.horarios = {
                        lunes: { inicio: '09:00', fin: '18:00', activo: true },
                        martes: { inicio: '09:00', fin: '18:00', activo: true },
                        miercoles: { inicio: '09:00', fin: '18:00', activo: true },
                        jueves: { inicio: '09:00', fin: '18:00', activo: true },
                        viernes: { inicio: '09:00', fin: '18:00', activo: true },
                        sabado: { inicio: '10:00', fin: '16:00', activo: true },
                        domingo: { inicio: '10:00', fin: '14:00', activo: false }
                    };
                }
                if (!this.configuracion.contacto) {
                    this.configuracion.contacto = {
                        email: 'soporte@mitienda.com',
                        telefono: '+54 9 11 1234-5678',
                        whatsapp: '+54 9 11 1234-5678',
                        direccion: 'Tu Direcci贸n, Ciudad'
                    };
                }
                if (!this.configuracion.respuestas) {
                    this.configuracion.respuestas = {
                        saludo: '隆Hola! Soy el asistente de soporte de tu tienda. 驴En qu茅 puedo ayudarte?',
                        despedida: '隆Gracias por contactarnos! Si tienes m谩s preguntas, no dudes en escribirnos.',
                        fueraHorario: 'Estamos fuera de horario de atenci贸n. Te responderemos pronto.',
                        enProceso: 'Hemos recibido tu consulta y la estamos procesando. Te responderemos en breve.'
                    };
                }
                this.guardarConfiguracion();
            }
            
            crearTicket(datos) {
                const ticket = {
                    id: Date.now(),
                    cliente: datos.cliente,
                    email: datos.email,
                    asunto: datos.asunto,
                    mensaje: datos.mensaje,
                    categoria: datos.categoria || 'general',
                    prioridad: datos.prioridad || 'normal',
                    estado: 'abierto',
                    fechaCreacion: new Date().toISOString(),
                    respuestas: [],
                    asignado: null,
                    tiempoRespuesta: null
                };
                this.tickets.unshift(ticket);
                this.guardarTickets();
                return ticket;
            }
            
            responderTicket(ticketId, respuesta) {
                const ticket = this.tickets.find(t => t.id === ticketId);
                if (ticket) {
                    const nuevaRespuesta = {
                        id: Date.now(),
                        mensaje: respuesta,
                        fecha: new Date().toISOString(),
                        tipo: 'soporte'
                    };
                    ticket.respuestas.push(nuevaRespuesta);
                    ticket.estado = 'respondido';
                    this.guardarTickets();
                    return ticket;
                }
                return null;
            }
            
            cerrarTicket(ticketId) {
                const ticket = this.tickets.find(t => t.id === ticketId);
                if (ticket) {
                    ticket.estado = 'cerrado';
                    ticket.fechaCierre = new Date().toISOString();
                    this.guardarTickets();
                    return ticket;
                }
                return null;
            }
            
            obtenerEstadisticas() {
                const total = this.tickets.length;
                const abiertos = this.tickets.filter(t => t.estado === 'abierto').length;
                const respondidos = this.tickets.filter(t => t.estado === 'respondido').length;
                const cerrados = this.tickets.filter(t => t.estado === 'cerrado').length;
                const urgentes = this.tickets.filter(t => t.prioridad === 'alta').length;
                return {
                    total,
                    abiertos,
                    respondidos,
                    cerrados,
                    urgentes
                };
            }
        }
        
        let sistemaSoporte = new SistemaSoporte();
        
        function abrirGestionSoporte() {
            console.log(' Abriendo gesti贸n de soporte...');
            const modal = document.createElement('div');
            modal.id = 'modalGestionSoporte';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            const estadisticas = sistemaSoporte.obtenerEstadisticas();
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 1400px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #3B82F6, #1D4ED8); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarGestionSoporte()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;"></div>
                        <h2 style="margin: 0;">Sistema de Soporte</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Gestiona el soporte a tus clientes</p>
                    </div>
                    <div style="padding: 32px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #F0FDF4; padding: 20px; border-radius: 12px; border: 1px solid #BBF7D0; text-align: center;">
                                <div style="font-size: 2rem; color: #059669; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #059669; font-size: 1.5rem;">${estadisticas.total}</h3>
                                <p style="margin: 0; color: #059669; font-size: 0.9rem;">Tickets Totales</p>
                            </div>
                            <div style="background: #FEF2F2; padding: 20px; border-radius: 12px; border: 1px solid #FECACA; text-align: center;">
                                <div style="font-size: 2rem; color: #DC2626; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #DC2626; font-size: 1.5rem;">${estadisticas.abiertos}</h3>
                                <p style="margin: 0; color: #DC2626; font-size: 0.9rem;">Pendientes</p>
                            </div>
                            <div style="background: #F0F9FF; padding: 20px; border-radius: 12px; border: 1px solid #BAE6FD; text-align: center;">
                                <div style="font-size: 2rem; color: #0369A1; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #0369A1; font-size: 1.5rem;">${estadisticas.respondidos}</h3>
                                <p style="margin: 0; color: #0369A1; font-size: 0.9rem;">Respondidos</p>
                            </div>
                            <div style="background: #FDF2F8; padding: 20px; border-radius: 12px; border: 1px solid #FBCFE8; text-align: center;">
                                <div style="font-size: 2rem; color: #BE185D; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #BE185D; font-size: 1.5rem;">${estadisticas.urgentes}</h3>
                                <p style="margin: 0; color: #BE185D; font-size: 0.9rem;">Urgentes</p>
                            </div>
                        </div>
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                                <button onclick="mostrarTabSoporte('tickets')" id="tabSoporteTickets" style="background: #3B82F6; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Tickets</button>
                                <button onclick="mostrarTabSoporte('configuracion')" id="tabSoporteConfiguracion" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">锔 Configuraci贸n</button>
                                <button onclick="mostrarTabSoporte('estadisticas')" id="tabSoporteEstadisticas" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Estad铆sticas</button>
                            </div>
                            <div id="contenidoSoporte">
                                <div id="tabContenidoSoporteTickets" style="display: block;">
                                    <h3 style="margin: 0 0 20px; color: #374151;"> Gesti贸n de Tickets</h3>
                                    <div id="listaTickets" style="display: grid; gap: 16px;">
                                        ${sistemaSoporte.tickets.length > 0 ? sistemaSoporte.tickets.map(ticket => `
                                            <div style="background: ${ticket.estado === 'cerrado' ? '#F0FDF4' : ticket.estado === 'respondido' ? '#F0F9FF' : '#FEF2F2'}; border: 1px solid ${ticket.estado === 'cerrado' ? '#BBF7D0' : ticket.estado === 'respondido' ? '#BAE6FD' : '#FECACA'}; border-radius: 12px; padding: 20px;">
                                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                                    <div><h4 style="margin: 0; color: #374151;">${ticket.asunto || 'Sin asunto'}</h4><p style="margin: 5px 0; color: #6B7280; font-size: 0.9rem;">${ticket.cliente || 'Cliente'}  ${new Date(ticket.fechaCreacion || Date.now()).toLocaleString('es-ES')}</p></div>
                                                    <span style="background: ${ticket.estado === 'cerrado' ? '#10B981' : ticket.estado === 'respondido' ? '#3B82F6' : '#F59E0B'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${ticket.estado === 'cerrado' ? ' Cerrado' : ticket.estado === 'respondido' ? ' Respondido' : ' Pendiente'}</span>
                                                </div>
                                                <div style="margin-bottom: 12px;"><p style="margin: 0; color: #374151;">${ticket.mensaje || ''}</p></div>
                                                ${ticket.respuestas && ticket.respuestas.length > 0 ? `<div style="background: #F8FAFC; border-left: 4px solid #3B82F6; padding: 16px; border-radius: 8px; margin-top: 12px;"><h5 style="margin: 0 0 8px; color: #1E40AF;"> Respuestas:</h5>${ticket.respuestas.map(r => `<div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 6px;"><p style="margin: 0; color: #374151; font-size: 0.9rem;">${r.mensaje || ''}</p><p style="margin: 4px 0 0; color: #6B7280; font-size: 0.8rem;">${new Date(r.fecha || Date.now()).toLocaleString('es-ES')}</p></div>`).join('')}</div>` : ''}
                                                <div style="display: flex; gap: 10px; margin-top: 12px;">
                                                    <button onclick="responderTicket(${ticket.id})" style="background: #3B82F6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;"> Responder</button>
                                                    <button onclick="cerrarTicketDesdeModal(${ticket.id})" style="background: #10B981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;"> Cerrar</button>
                                                    <button onclick="eliminarTicketDesdeModal(${ticket.id})" style="background: #EF4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">锔 Eliminar</button>
                                                </div>
                                            </div>
                                        `).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No hay tickets creados</p></div>'}
                                    </div>
                                </div>
                                <div id="tabContenidoSoporteConfiguracion" style="display: none;">
                                    <h3 style="margin: 0 0 20px; color: #374151;">锔 Configuraci贸n</h3>
                                    <form id="formularioConfiguracionSoporte" onsubmit="guardarConfiguracionSoporte(event); return false;">
                                        <div style="margin-bottom: 24px;">
                                            <h4 style="color: #374151; margin-bottom: 16px;"> Informaci贸n de Contacto</h4>
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Email</label><input type="email" id="emailSoporte" value="${sistemaSoporte.configuracion.contacto?.email || ''}" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Tel茅fono</label><input type="tel" id="telefonoSoporte" value="${sistemaSoporte.configuracion.contacto?.telefono || ''}" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 24px;">
                                            <h4 style="color: #374151; margin-bottom: 16px;"> Horarios de Atenci贸n</h4>
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                                ${Object.entries(sistemaSoporte.configuracion.horarios || {}).map(([dia, config]) => `
                                                    <div style="background: #F8FAFC; padding: 16px; border-radius: 8px; border: 1px solid #E5E7EB;">
                                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                                            <input type="checkbox" id="horario_${dia}" ${config?.activo ? 'checked' : ''} style="transform: scale(1.2);">
                                                            <label for="horario_${dia}" style="color: #374151; font-weight: 500; text-transform: capitalize;">${dia}</label>
                                                        </div>
                                                        <div style="display: flex; gap: 8px;">
                                                            <input type="time" id="inicio_${dia}" value="${config?.inicio || '09:00'}" style="flex: 1; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;">
                                                            <input type="time" id="fin_${dia}" value="${config?.fin || '18:00'}" style="flex: 1; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;">
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        <button type="submit" style="background: linear-gradient(135deg, #3B82F6, #1D4ED8); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Guardar</button>
                                    </form>
                                </div>
                                <div id="tabContenidoSoporteEstadisticas" style="display: none;">
                                    <h3 style="margin: 0 0 20px; color: #374151;"> Estad铆sticas</h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                        <div style="background: #F0FDF4; padding: 20px; border-radius: 12px; border: 1px solid #BBF7D0; text-align: center;">
                                            <h4 style="margin: 0 0 8px; color: #059669;">Tiempo Promedio</h4>
                                            <p style="margin: 0; color: #059669; font-size: 1.5rem; font-weight: 600;">2.5 horas</p>
                                        </div>
                                        <div style="background: #F0F9FF; padding: 20px; border-radius: 12px; border: 1px solid #BAE6FD; text-align: center;">
                                            <h4 style="margin: 0 0 8px; color: #0369A1;">Satisfacci贸n</h4>
                                            <p style="margin: 0; color: #0369A1; font-size: 1.5rem; font-weight: 600;">4.8/5</p>
                                        </div>
                                        <div style="background: #FDF2F8; padding: 20px; border-radius: 12px; border: 1px solid #FBCFE8; text-align: center;">
                                            <h4 style="margin: 0 0 8px; color: #BE185D;">Resueltos</h4>
                                            <p style="margin: 0; color: #BE185D; font-size: 1.5rem; font-weight: 600;">${estadisticas.cerrados}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="exportarTicketsSoporte()" style="background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Exportar</button>
                            <button onclick="cerrarGestionSoporte()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function mostrarTabSoporte(tab) {
            document.querySelectorAll('[id^="tabContenidoSoporte"]').forEach(contenido => {
                contenido.style.display = 'none';
            });
            document.querySelectorAll('[id^="tabSoporte"]').forEach(tabBtn => {
                if (tabBtn.id.startsWith('tabSoporte')) {
                    tabBtn.style.background = '#E5E7EB';
                    tabBtn.style.color = '#374151';
                }
            });
            const contenido = document.getElementById('tabContenidoSoporte' + tab.charAt(0).toUpperCase() + tab.slice(1));
            const tabBtn = document.getElementById('tabSoporte' + tab.charAt(0).toUpperCase() + tab.slice(1));
            if (contenido) contenido.style.display = 'block';
            if (tabBtn) {
                tabBtn.style.background = '#3B82F6';
                tabBtn.style.color = 'white';
            }
        }
        
        function responderTicket(ticketId) {
            const respuesta = prompt('Escribe tu respuesta:');
            if (respuesta && respuesta.trim()) {
                const ticket = sistemaSoporte.responderTicket(ticketId, respuesta.trim());
                if (ticket) {
                    mostrarNotificacion(' Respuesta enviada', 'success');
                    cerrarGestionSoporte();
                    setTimeout(() => abrirGestionSoporte(), 500);
                }
            }
        }
        
        function cerrarTicketDesdeModal(ticketId) {
            if (confirm('驴Cerrar este ticket?')) {
                const ticket = sistemaSoporte.cerrarTicket(ticketId);
                if (ticket) {
                    mostrarNotificacion(' Ticket cerrado', 'success');
                    cerrarGestionSoporte();
                    setTimeout(() => abrirGestionSoporte(), 500);
                }
            }
        }
        
        function eliminarTicketDesdeModal(ticketId) {
            if (confirm('驴Eliminar este ticket?')) {
                const index = sistemaSoporte.tickets.findIndex(t => t.id === ticketId);
                if (index !== -1) {
                    sistemaSoporte.tickets.splice(index, 1);
                    sistemaSoporte.guardarTickets();
                    mostrarNotificacion(' Ticket eliminado', 'success');
                    cerrarGestionSoporte();
                    setTimeout(() => abrirGestionSoporte(), 500);
                }
            }
        }
        
        function guardarConfiguracionSoporte(event) {
            event.preventDefault();
            sistemaSoporte.configuracion.contacto = {
                email: document.getElementById('emailSoporte')?.value || '',
                telefono: document.getElementById('telefonoSoporte')?.value || '',
                whatsapp: document.getElementById('telefonoSoporte')?.value || '',
                direccion: 'Tu Direcci贸n, Ciudad'
            };
            Object.keys(sistemaSoporte.configuracion.horarios || {}).forEach(dia => {
                const inicioEl = document.getElementById('inicio_' + dia);
                const finEl = document.getElementById('fin_' + dia);
                const activoEl = document.getElementById('horario_' + dia);
                if (inicioEl && finEl && activoEl) {
                    sistemaSoporte.configuracion.horarios[dia] = {
                        inicio: inicioEl.value,
                        fin: finEl.value,
                        activo: activoEl.checked
                    };
                }
            });
            sistemaSoporte.guardarConfiguracion();
            mostrarNotificacion(' Configuraci贸n guardada', 'success');
        }
        
        function exportarTicketsSoporte() {
            const datos = {
                tickets: sistemaSoporte.tickets,
                estadisticas: sistemaSoporte.obtenerEstadisticas(),
                fechaExportacion: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tickets-soporte-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            mostrarNotificacion(' Tickets exportados', 'success');
        }
        
        function cerrarGestionSoporte() {
            const modal = document.getElementById('modalGestionSoporte');
            if (modal) modal.remove();
        }
        
        // ============================================
        // SISTEMA DE GESTIN DE UBICACIONES
        // ============================================
        
        class SistemaUbicacion {
            constructor() {
                this.ubicaciones = this.cargarUbicaciones();
                this.configuracion = this.cargarConfiguracion();
                this.inicializar();
            }
            
            cargarUbicaciones() {
                return JSON.parse(localStorage.getItem('ubicaciones_tienda') || '[]');
            }
            
            cargarConfiguracion() {
                return JSON.parse(localStorage.getItem('configuracion_ubicacion') || '{}');
            }
            
            guardarUbicaciones() {
                localStorage.setItem('ubicaciones_tienda', JSON.stringify(this.ubicaciones));
            }
            
            guardarConfiguracion() {
                localStorage.setItem('configuracion_ubicacion', JSON.stringify(this.configuracion));
            }
            
            inicializar() {
                console.log(' Sistema de Ubicaci贸n inicializado');
                this.inicializarConfiguracionDefault();
            }
            
            inicializarConfiguracionDefault() {
                if (!this.configuracion.tienda) {
                    this.configuracion.tienda = {
                        direccion: '',
                        ciudad: '',
                        provincia: '',
                        codigoPostal: '',
                        pais: 'Argentina',
                        coordenadas: null,
                        radioEntrega: 10,
                        horariosEntrega: {
                            lunes: { inicio: '09:00', fin: '18:00', activo: true },
                            martes: { inicio: '09:00', fin: '18:00', activo: true },
                            miercoles: { inicio: '09:00', fin: '18:00', activo: true },
                            jueves: { inicio: '09:00', fin: '18:00', activo: true },
                            viernes: { inicio: '09:00', fin: '18:00', activo: true },
                            sabado: { inicio: '10:00', fin: '16:00', activo: true },
                            domingo: { inicio: '10:00', fin: '14:00', activo: false }
                        }
                    };
                }
                this.guardarConfiguracion();
            }
            
            obtenerUbicacionActual() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject('Geolocalizaci贸n no soportada');
                        return;
                    }
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const coordenadas = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            resolve(coordenadas);
                        },
                        (error) => {
                            reject('Error al obtener ubicaci贸n: ' + error.message);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 300000
                        }
                    );
                });
            }
            
            agregarUbicacion(datos) {
                const ubicacion = {
                    id: Date.now(),
                    nombre: datos.nombre,
                    direccion: datos.direccion,
                    ciudad: datos.ciudad,
                    provincia: datos.provincia,
                    codigoPostal: datos.codigoPostal,
                    coordenadas: datos.coordenadas,
                    tipo: datos.tipo || 'tienda',
                    activa: datos.activa !== false,
                    horarios: datos.horarios || this.configuracion.tienda.horariosEntrega,
                    servicios: datos.servicios || [],
                    fechaCreacion: new Date().toISOString()
                };
                this.ubicaciones.unshift(ubicacion);
                this.guardarUbicaciones();
                return ubicacion;
            }
            
            actualizarUbicacion(ubicacionId, datos) {
                const index = this.ubicaciones.findIndex(u => u.id === ubicacionId);
                if (index !== -1) {
                    this.ubicaciones[index] = { ...this.ubicaciones[index], ...datos };
                    this.guardarUbicaciones();
                    return this.ubicaciones[index];
                }
                return null;
            }
            
            eliminarUbicacion(ubicacionId) {
                const index = this.ubicaciones.findIndex(u => u.id === ubicacionId);
                if (index !== -1) {
                    const ubicacion = this.ubicaciones.splice(index, 1)[0];
                    this.guardarUbicaciones();
                    return true;
                }
                return false;
            }
            
            obtenerEstadisticas() {
                const total = this.ubicaciones.length;
                const activas = this.ubicaciones.filter(u => u.activa).length;
                const tiendas = this.ubicaciones.filter(u => u.tipo === 'tienda').length;
                const sucursales = this.ubicaciones.filter(u => u.tipo === 'sucursal').length;
                const depositos = this.ubicaciones.filter(u => u.tipo === 'deposito').length;
                return {
                    total,
                    activas,
                    tiendas,
                    sucursales,
                    depositos
                };
            }
        }
        
        let sistemaUbicacion = new SistemaUbicacion();
        
        function abrirGestionUbicaciones() {
            console.log(' Abriendo gesti贸n de ubicaciones...');
            const modal = document.createElement('div');
            modal.id = 'modalGestionUbicaciones';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            const estadisticas = sistemaUbicacion.obtenerEstadisticas();
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarGestionUbicaciones()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;"></div>
                        <h2 style="margin: 0;">Gesti贸n de Ubicaciones</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Administra las ubicaciones de tu tienda</p>
                    </div>
                    <div style="padding: 32px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #F0FDF4; padding: 20px; border-radius: 12px; border: 1px solid #BBF7D0; text-align: center;">
                                <div style="font-size: 2rem; color: #059669; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #059669; font-size: 1.5rem;">${estadisticas.tiendas}</h3>
                                <p style="margin: 0; color: #059669; font-size: 0.9rem;">Tiendas</p>
                            </div>
                            <div style="background: #F0F9FF; padding: 20px; border-radius: 12px; border: 1px solid #BAE6FD; text-align: center;">
                                <div style="font-size: 2rem; color: #0369A1; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #0369A1; font-size: 1.5rem;">${estadisticas.sucursales}</h3>
                                <p style="margin: 0; color: #0369A1; font-size: 0.9rem;">Sucursales</p>
                            </div>
                            <div style="background: #FDF2F8; padding: 20px; border-radius: 12px; border: 1px solid #FBCFE8; text-align: center;">
                                <div style="font-size: 2rem; color: #BE185D; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #BE185D; font-size: 1.5rem;">${estadisticas.depositos}</h3>
                                <p style="margin: 0; color: #BE185D; font-size: 0.9rem;">Dep贸sitos</p>
                            </div>
                            <div style="background: #FEF3C7; padding: 20px; border-radius: 12px; border: 1px solid #FDE68A; text-align: center;">
                                <div style="font-size: 2rem; color: #D97706; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #D97706; font-size: 1.5rem;">${estadisticas.activas}</h3>
                                <p style="margin: 0; color: #D97706; font-size: 0.9rem;">Activas</p>
                            </div>
                        </div>
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; color: #374151;"> Ubicaciones Registradas</h3>
                                <button onclick="mostrarFormularioUbicacion()" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Agregar</button>
                            </div>
                            <div id="listaUbicaciones" style="display: grid; gap: 16px;">
                                ${sistemaUbicacion.ubicaciones.length > 0 ? sistemaUbicacion.ubicaciones.map(ubicacion => `
                                    <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                            <div><h4 style="margin: 0; color: #374151;">${ubicacion.nombre || 'Ubicaci贸n'}</h4><p style="margin: 5px 0; color: #6B7280; font-size: 0.9rem;">${ubicacion.direccion || ''}, ${ubicacion.ciudad || ''}, ${ubicacion.provincia || ''}</p></div>
                                            <div style="display: flex; gap: 5px;">
                                                <span style="background: ${ubicacion.activa ? '#10B981' : '#6B7280'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${ubicacion.activa ? 'Activa' : 'Inactiva'}</span>
                                                <span style="background: ${ubicacion.tipo === 'tienda' ? '#3B82F6' : ubicacion.tipo === 'sucursal' ? '#8B5CF6' : '#F59E0B'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${ubicacion.tipo === 'tienda' ? '' : ubicacion.tipo === 'sucursal' ? '' : ''}</span>
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 12px;"><p style="margin: 0; color: #374151; font-size: 0.95rem;"><strong>CP:</strong> ${ubicacion.codigoPostal || 'N/A'} | <strong>Servicios:</strong> ${(ubicacion.servicios || []).length}</p></div>
                                        <div style="display: flex; gap: 10px;">
                                            <button onclick="toggleUbicacionDesdeModal(${ubicacion.id})" style="background: ${ubicacion.activa ? '#EF4444' : '#10B981'}; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">${ubicacion.activa ? '革' : '讹'}</button>
                                            <button onclick="eliminarUbicacionDesdeModal(${ubicacion.id})" style="background: #EF4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">锔 Eliminar</button>
                                        </div>
                                    </div>
                                `).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No hay ubicaciones registradas</p></div>'}
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="exportarUbicaciones()" style="background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Exportar</button>
                            <button onclick="cerrarGestionUbicaciones()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function mostrarFormularioUbicacion() {
            const modal = document.createElement('div');
            modal.id = 'modalFormularioUbicacion';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999999;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 24px; text-align: center; position: relative;">
                        <button onclick="cerrarFormularioUbicacion()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <h3 style="margin: 0;"> Agregar Nueva Ubicaci贸n</h3>
                    </div>
                    <div style="padding: 24px;">
                        <form id="formularioUbicacion" onsubmit="guardarUbicacion(event); return false;">
                            <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Nombre</label><input type="text" id="nombreUbicacion" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;" placeholder="Ej: Tienda Central"></div>
                            <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Tipo</label><select id="tipoUbicacion" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"><option value="">Seleccionar...</option><option value="tienda"> Tienda</option><option value="sucursal"> Sucursal</option><option value="deposito"> Dep贸sito</option></select></div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Direcci贸n</label><input type="text" id="direccionUbicacion" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Ciudad</label><input type="text" id="ciudadUbicacion" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Provincia</label><input type="text" id="provinciaUbicacion" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">C贸digo Postal</label><input type="text" id="codigoPostalUbicacion" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <button type="button" onclick="obtenerCoordenadasUbicacion()" style="background: #3B82F6; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%;"> Obtener Ubicaci贸n Actual</button>
                                <p style="margin: 8px 0 0; color: #6B7280; font-size: 0.9rem;">Esto usar谩 tu ubicaci贸n actual</p>
                            </div>
                            <div style="display: flex; gap: 16px; justify-content: center;">
                                <button type="submit" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Guardar</button>
                                <button type="button" onclick="cerrarFormularioUbicacion()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer;">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function obtenerCoordenadasUbicacion() {
            sistemaUbicacion.obtenerUbicacionActual()
                .then(coordenadas => {
                    mostrarNotificacion(' Ubicaci贸n obtenida', 'success');
                    console.log('Coordenadas:', coordenadas);
                })
                .catch(error => {
                    mostrarNotificacion(' ' + error, 'error');
                });
        }
        
        function guardarUbicacion(event) {
            event.preventDefault();
            const datos = {
                nombre: document.getElementById('nombreUbicacion').value,
                tipo: document.getElementById('tipoUbicacion').value,
                direccion: document.getElementById('direccionUbicacion').value,
                ciudad: document.getElementById('ciudadUbicacion').value,
                provincia: document.getElementById('provinciaUbicacion').value,
                codigoPostal: document.getElementById('codigoPostalUbicacion').value,
                coordenadas: null
            };
            const ubicacion = sistemaUbicacion.agregarUbicacion(datos);
            if (ubicacion) {
                mostrarNotificacion(' Ubicaci贸n agregada', 'success');
                cerrarFormularioUbicacion();
                cerrarGestionUbicaciones();
                setTimeout(() => abrirGestionUbicaciones(), 500);
            }
        }
        
        function cerrarFormularioUbicacion() {
            const modal = document.getElementById('modalFormularioUbicacion');
            if (modal) modal.remove();
        }
        
        function toggleUbicacionDesdeModal(ubicacionId) {
            const ubicacion = sistemaUbicacion.ubicaciones.find(u => u.id === ubicacionId);
            if (ubicacion) {
                ubicacion.activa = !ubicacion.activa;
                sistemaUbicacion.guardarUbicaciones();
                mostrarNotificacion(` Ubicaci贸n ${ubicacion.activa ? 'activada' : 'desactivada'}`, 'success');
                cerrarGestionUbicaciones();
                setTimeout(() => abrirGestionUbicaciones(), 500);
            }
        }
        
        function eliminarUbicacionDesdeModal(ubicacionId) {
            if (confirm('驴Eliminar esta ubicaci贸n?')) {
                const eliminada = sistemaUbicacion.eliminarUbicacion(ubicacionId);
                if (eliminada) {
                    mostrarNotificacion(' Ubicaci贸n eliminada', 'success');
                    cerrarGestionUbicaciones();
                    setTimeout(() => abrirGestionUbicaciones(), 500);
                }
            }
        }
        
        function exportarUbicaciones() {
            const datos = {
                ubicaciones: sistemaUbicacion.ubicaciones,
                estadisticas: sistemaUbicacion.obtenerEstadisticas(),
                fechaExportacion: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ubicaciones-tienda-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            mostrarNotificacion(' Ubicaciones exportadas', 'success');
        }
        
        function cerrarGestionUbicaciones() {
            const modal = document.getElementById('modalGestionUbicaciones');
            if (modal) modal.remove();
        }
        
        // ============================================
        // EDITOR VISUAL DE BOTS PRO
        // ============================================
        
        class EditorVisualBots {
            constructor() {
                this.bots = this.cargarBots();
                this.categorias = this.cargarCategorias();
                this.flujos = this.cargarFlujos();
                this.inicializar();
            }
            cargarBots() { return JSON.parse(localStorage.getItem('bots_personalizados') || '[]'); }
            cargarCategorias() { return JSON.parse(localStorage.getItem('categorias_bots') || '[]'); }
            cargarFlujos() { return JSON.parse(localStorage.getItem('flujos_bots') || '[]'); }
            guardarBots() { localStorage.setItem('bots_personalizados', JSON.stringify(this.bots)); }
            guardarCategorias() { localStorage.setItem('categorias_bots', JSON.stringify(this.categorias)); }
            guardarFlujos() { localStorage.setItem('flujos_bots', JSON.stringify(this.flujos)); }
            
            inicializar() {
                console.log(' Editor Visual de Bots inicializado');
                this.inicializarCategoriasDefault();
            }
            
            inicializarCategoriasDefault() {
                if (this.categorias.length === 0) {
                    this.categorias = [
                        { id: 'saludo', nombre: 'Saludo', icono: '', color: '#10B981' },
                        { id: 'envios', nombre: 'Env铆os', icono: '', color: '#3B82F6' },
                        { id: 'pagos', nombre: 'Pagos', icono: '', color: '#8B5CF6' },
                        { id: 'garantias', nombre: 'Garant铆as', icono: '★', color: '#F59E0B' },
                        { id: 'productos', nombre: 'Productos', icono: '', color: '#EF4444' },
                        { id: 'servicios', nombre: 'Servicios', icono: '', color: '#06B6D4' },
                        { id: 'horarios', nombre: 'Horarios', icono: '', color: '#84CC16' },
                        { id: 'contacto', nombre: 'Contacto', icono: '', color: '#EC4899' },
                        { id: 'despedida', nombre: 'Despedida', icono: '', color: '#6B7280' }
                    ];
                    this.guardarCategorias();
                }
            }
            
            crearBot(datos) {
                const bot = {
                    id: Date.now(),
                    nombre: datos.nombre,
                    descripcion: datos.descripcion,
                    activo: datos.activo !== false,
                    configuracion: {
                        saludo: datos.saludo || '隆Hola! 驴En qu茅 puedo ayudarte?',
                        despedida: datos.despedida || '隆Gracias por contactarnos!',
                        fueraHorario: datos.fueraHorario || 'Estamos fuera de horario.',
                        respuestas: datos.respuestas || {},
                        flujos: datos.flujos || []
                    },
                    estadisticas: { mensajesEnviados: 0, conversaciones: 0, satisfaccion: 0 },
                    fechaCreacion: new Date().toISOString()
                };
                this.bots.unshift(bot);
                this.guardarBots();
                return bot;
            }
            
            actualizarBot(botId, datos) {
                const index = this.bots.findIndex(b => b.id === botId);
                if (index !== -1) {
                    this.bots[index] = { ...this.bots[index], ...datos };
                    this.guardarBots();
                    return this.bots[index];
                }
                return null;
            }
            
            crearFlujo(datos) {
                const flujo = {
                    id: Date.now(),
                    nombre: datos.nombre,
                    categoria: datos.categoria,
                    condiciones: datos.condiciones || [],
                    respuestas: datos.respuestas || [],
                    acciones: datos.acciones || [],
                    activo: datos.activo !== false,
                    fechaCreacion: new Date().toISOString()
                };
                this.flujos.unshift(flujo);
                this.guardarFlujos();
                return flujo;
            }
            
            obtenerEstadisticas() {
                const totalBots = this.bots.length;
                const botsActivos = this.bots.filter(b => b.activo).length;
                const totalFlujos = this.flujos.length;
                const flujosActivos = this.flujos.filter(f => f.activo).length;
                const totalMensajes = this.bots.reduce((sum, b) => sum + b.estadisticas.mensajesEnviados, 0);
                return { totalBots, botsActivos, totalFlujos, flujosActivos, totalMensajes };
            }
        }
        
        let editorVisualBots = new EditorVisualBots();
        
        function abrirEditorVisualBots() {
            console.log(' Abriendo editor visual de bots...');
            const modal = document.createElement('div');
            modal.id = 'modalEditorVisualBots';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            const estadisticas = editorVisualBots.obtenerEstadisticas();
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 1600px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarEditorVisualBots()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;"></div>
                        <h2 style="margin: 0;">Editor Visual de Bots PRO</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Crea bots personalizados con flujos visuales</p>
                    </div>
                    <div style="padding: 32px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #F0FDF4; padding: 20px; border-radius: 12px; border: 1px solid #BBF7D0; text-align: center;">
                                <div style="font-size: 2rem; color: #059669; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #059669; font-size: 1.5rem;">${estadisticas.botsActivos}</h3>
                                <p style="margin: 0; color: #059669; font-size: 0.9rem;">Bots Activos</p>
                            </div>
                            <div style="background: #F0F9FF; padding: 20px; border-radius: 12px; border: 1px solid #BAE6FD; text-align: center;">
                                <div style="font-size: 2rem; color: #0369A1; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #0369A1; font-size: 1.5rem;">${estadisticas.flujosActivos}</h3>
                                <p style="margin: 0; color: #0369A1; font-size: 0.9rem;">Flujos Activos</p>
                            </div>
                            <div style="background: #FDF2F8; padding: 20px; border-radius: 12px; border: 1px solid #FBCFE8; text-align: center;">
                                <div style="font-size: 2rem; color: #BE185D; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #BE185D; font-size: 1.5rem;">${estadisticas.totalMensajes}</h3>
                                <p style="margin: 0; color: #BE185D; font-size: 0.9rem;">Mensajes</p>
                            </div>
                            <div style="background: #FEF3C7; padding: 20px; border-radius: 12px; border: 1px solid #FDE68A; text-align: center;">
                                <div style="font-size: 2rem; color: #D97706; margin-bottom: 8px;">猸</div>
                                <h3 style="margin: 0; color: #D97706; font-size: 1.5rem;">4.8/5</h3>
                                <p style="margin: 0; color: #D97706; font-size: 0.9rem;">Satisfacci贸n</p>
                            </div>
                        </div>
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                                <button onclick="mostrarTabBots('bots')" id="tabBotsBots" style="background: #8B5CF6; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Mis Bots</button>
                                <button onclick="mostrarTabBots('editor')" id="tabBotsEditor" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Editor</button>
                                <button onclick="mostrarTabBots('flujos')" id="tabBotsFlujos" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Flujos</button>
                                <button onclick="mostrarTabBots('categorias')" id="tabBotsCategorias" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">凤 Categor铆as</button>
                            </div>
                            <div id="contenidoBots">
                                <div id="tabContenidoBotsBots" style="display: block;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                        <h3 style="margin: 0; color: #374151;"> Mis Bots</h3>
                                        <button onclick="mostrarFormularioBot()" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Crear</button>
                                    </div>
                                    <div id="listaBots" style="display: grid; gap: 16px;">
                                        ${editorVisualBots.bots.length > 0 ? editorVisualBots.bots.map(bot => `
                                            <div style="background: ${bot.activo ? '#F0FDF4' : '#FEF2F2'}; border: 1px solid ${bot.activo ? '#BBF7D0' : '#FECACA'}; border-radius: 12px; padding: 20px;">
                                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                                    <div><h4 style="margin: 0; color: #374151;">${bot.nombre || 'Bot'}</h4><p style="margin: 5px 0; color: #6B7280; font-size: 0.9rem;">${bot.descripcion || ''}</p></div>
                                                    <span style="background: ${bot.activo ? '#10B981' : '#6B7280'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${bot.activo ? 'Activo' : 'Inactivo'}</span>
                                                </div>
                                                <div style="margin-bottom: 12px;"><p style="margin: 0; color: #374151; font-size: 0.95rem;"><strong>Mensajes:</strong> ${bot.estadisticas.mensajesEnviados} | <strong>Conversaciones:</strong> ${bot.estadisticas.conversaciones}</p></div>
                                                <div style="display: flex; gap: 10px;">
                                                    <button onclick="toggleBotDesdeModal(${bot.id})" style="background: ${bot.activo ? '#EF4444' : '#10B981'}; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">${bot.activo ? '革' : '讹'}</button>
                                                    <button onclick="eliminarBotDesdeModal(${bot.id})" style="background: #EF4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">锔</button>
                                                </div>
                                            </div>
                                        `).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No hay bots creados</p></div>'}
                                    </div>
                                </div>
                                <div id="tabContenidoBotsEditor" style="display: none;">
                                    <h3 style="margin: 0 0 20px; color: #374151;"> Editor Visual</h3>
                                    <div style="background: #F8FAFC; padding: 20px; border-radius: 8px; border: 2px dashed #D1D5DB; text-align: center;">
                                        <div style="font-size: 48px; color: #6B7280; margin-bottom: 16px;"></div>
                                        <h4 style="color: #6B7280; margin: 0 0 8px;">Editor Visual en Desarrollo</h4>
                                        <p style="color: #6B7280; margin: 0;">Pr贸ximamente podr谩s crear flujos visuales arrastrando elementos</p>
                                    </div>
                                </div>
                                <div id="tabContenidoBotsFlujos" style="display: none;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                        <h3 style="margin: 0; color: #374151;"> Flujos</h3>
                                        <button onclick="mostrarFormularioFlujo()" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Crear</button>
                                    </div>
                                    <div id="listaFlujos" style="display: grid; gap: 16px;">
                                        ${editorVisualBots.flujos.length > 0 ? editorVisualBots.flujos.map(flujo => `
                                            <div style="background: #F0F9FF; border: 1px solid #BAE6FD; border-radius: 12px; padding: 20px;">
                                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                                    <div><h4 style="margin: 0; color: #374151;">${flujo.nombre || 'Flujo'}</h4><p style="margin: 5px 0; color: #6B7280; font-size: 0.9rem;">Cat: ${editorVisualBots.categorias.find(c => c.id === flujo.categoria)?.nombre || 'N/A'}</p></div>
                                                    <span style="background: ${flujo.activo ? '#10B981' : '#6B7280'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${flujo.activo ? 'Activo' : 'Inactivo'}</span>
                                                </div>
                                                <div style="display: flex; gap: 10px;">
                                                    <button onclick="eliminarFlujoDesdeModal(${flujo.id})" style="background: #EF4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">锔</button>
                                                </div>
                                            </div>
                                        `).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No hay flujos</p></div>'}
                                    </div>
                                </div>
                                <div id="tabContenidoBotsCategorias" style="display: none;">
                                    <h3 style="margin: 0 0 20px; color: #374151;">凤 Categor铆as</h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                        ${editorVisualBots.categorias.map(cat => `
                                            <div style="background: #F8FAFC; padding: 20px; border-radius: 12px; border: 1px solid #E5E7EB; text-align: center;">
                                                <div style="font-size: 2rem; margin-bottom: 10px;">${cat.icono}</div>
                                                <h4 style="margin: 0 0 5px; color: #374151;">${cat.nombre}</h4>
                                                <div style="width: 20px; height: 20px; background: ${cat.color}; border-radius: 50%; margin: 0 auto;"></div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="exportarBots()" style="background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Exportar</button>
                            <button onclick="cerrarEditorVisualBots()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function mostrarTabBots(tab) {
            document.querySelectorAll('[id^="tabContenidoBots"]').forEach(c => c.style.display = 'none');
            document.querySelectorAll('[id^="tabBots"]').forEach(t => { t.style.background = '#E5E7EB'; t.style.color = '#374151'; });
            const cont = document.getElementById('tabContenidoBots' + tab.charAt(0).toUpperCase() + tab.slice(1));
            const btn = document.getElementById('tabBots' + tab.charAt(0).toUpperCase() + tab.slice(1));
            if (cont) cont.style.display = 'block';
            if (btn) { btn.style.background = '#8B5CF6'; btn.style.color = 'white'; }
        }
        
        function mostrarFormularioBot() {
            const modal = document.createElement('div');
            modal.id = 'modalFormularioBot';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999999;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; padding: 24px; text-align: center; position: relative;">
                        <button onclick="cerrarFormularioBot()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <h3 style="margin: 0;"> Crear Bot</h3>
                    </div>
                    <div style="padding: 24px;">
                        <form id="formularioBot" onsubmit="guardarBot(event); return false;">
                            <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Nombre</label><input type="text" id="nombreBot" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;" placeholder="Bot de Soporte"></div>
                            <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Descripci贸n</label><textarea id="descripcionBot" rows="3" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;" placeholder="Describe tu bot"></textarea></div>
                            <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Saludo</label><input type="text" id="saludoBot" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;" placeholder="隆Hola! 驴En qu茅 puedo ayudarte?"></div>
                            <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Despedida</label><input type="text" id="despedidaBot" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;" placeholder="隆Gracias!"></div>
                            <div style="display: flex; gap: 16px; justify-content: center;">
                                <button type="submit" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Crear</button>
                                <button type="button" onclick="cerrarFormularioBot()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer;">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function guardarBot(event) {
            event.preventDefault();
            const datos = {
                nombre: document.getElementById('nombreBot').value,
                descripcion: document.getElementById('descripcionBot').value,
                saludo: document.getElementById('saludoBot').value,
                despedida: document.getElementById('despedidaBot').value
            };
            const bot = editorVisualBots.crearBot(datos);
            if (bot) {
                mostrarNotificacion(' Bot creado', 'success');
                cerrarFormularioBot();
                cerrarEditorVisualBots();
                setTimeout(() => abrirEditorVisualBots(), 500);
            }
        }
        
        function cerrarFormularioBot() {
            const modal = document.getElementById('modalFormularioBot');
            if (modal) modal.remove();
        }
        
        function toggleBotDesdeModal(botId) {
            const bot = editorVisualBots.bots.find(b => b.id === botId);
            if (bot) {
                bot.activo = !bot.activo;
                editorVisualBots.guardarBots();
                mostrarNotificacion(` Bot ${bot.activo ? 'activado' : 'desactivado'}`, 'success');
                cerrarEditorVisualBots();
                setTimeout(() => abrirEditorVisualBots(), 500);
            }
        }
        
        function eliminarBotDesdeModal(botId) {
            if (confirm('驴Eliminar este bot?')) {
                const index = editorVisualBots.bots.findIndex(b => b.id === botId);
                if (index !== -1) {
                    editorVisualBots.bots.splice(index, 1);
                    editorVisualBots.guardarBots();
                    mostrarNotificacion(' Bot eliminado', 'success');
                    cerrarEditorVisualBots();
                    setTimeout(() => abrirEditorVisualBots(), 500);
                }
            }
        }
        
        function mostrarFormularioFlujo() {
            mostrarNotificacion(' Funci贸n en desarrollo', 'info');
        }
        
        function eliminarFlujoDesdeModal(flujoId) {
            if (confirm('驴Eliminar este flujo?')) {
                const index = editorVisualBots.flujos.findIndex(f => f.id === flujoId);
                if (index !== -1) {
                    editorVisualBots.flujos.splice(index, 1);
                    editorVisualBots.guardarFlujos();
                    mostrarNotificacion(' Flujo eliminado', 'success');
                    cerrarEditorVisualBots();
                    setTimeout(() => abrirEditorVisualBots(), 500);
                }
            }
        }
        
        function exportarBots() {
            const datos = {
                bots: editorVisualBots.bots,
                flujos: editorVisualBots.flujos,
                categorias: editorVisualBots.categorias,
                estadisticas: editorVisualBots.obtenerEstadisticas(),
                fechaExportacion: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bots-personalizados-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            mostrarNotificacion(' Bots exportados', 'success');
        }
        
        function cerrarEditorVisualBots() {
            const modal = document.getElementById('modalEditorVisualBots');
            if (modal) modal.remove();
        }
        
        // ============================================
        // SISTEMA DE REMISERA COMPLETO CON IA
        // ============================================
        
        class SistemaRemiseriaCompleto {
            constructor() {
                this.remiseros = this.cargarRemiseros();
                this.turnos = this.cargarTurnos();
                this.reservas = this.cargarReservas();
                this.configuracion = this.cargarConfiguracion();
                this.inicializar();
            }
            cargarRemiseros() { return JSON.parse(localStorage.getItem('remiseros_tienda') || '[]'); }
            cargarTurnos() { return JSON.parse(localStorage.getItem('turnos_remiseria') || '[]'); }
            cargarReservas() { return JSON.parse(localStorage.getItem('reservas_remiseria') || '[]'); }
            cargarConfiguracion() { return JSON.parse(localStorage.getItem('configuracion_remiseria') || '{}'); }
            guardarRemiseros() { localStorage.setItem('remiseros_tienda', JSON.stringify(this.remiseros)); }
            guardarTurnos() { localStorage.setItem('turnos_remiseria', JSON.stringify(this.turnos)); }
            guardarReservas() { localStorage.setItem('reservas_remiseria', JSON.stringify(this.reservas)); }
            guardarConfiguracion() { localStorage.setItem('configuracion_remiseria', JSON.stringify(this.configuracion)); }
            
            inicializar() {
                console.log(' Sistema de Remiser铆a Completo inicializado');
                this.inicializarConfiguracionDefault();
            }
            
            inicializarConfiguracionDefault() {
                if (!this.configuracion.zonas) {
                    this.configuracion.zonas = {
                        rural: { nombre: 'Zona Rural', tipo: 'por_asiento', precioBase: 50, moneda: 'ARS' },
                        urbana: { nombre: 'Zona Urbana', tipo: 'por_kilometro', precioBase: 25, moneda: 'ARS' }
                    };
                }
                if (!this.configuracion.notificaciones) {
                    this.configuracion.notificaciones = { whatsapp: true, email: true, push: false, sms: false };
                }
                if (!this.configuracion.asientos) {
                    this.configuracion.asientos = { maximo: 5, opcional: true };
                }
                this.guardarConfiguracion();
            }
            
            agregarRemisero(datos) {
                const remisero = {
                    id: Date.now(),
                    nombre: datos.nombre,
                    apellido: datos.apellido,
                    telefono: datos.telefono,
                    email: datos.email,
                    vehiculo: {
                        marca: datos.marcaVehiculo,
                        modelo: datos.modeloVehiculo,
                        patente: datos.patente,
                        color: datos.colorVehiculo,
                        asientos: datos.asientos || 4
                    },
                    zona: datos.zona || 'urbana',
                    activo: datos.activo !== false,
                    calificacion: 0,
                    totalViajes: 0,
                    fechaRegistro: new Date().toISOString()
                };
                this.remiseros.unshift(remisero);
                this.guardarRemiseros();
                return remisero;
            }
            
            crearTurno(datos) {
                const remisero = this.remiseros.find(r => r.id === datos.remiseroId);
                const esRural = remisero?.zona === 'rural';
                
                const turno = {
                    id: Date.now(),
                    remiseroId: datos.remiseroId,
                    fecha: datos.fecha,
                    horaInicio: datos.horaInicio,
                    horaFin: datos.horaFin,
                    asientosDisponibles: datos.asientosDisponibles || 4,
                    asientosOcupados: 0,
                    origen: datos.origen,
                    destino: datos.destino,
                    precio: datos.precio,
                    zona: remisero?.zona || 'urbana',
                    estado: 'disponible',
                    completo: false,
                    reservas: [],
                    fechaCreacion: new Date().toISOString()
                };
                this.turnos.unshift(turno);
                this.guardarTurnos();
                return turno;
            }
            
            crearReserva(datos) {
                const turno = this.turnos.find(t => t.id === datos.turnoId);
                const remisero = this.remiseros.find(r => r.id === turno?.remiseroId);
                const esRural = remisero?.zona === 'rural';
                
                const reserva = {
                    id: Date.now(),
                    turnoId: datos.turnoId,
                    tipo: datos.tipo || 'pasajero', // 'pasajero' o 'encomienda'
                    cliente: { nombre: datos.nombreCliente, telefono: datos.telefonoCliente, email: datos.emailCliente },
                    asientos: datos.asientos || 1,
                    origen: datos.origen,
                    destino: datos.destino,
                    tipoViaje: datos.tipoViaje || 'ida', // 'ida', 'vuelta', 'ambas'
                    precio: datos.precio,
                    metodoPago: datos.metodoPago || 'efectivo',
                    estado: 'pendiente',
                    ticket: null,
                    // Para encomiendas
                    peso: datos.peso || null,
                    dimensiones: datos.dimensiones || null,
                    descripcion: datos.descripcion || null,
                    fechaCreacion: new Date().toISOString()
                };
                reserva.ticket = this.generarTicket(reserva);
                this.reservas.unshift(reserva);
                this.guardarReservas();
                this.actualizarTurnoReserva(datos.turnoId, reserva);
                
                // Verificar si turno rural est谩 completo (4 pasajeros)
                if (esRural && turno) {
                    const totalPasajeros = this.reservas
                        .filter(r => r.turnoId === datos.turnoId && r.tipo === 'pasajero')
                        .reduce((sum, r) => sum + (r.asientos || 1), 0);
                    
                    if (totalPasajeros >= 4) {
                        turno.completo = true;
                        turno.estado = 'completo';
                        this.guardarTurnos();
                        mostrarNotificacion(` Turno RURAL COMPLETO: ${totalPasajeros} pasajeros`, 'success');
                    }
                }
                
                return reserva;
            }
            
            generarTicket(reserva) {
                const numeroTicket = 'CRS-' + Date.now().toString().slice(-6);
                const turno = this.turnos.find(t => t.id === reserva.turnoId);
                const remisero = this.remiseros.find(r => r.id === turno.remiseroId);
                return {
                    numero: numeroTicket,
                    fecha: new Date().toLocaleDateString('es-ES'),
                    hora: new Date().toLocaleTimeString('es-ES'),
                    remisero: `${remisero.nombre} ${remisero.apellido}`,
                    vehiculo: `${remisero.vehiculo.marca} ${remisero.vehiculo.modelo}`,
                    patente: remisero.vehiculo.patente,
                    telefono: remisero.telefono,
                    origen: reserva.origen,
                    destino: reserva.destino,
                    asientos: reserva.asientos,
                    precio: reserva.precio,
                    agradecimiento: '隆Gracias por elegir Cresalia! Tu viaje seguro nos enorgullece. '
                };
            }
            
            actualizarTurnoReserva(turnoId, reserva) {
                const turno = this.turnos.find(t => t.id === turnoId);
                const remisero = this.remiseros.find(r => r.id === turno?.remiseroId);
                const esRural = remisero?.zona === 'rural';
                
                if (turno) {
                    if (reserva.tipo === 'pasajero') {
                        turno.asientosOcupados += reserva.asientos || 1;
                    }
                    turno.reservas.push(reserva.id);
                    
                    // Solo zona rural requiere m铆nimo de pasajeros (cobra por asiento)
                    if (esRural) {
                        const minimoRural = 4; // M铆nimo requerido para zona rural (cobra por asiento)
                        
                        const totalPasajeros = this.reservas
                            .filter(r => r.turnoId === turnoId && r.tipo === 'pasajero')
                            .reduce((sum, r) => sum + (r.asientos || 1), 0);
                        
                        if (totalPasajeros >= minimoRural) {
                            turno.completo = true;
                            turno.estado = 'completo';
                            mostrarNotificacion(` Turno RURAL COMPLETO: ${totalPasajeros} pasajeros`, 'success');
                        } else {
                            const faltantes = minimoRural - totalPasajeros;
                            mostrarNotificacion(`癸 Turno rural: faltan ${faltantes} pasajero(s) para completar (m铆nimo ${minimoRural} - cobra por asiento)`, 'info');
                        }
                    } else {
                        // Zona urbana: cobra por kil贸metro, NO requiere m铆nimo de pasajeros
                        // Solo verificar si se llenaron todos los asientos disponibles
                        if (turno.asientosOcupados >= turno.asientosDisponibles) {
                            turno.estado = 'ocupado';
                        }
                    }
                    
                    this.guardarTurnos();
                }
            }
            
            // Sistema de matching para zona rural
            buscarMatching(reservaCancelada) {
                const turnoCancelado = this.turnos.find(t => t.id === reservaCancelada.turnoId);
                if (!turnoCancelado) return null;
                
                const remisero = this.remiseros.find(r => r.id === turnoCancelado.remiseroId);
                const esRural = remisero?.zona === 'rural';
                
                if (!esRural) return null; // Solo matching para zona rural
                
                // Buscar otras solicitudes de pasajeros buscando remis
                const solicitudesPendientes = JSON.parse(localStorage.getItem('solicitudes_pasajeros') || '[]');
                
                // Buscar solicitudes con mismo destino (ciudad) y fecha similar
                // Para matching: busca por destino (ciudad) y tipo de viaje compatible
                // IMPORTANTE: "Solo Ida" puede matchear con "Solo Vuelta" (y viceversa) para optimizar viajes
                const matches = solicitudesPendientes.filter(solicitud => {
                    const mismoDestino = solicitud.destino === turnoCancelado.destino;
                    const mismaFecha = solicitud.fecha === turnoCancelado.fecha;
                    const mismoHorario = Math.abs(new Date(`2000-01-01T${solicitud.hora}`) - new Date(`2000-01-01T${turnoCancelado.horaInicio}`)) < 3600000; // 1 hora de diferencia
                    
                    // Compatibilidad de tipo de viaje (OPTIMIZADO):
                    // - "Solo Ida" puede matchear con "Solo Vuelta" (remisero hace ida y vuelta con dos pasajeros)
                    // - "Solo Vuelta" puede matchear con "Solo Ida" (remisero hace ida y vuelta con dos pasajeros)
                    // - "Ida y Vuelta" puede matchear con cualquiera
                    // - Mismo tipo tambi茅n es compatible
                    const tipoViajeCancelado = reservaCancelada.tipoViaje || 'ida';
                    const tipoViajeSolicitud = solicitud.tipoViaje || 'ida';
                    
                    const tipoViajeCompatible = 
                        tipoViajeCancelado === 'ambas' || // "Ida y Vuelta" matchea con cualquiera
                        tipoViajeSolicitud === 'ambas' || // Cualquiera matchea con "Ida y Vuelta"
                        tipoViajeCancelado === tipoViajeSolicitud || // Mismo tipo
                        (tipoViajeCancelado === 'ida' && tipoViajeSolicitud === 'vuelta') || // Ida + Vuelta = viaje completo
                        (tipoViajeCancelado === 'vuelta' && tipoViajeSolicitud === 'ida'); // Vuelta + Ida = viaje completo
                    
                    return mismoDestino && mismaFecha && mismoHorario && tipoViajeCompatible && solicitud.estado === 'pendiente';
                });
                
                // Tambi茅n buscar en reservas existentes del sistema (no solo solicitudes pendientes)
                const reservasPendientes = this.reservas.filter(r => 
                    r.turnoId !== turnoCancelado.id &&
                    r.estado === 'pendiente' &&
                    r.tipo === 'pasajero' &&
                    r.destino === turnoCancelado.destino
                );
                
                // Filtrar reservas por compatibilidad de tipo de viaje
                const reservasCompatibles = reservasPendientes.filter(reserva => {
                    const tipoViajeCancelado = reservaCancelada.tipoViaje || 'ida';
                    const tipoViajeReserva = reserva.tipoViaje || 'ida';
                    
                    const tipoViajeCompatible = 
                        tipoViajeCancelado === 'ambas' ||
                        tipoViajeReserva === 'ambas' ||
                        tipoViajeCancelado === tipoViajeReserva ||
                        (tipoViajeCancelado === 'ida' && tipoViajeReserva === 'vuelta') ||
                        (tipoViajeCancelado === 'vuelta' && tipoViajeReserva === 'ida');
                    
                    return tipoViajeCompatible;
                });
                
                // Buscar encomiendas pendientes (mismo destino - ciudad)
                const encomiendasPendientes = this.reservas.filter(r => 
                    r.tipo === 'encomienda' && 
                    r.estado === 'pendiente' &&
                    r.turnoId !== turnoCancelado.id &&
                    r.destino === turnoCancelado.destino
                );
                
                return {
                    turno: turnoCancelado,
                    remisero: remisero,
                    solicitudesPasajeros: matches,
                    reservasCompatibles: reservasCompatibles, // Reservas del sistema con tipo de viaje compatible
                    encomiendas: encomiendasPendientes,
                    totalMatches: matches.length + reservasCompatibles.length + encomiendasPendientes.length
                };
            }
            
            obtenerEstadisticas() {
                return {
                    totalRemiseros: this.remiseros.length,
                    remiserosActivos: this.remiseros.filter(r => r.activo).length,
                    totalTurnos: this.turnos.length,
                    turnosDisponibles: this.turnos.filter(t => t.estado === 'disponible').length,
                    totalReservas: this.reservas.length,
                    reservasConfirmadas: this.reservas.filter(r => r.estado === 'confirmada').length,
                    ingresosTotales: this.reservas.reduce((sum, r) => sum + r.precio, 0)
                };
            }
            
            // Alias para mantener compatibilidad
            agregarTurno(datos) {
                return this.crearTurno(datos);
            }
            
            agregarReserva(datos) {
                return this.crearReserva({
                    turnoId: datos.turnoId,
                    nombreCliente: datos.cliente.nombre,
                    telefonoCliente: datos.cliente.telefono,
                    emailCliente: datos.cliente.email || '',
                    origen: datos.origen,
                    destino: datos.destino,
                    precio: datos.precio,
                    metodoPago: datos.metodoPago,
                    asientos: 1
                });
            }
        }
        
        let sistemaRemiseriaCompleto = new SistemaRemiseriaCompleto();
        
        // Hacer funci贸n global
        window.abrirGestionRemiseriaCompleta = function abrirGestionRemiseriaCompleta() {
            console.log(' Abriendo gesti贸n de remiser铆a completa...');
            const modal = document.createElement('div');
            modal.id = 'modalGestionRemiseriaCompleta';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            const estadisticas = sistemaRemiseriaCompleto.obtenerEstadisticas();
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 1600px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarGestionRemiseriaCompleta()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;"></div>
                        <h2 style="margin: 0;">Sistema de Remiser铆a Completo</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Gesti贸n inteligente con IA y notificaciones</p>
                    </div>
                    <div style="padding: 32px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #F0FDF4; padding: 20px; border-radius: 12px; border: 1px solid #BBF7D0; text-align: center;">
                                <div style="font-size: 2rem; color: #059669; margin-bottom: 8px;">ㄢ</div>
                                <h3 style="margin: 0; color: #059669; font-size: 1.5rem;">${estadisticas.remiserosActivos}</h3>
                                <p style="margin: 0; color: #059669; font-size: 0.9rem;">Remiseros Activos</p>
                            </div>
                            <div style="background: #F0F9FF; padding: 20px; border-radius: 12px; border: 1px solid #BAE6FD; text-align: center;">
                                <div style="font-size: 2rem; color: #0369A1; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #0369A1; font-size: 1.5rem;">${estadisticas.turnosDisponibles}</h3>
                                <p style="margin: 0; color: #0369A1; font-size: 0.9rem;">Turnos Disponibles</p>
                            </div>
                            <div style="background: #FDF2F8; padding: 20px; border-radius: 12px; border: 1px solid #FBCFE8; text-align: center;">
                                <div style="font-size: 2rem; color: #BE185D; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #BE185D; font-size: 1.5rem;">${estadisticas.reservasConfirmadas}</h3>
                                <p style="margin: 0; color: #BE185D; font-size: 0.9rem;">Reservas</p>
                            </div>
                            <div style="background: #FEF3C7; padding: 20px; border-radius: 12px; border: 1px solid #FDE68A; text-align: center;">
                                <div style="font-size: 2rem; color: #D97706; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #D97706; font-size: 1.5rem;">$${estadisticas.ingresosTotales}</h3>
                                <p style="margin: 0; color: #D97706; font-size: 0.9rem;">Ingresos</p>
                            </div>
                        </div>
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                                <button onclick="mostrarTabRemiseria('remiseros')" id="tabRemiseriaRemiseros" style="background: #F59E0B; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">ㄢ Remiseros</button>
                                <button onclick="mostrarTabRemiseria('turnos')" id="tabRemiseriaTurnos" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Turnos</button>
                                <button onclick="mostrarTabRemiseria('reservas')" id="tabRemiseriaReservas" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Reservas</button>
                                <button onclick="mostrarTabRemiseria('configuracion')" id="tabRemiseriaConfiguracion" style="background: #E5E7EB; color: #374151; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">锔 Config</button>
                            </div>
                            <div id="contenidoRemiseria">
                                <div id="tabContenidoRemiseriaRemiseros" style="display: block;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                        <h3 style="margin: 0; color: #374151;">ㄢ Remiseros</h3>
                                        <button onclick="mostrarFormularioRemisero()" style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Agregar</button>
                                    </div>
                                    <div id="listaRemiseros" style="display: grid; gap: 16px;">
                                        ${sistemaRemiseriaCompleto.remiseros.length > 0 ? sistemaRemiseriaCompleto.remiseros.map(remisero => `
                                            <div style="background: ${remisero.activo ? '#F0FDF4' : '#FEF2F2'}; border: 1px solid ${remisero.activo ? '#BBF7D0' : '#FECACA'}; border-radius: 12px; padding: 20px;">
                                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                                    <div><h4 style="margin: 0; color: #374151;">${remisero.nombre} ${remisero.apellido}</h4><p style="margin: 5px 0; color: #6B7280; font-size: 0.9rem;">${remisero.vehiculo.marca} ${remisero.vehiculo.modelo} - ${remisero.vehiculo.patente}</p></div>
                                                    <div style="display: flex; gap: 5px;">
                                                        <span style="background: ${remisero.activo ? '#10B981' : '#6B7280'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${remisero.activo ? 'Activo' : 'Inactivo'}</span>
                                                        <span style="background: #3B82F6; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">猸 ${remisero.calificacion}/5</span>
                                                    </div>
                                                </div>
                                                <div style="margin-bottom: 12px;"><p style="margin: 0; color: #374151; font-size: 0.95rem;"><strong>Tel:</strong> ${remisero.telefono} | <strong>Zona:</strong> ${remisero.zona} | <strong>Viajes:</strong> ${remisero.totalViajes}</p></div>
                                                <div style="display: flex; gap: 10px;">
                                                    <button onclick="toggleRemiseroDesdeModal(${remisero.id})" style="background: ${remisero.activo ? '#EF4444' : '#10B981'}; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">${remisero.activo ? '革' : '讹'}</button>
                                                    <button onclick="eliminarRemiseroDesdeModal(${remisero.id})" style="background: #EF4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">锔</button>
                                                </div>
                                            </div>
                                        `).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No hay remiseros</p></div>'}
                                    </div>
                                </div>
                                <div id="tabContenidoRemiseriaTurnos" style="display: none;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                        <h3 style="margin: 0; color: #374151;"> Turnos</h3>
                                        <button onclick="mostrarFormularioTurno()" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Crear</button>
                                    </div>
                                    <div id="listaTurnos" style="display: grid; gap: 16px;">
                                        ${sistemaRemiseriaCompleto.turnos.length > 0 ? sistemaRemiseriaCompleto.turnos.map(turno => {
                                            const remisero = sistemaRemiseriaCompleto.remiseros.find(r => r.id === turno.remiseroId);
                                            const reservasAfectadas = sistemaRemiseriaCompleto.reservas.filter(r => r.turnoId === turno.id);
                                            return `
                                                <div style="background: ${turno.estado === 'disponible' ? '#F0FDF4' : turno.estado === 'no-puede-concurrir' ? '#FEF3C7' : turno.estado === 'dia-libre' ? '#DBEAFE' : '#FEF2F2'}; border: 1px solid ${turno.estado === 'disponible' ? '#BBF7D0' : turno.estado === 'no-puede-concurrir' ? '#FDE68A' : turno.estado === 'dia-libre' ? '#BAE6FD' : '#FECACA'}; border-radius: 12px; padding: 20px;">
                                                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                                        <div><h4 style="margin: 0; color: #374151;">${remisero ? remisero.nombre + ' ' + remisero.apellido : 'N/A'}</h4><p style="margin: 5px 0; color: #6B7280; font-size: 0.9rem;">${new Date(turno.fecha).toLocaleDateString('es-ES')} | ${turno.horaInicio}-${turno.horaFin}</p></div>
                                                        <span style="background: ${turno.estado === 'disponible' ? '#10B981' : turno.estado === 'no-puede-concurrir' ? '#F59E0B' : turno.estado === 'dia-libre' ? '#3B82F6' : '#EF4444'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${turno.estado === 'disponible' ? 'Disponible' : turno.estado === 'no-puede-concurrir' ? '锔 No puede concurrir' : turno.estado === 'dia-libre' ? '锔 D铆a libre' : 'Ocupado'}</span>
                                                    </div>
                                                    <div style="margin-bottom: 12px;">
                                                        <p style="margin: 0; color: #374151; font-size: 0.95rem;">
                                                            <strong>Asientos:</strong> ${turno.asientosOcupados}/${turno.asientosDisponibles} | 
                                                            <strong>Precio:</strong> $${turno.precio}
                                                            ${reservasAfectadas.length > 0 ? ` | <strong>Reservas:</strong> ${reservasAfectadas.length}` : ''}
                                                            ${remisero?.zona === 'rural' ? ` | <strong>Zona:</strong> Rural` : ''}
                                                        </p>
                                                        ${remisero?.zona === 'rural' ? `
                                                            <p style="margin: 8px 0 0; color: ${turno.completo ? '#10B981' : '#F59E0B'}; font-weight: 600; font-size: 0.9rem;">
                                                                ${turno.completo ? ` COMPLETO (${turno.asientosOcupados} pasajeros)` : `锔 Faltan ${Math.max(0, 4 - turno.asientosOcupados)} pasajero(s) para completar (m铆nimo 4)`}
                                                            </p>
                                                        ` : ''}
                                                    </div>
                                                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                                        ${turno.estado === 'disponible' ? `
                                                            ${remisero?.zona === 'rural' && !turno.completo ? `
                                                                <button onclick="marcarTurnoCompleto(${turno.id})" style="background: #10B981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;"> Marcar Completo</button>
                                                            ` : ''}
                                                            <button onclick="marcarTurnoNoPuedeConcurrir(${turno.id})" style="background: #F59E0B; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">锔 No puede concurrir</button>
                                                            <button onclick="marcarTurnoDiaLibre(${turno.id})" style="background: #3B82F6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">锔 D铆a libre</button>
                                                        ` : `
                                                            <button onclick="marcarTurnoDisponible(${turno.id})" style="background: #10B981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;"> Disponible</button>
                                                        `}
                                                        <button onclick="eliminarTurnoDesdeModal(${turno.id})" style="background: #EF4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">锔</button>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No hay turnos</p></div>'}
                                    </div>
                                </div>
                                <div id="tabContenidoRemiseriaReservas" style="display: none;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                        <h3 style="margin: 0; color: #374151;"> Reservas</h3>
                                        <button onclick="mostrarFormularioReserva()" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Nueva</button>
                                    </div>
                                    <div id="listaReservas" style="display: grid; gap: 16px;">
                                        ${sistemaRemiseriaCompleto.reservas.length > 0 ? sistemaRemiseriaCompleto.reservas.map(reserva => `
                                            <div style="background: #F0F9FF; border: 1px solid #BAE6FD; border-radius: 12px; padding: 20px;">
                                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                                    <div><h4 style="margin: 0; color: #374151;">Ticket: ${reserva.ticket?.numero || 'N/A'}</h4><p style="margin: 5px 0; color: #6B7280; font-size: 0.9rem;">${reserva.cliente.nombre}</p></div>
                                                    <span style="background: ${reserva.estado === 'confirmada' ? '#10B981' : '#F59E0B'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">${reserva.estado === 'confirmada' ? 'Confirmada' : 'Pendiente'}</span>
                                                </div>
                                                <div style="margin-bottom: 12px;"><p style="margin: 0; color: #374151; font-size: 0.95rem;"><strong>Precio:</strong> $${reserva.precio} | <strong>Pago:</strong> ${reserva.metodoPago}</p></div>
                                                <div style="display: flex; gap: 10px;">
                                                    <button onclick="verTicketDesdeModal(${reserva.id})" style="background: #3B82F6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">锔 Ver</button>
                                                    <button onclick="eliminarReservaDesdeModal(${reserva.id})" style="background: #EF4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">锔</button>
                                                </div>
                                            </div>
                                        `).join('') : '<div style="text-align: center; padding: 40px; color: #6B7280;"><p>No hay reservas</p></div>'}
                                    </div>
                                </div>
                                <div id="tabContenidoRemiseriaConfiguracion" style="display: none;">
                                    <h3 style="margin: 0 0 20px; color: #374151;">锔 Configuraci贸n</h3>
                                    <div style="background: #F8FAFC; padding: 20px; border-radius: 12px; border: 1px solid #E5E7EB;">
                                        <h4 style="color: #374151; margin-bottom: 16px;"> Notificaciones</h4>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                            <div style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" id="notifWhatsApp" ${sistemaRemiseriaCompleto.configuracion.notificaciones.whatsapp ? 'checked' : ''} style="transform: scale(1.2);"><label for="notifWhatsApp" style="color: #374151; font-weight: 500;">WhatsApp</label></div>
                                            <div style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" id="notifEmail" ${sistemaRemiseriaCompleto.configuracion.notificaciones.email ? 'checked' : ''} style="transform: scale(1.2);"><label for="notifEmail" style="color: #374151; font-weight: 500;">Email</label></div>
                                            <div style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" id="notifPush" ${sistemaRemiseriaCompleto.configuracion.notificaciones.push ? 'checked' : ''} style="transform: scale(1.2);"><label for="notifPush" style="color: #374151; font-weight: 500;">Push</label></div>
                                            <div style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" id="notifSMS" ${sistemaRemiseriaCompleto.configuracion.notificaciones.sms ? 'checked' : ''} style="transform: scale(1.2);"><label for="notifSMS" style="color: #374151; font-weight: 500;">SMS</label></div>
                                        </div>
                                    </div>
                                    <div style="display: flex; justify-content: center; margin-top: 24px;">
                                        <button onclick="guardarConfiguracionRemiseria()" style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Guardar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="exportarRemiseria()" style="background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Exportar</button>
                            <button onclick="cerrarGestionRemiseriaCompleta()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function mostrarTabRemiseria(tab) {
            document.querySelectorAll('[id^="tabContenidoRemiseria"]').forEach(c => c.style.display = 'none');
            document.querySelectorAll('[id^="tabRemiseria"]').forEach(t => { t.style.background = '#E5E7EB'; t.style.color = '#374151'; });
            const cont = document.getElementById('tabContenidoRemiseria' + tab.charAt(0).toUpperCase() + tab.slice(1));
            const btn = document.getElementById('tabRemiseria' + tab.charAt(0).toUpperCase() + tab.slice(1));
            if (cont) cont.style.display = 'block';
            if (btn) { btn.style.background = '#F59E0B'; btn.style.color = 'white'; }
        }
        
        function mostrarFormularioRemisero() {
            const modal = document.createElement('div');
            modal.id = 'modalFormularioRemisero';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999999;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; padding: 24px; text-align: center; position: relative;">
                        <button onclick="cerrarFormularioRemisero()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <h3 style="margin: 0;">ㄢ Agregar Remisero</h3>
                    </div>
                    <div style="padding: 24px;">
                        <form id="formularioRemisero" onsubmit="guardarRemisero(event); return false;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Nombre</label><input type="text" id="nombreRemisero" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Apellido</label><input type="text" id="apellidoRemisero" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Tel茅fono</label><input type="tel" id="telefonoRemisero" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Email</label><input type="email" id="emailRemisero" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            </div>
                            <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Zona</label><select id="zonaRemisero" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"><option value="urbana">Urbana (km)</option><option value="rural">Rural (asiento)</option></select></div>
                            <h4 style="color: #374151; margin: 20px 0 16px;">Veh铆culo</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Marca</label><input type="text" id="marcaVehiculo" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Modelo</label><input type="text" id="modeloVehiculo" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Patente</label><input type="text" id="patenteVehiculo" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Color</label><input type="text" id="colorVehiculo" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            </div>
                            <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Cantidad de Asientos del Veh铆culo</label><input type="number" id="asientosVehiculo" required min="1" max="6" value="4" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;" placeholder="M谩ximo 6 asientos"></div>
                            <div style="display: flex; gap: 16px; justify-content: center;">
                                <button type="submit" style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Guardar</button>
                                <button type="button" onclick="cerrarFormularioRemisero()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer;">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function guardarRemisero(event) {
            event.preventDefault();
            const datos = {
                nombre: document.getElementById('nombreRemisero').value,
                apellido: document.getElementById('apellidoRemisero').value,
                telefono: document.getElementById('telefonoRemisero').value,
                email: document.getElementById('emailRemisero').value,
                zona: document.getElementById('zonaRemisero').value,
                marcaVehiculo: document.getElementById('marcaVehiculo').value,
                modeloVehiculo: document.getElementById('modeloVehiculo').value,
                patente: document.getElementById('patenteVehiculo').value,
                colorVehiculo: document.getElementById('colorVehiculo').value,
                asientos: parseInt(document.getElementById('asientosVehiculo').value || 4)
            };
            const remisero = sistemaRemiseriaCompleto.agregarRemisero(datos);
            if (remisero) {
                mostrarNotificacion(' Remisero agregado', 'success');
                cerrarFormularioRemisero();
                cerrarGestionRemiseriaCompleta();
                setTimeout(() => abrirGestionRemiseriaCompleta(), 500);
            }
        }
        
        function cerrarFormularioRemisero() {
            const modal = document.getElementById('modalFormularioRemisero');
            if (modal) modal.remove();
        }
        
        function mostrarFormularioTurno() {
            const remiseros = sistemaRemiseriaCompleto.remiseros.filter(r => r.activo);
            const modal = document.createElement('div');
            modal.id = 'modalFormularioTurnoRemiseria';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999999;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 24px; text-align: center; position: relative;">
                        <button onclick="cerrarFormularioTurnoRemiseria()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <h3 style="margin: 0;"> Crear Turno de Remisero</h3>
                    </div>
                    <div style="padding: 24px;">
                        <form id="formularioTurnoRemiseria" onsubmit="guardarTurnoRemiseria(event); return false;">
                            <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Remisero</label><select id="remiseroTurno" required onchange="actualizarAsientosMaximos()" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;">${remiseros.length > 0 ? remiseros.map(r => `<option value="${r.id}">${r.nombre} ${r.apellido} - ${r.vehiculo.patente} (${r.vehiculo.asientos || 4} asientos)</option>`).join('') : '<option value="">No hay remiseros activos</option>'}</select></div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Fecha</label><input type="date" id="fechaTurnoRemiseria" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Hora Inicio</label><input type="time" id="horaInicioTurno" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Hora Fin</label><input type="time" id="horaFinTurno" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Precio</label><input type="number" id="precioTurno" required min="0" step="0.01" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Origen</label><input type="text" id="origenTurno" placeholder="Ej: Centro, Terminal, etc." style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                <div id="campoDestinoTurno">
                                    <!-- Se actualizar谩 din谩micamente seg煤n la zona del remisero -->
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Destino</label>
                                    <select id="destinoTurnoRural" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; display: none;"><option value="Resistencia">Resistencia (Chaco)</option><option value="Corrientes">Corrientes</option><option value="Formosa">Formosa</option><option value="Posadas">Posadas (Misiones)</option><option value="Paran谩">Paran谩 (Entre R铆os)</option><option value="Santa Fe">Santa Fe</option><option value="Rosario">Rosario</option><option value="C贸rdoba">C贸rdoba</option><option value="Buenos Aires">Buenos Aires</option><option value="Otro">Otro</option></select>
                                    <input type="text" id="destinoTurnoUrbano" placeholder="Direcci贸n exacta de destino (ej: Av. 9 de Julio 1234)" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; display: none;">
                                </div>
                            </div>
                            <div id="destinoOtroTurno" style="display: none; margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Especificar otro destino</label><input type="text" id="destinoOtroTurnoInput" placeholder="Nombre de la ciudad" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            <div id="camposAsientosTurno" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Asientos Disponibles</label><input type="number" id="asientosDisponibles" required min="1" max="6" value="4" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Asientos Ocupados</label><input type="number" id="asientosOcupados" min="0" value="0" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            </div>
                            <div id="infoZonaTurno" style="background: #F0F9FF; border: 1px solid #BAE6FD; border-radius: 8px; padding: 12px; margin-bottom: 20px; display: none;">
                                <p style="margin: 0; color: #0369A1; font-size: 0.9rem;"><strong>癸 Zona Rural:</strong> Cobra por asiento. M铆nimo 4 pasajeros. Destino: ciudad principal.</p>
                                <p style="margin: 8px 0 0; color: #0369A1; font-size: 0.9rem;"><strong>癸 Zona Urbana:</strong> Cobra por kil贸metro. No requiere m铆nimo de pasajeros. Destino: direcci贸n exacta.</p>
                            </div>
                            <div style="display: flex; gap: 16px; justify-content: center;">
                                <button type="submit" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Guardar</button>
                                <button type="button" onclick="cerrarFormularioTurnoRemiseria()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer;">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => {
                configurarSelectDestino();
                actualizarAsientosMaximos();
            }, 100);
        }
        
        function guardarTurnoRemiseria(event) {
            event.preventDefault();
            const remiseroId = parseInt(document.getElementById('remiseroTurno').value);
            const remisero = sistemaRemiseriaCompleto.remiseros.find(r => r.id === remiseroId);
            const esRural = remisero?.zona === 'rural';
            
            let destino = '';
            if (esRural) {
                // Zona rural: usar select de ciudades
                destino = document.getElementById('destinoTurnoRural').value;
                if (destino === 'Otro') {
                    destino = document.getElementById('destinoOtroTurnoInput').value || '';
                }
            } else {
                // Zona urbana: usar campo de texto para direcci贸n exacta
                destino = document.getElementById('destinoTurnoUrbano').value;
                if (!destino.trim()) {
                    mostrarNotificacion('锔 La zona urbana requiere una direcci贸n exacta de destino', 'warning');
                    return;
                }
            }
            
            const datos = {
                remiseroId: remiseroId,
                fecha: document.getElementById('fechaTurnoRemiseria').value,
                horaInicio: document.getElementById('horaInicioTurno').value,
                horaFin: document.getElementById('horaFinTurno').value,
                precio: parseFloat(document.getElementById('precioTurno').value),
                origen: document.getElementById('origenTurno').value || '',
                destino: destino,
                asientosDisponibles: esRural ? parseInt(document.getElementById('asientosDisponibles').value) : (remisero?.vehiculo?.asientos || 4),
                asientosOcupados: parseInt(document.getElementById('asientosOcupados').value || 0)
            };
            const turno = sistemaRemiseriaCompleto.agregarTurno(datos);
            if (turno) {
                mostrarNotificacion(' Turno creado', 'success');
                cerrarFormularioTurnoRemiseria();
                cerrarGestionRemiseriaCompleta();
                setTimeout(() => abrirGestionRemiseriaCompleta(), 500);
            }
        }
        
        function cerrarFormularioTurnoRemiseria() {
            const modal = document.getElementById('modalFormularioTurnoRemiseria');
            if (modal) modal.remove();
        }
        
        function actualizarAsientosMaximos() {
            const asientosInput = document.getElementById('asientosDisponibles');
            const remiseroSelect = document.getElementById('remiseroTurno');
            const destinoRural = document.getElementById('destinoTurnoRural');
            const destinoUrbano = document.getElementById('destinoTurnoUrbano');
            const destinoOtro = document.getElementById('destinoOtroTurno');
            const camposAsientos = document.getElementById('camposAsientosTurno');
            const infoZona = document.getElementById('infoZonaTurno');
            
            if (remiseroSelect) {
                const remiseroId = parseInt(remiseroSelect.value);
                const remisero = sistemaRemiseriaCompleto.remiseros.find(r => r.id === remiseroId);
                
                if (remisero) {
                    const esRural = remisero.zona === 'rural';
                    
                    // Actualizar asientos m谩ximos
                    if (asientosInput && remisero.vehiculo && remisero.vehiculo.asientos) {
                        asientosInput.max = remisero.vehiculo.asientos;
                        if (parseInt(asientosInput.value) > remisero.vehiculo.asientos) {
                            asientosInput.value = remisero.vehiculo.asientos;
                        }
                    }
                    
                    // Mostrar/ocultar campos seg煤n zona
                    if (destinoRural && destinoUrbano) {
                        if (esRural) {
                            destinoRural.style.display = 'block';
                            destinoRural.required = true;
                            destinoUrbano.style.display = 'none';
                            destinoUrbano.required = false;
                            destinoUrbano.value = '';
                            if (camposAsientos) camposAsientos.style.display = 'grid';
                        } else {
                            destinoRural.style.display = 'none';
                            destinoRural.required = false;
                            destinoRural.value = '';
                            destinoUrbano.style.display = 'block';
                            destinoUrbano.required = true;
                            if (destinoOtro) destinoOtro.style.display = 'none';
                            if (camposAsientos) camposAsientos.style.display = 'none';
                        }
                    }
                    
                    // Mostrar informaci贸n de zona
                    if (infoZona) {
                        infoZona.style.display = 'block';
                        const infoText = esRural 
                            ? `<strong>癸 Zona Rural:</strong> Cobra por ASIENTO. M铆nimo 4 pasajeros requeridos. Destino: ciudad principal.`
                            : `<strong>癸 Zona Urbana:</strong> Cobra por KILMETRO. No requiere m铆nimo de pasajeros. Destino: direcci贸n EXACTA requerida.`;
                        infoZona.innerHTML = `<p style="margin: 0; color: #0369A1; font-size: 0.9rem;">${infoText}</p>`;
                    }
                }
            }
        }
        
        function configurarSelectDestino() {
            // Para formulario de turnos (zona rural)
            const destinoTurnoRural = document.getElementById('destinoTurnoRural');
            if (destinoTurnoRural && !destinoTurnoRural.hasAttribute('data-listener')) {
                destinoTurnoRural.setAttribute('data-listener', 'true');
                destinoTurnoRural.addEventListener('change', function() {
                    const otroDiv = document.getElementById('destinoOtroTurno');
                    if (otroDiv) {
                        otroDiv.style.display = this.value === 'Otro' ? 'block' : 'none';
                    }
                });
            }
            
            // Para formulario de reservas (zona rural)
            const destinoReservaRural = document.getElementById('destinoReservaRural');
            if (destinoReservaRural && !destinoReservaRural.hasAttribute('data-listener')) {
                destinoReservaRural.setAttribute('data-listener', 'true');
                destinoReservaRural.addEventListener('change', function() {
                    const otroDiv = document.getElementById('destinoOtroReserva');
                    if (otroDiv) {
                        otroDiv.style.display = this.value === 'Otro' ? 'block' : 'none';
                    }
                });
            }
            
            // Actualizar destino seg煤n turno seleccionado en formulario de reservas
            const turnoReserva = document.getElementById('turnoReserva');
            if (turnoReserva && !turnoReserva.hasAttribute('data-listener')) {
                turnoReserva.setAttribute('data-listener', 'true');
                turnoReserva.addEventListener('change', function() {
                    actualizarDestinoSegunTurno();
                });
            }
        }
        
        function actualizarDestinoSegunTurno() {
            const turnoSelect = document.getElementById('turnoReserva');
            const destinoRural = document.getElementById('destinoReservaRural');
            const destinoUrbano = document.getElementById('destinoReservaUrbano');
            const destinoOtro = document.getElementById('destinoOtroReserva');
            
            if (turnoSelect && destinoRural && destinoUrbano) {
                const turnoId = parseInt(turnoSelect.value);
                const turno = sistemaRemiseriaCompleto.turnos.find(t => t.id === turnoId);
                
                if (turno) {
                    const remisero = sistemaRemiseriaCompleto.remiseros.find(r => r.id === turno.remiseroId);
                    const esRural = remisero?.zona === 'rural';
                    
                    if (esRural) {
                        destinoRural.style.display = 'block';
                        destinoRural.required = true;
                        destinoUrbano.style.display = 'none';
                        destinoUrbano.required = false;
                        destinoUrbano.value = '';
                        if (destinoOtro && destinoRural.value !== 'Otro') destinoOtro.style.display = 'none';
                    } else {
                        destinoRural.style.display = 'none';
                        destinoRural.required = false;
                        destinoRural.value = '';
                        destinoUrbano.style.display = 'block';
                        destinoUrbano.required = true;
                        if (destinoOtro) destinoOtro.style.display = 'none';
                    }
                }
            }
        }
        
        
        function mostrarFormularioReserva() {
            const turnos = sistemaRemiseriaCompleto.turnos.filter(t => t.estado === 'disponible');
            const modal = document.createElement('div');
            modal.id = 'modalFormularioReserva';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999999;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; padding: 24px; text-align: center; position: relative;">
                        <button onclick="cerrarFormularioReserva()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <h3 style="margin: 0;"> Nueva Reserva</h3>
                    </div>
                    <div style="padding: 24px;">
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button type="button" onclick="cambiarTipoReserva('pasajero')" id="btnTipoPasajero" style="flex: 1; background: #8B5CF6; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Pasajero</button>
                            <button type="button" onclick="cambiarTipoReserva('encomienda')" id="btnTipoEncomienda" style="flex: 1; background: #E5E7EB; color: #6B7280; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Encomienda</button>
                        </div>
                        <form id="formularioReserva" onsubmit="guardarReservaRemiseria(event); return false;">
                            <input type="hidden" id="tipoReserva" value="pasajero">
                            <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Turno</label><select id="turnoReserva" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;">${turnos.length > 0 ? turnos.map(t => {
                                const remisero = sistemaRemiseriaCompleto.remiseros.find(r => r.id === t.remiseroId);
                                return `<option value="${t.id}">${remisero ? remisero.nombre + ' ' + remisero.apellido : 'N/A'} - ${new Date(t.fecha).toLocaleDateString('es-ES')} ${t.horaInicio}-${t.horaFin}</option>`;
                            }).join('') : '<option value="">No hay turnos disponibles</option>'}</select></div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Nombre Cliente</label><input type="text" id="nombreClienteReserva" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Tel茅fono</label><input type="tel" id="telefonoClienteReserva" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            </div>
                            <div id="camposPasajero">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                    <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Asientos</label><input type="number" id="asientosReserva" min="1" value="1" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                    <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Email (opcional)</label><input type="email" id="emailClienteReserva" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                </div>
                            </div>
                            <div id="camposEncomienda" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                    <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Peso (kg)</label><input type="number" id="pesoEncomienda" min="0" step="0.1" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                    <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Dimensiones</label><input type="text" id="dimensionesEncomienda" placeholder="Ej: 30x20x15 cm" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                                </div>
                                <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Descripci贸n</label><textarea id="descripcionEncomienda" rows="3" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;" placeholder="Descripci贸n del contenido"></textarea></div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Origen</label><input type="text" id="origenReserva" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;" placeholder="Direcci贸n de origen"></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Destino (Ciudad)</label><select id="destinoReserva" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"><option value="Resistencia">Resistencia (Chaco)</option><option value="Corrientes">Corrientes</option><option value="Formosa">Formosa</option><option value="Posadas">Posadas (Misiones)</option><option value="Paran谩">Paran谩 (Entre R铆os)</option><option value="Santa Fe">Santa Fe</option><option value="Rosario">Rosario</option><option value="C贸rdoba">C贸rdoba</option><option value="Buenos Aires">Buenos Aires</option><option value="Otro">Otro</option></select></div>
                            </div>
                            <div id="destinoOtroReserva" style="display: none; margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Especificar otro destino</label><input type="text" id="destinoOtroReservaInput" placeholder="Nombre de la ciudad" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Tipo de Viaje</label><select id="tipoViajeReserva" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"><option value="ida">Solo Ida</option><option value="vuelta">Solo Vuelta</option><option value="ambas">Ida y Vuelta</option></select></div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">M茅todo de Pago</label><select id="metodoPagoReserva" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"><option value="efectivo">Efectivo</option><option value="tarjeta">Tarjeta</option><option value="transferencia">Transferencia</option></select></div>
                                <div><label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Precio</label><input type="number" id="precioReserva" required min="0" step="0.01" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;"></div>
                            </div>
                            <div style="display: flex; gap: 16px; justify-content: center;">
                                <button type="submit" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Guardar</button>
                                <button type="button" onclick="cerrarFormularioReserva()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer;">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => {
                configurarSelectDestino();
            }, 100);
        }
        
        function cambiarTipoReserva(tipo) {
            document.getElementById('tipoReserva').value = tipo;
            const btnPasajero = document.getElementById('btnTipoPasajero');
            const btnEncomienda = document.getElementById('btnTipoEncomienda');
            const camposPasajero = document.getElementById('camposPasajero');
            const camposEncomienda = document.getElementById('camposEncomienda');
            
            if (tipo === 'pasajero') {
                btnPasajero.style.background = '#8B5CF6';
                btnPasajero.style.color = 'white';
                btnEncomienda.style.background = '#E5E7EB';
                btnEncomienda.style.color = '#6B7280';
                camposPasajero.style.display = 'block';
                camposEncomienda.style.display = 'none';
                const asientos = document.getElementById('asientosReserva');
                if (asientos) asientos.required = true;
            } else {
                btnEncomienda.style.background = '#8B5CF6';
                btnEncomienda.style.color = 'white';
                btnPasajero.style.background = '#E5E7EB';
                btnPasajero.style.color = '#6B7280';
                camposEncomienda.style.display = 'block';
                camposPasajero.style.display = 'none';
                const asientos = document.getElementById('asientosReserva');
                if (asientos) asientos.required = false;
            }
        }
        
        function guardarReservaRemiseria(event) {
            event.preventDefault();
            const tipo = document.getElementById('tipoReserva').value;
            const turnoId = parseInt(document.getElementById('turnoReserva').value);
            const turno = sistemaRemiseriaCompleto.turnos.find(t => t.id === turnoId);
            const remisero = turno ? sistemaRemiseriaCompleto.remiseros.find(r => r.id === turno.remiseroId) : null;
            const esRural = remisero?.zona === 'rural';
            
            let destino = '';
            if (esRural) {
                // Zona rural: usar select de ciudades
                destino = document.getElementById('destinoReservaRural').value;
                if (destino === 'Otro') {
                    destino = document.getElementById('destinoOtroReservaInput').value || '';
                }
            } else {
                // Zona urbana: usar campo de texto para direcci贸n exacta
                destino = document.getElementById('destinoReservaUrbano').value;
                if (!destino.trim()) {
                    mostrarNotificacion('锔 La zona urbana requiere una direcci贸n exacta de destino', 'warning');
                    return;
                }
            }
            
            const datos = {
                turnoId: parseInt(document.getElementById('turnoReserva').value),
                tipo: tipo,
                nombreCliente: document.getElementById('nombreClienteReserva').value,
                telefonoCliente: document.getElementById('telefonoClienteReserva').value,
                emailCliente: document.getElementById('emailClienteReserva')?.value || '',
                origen: document.getElementById('origenReserva').value,
                destino: destino,
                tipoViaje: document.getElementById('tipoViajeReserva').value,
                precio: parseFloat(document.getElementById('precioReserva').value),
                metodoPago: document.getElementById('metodoPagoReserva').value
            };
            
            if (tipo === 'pasajero') {
                datos.asientos = parseInt(document.getElementById('asientosReserva').value || 1);
            } else {
                datos.peso = parseFloat(document.getElementById('pesoEncomienda').value) || null;
                datos.dimensiones = document.getElementById('dimensionesEncomienda').value || null;
                datos.descripcion = document.getElementById('descripcionEncomienda').value || null;
            }
            
            const reserva = sistemaRemiseriaCompleto.crearReserva(datos);
            if (reserva) {
                mostrarNotificacion(` ${tipo === 'pasajero' ? 'Pasajero' : 'Encomienda'} agregado(a)`, 'success');
                cerrarFormularioReserva();
                cerrarGestionRemiseriaCompleta();
                setTimeout(() => abrirGestionRemiseriaCompleta(), 500);
            }
        }
        
        function cerrarFormularioReserva() {
            const modal = document.getElementById('modalFormularioReserva');
            if (modal) modal.remove();
        }
        
        function toggleRemiseroDesdeModal(remiseroId) {
            const remisero = sistemaRemiseriaCompleto.remiseros.find(r => r.id === remiseroId);
            if (remisero) {
                remisero.activo = !remisero.activo;
                sistemaRemiseriaCompleto.guardarRemiseros();
                mostrarNotificacion(` Remisero ${remisero.activo ? 'activado' : 'desactivado'}`, 'success');
                cerrarGestionRemiseriaCompleta();
                setTimeout(() => abrirGestionRemiseriaCompleta(), 500);
            }
        }
        
        function eliminarRemiseroDesdeModal(remiseroId) {
            if (confirm('驴Eliminar este remisero?')) {
                const index = sistemaRemiseriaCompleto.remiseros.findIndex(r => r.id === remiseroId);
                if (index !== -1) {
                    sistemaRemiseriaCompleto.remiseros.splice(index, 1);
                    sistemaRemiseriaCompleto.guardarRemiseros();
                    mostrarNotificacion(' Remisero eliminado', 'success');
                    cerrarGestionRemiseriaCompleta();
                    setTimeout(() => abrirGestionRemiseriaCompleta(), 500);
                }
            }
        }
        
        function eliminarTurnoDesdeModal(turnoId) {
            if (confirm('驴Eliminar este turno?')) {
                const index = sistemaRemiseriaCompleto.turnos.findIndex(t => t.id === turnoId);
                if (index !== -1) {
                    const turno = sistemaRemiseriaCompleto.turnos[index];
                    const reservasAfectadas = sistemaRemiseriaCompleto.reservas.filter(r => r.turnoId === turnoId);
                    
                    if (reservasAfectadas.length > 0) {
                        if (confirm(`锔 Este turno tiene ${reservasAfectadas.length} reserva(s). 驴Deseas notificar a los clientes antes de eliminar?`)) {
                            notificarClientesTurnoCancelado(turno, reservasAfectadas, 'eliminado');
                        }
                    }
                    
                    sistemaRemiseriaCompleto.turnos.splice(index, 1);
                    sistemaRemiseriaCompleto.guardarTurnos();
                    mostrarNotificacion(' Turno eliminado', 'success');
                    cerrarGestionRemiseriaCompleta();
                    setTimeout(() => abrirGestionRemiseriaCompleta(), 500);
                }
            }
        }
        
        function marcarTurnoNoPuedeConcurrir(turnoId) {
            const turno = sistemaRemiseriaCompleto.turnos.find(t => t.id === turnoId);
            if (turno) {
                const reservasAfectadas = sistemaRemiseriaCompleto.reservas.filter(r => r.turnoId === turnoId);
                
                if (reservasAfectadas.length > 0) {
                    if (confirm(`锔 Este turno tiene ${reservasAfectadas.length} reserva(s). 驴Deseas notificar a los clientes?`)) {
                        notificarClientesTurnoCancelado(turno, reservasAfectadas, 'no-puede-concurrir');
                    }
                }
                
                turno.estado = 'no-puede-concurrir';
                turno.motivo = 'No puede concurrir';
                turno.fechaCambio = new Date().toISOString();
                sistemaRemiseriaCompleto.guardarTurnos();
                mostrarNotificacion('锔 Turno marcado como "No puede concurrir"', 'warning');
                cerrarGestionRemiseriaCompleta();
                setTimeout(() => abrirGestionRemiseriaCompleta(), 500);
            }
        }
        
        function marcarTurnoDiaLibre(turnoId) {
            const turno = sistemaRemiseriaCompleto.turnos.find(t => t.id === turnoId);
            if (turno) {
                const reservasAfectadas = sistemaRemiseriaCompleto.reservas.filter(r => r.turnoId === turnoId);
                
                if (reservasAfectadas.length > 0) {
                    if (confirm(`锔 Este turno tiene ${reservasAfectadas.length} reserva(s). 驴Deseas notificar a los clientes?`)) {
                        notificarClientesTurnoCancelado(turno, reservasAfectadas, 'dia-libre');
                    }
                }
                
                turno.estado = 'dia-libre';
                turno.motivo = 'D铆a libre';
                turno.fechaCambio = new Date().toISOString();
                sistemaRemiseriaCompleto.guardarTurnos();
                mostrarNotificacion('锔 Turno marcado como "D铆a libre"', 'info');
                cerrarGestionRemiseriaCompleta();
                setTimeout(() => abrirGestionRemiseriaCompleta(), 500);
            }
        }
        
        function marcarTurnoDisponible(turnoId) {
            const turno = sistemaRemiseriaCompleto.turnos.find(t => t.id === turnoId);
            if (turno) {
                turno.estado = 'disponible';
                turno.motivo = null;
                turno.fechaCambio = new Date().toISOString();
                sistemaRemiseriaCompleto.guardarTurnos();
                mostrarNotificacion(' Turno marcado como disponible', 'success');
                cerrarGestionRemiseriaCompleta();
                setTimeout(() => abrirGestionRemiseriaCompleta(), 500);
            }
        }
        
        function marcarTurnoCompleto(turnoId) {
            const turno = sistemaRemiseriaCompleto.turnos.find(t => t.id === turnoId);
            const remisero = sistemaRemiseriaCompleto.remiseros.find(r => r.id === turno?.remiseroId);
            
            if (turno && remisero?.zona === 'rural') {
                if (confirm('驴Marcar este turno como COMPLETO? El sistema dejar谩 de buscar m谩s pasajeros.')) {
                    turno.completo = true;
                    turno.estado = 'completo';
                    sistemaRemiseriaCompleto.guardarTurnos();
                    mostrarNotificacion(' Turno marcado como COMPLETO', 'success');
                    cerrarGestionRemiseriaCompleta();
                    setTimeout(() => abrirGestionRemiseriaCompleta(), 500);
                }
            }
        }
        
        async function notificarClientesTurnoCancelado(turno, reservasAfectadas, motivo) {
            const remisero = sistemaRemiseriaCompleto.remiseros.find(r => r.id === turno.remiseroId);
            const remiseroNombre = remisero ? `${remisero.nombre} ${remisero.apellido}` : 'el remisero';
            const esRural = remisero?.zona === 'rural';
            
            // Si es zona rural, buscar matching para proteger al remisero
            if (esRural && reservasAfectadas.length > 0) {
                for (const reserva of reservasAfectadas) {
                    const matching = sistemaRemiseriaCompleto.buscarMatching(reserva);
                    
                    if (matching && matching.totalMatches > 0) {
                        // Mostrar modal de matching para el remisero
                        mostrarModalMatching(turno, reserva, matching);
                        
                        // Notificar al remisero sobre las opciones de matching
                        const mensajeRemisero = generarMensajeMatchingRemisero(turno, reserva, matching);
                        await enviarNotificacionEmail(remisero.email, remiseroNombre, mensajeRemisero);
                    }
                }
            }
            
            // Buscar otros remiseros disponibles para la misma fecha/hora
            const otrosRemiseros = sistemaRemiseriaCompleto.remiseros.filter(r => 
                r.id !== turno.remiseroId && 
                r.activo && 
                r.zona === remisero?.zona
            );
            
            // Buscar otros turnos disponibles para la misma fecha/hora
            const otrosTurnos = sistemaRemiseriaCompleto.turnos.filter(t => 
                t.id !== turno.id &&
                t.fecha === turno.fecha &&
                t.estado === 'disponible' &&
                t.horaInicio === turno.horaInicio
            );
            
            // Buscar horarios de colectivos (si hay integraci贸n con transporte p煤blico)
            const horariosColectivos = await buscarHorariosColectivos(turno.origen, turno.destino, turno.fecha, turno.horaInicio);
            
            for (const reserva of reservasAfectadas) {
                const mensaje = generarMensajeDisculpa(reserva, turno, remiseroNombre, motivo, otrosRemiseros, otrosTurnos, horariosColectivos);
                
                // Enviar por email (gratis con Brevo)
                await enviarNotificacionEmail(reserva.cliente.email || reserva.cliente.telefono, reserva.cliente.nombre, mensaje);
                
                // Preparar para WhatsApp (cuando tenga API KEY)
                if (sistemaRemiseriaCompleto.configuracion.notificaciones.whatsapp) {
                    await enviarNotificacionWhatsApp(reserva.cliente.telefono, mensaje);
                }
            }
            
            mostrarNotificacion(` ${reservasAfectadas.length} cliente(s) notificado(s)`, 'success');
        }
        
        function generarMensajeMatchingRemisero(turno, reservaCancelada, matching) {
            let mensaje = `Hola ${matching.remisero.nombre},\n\n`;
            mensaje += `Se ha cancelado una reserva en tu turno del ${new Date(turno.fecha).toLocaleDateString('es-ES')} a las ${turno.horaInicio}.\n\n`;
            mensaje += ` SISTEMA DE MATCHING ACTIVADO:\n\n`;
            mensaje += `Hemos encontrado ${matching.totalMatches} opci贸n(es) para que no pierdas dinero:\n\n`;
            
            if (matching.solicitudesPasajeros.length > 0) {
                mensaje += ` Solicitudes de pasajeros (${matching.solicitudesPasajeros.length}):\n`;
                matching.solicitudesPasajeros.slice(0, 3).forEach(s => {
                    const tipoViaje = s.tipoViaje || 'ida';
                    const tipoViajeTexto = tipoViaje === 'ida' ? 'Solo Ida' : tipoViaje === 'vuelta' ? 'Solo Vuelta' : 'Ida y Vuelta';
                    const compatibilidad = reservaCancelada.tipoViaje === 'ida' && tipoViaje === 'vuelta' ? ' (Ida + Vuelta = Viaje Completo)' :
                                         reservaCancelada.tipoViaje === 'vuelta' && tipoViaje === 'ida' ? ' (Vuelta + Ida = Viaje Completo)' : '';
                    mensaje += `- ${s.nombre} - ${s.asientos} asiento(s) - ${s.origen}  ${s.destino} - ${tipoViajeTexto} ${compatibilidad} - Tel: ${s.telefono}\n`;
                });
                mensaje += `\n`;
            }
            
            if (matching.reservasCompatibles && matching.reservasCompatibles.length > 0) {
                mensaje += ` Reservas compatibles del sistema (${matching.reservasCompatibles.length}):\n`;
                matching.reservasCompatibles.slice(0, 3).forEach(r => {
                    const tipoViaje = r.tipoViaje || 'ida';
                    const tipoViajeTexto = tipoViaje === 'ida' ? 'Solo Ida' : tipoViaje === 'vuelta' ? 'Solo Vuelta' : 'Ida y Vuelta';
                    const compatibilidad = reservaCancelada.tipoViaje === 'ida' && tipoViaje === 'vuelta' ? ' (Ida + Vuelta = Viaje Completo)' :
                                         reservaCancelada.tipoViaje === 'vuelta' && tipoViaje === 'ida' ? ' (Vuelta + Ida = Viaje Completo)' : '';
                    mensaje += `- ${r.cliente.nombre} - ${r.asientos} asiento(s) - ${r.origen}  ${r.destino} - ${tipoViajeTexto} ${compatibilidad} - Tel: ${r.cliente.telefono}\n`;
                });
                mensaje += `\n`;
            }
            
            if (matching.encomiendas.length > 0) {
                mensaje += ` Encomiendas disponibles (${matching.encomiendas.length}):\n`;
                matching.encomiendas.slice(0, 3).forEach(e => {
                    mensaje += `- ${e.cliente.nombre} - ${e.peso || 'N/A'} kg - ${e.origen}  ${e.destino} - $${e.precio} - Tel: ${e.cliente.telefono}\n`;
                });
                mensaje += `\n`;
            }
            
            mensaje += `Puedes contactar directamente a estos clientes o usar el panel para aceptarlos autom谩ticamente.\n\n`;
            mensaje += ` Cresalia Remiser铆a`;
            
            return mensaje;
        }
        
        function mostrarModalMatching(turno, reservaCancelada, matching) {
            const modal = document.createElement('div');
            modal.id = 'modalMatchingRural';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 99999999;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; padding: 24px; text-align: center; position: relative;">
                        <button onclick="cerrarModalMatching()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <h3 style="margin: 0;"> MATCHING PARA ZONA RURAL</h3>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Encontramos opciones para que no pierdas dinero</p>
                    </div>
                    <div style="padding: 24px;">
                        <div style="background: #FEF3C7; border: 2px solid #F59E0B; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                            <p style="margin: 0; color: #92400E; font-weight: 600;">锔 Se cancel贸 una reserva en tu turno del ${new Date(turno.fecha).toLocaleDateString('es-ES')} a las ${turno.horaInicio}</p>
                        </div>
                        
                        ${matching.solicitudesPasajeros.length > 0 ? `
                            <h4 style="margin: 0 0 16px; color: #374151;"> Solicitudes de Pasajeros (${matching.solicitudesPasajeros.length})</h4>
                            <div style="background: #EFF6FF; border-left: 4px solid #3B82F6; padding: 12px; margin-bottom: 16px; border-radius: 4px;">
                                <p style="margin: 0; color: #1E40AF; font-size: 0.9rem;"><strong> Tip:</strong> Si alguien necesita "Solo Ida" y otro "Solo Vuelta", puedes hacer ambos viajes y optimizar tu recorrido.</p>
                            </div>
                            <div style="display: grid; gap: 12px; margin-bottom: 24px;">
                                ${matching.solicitudesPasajeros.map(s => {
                                    const tipoViaje = s.tipoViaje || 'ida';
                                    const tipoViajeTexto = tipoViaje === 'ida' ? 'Solo Ida' : tipoViaje === 'vuelta' ? 'Solo Vuelta' : 'Ida y Vuelta';
                                    const reservaTipo = reservaCancelada.tipoViaje || 'ida';
                                    const esCompatible = (reservaTipo === 'ida' && tipoViaje === 'vuelta') || (reservaTipo === 'vuelta' && tipoViaje === 'ida');
                                    const badgeColor = esCompatible ? '#10B981' : '#6B7280';
                                    return `
                                    <div style="background: ${esCompatible ? '#F0FDF4' : '#F9FAFB'}; border: 1px solid ${esCompatible ? '#10B981' : '#E5E7EB'}; border-radius: 8px; padding: 16px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center;">
                                            <strong style="color: #374151;">${s.nombre}</strong>
                                            <div style="display: flex; gap: 8px; align-items: center;">
                                                <span style="background: ${badgeColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">${tipoViajeTexto}</span>
                                                <span style="background: #10B981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">${s.asientos} asiento(s)</span>
                                            </div>
                                        </div>
                                        ${esCompatible ? `<p style="margin: 4px 0; color: #10B981; font-size: 0.85rem; font-weight: 600;"> Viaje Completo: ${reservaTipo === 'ida' ? 'Ida + Vuelta' : 'Vuelta + Ida'}</p>` : ''}
                                        <p style="margin: 4px 0; color: #6B7280; font-size: 0.9rem;"> ${s.origen}  ${s.destino}</p>
                                        <p style="margin: 4px 0; color: #6B7280; font-size: 0.9rem;"> ${s.telefono}</p>
                                        <button onclick="aceptarMatchingPasajero('${s.id}', ${turno.id})" style="background: #10B981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 8px;"> Aceptar</button>
                                    </div>
                                `;
                                }).join('')}
                            </div>
                        ` : ''}
                        
                        ${matching.reservasCompatibles && matching.reservasCompatibles.length > 0 ? `
                            <h4 style="margin: 0 0 16px; color: #374151;"> Reservas Compatibles del Sistema (${matching.reservasCompatibles.length})</h4>
                            <div style="display: grid; gap: 12px; margin-bottom: 24px;">
                                ${matching.reservasCompatibles.map(r => {
                                    const tipoViaje = r.tipoViaje || 'ida';
                                    const tipoViajeTexto = tipoViaje === 'ida' ? 'Solo Ida' : tipoViaje === 'vuelta' ? 'Solo Vuelta' : 'Ida y Vuelta';
                                    const reservaTipo = reservaCancelada.tipoViaje || 'ida';
                                    const esCompatible = (reservaTipo === 'ida' && tipoViaje === 'vuelta') || (reservaTipo === 'vuelta' && tipoViaje === 'ida');
                                    const badgeColor = esCompatible ? '#10B981' : '#6B7280';
                                    return `
                                    <div style="background: ${esCompatible ? '#F0FDF4' : '#F9FAFB'}; border: 1px solid ${esCompatible ? '#10B981' : '#E5E7EB'}; border-radius: 8px; padding: 16px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center;">
                                            <strong style="color: #374151;">${r.cliente.nombre}</strong>
                                            <div style="display: flex; gap: 8px; align-items: center;">
                                                <span style="background: ${badgeColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">${tipoViajeTexto}</span>
                                                <span style="background: #10B981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">${r.asientos} asiento(s)</span>
                                            </div>
                                        </div>
                                        ${esCompatible ? `<p style="margin: 4px 0; color: #10B981; font-size: 0.85rem; font-weight: 600;"> Viaje Completo: ${reservaTipo === 'ida' ? 'Ida + Vuelta' : 'Vuelta + Ida'}</p>` : ''}
                                        <p style="margin: 4px 0; color: #6B7280; font-size: 0.9rem;"> ${r.origen}  ${r.destino}</p>
                                        <p style="margin: 4px 0; color: #6B7280; font-size: 0.9rem;"> ${r.cliente.telefono}</p>
                                        <button onclick="aceptarMatchingReserva(${r.id}, ${turno.id})" style="background: #10B981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 8px;"> Aceptar</button>
                                    </div>
                                `;
                                }).join('')}
                            </div>
                        ` : ''}
                        
                        ${matching.encomiendas.length > 0 ? `
                            <h4 style="margin: 0 0 16px; color: #374151;"> Encomiendas Disponibles (${matching.encomiendas.length})</h4>
                            <div style="display: grid; gap: 12px; margin-bottom: 24px;">
                                ${matching.encomiendas.map(e => `
                                    <div style="background: #F0F9FF; border: 1px solid #BAE6FD; border-radius: 8px; padding: 16px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <strong style="color: #374151;">${e.cliente.nombre}</strong>
                                            <span style="background: #3B82F6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">$${e.precio}</span>
                                        </div>
                                        <p style="margin: 4px 0; color: #6B7280; font-size: 0.9rem;"> ${e.origen}  ${e.destino}</p>
                                        <p style="margin: 4px 0; color: #6B7280; font-size: 0.9rem;"> ${e.peso || 'N/A'} kg - ${e.dimensiones || 'N/A'}</p>
                                        <p style="margin: 4px 0; color: #6B7280; font-size: 0.9rem;"> ${e.cliente.telefono}</p>
                                        <button onclick="aceptarMatchingEncomienda(${e.id}, ${turno.id})" style="background: #3B82F6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 8px;"> Aceptar</button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function cerrarModalMatching() {
            const modal = document.getElementById('modalMatchingRural');
            if (modal) modal.remove();
        }
        
        function aceptarMatchingPasajero(solicitudId, turnoId) {
            const solicitudes = JSON.parse(localStorage.getItem('solicitudes_pasajeros') || '[]');
            const solicitud = solicitudes.find(s => s.id === solicitudId);
            
            if (solicitud) {
                // Crear reserva autom谩tica
                const reserva = sistemaRemiseriaCompleto.crearReserva({
                    turnoId: turnoId,
                    tipo: 'pasajero',
                    nombreCliente: solicitud.nombre,
                    telefonoCliente: solicitud.telefono,
                    emailCliente: solicitud.email || '',
                    asientos: solicitud.asientos || 1,
                    origen: solicitud.origen,
                    destino: solicitud.destino,
                    precio: solicitud.precio || sistemaRemiseriaCompleto.configuracion.zonas.rural.precioBase * solicitud.asientos,
                    metodoPago: 'efectivo'
                });
                
                // Marcar solicitud como aceptada
                solicitud.estado = 'aceptada';
                solicitud.turnoId = turnoId;
                solicitud.reservaId = reserva.id;
                localStorage.setItem('solicitudes_pasajeros', JSON.stringify(solicitudes));
                
                mostrarNotificacion(' Pasajero agregado al turno', 'success');
                cerrarModalMatching();
                cerrarGestionRemiseriaCompleta();
                setTimeout(() => abrirGestionRemiseriaCompleta(), 500);
            }
        }
        
        function aceptarMatchingReserva(reservaId, turnoId) {
            const reserva = sistemaRemiseriaCompleto.reservas.find(r => r.id === reservaId);
            
            if (reserva) {
                // Actualizar reserva al nuevo turno
                const turnoAnterior = reserva.turnoId;
                reserva.turnoId = turnoId;
                reserva.estado = 'confirmada';
                sistemaRemiseriaCompleto.guardarReservas();
                
                // Actualizar turno anterior (restar asientos)
                if (turnoAnterior) {
                    const turnoAnt = sistemaRemiseriaCompleto.turnos.find(t => t.id === turnoAnterior);
                    if (turnoAnt && reserva.tipo === 'pasajero') {
                        turnoAnt.asientosOcupados = Math.max(0, turnoAnt.asientosOcupados - (reserva.asientos || 1));
                        sistemaRemiseriaCompleto.guardarTurnos();
                    }
                }
                
                // Actualizar nuevo turno
                sistemaRemiseriaCompleto.actualizarTurnoReserva(turnoId, reserva);
                
                const tipoViaje = reserva.tipoViaje || 'ida';
                const tipoViajeTexto = tipoViaje === 'ida' ? 'Solo Ida' : tipoViaje === 'vuelta' ? 'Solo Vuelta' : 'Ida y Vuelta';
                mostrarNotificacion(` Reserva (${tipoViajeTexto}) agregada al turno`, 'success');
                cerrarModalMatching();
                cerrarGestionRemiseriaCompleta();
                setTimeout(() => abrirGestionRemiseriaCompleta(), 500);
            }
        }
        
        function aceptarMatchingEncomienda(encomiendaId, turnoId) {
            const encomienda = sistemaRemiseriaCompleto.reservas.find(r => r.id === encomiendaId);
            
            if (encomienda) {
                // Actualizar encomienda al nuevo turno
                encomienda.turnoId = turnoId;
                encomienda.estado = 'confirmada';
                sistemaRemiseriaCompleto.guardarReservas();
                
                // Actualizar turno
                sistemaRemiseriaCompleto.actualizarTurnoReserva(turnoId, encomienda);
                
                mostrarNotificacion(' Encomienda agregada al turno', 'success');
                cerrarModalMatching();
                cerrarGestionRemiseriaCompleta();
                setTimeout(() => abrirGestionRemiseriaCompleta(), 500);
            }
        }
        
        function generarMensajeDisculpa(reserva, turno, remiseroNombre, motivo, otrosRemiseros, otrosTurnos, horariosColectivos) {
            let mensaje = `Hola ${reserva.cliente.nombre},\n\n`;
            mensaje += `Lamentamos informarte que ${remiseroNombre} ${motivo === 'no-puede-concurrir' ? 'no puede concurrir' : motivo === 'dia-libre' ? 'tom贸 el d铆a libre' : 'cancel贸'} el turno del ${new Date(turno.fecha).toLocaleDateString('es-ES')} a las ${turno.horaInicio}.\n\n`;
            mensaje += `Entendemos que esto puede causarte inconvenientes y nos disculpamos sinceramente. \n\n`;
            
            if (otrosRemiseros.length > 0 || otrosTurnos.length > 0 || horariosColectivos.length > 0) {
                mensaje += `Te ofrecemos las siguientes alternativas:\n\n`;
                
                if (otrosRemiseros.length > 0) {
                    mensaje += ` Otros remiseros disponibles:\n`;
                    otrosRemiseros.slice(0, 3).forEach(r => {
                        mensaje += `- ${r.nombre} ${r.apellido} (${r.telefono}) - ${r.vehiculo.marca} ${r.vehiculo.modelo}\n`;
                    });
                    mensaje += `\n`;
                }
                
                if (otrosTurnos.length > 0) {
                    mensaje += ` Otros turnos disponibles:\n`;
                    otrosTurnos.slice(0, 3).forEach(t => {
                        const r = sistemaRemiseriaCompleto.remiseros.find(rem => rem.id === t.remiseroId);
                        mensaje += `- ${r ? r.nombre + ' ' + r.apellido : 'Remisero'} - ${t.horaInicio}-${t.horaFin} - $${t.precio}\n`;
                    });
                    mensaje += `\n`;
                }
                
                if (horariosColectivos.length > 0) {
                    mensaje += ` Horarios de colectivos disponibles:\n`;
                    horariosColectivos.slice(0, 3).forEach(h => {
                        mensaje += `- L铆nea ${h.linea} - ${h.hora} - Desde ${h.origen} hasta ${h.destino}\n`;
                    });
                    mensaje += `\n`;
                }
            }
            
            mensaje += `Si deseas reprogramar tu viaje o necesitas m谩s informaci贸n, no dudes en contactarnos.\n\n`;
            mensaje += `Gracias por tu comprensi贸n.\n`;
            mensaje += `Cresalia Remiser铆a `;
            
            return mensaje;
        }
        
        async function buscarHorariosColectivos(origen, destino, fecha, hora) {
            // Integraci贸n futura con sistema de transporte p煤blico
            // Por ahora retorna array vac铆o
            // Puedes integrar con la comunidad de "Transporte P煤blico" m谩s adelante
            try {
                // Aqu铆 podr铆as buscar en localStorage de la comunidad de transporte p煤blico
                const alertasTransporte = JSON.parse(localStorage.getItem('alertas_transporte_publico') || '[]');
                // Filtrar por origen/destino cercanos y horarios
                // Por ahora retornamos vac铆o
                return [];
            } catch (error) {
                console.warn('锔 Error buscando horarios de colectivos:', error);
                return [];
            }
        }
        
        async function enviarNotificacionEmail(email, nombre, mensaje) {
            if (!email) return;
            
            try {
                // Usar sistema de emails autom谩ticos de Cresalia (Brevo)
                if (window.sistemaEmailsCresalia) {
                    await window.sistemaEmailsCresalia.enviarEmailConBrevo(
                        email,
                        nombre,
                        '锔 Cambio en tu reserva de remiser铆a - Cresalia',
                        mensaje.replace(/\n/g, '<br>')
                    );
                    console.log(' Email enviado a:', email);
                } else {
                    console.warn('锔 Sistema de emails no disponible');
                }
            } catch (error) {
                console.error(' Error enviando email:', error);
            }
        }
        
        async function enviarNotificacionWhatsApp(telefono, mensaje) {
            if (!telefono) return;
            
            // Verificar si hay API KEY de WhatsApp configurada
            const whatsappApiKey = localStorage.getItem('whatsapp_api_key') || 
                                 (typeof process !== 'undefined' && process.env && process.env.WHATSAPP_API_KEY);
            
            if (!whatsappApiKey) {
                console.log('癸 WhatsApp API KEY no configurada. Usando email en su lugar.');
                // Guardar para enviar cuando se configure
                const pendientes = JSON.parse(localStorage.getItem('whatsapp_pendientes') || '[]');
                pendientes.push({ telefono, mensaje, fecha: new Date().toISOString() });
                localStorage.setItem('whatsapp_pendientes', JSON.stringify(pendientes));
                return;
            }
            
            try {
                // Llamar a API de WhatsApp (Vercel Serverless Function)
                const response = await fetch('/api/enviar-whatsapp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: telefono,
                        message: mensaje,
                        api_key: whatsappApiKey
                    })
                });
                
                if (response.ok) {
                    console.log(' WhatsApp enviado a:', telefono);
                } else {
                    throw new Error('Error en respuesta de API');
                }
            } catch (error) {
                console.error(' Error enviando WhatsApp:', error);
                // Fallback a email si est谩 disponible
                const email = sistemaRemiseriaCompleto.reservas.find(r => r.cliente.telefono === telefono)?.cliente.email;
                if (email) {
                    await enviarNotificacionEmail(email, '', mensaje);
                }
            }
        }
        
        function verTicketDesdeModal(reservaId) {
            const reserva = sistemaRemiseriaCompleto.reservas.find(r => r.id === reservaId);
            if (reserva && reserva.ticket) {
                const ticket = reserva.ticket;
                mostrarNotificacion(` Ticket: ${ticket.numero} | Remisero: ${ticket.remisero} | Veh铆culo: ${ticket.vehiculo} (${ticket.patente})`, 'success');
            }
        }
        
        function eliminarReservaDesdeModal(reservaId) {
            if (confirm('驴Eliminar esta reserva?')) {
                const index = sistemaRemiseriaCompleto.reservas.findIndex(r => r.id === reservaId);
                if (index !== -1) {
                    sistemaRemiseriaCompleto.reservas.splice(index, 1);
                    sistemaRemiseriaCompleto.guardarReservas();
                    mostrarNotificacion(' Reserva eliminada', 'success');
                    cerrarGestionRemiseriaCompleta();
                    setTimeout(() => abrirGestionRemiseriaCompleta(), 500);
                }
            }
        }
        
        function guardarConfiguracionRemiseria() {
            sistemaRemiseriaCompleto.configuracion.notificaciones = {
                whatsapp: document.getElementById('notifWhatsApp').checked,
                email: document.getElementById('notifEmail').checked,
                push: document.getElementById('notifPush').checked,
                sms: document.getElementById('notifSMS').checked
            };
            sistemaRemiseriaCompleto.guardarConfiguracion();
            mostrarNotificacion(' Configuraci贸n guardada', 'success');
        }
        
        function exportarRemiseria() {
            const datos = {
                remiseros: sistemaRemiseriaCompleto.remiseros,
                turnos: sistemaRemiseriaCompleto.turnos,
                reservas: sistemaRemiseriaCompleto.reservas,
                estadisticas: sistemaRemiseriaCompleto.obtenerEstadisticas(),
                fechaExportacion: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'remiseria-completa-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            mostrarNotificacion(' Datos exportados', 'success');
        }
        
        window.cerrarGestionRemiseriaCompleta = function cerrarGestionRemiseriaCompleta() {
            const modal = document.getElementById('modalGestionRemiseriaCompleta');
            if (modal) modal.remove();
        };
        
        // ============================================
        // HISTORIAL DE PAGOS Y SUSCRIPCIONES
        // ============================================
        
        function abrirHistorialPagos() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            const historialPagos = JSON.parse(localStorage.getItem('historial_pagos') || '[]');
            const historialSuscripciones = JSON.parse(localStorage.getItem('historial_suscripciones') || '[]');
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 16px; max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 25px;">
                        <h3 style="margin: 0; color: #1e293b;"> Historial de Pagos</h3>
                        <button onclick="cerrarModalSeguro(this)" style="background: #6B7280; color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 18px; width: 40px; height: 40px;"></button>
                    </div>
                    <div style="background: #F8FAFC; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px; color: #374151;">Resumen</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; color: #10B981; font-weight: 700;">${historialPagos.length}</div>
                                <div style="color: #6B7280; font-size: 0.9rem;">Pagos Realizados</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; color: #8B5CF6; font-weight: 700;">$${historialPagos.reduce((sum, p) => sum + (parseFloat(p.monto) || 0), 0).toFixed(2)}</div>
                                <div style="color: #6B7280; font-size: 0.9rem;">Total Pagado</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; color: #F59E0B; font-weight: 700;">${historialPagos.filter(p => p.estado === 'completado').length}</div>
                                <div style="color: #6B7280; font-size: 0.9rem;">Aprobados</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; color: #EC4899; font-weight: 700;">${historialSuscripciones.length}</div>
                                <div style="color: #6B7280; font-size: 0.9rem;">Suscripciones</div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button onclick="mostrarTabHistorial('pagos')" id="tabPagos" style="padding: 10px 20px; background: #8B5CF6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;"> Pagos</button>
                        <button onclick="mostrarTabHistorial('suscripciones')" id="tabSuscripciones" style="padding: 10px 20px; background: #E5E7EB; color: #6B7280; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;"> Suscripciones</button>
                    </div>
                    <div id="contenidoPagos" style="max-height: 400px; overflow-y: auto;">
                        ${historialPagos.length === 0 ? '<div style="text-align: center; padding: 40px; color: #6B7280;"><div style="font-size: 3rem; margin-bottom: 15px;"></div><p>No hay pagos</p></div>' : historialPagos.map(pago => `
                            <div style="background: white; border: 1px solid #E5E7EB; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <div><h5 style="margin: 0 0 5px; color: #1F2937;">${pago.concepto || 'Pago'}</h5><p style="margin: 0; color: #6B7280; font-size: 0.9rem;">${pago.fecha ? new Date(pago.fecha).toLocaleString('es-ES') : 'N/A'}</p></div>
                                    <div style="text-align: right;"><div style="font-size: 1.2rem; font-weight: 700; color: #10B981;">$${pago.monto || 0}</div><div style="font-size: 0.8rem; color: #6B7280;">${pago.metodo || 'N/A'}</div></div>
                                </div>
                                <span style="background: ${pago.estado === 'completado' ? '#D1FAE5' : '#FEE2E2'}; color: ${pago.estado === 'completado' ? '#065F46' : '#991B1B'}; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">${pago.estado === 'completado' ? ' Aprobado' : ' Pendiente'}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div id="contenidoSuscripciones" style="max-height: 400px; overflow-y: auto; display: none;">
                        ${historialSuscripciones.length === 0 ? '<div style="text-align: center; padding: 40px; color: #6B7280;"><div style="font-size: 3rem; margin-bottom: 15px;"></div><p>No hay suscripciones</p></div>' : historialSuscripciones.map(sub => `
                            <div style="background: white; border: 1px solid #E5E7EB; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                                <h5 style="margin: 0 0 10px; color: #1F2937;">Plan ${sub.plan || 'N/A'}</h5>
                                <p style="margin: 0 0 10px; color: #6B7280;">Desde: ${sub.fechaInicio ? new Date(sub.fechaInicio).toLocaleDateString('es-ES') : 'N/A'}</p>
                                <span style="background: ${sub.activa ? '#D1FAE5' : '#FEE2E2'}; color: ${sub.activa ? '#065F46' : '#991B1B'}; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">${sub.activa ? ' Activa' : ' Inactiva'}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function mostrarTabHistorial(tab) {
            const contenidoPagos = document.getElementById('contenidoPagos');
            const contenidoSuscripciones = document.getElementById('contenidoSuscripciones');
            const tabPagos = document.getElementById('tabPagos');
            const tabSuscripciones = document.getElementById('tabSuscripciones');
            
            if (contenidoPagos && contenidoSuscripciones && tabPagos && tabSuscripciones) {
                contenidoPagos.style.display = tab === 'pagos' ? 'block' : 'none';
                contenidoSuscripciones.style.display = tab === 'suscripciones' ? 'block' : 'none';
                tabPagos.style.background = tab === 'pagos' ? '#8B5CF6' : '#E5E7EB';
                tabPagos.style.color = tab === 'pagos' ? 'white' : '#6B7280';
                tabSuscripciones.style.background = tab === 'suscripciones' ? '#8B5CF6' : '#E5E7EB';
                tabSuscripciones.style.color = tab === 'suscripciones' ? 'white' : '#6B7280';
            }
        }
        
        function cerrarModalSeguro(btn) {
            const modal = btn.closest('div[style*="position: fixed"]');
            if (modal) modal.remove();
        }
        
        // ============================================
        // SISTEMA DE CALENDARIOS DE SERVICIOS
        // ============================================
        
        class SistemaCalendariosServicios {
            constructor() {
                this.turnos = this.cargarTurnos();
                this.reservas = this.cargarReservas();
                this.sanciones = this.cargarSanciones();
                this.configuracion = this.cargarConfiguracion();
                this.inicializar();
            }
            cargarTurnos() { return JSON.parse(localStorage.getItem('turnos_servicios') || '[]'); }
            cargarReservas() { return JSON.parse(localStorage.getItem('reservas_servicios') || '[]'); }
            cargarSanciones() { return JSON.parse(localStorage.getItem('sanciones_servicios') || '[]'); }
            cargarConfiguracion() { return JSON.parse(localStorage.getItem('configuracion_calendarios') || '{}'); }
            guardarTurnos() { localStorage.setItem('turnos_servicios', JSON.stringify(this.turnos)); }
            guardarReservas() { localStorage.setItem('reservas_servicios', JSON.stringify(this.reservas)); }
            guardarSanciones() { localStorage.setItem('sanciones_servicios', JSON.stringify(this.sanciones)); }
            guardarConfiguracion() { localStorage.setItem('configuracion_calendarios', JSON.stringify(this.configuracion)); }
            
            inicializar() {
                console.log(' Sistema de Calendarios inicializado');
                this.inicializarConfiguracionDefault();
            }
            
            inicializarConfiguracionDefault() {
                if (!this.configuracion.sanciones) {
                    this.configuracion.sanciones = {
                        cancelacionTardia: { activa: true, tiempoMinimo: 2, porcentaje: 20 },
                        noShow: { activa: true, porcentaje: 50 },
                        cancelacionReiterada: { activa: true, maxCancelaciones: 3, diasSuspension: 7 }
                    };
                    this.guardarConfiguracion();
                }
            }
            
            obtenerEstadisticas() {
                return {
                    turnosDisponibles: this.turnos.filter(t => t.estado === 'disponible').length,
                    reservasCompletadas: this.reservas.filter(r => r.estado === 'completada').length,
                    reservasCanceladas: this.reservas.filter(r => r.estado === 'cancelada').length,
                    sancionesActivas: this.sanciones.filter(s => s.estado === 'activa').length
                };
            }
        }
        
        let sistemaCalendariosServicios = new SistemaCalendariosServicios();
        
        function abrirGestionCalendariosServicios() {
            console.log(' Abriendo calendarios...');
            const modal = document.createElement('div');
            modal.id = 'modalCalendariosServicios';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            const stats = sistemaCalendariosServicios.obtenerEstadisticas();
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #EC4899, #BE185D); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarCalendariosServicios()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;"></div>
                        <h2 style="margin: 0;">Sistema de Calendarios</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Gesti贸n de turnos, reservas y sanciones</p>
                    </div>
                    <div style="padding: 32px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #F0FDF4; padding: 20px; border-radius: 12px; border: 1px solid #BBF7D0; text-align: center;">
                                <div style="font-size: 2rem; color: #059669; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #059669; font-size: 1.5rem;">${stats.turnosDisponibles}</h3>
                                <p style="margin: 0; color: #059669; font-size: 0.9rem;">Turnos Disponibles</p>
                            </div>
                            <div style="background: #F0F9FF; padding: 20px; border-radius: 12px; border: 1px solid #BAE6FD; text-align: center;">
                                <div style="font-size: 2rem; color: #0369A1; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #0369A1; font-size: 1.5rem;">${stats.reservasCompletadas}</h3>
                                <p style="margin: 0; color: #0369A1; font-size: 0.9rem;">Completadas</p>
                            </div>
                            <div style="background: #FEF2F2; padding: 20px; border-radius: 12px; border: 1px solid #FECACA; text-align: center;">
                                <div style="font-size: 2rem; color: #DC2626; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #DC2626; font-size: 1.5rem;">${stats.reservasCanceladas}</h3>
                                <p style="margin: 0; color: #DC2626; font-size: 0.9rem;">Cancelaciones</p>
                            </div>
                            <div style="background: #FEF3C7; padding: 20px; border-radius: 12px; border: 1px solid #FDE68A; text-align: center;">
                                <div style="font-size: 2rem; color: #D97706; margin-bottom: 8px;">锔</div>
                                <h3 style="margin: 0; color: #D97706; font-size: 1.5rem;">${stats.sancionesActivas}</h3>
                                <p style="margin: 0; color: #D97706; font-size: 0.9rem;">Sanciones</p>
                            </div>
                        </div>
                        <div style="text-align: center; padding: 40px; background: #F8FAFC; border-radius: 12px;">
                            <div style="font-size: 3rem; margin-bottom: 16px;"></div>
                            <h3 style="color: #374151; margin: 0 0 10px;">Sistema de Calendarios Activo</h3>
                            <p style="color: #6B7280; margin: 0;">Gestiona turnos, reservas y sanciones de servicios</p>
                        </div>
                        <div style="display: flex; justify-content: center; margin-top: 30px;">
                            <button onclick="cerrarCalendariosServicios()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function cerrarCalendariosServicios() {
            const modal = document.getElementById('modalCalendariosServicios');
            if (modal) modal.remove();
        }
        
        // ============================================
        // GESTIN DE TURNOS
        // ============================================
        
        function abrirSistemaTurnos() {
            // Cargar FullCalendar.js si no est谩 cargado
            if (!window.FullCalendar) {
                const link = document.createElement('link');
                link.href = 'https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css';
                link.rel = 'stylesheet';
                document.head.appendChild(link);
                
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js';
                script.onload = () => {
                    mostrarModalTurnos();
                };
                document.head.appendChild(script);
            } else {
                mostrarModalTurnos();
            }
        }
        
        function mostrarModalTurnos() {
            const modal = document.createElement('div');
            modal.id = 'modalTurnos';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            
            const turnos = JSON.parse(localStorage.getItem('turnos_reservados') || '[]');
            const servicios = sistemaServicios.cargarServicios();
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <div>
                            <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                            <h3 style="margin: 0; color: #1e293b;">Sistema de Turnos</h3>
                            <p style="margin: 5px 0 0; color: #6B7280;">Gestiona las citas de tus clientes</p>
                        </div>
                        <button onclick="cerrarModalTurnos()" style="background: #6B7280; color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 18px; width: 40px; height: 40px;"></button>
                    </div>
                    
                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <button onclick="mostrarVistaTurnos('calendario')" id="btnVistaCalendario" style="background: #8B5CF6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Calendario</button>
                        <button onclick="mostrarVistaTurnos('lista')" id="btnVistaLista" style="background: #E5E7EB; color: #374151; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Lista</button>
                        <button onclick="mostrarFormularioNuevoTurno()" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-left: auto;"> Nuevo Turno</button>
                                </div>
                    
                    <!-- Vista Calendario -->
                    <div id="vistaCalendarioTurnos" style="display: block;">
                        <div id="calendarioTurnos" style="background: white; border-radius: 12px; padding: 20px; min-height: 500px;"></div>
                    </div>
                    
                    <!-- Vista Lista -->
                    <div id="vistaListaTurnos" style="display: none;">
                        <div id="listaTurnos" style="display: grid; gap: 15px;">
                            ${turnos.length === 0 ? '<div style="text-align: center; padding: 40px; background: #F8FAFC; border-radius: 12px; color: #6B7280;"><div style="font-size: 3rem; margin-bottom: 15px;"></div><p>No hay turnos programados</p></div>' : turnos.map(turno => `
                                <div style="background: #F8FAFC; border: 1px solid #E5E7EB; border-radius: 8px; padding: 20px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                        <div>
                                            <h5 style="margin: 0 0 5px; color: #1F2937;">${turno.servicio || 'Turno'}</h5>
                                            <p style="margin: 0; color: #6B7280; font-size: 0.9rem;">
                                                 ${turno.fecha ? new Date(turno.fecha).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A'}
                                            </p>
                                            <p style="margin: 5px 0 0; color: #6B7280; font-size: 0.9rem;"> ${turno.hora || 'N/A'}</p>
                                        </div>
                                        <span style="background: ${turno.estado === 'confirmado' ? '#D1FAE5' : turno.estado === 'completado' ? '#DBEAFE' : turno.estado === 'cancelado' ? '#FEE2E2' : '#FEF3C7'}; color: ${turno.estado === 'confirmado' ? '#065F46' : turno.estado === 'completado' ? '#1E40AF' : turno.estado === 'cancelado' ? '#991B1B' : '#92400E'}; padding: 4px 12px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; text-transform: capitalize;">${turno.estado || 'Pendiente'}</span>
                                    </div>
                                    ${turno.cliente ? `<p style="margin: 5px 0; color: #6B7280; font-size: 0.9rem;"> Cliente: ${turno.cliente}</p>` : ''}
                                    ${turno.clienteEmail ? `<p style="margin: 5px 0; color: #6B7280; font-size: 0.9rem;"> ${turno.clienteEmail}</p>` : ''}
                                    ${turno.clienteTelefono ? `<p style="margin: 5px 0; color: #6B7280; font-size: 0.9rem;"> ${turno.clienteTelefono}</p>` : ''}
                                    ${turno.notas ? `<p style="margin: 5px 0; color: #6B7280; font-size: 0.9rem;"> ${turno.notas}</p>` : ''}
                                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                                        <button onclick="editarTurno(${turno.id})" style="background: #3B82F6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">锔 Editar</button>
                                        <button onclick="cambiarEstadoTurno(${turno.id}, 'completado')" style="background: #10B981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;"> Completar</button>
                                        <button onclick="cambiarEstadoTurno(${turno.id}, 'cancelado')" style="background: #EF4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;"> Cancelar</button>
                                    </div>
                            </div>
                        `).join('')}
                    </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Inicializar calendario
            if (window.FullCalendar) {
                inicializarCalendarioTurnos(turnos);
            }
        }
        
        function inicializarCalendarioTurnos(turnos) {
            const calendarEl = document.getElementById('calendarioTurnos');
            if (!calendarEl) return;
            
            // Convertir turnos a formato de FullCalendar
            const events = turnos.map(turno => {
                const fecha = turno.fecha ? new Date(turno.fecha) : new Date();
                const hora = turno.hora ? turno.hora.split(':') : [9, 0];
                fecha.setHours(parseInt(hora[0]), parseInt(hora[1]), 0);
                
                return {
                    id: turno.id,
                    title: `${turno.servicio || 'Turno'} - ${turno.cliente || 'Sin cliente'}`,
                    start: fecha.toISOString(),
                    backgroundColor: turno.estado === 'confirmado' ? '#10B981' : turno.estado === 'completado' ? '#3B82F6' : turno.estado === 'cancelado' ? '#EF4444' : '#F59E0B',
                    borderColor: turno.estado === 'confirmado' ? '#059669' : turno.estado === 'completado' ? '#2563EB' : turno.estado === 'cancelado' ? '#DC2626' : '#D97706',
                    extendedProps: turno
                };
            });
            
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: events,
                editable: true,
                selectable: true,
                selectMirror: true,
                dayMaxEvents: true,
                select: function(arg) {
                    mostrarFormularioNuevoTurno(arg.startStr);
                    calendar.unselect();
                },
                eventClick: function(arg) {
                    mostrarDetallesTurno(arg.event.extendedProps);
                },
                eventDrop: function(arg) {
                    actualizarFechaTurno(arg.event.id, arg.event.start);
                }
            });
            
            calendar.render();
            window.calendarioTurnosInstance = calendar;
        }
        
        function mostrarVistaTurnos(vista) {
            const vistaCalendario = document.getElementById('vistaCalendarioTurnos');
            const vistaLista = document.getElementById('vistaListaTurnos');
            const btnCalendario = document.getElementById('btnVistaCalendario');
            const btnLista = document.getElementById('btnVistaLista');
            
            if (vista === 'calendario') {
                vistaCalendario.style.display = 'block';
                vistaLista.style.display = 'none';
                btnCalendario.style.background = '#8B5CF6';
                btnCalendario.style.color = 'white';
                btnLista.style.background = '#E5E7EB';
                btnLista.style.color = '#374151';
            } else {
                vistaCalendario.style.display = 'none';
                vistaLista.style.display = 'block';
                btnCalendario.style.background = '#E5E7EB';
                btnCalendario.style.color = '#374151';
                btnLista.style.background = '#8B5CF6';
                btnLista.style.color = 'white';
            }
        }
        
        function mostrarFormularioNuevoTurno(fechaSeleccionada) {
            const servicios = sistemaServicios.cargarServicios();
            const modal = document.createElement('div');
            modal.id = 'modalNuevoTurno';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000000;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h3 style="margin: 0; color: #1e293b;"> Nuevo Turno</h3>
                        <button onclick="cerrarModalNuevoTurno()" style="background: #6B7280; color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 18px; width: 40px; height: 40px;"></button>
                    </div>
                    <form id="formNuevoTurno" onsubmit="guardarNuevoTurno(event); return false;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Servicio</label>
                            <select id="servicioTurno" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;">
                                <option value="">Seleccionar servicio...</option>
                                ${servicios.map(s => `<option value="${s.nombre}">${s.nombre} - $${s.precio}</option>`).join('')}
                            </select>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Cliente</label>
                            <input type="text" id="clienteTurno" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;" placeholder="Nombre del cliente">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Email</label>
                            <input type="email" id="emailTurno" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;" placeholder="email@ejemplo.com">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Tel茅fono</label>
                            <input type="tel" id="telefonoTurno" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;" placeholder="+54 9 11 1234-5678">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Fecha</label>
                                <input type="date" id="fechaTurno" required value="${fechaSeleccionada ? fechaSeleccionada.split('T')[0] : ''}" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Hora</label>
                                <input type="time" id="horaTurno" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;">
                            </div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Notas</label>
                            <textarea id="notasTurno" rows="3" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px;" placeholder="Notas adicionales..."></textarea>
                    </div>
                    <div style="display: flex; gap: 16px; justify-content: center;">
                            <button type="submit" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Guardar</button>
                            <button type="button" onclick="cerrarModalNuevoTurno()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer;">Cancelar</button>
                    </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function guardarNuevoTurno(event) {
            event.preventDefault();
            const turnos = JSON.parse(localStorage.getItem('turnos_reservados') || '[]');
            const nuevoTurno = {
                id: Date.now(),
                servicio: document.getElementById('servicioTurno').value,
                cliente: document.getElementById('clienteTurno').value,
                clienteEmail: document.getElementById('emailTurno').value,
                clienteTelefono: document.getElementById('telefonoTurno').value,
                fecha: document.getElementById('fechaTurno').value,
                hora: document.getElementById('horaTurno').value,
                notas: document.getElementById('notasTurno').value,
                estado: 'confirmado',
                fechaCreacion: new Date().toISOString()
            };
            turnos.push(nuevoTurno);
            localStorage.setItem('turnos_reservados', JSON.stringify(turnos));
            mostrarNotificacion(' Turno creado exitosamente', 'success');
            cerrarModalNuevoTurno();
            cerrarModalTurnos();
            setTimeout(() => abrirSistemaTurnos(), 500);
        }
        
        function cerrarModalNuevoTurno() {
            const modal = document.getElementById('modalNuevoTurno');
            if (modal) modal.remove();
        }
        
        function cambiarEstadoTurno(id, nuevoEstado) {
            const turnos = JSON.parse(localStorage.getItem('turnos_reservados') || '[]');
            const turno = turnos.find(t => t.id === id);
            if (turno) {
                turno.estado = nuevoEstado;
                localStorage.setItem('turnos_reservados', JSON.stringify(turnos));
                mostrarNotificacion(` Turno ${nuevoEstado}`, 'success');
                cerrarModalTurnos();
                setTimeout(() => abrirSistemaTurnos(), 500);
            }
        }
        
        function editarTurno(id) {
            const turnos = JSON.parse(localStorage.getItem('turnos_reservados') || '[]');
            const turno = turnos.find(t => t.id === id);
            if (turno) {
                mostrarFormularioNuevoTurno();
                // Pre-llenar formulario
                setTimeout(() => {
                    document.getElementById('servicioTurno').value = turno.servicio || '';
                    document.getElementById('clienteTurno').value = turno.cliente || '';
                    document.getElementById('emailTurno').value = turno.clienteEmail || '';
                    document.getElementById('telefonoTurno').value = turno.clienteTelefono || '';
                    document.getElementById('fechaTurno').value = turno.fecha || '';
                    document.getElementById('horaTurno').value = turno.hora || '';
                    document.getElementById('notasTurno').value = turno.notas || '';
                    
                    // Cambiar submit para editar
                    document.getElementById('formNuevoTurno').onsubmit = (e) => {
                        e.preventDefault();
                        turno.servicio = document.getElementById('servicioTurno').value;
                        turno.cliente = document.getElementById('clienteTurno').value;
                        turno.clienteEmail = document.getElementById('emailTurno').value;
                        turno.clienteTelefono = document.getElementById('telefonoTurno').value;
                        turno.fecha = document.getElementById('fechaTurno').value;
                        turno.hora = document.getElementById('horaTurno').value;
                        turno.notas = document.getElementById('notasTurno').value;
                        localStorage.setItem('turnos_reservados', JSON.stringify(turnos));
                        mostrarNotificacion(' Turno actualizado', 'success');
                        cerrarModalNuevoTurno();
                        cerrarModalTurnos();
                        setTimeout(() => abrirSistemaTurnos(), 500);
                    };
                }, 100);
            }
        }
        
        function mostrarDetallesTurno(turno) {
            alert(`Turno: ${turno.servicio}\nCliente: ${turno.cliente}\nFecha: ${turno.fecha} ${turno.hora}\nEstado: ${turno.estado}`);
        }
        
        function actualizarFechaTurno(id, nuevaFecha) {
            const turnos = JSON.parse(localStorage.getItem('turnos_reservados') || '[]');
            const turno = turnos.find(t => t.id === id);
            if (turno) {
                turno.fecha = nuevaFecha.toISOString().split('T')[0];
                localStorage.setItem('turnos_reservados', JSON.stringify(turnos));
                mostrarNotificacion(' Fecha actualizada', 'success');
            }
        }

        function guardarTurno() {
            const form = document.getElementById('formTurnos');
            if (!form) return;
            const formData = new FormData(form);
            const turno = Object.fromEntries(formData);
            const existentes = JSON.parse(localStorage.getItem('turnos_guardados') || '[]');
            existentes.push({ ...turno, id: Date.now() });
            localStorage.setItem('turnos_guardados', JSON.stringify(existentes));
            mostrarNotificacion(' Turno guardado', 'success');
            cerrarModal('modalTurnos');
        }
        
        function agregarTurno() {
            mostrarFormularioNuevoTurno();
        }
        
        function cerrarModalTurnos() {
            const modal = document.getElementById('modalTurnos');
            if (modal) modal.remove();
            if (window.calendarioTurnosInstance) {
                window.calendarioTurnosInstance.destroy();
                window.calendarioTurnosInstance = null;
            }
        }
        
        // ============================================
        // SISTEMA DE ANALYTICS
        // ============================================
        
        function animarNumero(elementId, valorFinal) {
            const elemento = document.getElementById(elementId);
            if (!elemento) return;
            
            const valorInicial = 0;
            const duracion = 2000;
            const incremento = valorFinal / (duracion / 16);
            let valorActual = valorInicial;
            
            const animacion = setInterval(() => {
                valorActual += incremento;
                if (valorActual >= valorFinal) {
                    valorActual = valorFinal;
                    clearInterval(animacion);
                }
                
                if (elementId === 'metricIngresos') {
                    elemento.textContent = `$${Math.floor(valorActual).toLocaleString()}`;
                } else {
                    elemento.textContent = Math.floor(valorActual).toLocaleString();
                }
            }, 16);
        }
        
        // ============================================
        // FUNCIONES PARA ABRIR SISTEMAS
        // ============================================
        
        // ============================================
        // SISTEMA COMPLETO DE PRODUCTOS
        // ============================================
        
        class SistemaProductos {
            constructor() {
                this.productos = this.cargarProductos();
            }
            
            cargarProductos() {
                return JSON.parse(localStorage.getItem('productos_tienda') || '[]');
            }
            
            guardarProductos() {
                localStorage.setItem('productos_tienda', JSON.stringify(this.productos));
            }
            
            agregarProducto(producto) {
                const nuevoProducto = {
                    id: Date.now().toString(),
                    nombre: producto.nombre,
                    precio: parseFloat(producto.precio),
                    categoria: producto.categoria,
                    descripcion: producto.descripcion || '',
                    stock: parseInt(producto.stock) || 0,
                    imagen: producto.imagen || '',
                    descuento: parseFloat(producto.descuento) || 0,
                    enOferta: producto.enOferta || false,
                    fecha: new Date().toISOString()
                };
                
                this.productos.unshift(nuevoProducto);
                this.guardarProductos();
                return nuevoProducto;
            }
            
            editarProducto(id, datosActualizados) {
                const index = this.productos.findIndex(p => p.id === id);
                if (index !== -1) {
                    this.productos[index] = {
                        ...this.productos[index],
                        ...datosActualizados,
                        precio: parseFloat(datosActualizados.precio),
                        stock: parseInt(datosActualizados.stock),
                        descuento: parseFloat(datosActualizados.descuento) || 0
                    };
                    this.guardarProductos();
                }
            }
            
            eliminarProducto(id) {
                this.productos = this.productos.filter(p => p.id !== id);
                this.guardarProductos();
            }
            
            obtenerProducto(id) {
                return this.productos.find(p => p.id === id);
            }
        }
        
        // Instancia global de Productos
        let sistemaProductos = new SistemaProductos();
        
        // ============================================
        // SISTEMA COMPLETO DE SERVICIOS
        // ============================================
        
        class SistemaServicios {
            constructor() {
                this.servicios = this.cargarServicios();
                this.combos = this.cargarCombos();
            }
            
            cargarServicios() {
                return JSON.parse(localStorage.getItem('servicios_tienda') || '[]');
            }
            
            cargarCombos() {
                return JSON.parse(localStorage.getItem('combos_tienda') || '[]');
            }
            
            guardarServicios() {
                localStorage.setItem('servicios_tienda', JSON.stringify(this.servicios));
            }
            
            guardarCombos() {
                localStorage.setItem('combos_tienda', JSON.stringify(this.combos));
            }
            
            agregarServicio(servicio) {
                const nuevoServicio = {
                    id: Date.now().toString(),
                    nombre: servicio.nombre,
                    precio: parseFloat(servicio.precio),
                    precioPorHora: parseFloat(servicio.precioPorHora) || 0,
                    categoria: servicio.categoria,
                    descripcion: servicio.descripcion || '',
                    duracion: parseInt(servicio.duracion) || 60,
                    descuento: parseFloat(servicio.descuento) || 0,
                    enOferta: servicio.enOferta || false,
                    fecha: new Date().toISOString()
                };
                
                this.servicios.unshift(nuevoServicio);
                this.guardarServicios();
                return nuevoServicio;
            }
            
            editarServicio(id, datosActualizados) {
                const index = this.servicios.findIndex(s => s.id === id);
                if (index !== -1) {
                    this.servicios[index] = {
                        ...this.servicios[index],
                        ...datosActualizados,
                        precio: parseFloat(datosActualizados.precio),
                        precioPorHora: parseFloat(datosActualizados.precioPorHora) || 0,
                        duracion: parseInt(datosActualizados.duracion),
                        descuento: parseFloat(datosActualizados.descuento) || 0
                    };
                    this.guardarServicios();
                }
            }
            
            eliminarServicio(id) {
                this.servicios = this.servicios.filter(s => s.id !== id);
                this.guardarServicios();
            }
            
            obtenerServicio(id) {
                return this.servicios.find(s => s.id === id);
            }
            
            agregarCombo(combo) {
                const nuevoCombo = {
                    id: Date.now().toString(),
                    nombre: combo.nombre,
                    descripcion: combo.descripcion,
                    serviciosIncluidos: combo.serviciosIncluidos || [],
                    precioOriginal: parseFloat(combo.precioOriginal),
                    precioCombo: parseFloat(combo.precioCombo),
                    descuento: parseFloat(combo.descuento),
                    fecha: new Date().toISOString()
                };
                
                this.combos.unshift(nuevoCombo);
                this.guardarCombos();
                return nuevoCombo;
            }
            
            eliminarCombo(id) {
                this.combos = this.combos.filter(c => c.id !== id);
                this.guardarCombos();
            }
        }
        
        // Instancia global de Servicios
        let sistemaServicios = new SistemaServicios();
        
        // Funci贸n para abrir gesti贸n de productos
        function abrirGestionProductos() {
            mostrarFormularioProducto();
        }
        
        // Funci贸n para abrir gesti贸n de servicios
        function abrirGestionServicios() {
            mostrarFormularioServicio();
        }
        
        // Funci贸n COMPLETA para mostrar formulario de productos
        function mostrarFormularioProducto(productoId = null) {
            console.log(' Abriendo gesti贸n de productos...');
            
            // Cerrar modal anterior si existe
            const modalAnterior = document.getElementById('modalGestionProductos');
            if (modalAnterior) modalAnterior.remove();
            
            const productoEditar = productoId ? sistemaProductos.obtenerProducto(productoId) : null;
            const esEdicion = productoEditar !== null;
            
            const modal = document.createElement('div');
            modal.id = 'modalGestionProductos';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 999999; overflow-y: auto; padding: 20px;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 1200px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #EC4899, #F9A8D4); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarModalGestionProductos()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;"></div>
                        <h2 style="margin: 0;">${esEdicion ? 'Editar Producto' : 'Gesti贸n de Productos'}</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Administra tu cat谩logo completo</p>
                    </div>
                    
                    <div style="padding: 32px;">
                        <!-- Formulario de Producto -->
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                            <h3 style="margin: 0 0 20px; color: #374151;">${esEdicion ? '锔 Editar Producto' : ' Agregar Nuevo Producto'}</h3>
                            
                            <form id="formProducto" onsubmit="guardarProductoCompleto(event, ${esEdicion ? `'${productoId}'` : 'null'})">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Nombre del Producto *</label>
                                        <input type="text" id="nombreProducto" required placeholder="Ej: Remera deportiva" 
                                               value="${esEdicion ? productoEditar.nombre : ''}"
                                               style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Categor铆a *</label>
                                        <select id="categoriaProducto" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                            <option value="">Seleccionar categor铆a</option>
                                            <option value="ropa" ${esEdicion && productoEditar.categoria === 'ropa' ? 'selected' : ''}>Ropa</option>
                                            <option value="calzado" ${esEdicion && productoEditar.categoria === 'calzado' ? 'selected' : ''}>Calzado</option>
                                            <option value="accesorios" ${esEdicion && productoEditar.categoria === 'accesorios' ? 'selected' : ''}>Accesorios</option>
                                            <option value="tecnologia" ${esEdicion && productoEditar.categoria === 'tecnologia' ? 'selected' : ''}>Tecnolog铆a</option>
                                            <option value="hogar" ${esEdicion && productoEditar.categoria === 'hogar' ? 'selected' : ''}>Hogar</option>
                                            <option value="alimentos" ${esEdicion && productoEditar.categoria === 'alimentos' ? 'selected' : ''}>Alimentos</option>
                                            <option value="otros" ${esEdicion && productoEditar.categoria === 'otros' ? 'selected' : ''}>Otros</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Precio *</label>
                                        <input type="number" id="precioProducto" required placeholder="0.00" step="0.01" min="0"
                                               value="${esEdicion ? productoEditar.precio : ''}"
                                               style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Stock</label>
                                        <input type="number" id="stockProducto" placeholder="0" min="0"
                                               value="${esEdicion ? productoEditar.stock : ''}"
                                               style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Descuento (%)</label>
                                        <input type="number" id="descuentoProducto" placeholder="0" min="0" max="100" step="0.1"
                                               value="${esEdicion ? productoEditar.descuento : ''}"
                                               style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Descripci贸n</label>
                                    <textarea id="descripcionProducto" rows="3" placeholder="Describe tu producto..."
                                              style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem; resize: vertical;">${esEdicion ? productoEditar.descripcion : ''}</textarea>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Imagen del Producto</label>
                                    <input type="file" id="imagenProducto" accept="image/*" onchange="previewImagenProducto(event)" 
                                           style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                    <div id="previewImagenProducto" style="margin-top: 12px; ${esEdicion && productoEditar.imagen ? 'display: block;' : 'display: none;'}">
                                        <img id="imgPreviewProducto" src="${esEdicion && productoEditar.imagen ? productoEditar.imagen : ''}" 
                                             style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #E5E7EB;" 
                                             alt="Vista previa">
                                        <button type="button" onclick="eliminarImagenProducto()" 
                                                style="margin-top: 8px; padding: 6px 12px; background: #EF4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                                            <i class="fas fa-trash"></i> Eliminar imagen
                                        </button>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <label style="display: flex; align-items: center; gap: 8px; color: #374151; cursor: pointer;">
                                        <input type="checkbox" id="enOfertaProducto" ${esEdicion && productoEditar.enOferta ? 'checked' : ''}>
                                        <span style="font-weight: 600;"> Marcar como producto en oferta</span>
                                    </label>
                                </div>
                                
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="cerrarModalGestionProductos()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        Cancelar
                                    </button>
                                    <button type="submit" style="background: linear-gradient(135deg, #EC4899, #F9A8D4); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        <i class="fas fa-save"></i> ${esEdicion ? 'Actualizar Producto' : 'Guardar Producto'}
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        ${!esEdicion ? `
                        <!-- Lista de Productos -->
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB;">
                            <h3 style="margin: 0 0 20px; color: #374151;"> Productos Registrados (${sistemaProductos.productos.length})</h3>
                            
                            <div id="listaProductos" style="display: grid; gap: 15px; max-height: 400px; overflow-y: auto;">
                                ${sistemaProductos.productos.length > 0 ? 
                                    sistemaProductos.productos.map(producto => `
                                        <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; display: grid; grid-template-columns: auto 1fr auto; gap: 20px; align-items: center;">
                                            ${producto.imagen ? `
                                                <div style="width: 80px; height: 80px; border-radius: 8px; overflow: hidden; border: 2px solid #E5E7EB; flex-shrink: 0;">
                                                    <img src="${producto.imagen}" alt="${producto.nombre}" style="width: 100%; height: 100%; object-fit: cover;">
                                                </div>
                                            ` : `
                                                <div style="width: 80px; height: 80px; border-radius: 8px; background: #F3F4F6; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                                    <i class="fas fa-image" style="font-size: 2rem; color: #9CA3AF;"></i>
                                                </div>
                                            `}
                                            <div>
                                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                                    <h4 style="margin: 0; color: #374151; font-size: 1.1rem;">${producto.nombre}</h4>
                                                    ${producto.enOferta ? '<span style="background: #EF4444; color: white; padding: 2px 8px; border-radius: 6px; font-size: 0.75rem;"> OFERTA</span>' : ''}
                                                </div>
                                                <p style="margin: 0 0 8px; color: #6B7280; font-size: 0.9rem;">${producto.categoria}  Stock: ${producto.stock}</p>
                                                <div style="display: flex; align-items: center; gap: 15px;">
                                                    <span style="font-weight: 700; color: #EC4899; font-size: 1.2rem;">$${producto.precio.toFixed(2)}</span>
                                                    ${producto.descuento > 0 ? `<span style="background: #FEF3C7; color: #92400E; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">-${producto.descuento}% OFF</span>` : ''}
                                                </div>
                                            </div>
                                            <div style="display: flex; gap: 8px;">
                                                <button onclick="mostrarFormularioProducto('${producto.id}')" style="background: #3B82F6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                                    <i class="fas fa-edit"></i> Editar
                                                </button>
                                                <button onclick="eliminarProductoCompleto('${producto.id}')" style="background: #DC2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    `).join('') : 
                                    '<div style="text-align: center; padding: 40px; color: #6B7280;"><i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 15px;"></i><p>No hay productos registrados a煤n</p></div>'
                                }
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Funci贸n para guardar producto completo
        function guardarProductoCompleto(event, productoId = null) {
            event.preventDefault();
            
            const imagenInput = document.getElementById('imagenProducto');
            const imgPreview = document.getElementById('imgPreviewProducto');
            
            // Funci贸n para procesar la imagen
            const procesarImagen = () => {
                return new Promise((resolve) => {
                    // Si hay una imagen nueva seleccionada
                    if (imagenInput && imagenInput.files && imagenInput.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            resolve(e.target.result); // Retorna base64
                        };
                        reader.onerror = () => resolve(null);
                        reader.readAsDataURL(imagenInput.files[0]);
                    } 
                    // Si hay una imagen existente en el preview
                    else if (imgPreview && imgPreview.src && imgPreview.src.startsWith('data:')) {
                        resolve(imgPreview.src);
                    } 
                    // Si estamos editando y el producto ya tiene imagen
                    else if (productoId) {
                        const productoExistente = sistemaProductos.obtenerProducto(productoId);
                        resolve(productoExistente?.imagen || null);
                    } 
                    else {
                        resolve(null);
                    }
                });
            };
            
            // Procesar imagen y luego guardar producto
            procesarImagen().then((imagenBase64) => {
                const producto = {
                    nombre: document.getElementById('nombreProducto').value,
                    precio: document.getElementById('precioProducto').value,
                    categoria: document.getElementById('categoriaProducto').value,
                    descripcion: document.getElementById('descripcionProducto').value,
                    stock: document.getElementById('stockProducto').value || 0,
                    descuento: document.getElementById('descuentoProducto').value || 0,
                    enOferta: document.getElementById('enOfertaProducto').checked,
                    imagen: imagenBase64 || null
                };
                
                if (productoId) {
                    // Editar producto existente
                    sistemaProductos.editarProducto(productoId, producto);
                    mostrarNotificacion(' Producto actualizado exitosamente', 'success');
                } else {
                    // Agregar nuevo producto
                    sistemaProductos.agregarProducto(producto);
                    mostrarNotificacion(' Producto agregado exitosamente', 'success');
                }
                
                // Cerrar modal - la lista se actualizar谩 cuando se abra nuevamente
                cerrarModalGestionProductos();
                if (!productoId) {
                    // Solo reabrir si es un producto nuevo (para agregar m谩s)
                    setTimeout(() => {
                        mostrarFormularioProducto();
                    }, 100);
                }
                // Si es edici贸n, solo cerrar (no reabrir)
            });
        }
        
        // Funci贸n para previsualizar imagen
        function previewImagenProducto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('previewImagenProducto');
                    const img = document.getElementById('imgPreviewProducto');
                    if (preview && img) {
                        img.src = e.target.result;
                        preview.style.display = 'block';
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Funci贸n para eliminar imagen
        function eliminarImagenProducto() {
            const imagenInput = document.getElementById('imagenProducto');
            const preview = document.getElementById('previewImagenProducto');
            const img = document.getElementById('imgPreviewProducto');
            
            if (imagenInput) imagenInput.value = '';
            if (img) img.src = '';
            if (preview) preview.style.display = 'none';
        }
        
        // Funci贸n para eliminar producto completo
        function eliminarProductoCompleto(productoId) {
            if (confirm('驴Est谩s seguro de que quieres eliminar este producto?')) {
                sistemaProductos.eliminarProducto(productoId);
                mostrarNotificacion(' Producto eliminado', 'success');
                cerrarModalGestionProductos();
                setTimeout(() => mostrarFormularioProducto(), 100);
            }
        }
        
        // Funci贸n para cerrar modal de gesti贸n de productos
        function cerrarModalGestionProductos() {
            const modal = document.getElementById('modalGestionProductos');
            if (modal) modal.remove();
        }
        
        // Funci贸n COMPLETA para mostrar formulario de servicios
        function mostrarFormularioServicio(servicioId = null) {
            console.log('锔 Abriendo gesti贸n de servicios...');
            
            // Cerrar modal anterior si existe
            const modalAnterior = document.getElementById('modalGestionServicios');
            if (modalAnterior) modalAnterior.remove();
            
            const servicioEditar = servicioId ? sistemaServicios.obtenerServicio(servicioId) : null;
            const esEdicion = servicioEditar !== null;
            
            const modal = document.createElement('div');
            modal.id = 'modalGestionServicios';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 999999; overflow-y: auto; padding: 20px;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 1400px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #8B5CF6, #A78BFA); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarModalGestionServicios()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;">锔</div>
                        <h2 style="margin: 0;">${esEdicion ? 'Editar Servicio' : 'Gesti贸n de Servicios'}</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Administra servicios, ofertas y combos</p>
                    </div>
                    
                    <div style="padding: 32px;">
                        <!-- Tabs -->
                        <div style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #E5E7EB;">
                            <button onclick="cambiarTabServicio('servicios')" id="tabServiciosBtn" style="padding: 12px 24px; border: none; background: linear-gradient(135deg, #8B5CF6, #A78BFA); color: white; cursor: pointer; font-weight: 600; border-radius: 8px 8px 0 0;">
                                Servicios
                            </button>
                            <button onclick="cambiarTabServicio('combos')" id="tabCombosBtn" style="padding: 12px 24px; border: none; background: #F3F4F6; color: #374151; cursor: pointer; font-weight: 600; border-radius: 8px 8px 0 0;">
                                Combos
                            </button>
                        </div>
                        
                        <!-- Tab de Servicios -->
                        <div id="tabServicios">
                            <!-- Formulario de Servicio -->
                            <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                                <h3 style="margin: 0 0 20px; color: #374151;">${esEdicion ? '锔 Editar Servicio' : ' Agregar Nuevo Servicio'}</h3>
                                
                                <form id="formServicio" onsubmit="guardarServicioCompleto(event, ${esEdicion ? `'${servicioId}'` : 'null'})">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Nombre del Servicio *</label>
                                            <input type="text" id="nombreServicio" required placeholder="Ej: Consultor铆a empresarial" 
                                                   value="${esEdicion ? servicioEditar.nombre : ''}"
                                                   style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                        </div>
                                        
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Categor铆a *</label>
                                            <select id="categoriaServicio" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                                <option value="">Seleccionar categor铆a</option>
                                                <option value="consultoria" ${esEdicion && servicioEditar.categoria === 'consultoria' ? 'selected' : ''}>Consultor铆a</option>
                                                <option value="mantenimiento" ${esEdicion && servicioEditar.categoria === 'mantenimiento' ? 'selected' : ''}>Mantenimiento</option>
                                                <option value="reparacion" ${esEdicion && servicioEditar.categoria === 'reparacion' ? 'selected' : ''}>Reparaci贸n</option>
                                                <option value="diseno" ${esEdicion && servicioEditar.categoria === 'diseno' ? 'selected' : ''}>Dise帽o</option>
                                                <option value="desarrollo" ${esEdicion && servicioEditar.categoria === 'desarrollo' ? 'selected' : ''}>Desarrollo</option>
                                                <option value="limpieza" ${esEdicion && servicioEditar.categoria === 'limpieza' ? 'selected' : ''}>Limpieza</option>
                                                <option value="transporte" ${esEdicion && servicioEditar.categoria === 'transporte' ? 'selected' : ''}>Transporte</option>
                                                <option value="educacion" ${esEdicion && servicioEditar.categoria === 'educacion' ? 'selected' : ''}>Educaci贸n</option>
                                                <option value="otros" ${esEdicion && servicioEditar.categoria === 'otros' ? 'selected' : ''}>Otros</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Precio Base *</label>
                                            <input type="number" id="precioServicio" required placeholder="0.00" step="0.01" min="0"
                                                   value="${esEdicion ? servicioEditar.precio : ''}"
                                                   style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                        </div>
                                        
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;"> Precio x Hora</label>
                                            <input type="number" id="precioPorHoraServicio" placeholder="0.00" step="0.01" min="0"
                                                   value="${esEdicion ? servicioEditar.precioPorHora : ''}"
                                                   style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                        </div>
                                        
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Duraci贸n (min)</label>
                                            <input type="number" id="duracionServicio" placeholder="60" min="15" step="15"
                                                   value="${esEdicion ? servicioEditar.duracion : ''}"
                                                   style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                        </div>
                                        
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Descuento (%)</label>
                                            <input type="number" id="descuentoServicio" placeholder="0" min="0" max="100" step="0.1"
                                                   value="${esEdicion ? servicioEditar.descuento : ''}"
                                                   style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Descripci贸n</label>
                                        <textarea id="descripcionServicio" rows="3" placeholder="Describe tu servicio..."
                                                  style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem; resize: vertical;">${esEdicion ? servicioEditar.descripcion : ''}</textarea>
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: flex; align-items: center; gap: 8px; color: #374151; cursor: pointer;">
                                            <input type="checkbox" id="enOfertaServicio" ${esEdicion && servicioEditar.enOferta ? 'checked' : ''}>
                                            <span style="font-weight: 600;"> Marcar como servicio en oferta</span>
                                        </label>
                                    </div>
                                    
                                    <div style="background: #FEF3C7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #F59E0B;">
                                        <p style="margin: 0; color: #92400E; font-size: 0.9rem;">
                                             <strong>Tip:</strong> Si defines "Precio por Hora", se calcular谩 autom谩ticamente seg煤n la duraci贸n. Si no, se usar谩 el "Precio Base".
                                        </p>
                                    </div>
                                    
                                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                        <button type="button" onclick="cerrarModalGestionServicios()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                            Cancelar
                                        </button>
                                        <button type="submit" style="background: linear-gradient(135deg, #8B5CF6, #A78BFA); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                            <i class="fas fa-save"></i> ${esEdicion ? 'Actualizar Servicio' : 'Guardar Servicio'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            ${!esEdicion ? `
                            <!-- Lista de Servicios -->
                            <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB;">
                                <h3 style="margin: 0 0 20px; color: #374151;"> Servicios Registrados (${sistemaServicios.servicios.length})</h3>
                                
                                <div id="listaServicios" style="display: grid; gap: 15px; max-height: 400px; overflow-y: auto;">
                                    ${sistemaServicios.servicios.length > 0 ? 
                                        sistemaServicios.servicios.map(servicio => `
                                            <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: center;">
                                                <div>
                                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                                        <h4 style="margin: 0; color: #374151; font-size: 1.1rem;">${servicio.nombre}</h4>
                                                        ${servicio.enOferta ? '<span style="background: #EF4444; color: white; padding: 2px 8px; border-radius: 6px; font-size: 0.75rem;"> OFERTA</span>' : ''}
                                                    </div>
                                                    <p style="margin: 0 0 8px; color: #6B7280; font-size: 0.9rem;">${servicio.categoria}  ${servicio.duracion} min</p>
                                                    <div style="display: flex; align-items: center; gap: 15px;">
                                                        <span style="font-weight: 700; color: #8B5CF6; font-size: 1.2rem;">$${servicio.precio.toFixed(2)}</span>
                                                        ${servicio.precioPorHora > 0 ? `<span style="background: #E0E7FF; color: #4338CA; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">$${servicio.precioPorHora}/hora</span>` : ''}
                                                        ${servicio.descuento > 0 ? `<span style="background: #FEF3C7; color: #92400E; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">-${servicio.descuento}% OFF</span>` : ''}
                                                    </div>
                                                </div>
                                                <div style="display: flex; gap: 8px;">
                                                    <button onclick="mostrarFormularioServicio('${servicio.id}')" style="background: #3B82F6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                                        <i class="fas fa-edit"></i> Editar
                                                    </button>
                                                    <button onclick="eliminarServicioCompleto('${servicio.id}')" style="background: #DC2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('') : 
                                        '<div style="text-align: center; padding: 40px; color: #6B7280;"><i class="fas fa-concierge-bell" style="font-size: 3rem; margin-bottom: 15px;"></i><p>No hay servicios registrados a煤n</p></div>'
                                    }
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <!-- Tab de Combos -->
                        <div id="tabCombos" style="display: none;">
                            <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                                <h3 style="margin: 0 0 20px; color: #374151;"> Crear Combo</h3>
                                
                                <form id="formCombo" onsubmit="guardarComboCompleto(event)">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Nombre del Combo *</label>
                                            <input type="text" id="nombreCombo" required placeholder="Ej: Pack Premium"
                                                   style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                        </div>
                                        
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Descuento del Combo (%) *</label>
                                            <input type="number" id="descuentoCombo" required placeholder="20" min="1" max="100" step="0.1"
                                                   style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                        </div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Precio Original *</label>
                                            <input type="number" id="precioOriginalCombo" required placeholder="0.00" step="0.01" min="0"
                                                   style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                        </div>
                                        
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Precio con Descuento *</label>
                                            <input type="number" id="precioComboFinal" required placeholder="0.00" step="0.01" min="0"
                                                   style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Descripci贸n del Combo</label>
                                        <textarea id="descripcionCombo" rows="3" placeholder="Describe qu茅 incluye el combo..."
                                                  style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                                    </div>
                                    
                                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                        <button type="submit" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                            <i class="fas fa-gift"></i> Crear Combo
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Lista de Combos -->
                            <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB;">
                                <h3 style="margin: 0 0 20px; color: #374151;"> Combos Creados (${sistemaServicios.combos.length})</h3>
                                
                                <div id="listaCombos" style="display: grid; gap: 15px; max-height: 400px; overflow-y: auto;">
                                    ${sistemaServicios.combos.length > 0 ? 
                                        sistemaServicios.combos.map(combo => `
                                            <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: center;">
                                                <div>
                                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                                        <h4 style="margin: 0; color: #374151; font-size: 1.1rem;"> ${combo.nombre}</h4>
                                                        <span style="background: #10B981; color: white; padding: 2px 8px; border-radius: 6px; font-size: 0.75rem;">-${combo.descuento}% COMBO</span>
                                                    </div>
                                                    <p style="margin: 0 0 8px; color: #6B7280; font-size: 0.9rem;">${combo.descripcion}</p>
                                                    <div style="display: flex; align-items: center; gap: 15px;">
                                                        <span style="font-weight: 700; color: #10B981; font-size: 1.2rem;">$${combo.precioCombo.toFixed(2)}</span>
                                                        <span style="text-decoration: line-through; color: #9CA3AF;">$${combo.precioOriginal.toFixed(2)}</span>
                                                        <span style="background: #D1FAE5; color: #166534; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">Ahorras $${(combo.precioOriginal - combo.precioCombo).toFixed(2)}</span>
                                                    </div>
                                                </div>
                                                <div style="display: flex; gap: 8px;">
                                                    <button onclick="eliminarComboCompleto('${combo.id}')" style="background: #DC2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('') : 
                                        '<div style="text-align: center; padding: 40px; color: #6B7280;"><i class="fas fa-gift" style="font-size: 3rem; margin-bottom: 15px;"></i><p>No hay combos creados a煤n</p></div>'
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Funci贸n para cambiar tabs de servicios
        function cambiarTabServicio(tab) {
            document.getElementById('tabServicios').style.display = tab === 'servicios' ? 'block' : 'none';
            document.getElementById('tabCombos').style.display = tab === 'combos' ? 'block' : 'none';
            
            document.getElementById('tabServiciosBtn').style.background = tab === 'servicios' ? 'linear-gradient(135deg, #8B5CF6, #A78BFA)' : '#F3F4F6';
            document.getElementById('tabServiciosBtn').style.color = tab === 'servicios' ? 'white' : '#374151';
            
            document.getElementById('tabCombosBtn').style.background = tab === 'combos' ? 'linear-gradient(135deg, #8B5CF6, #A78BFA)' : '#F3F4F6';
            document.getElementById('tabCombosBtn').style.color = tab === 'combos' ? 'white' : '#374151';
        }
        
        // Funci贸n para guardar servicio completo
        function guardarServicioCompleto(event, servicioId = null) {
            event.preventDefault();
            
            const servicio = {
                nombre: document.getElementById('nombreServicio').value,
                precio: document.getElementById('precioServicio').value,
                precioPorHora: document.getElementById('precioPorHoraServicio').value || 0,
                categoria: document.getElementById('categoriaServicio').value,
                descripcion: document.getElementById('descripcionServicio').value,
                duracion: document.getElementById('duracionServicio').value || 60,
                descuento: document.getElementById('descuentoServicio').value || 0,
                enOferta: document.getElementById('enOfertaServicio').checked
            };
            
            if (servicioId) {
                // Editar servicio existente
                sistemaServicios.editarServicio(servicioId, servicio);
                mostrarNotificacion(' Servicio actualizado exitosamente', 'success');
            } else {
                // Agregar nuevo servicio
                sistemaServicios.agregarServicio(servicio);
                mostrarNotificacion(' Servicio agregado exitosamente', 'success');
            }
            
            // Cerrar y reabrir modal para actualizar la lista
            cerrarModalGestionServicios();
            if (!servicioId) {
                setTimeout(() => mostrarFormularioServicio(), 100);
            }
        }
        
        // Funci贸n para eliminar servicio completo
        function eliminarServicioCompleto(servicioId) {
            if (confirm('驴Est谩s seguro de que quieres eliminar este servicio?')) {
                sistemaServicios.eliminarServicio(servicioId);
                mostrarNotificacion(' Servicio eliminado', 'success');
                cerrarModalGestionServicios();
                setTimeout(() => mostrarFormularioServicio(), 100);
            }
        }
        
        // Funci贸n para guardar combo completo
        function guardarComboCompleto(event) {
            event.preventDefault();
            
            const combo = {
                nombre: document.getElementById('nombreCombo').value,
                descripcion: document.getElementById('descripcionCombo').value,
                precioOriginal: document.getElementById('precioOriginalCombo').value,
                precioCombo: document.getElementById('precioComboFinal').value,
                descuento: document.getElementById('descuentoCombo').value
            };
            
            sistemaServicios.agregarCombo(combo);
            mostrarNotificacion(' Combo creado exitosamente', 'success');
            
            // Limpiar formulario
            document.getElementById('formCombo').reset();
            
            // Reabrir modal para actualizar lista
            cerrarModalGestionServicios();
            setTimeout(() => {
                mostrarFormularioServicio();
                cambiarTabServicio('combos');
            }, 100);
        }
        
        // Funci贸n para eliminar combo completo
        function eliminarComboCompleto(comboId) {
            if (confirm('驴Est谩s seguro de que quieres eliminar este combo?')) {
                sistemaServicios.eliminarCombo(comboId);
                mostrarNotificacion(' Combo eliminado', 'success');
                cerrarModalGestionServicios();
                setTimeout(() => {
                    mostrarFormularioServicio();
                    cambiarTabServicio('combos');
                }, 100);
            }
        }
        
        // Funci贸n para cerrar modal de gesti贸n de servicios
        function cerrarModalGestionServicios() {
            const modal = document.getElementById('modalGestionServicios');
            if (modal) modal.remove();
        }
        
        // Funci贸n para reservar turno
        function reservarTurno(hora) {
            const cliente = prompt(`驴Nombre del cliente para el turno de ${hora}?`);
            const servicio = prompt(`驴Qu茅 servicio necesita?`);
            
            if (cliente && servicio) {
                console.log(' Turno reservado:', hora, cliente, servicio);
                
                // Buscar el turno y actualizarlo
                const turnos = document.querySelectorAll('.turno-item');
                turnos.forEach(turno => {
                    if (turno.querySelector('.hora').textContent === hora) {
                        turno.querySelector('.estado').textContent = `${cliente} - ${servicio}`;
                        turno.querySelector('.estado').className = 'estado ocupado';
                        turno.querySelector('.estado').style.cssText = 'color: #EF4444; font-weight: 500;';
                        turno.querySelector('button').textContent = 'Cancelar';
                        turno.querySelector('button').className = 'btn-cancelar';
                        turno.querySelector('button').style.cssText = 'background: linear-gradient(135deg, #EF4444, #DC2626); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;';
                        turno.querySelector('button').setAttribute('onclick', `cancelarTurno('${hora}')`);
                    }
                });
                
                actualizarEstadisticasTurnos();
                mostrarNotificacion(` Turno reservado: ${hora} para ${cliente}`, 'success');
            }
        }
        
        // Funci贸n para cancelar turno
        function cancelarTurno(hora) {
            if (confirm(`驴Cancelar el turno de ${hora}?`)) {
                const turnos = document.querySelectorAll('.turno-item');
                turnos.forEach(turno => {
                    if (turno.querySelector('.hora').textContent === hora) {
                        turno.querySelector('.estado').textContent = 'Disponible';
                        turno.querySelector('.estado').className = 'estado disponible';
                        turno.querySelector('.estado').style.cssText = 'color: #10B981; font-weight: 500;';
                        turno.querySelector('button').textContent = 'Reservar';
                        turno.querySelector('button').className = 'btn-reservar';
                        turno.querySelector('button').style.cssText = 'background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;';
                        turno.querySelector('button').setAttribute('onclick', `reservarTurno('${hora}')`);
                    }
                });
                
                actualizarEstadisticasTurnos();
                mostrarNotificacion(` Turno ${hora} cancelado y disponible nuevamente`, 'success');
            }
        }
        
        // Funci贸n para actualizar estad铆sticas de turnos
        function actualizarEstadisticasTurnos() {
            const turnos = document.querySelectorAll('.turno-item');
            const totalTurnos = turnos.length;
            const turnosOcupados = document.querySelectorAll('.estado.ocupado').length;
            
            const totalEl = document.getElementById('totalTurnos');
            const ocupadosEl = document.getElementById('turnosOcupados');
            
            if (totalEl) totalEl.textContent = totalTurnos;
            if (ocupadosEl) ocupadosEl.textContent = turnosOcupados;
        }
        
        // Funci贸n para cerrar modal de turnos
        function cerrarModalTurnos() {
            const modal = document.getElementById('modalSistemaTurnos');
            if (modal) modal.remove();
        }
        
        // ============================================
        // SISTEMA DE ANALYTICS AVANZADO
        // ============================================
        
        class SistemaAnalytics {
            constructor() {
                this.datos = this.cargarDatos();
                this.mensajesAlentadores = this.obtenerMensajesAlentadores();
            }
            
            cargarDatos() {
                const datos = JSON.parse(localStorage.getItem('analytics_cresalia') || '{}');
                return {
                    visitas: datos.visitas || Math.floor(Math.random() * 1000) + 500,
                    ventas: datos.ventas || Math.floor(Math.random() * 50) + 10,
                    productos: datos.productos || 15,
                    servicios: datos.servicios || 8,
                    ingresos: datos.ingresos || Math.floor(Math.random() * 5000) + 1000,
                    tiempoPromedio: datos.tiempoPromedio || Math.floor(Math.random() * 300) + 120,
                    conversionRate: datos.conversionRate || Math.floor(Math.random() * 10) + 2,
                    ...datos
                };
            }
            
            obtenerMensajesAlentadores() {
                return {
                    visitas: [
                        "隆Incre铆ble! Tu tienda est谩 recibiendo mucha atenci贸n. Cada visita es una oportunidad de crecimiento.",
                        "Las visitas est谩n llegando constantemente. Tu esfuerzo en promoci贸n est谩 dando frutos.",
                        "Cada persona que visita tu tienda es un paso m谩s hacia el 茅xito. 隆Sigue as铆!",
                        "Tu tienda est谩 siendo descubierta por m谩s personas cada d铆a. 隆Excelente trabajo!"
                    ],
                    ventas: [
                        "隆Fant谩stico! Cada venta es una confirmaci贸n de que est谩s en el camino correcto.",
                        "Las ventas est谩n llegando. Tu dedicaci贸n y calidad se est谩n notando.",
                        "Cada venta representa la confianza que las personas tienen en ti. 隆Sigue construyendo esa confianza!",
                        "Tu negocio est谩 creciendo. Cada venta es un logro que merece celebraci贸n."
                    ],
                    productos: [
                        "Tu cat谩logo est谩 creciendo constantemente. Cada producto es una nueva oportunidad de 茅xito.",
                        "隆Excelente variedad! Ofreces opciones que satisfacen diferentes necesidades.",
                        "Tu dedicaci贸n a expandir tu oferta se nota. 隆Sigue agregando valor!",
                        "Cada producto que agregas es una nueva puerta hacia el 茅xito."
                    ],
                    ingresos: [
                        "隆Incre铆ble progreso! Tus ingresos reflejan el valor que aportas a tus clientes.",
                        "El crecimiento en ingresos muestra que tu estrategia est谩 funcionando perfectamente.",
                        "Cada peso que ganas es fruto de tu dedicaci贸n y esfuerzo. 隆Mereces este 茅xito!",
                        "Tu negocio est谩 generando resultados positivos. 隆Sigue construyendo sobre esta base!"
                    ]
                };
            }
            
            obtenerMensajeAlentador(categoria) {
                const mensajes = this.mensajesAlentadores[categoria] || ["隆Sigue adelante! Cada d铆a es una nueva oportunidad de crecimiento."];
                return mensajes[Math.floor(Math.random() * mensajes.length)];
            }
            
            guardarDatos() {
                localStorage.setItem('analytics_cresalia', JSON.stringify(this.datos));
            }
            
            actualizarMetrica(categoria, valor) {
                this.datos[categoria] = valor;
                this.guardarDatos();
            }
        }
        
        // Instancia global de Analytics
        let sistemaAnalytics = new SistemaAnalytics();
        
        // Funci贸n para abrir analytics avanzado
        function abrirAnalyticsAvanzado() {
            console.log(' Abriendo analytics avanzado...');
            
            // Cerrar modal anterior si existe
            const modalAnterior = document.getElementById('modalAnalyticsAvanzado');
            if (modalAnterior) modalAnterior.remove();
            
            const modal = document.createElement('div');
            modal.id = 'modalAnalyticsAvanzado';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #3B82F6, #1D4ED8); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarAnalyticsAvanzado()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;"></div>
                        <h2 style="margin: 0;">Analytics de tu Tienda</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Descubre c贸mo est谩 creciendo tu negocio</p>
                    </div>
                    
                    <div style="padding: 32px;">
                        <!-- M茅tricas principales -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px;">
                            <div style="background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 24px; border-radius: 16px; text-align: center;">
                                <div style="font-size: 3rem; margin-bottom: 10px;"></div>
                                <h3 style="margin: 0 0 8px 0;">Visitas Totales</h3>
                                <p style="font-size: 2rem; margin: 0; font-weight: bold;" id="metricVisitas">${sistemaAnalytics.datos.visitas}</p>
                                <p style="font-size: 0.9rem; margin: 8px 0 0; opacity: 0.9;">${sistemaAnalytics.obtenerMensajeAlentador('visitas')}</p>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; padding: 24px; border-radius: 16px; text-align: center;">
                                <div style="font-size: 3rem; margin-bottom: 10px;"></div>
                                <h3 style="margin: 0 0 8px 0;">Ventas</h3>
                                <p style="font-size: 2rem; margin: 0; font-weight: bold;" id="metricVentas">${sistemaAnalytics.datos.ventas}</p>
                                <p style="font-size: 0.9rem; margin: 8px 0 0; opacity: 0.9;">${sistemaAnalytics.obtenerMensajeAlentador('ventas')}</p>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #EC4899, #DB2777); color: white; padding: 24px; border-radius: 16px; text-align: center;">
                                <div style="font-size: 3rem; margin-bottom: 10px;"></div>
                                <h3 style="margin: 0 0 8px 0;">Productos</h3>
                                <p style="font-size: 2rem; margin: 0; font-weight: bold;" id="metricProductos">${sistemaAnalytics.datos.productos}</p>
                                <p style="font-size: 0.9rem; margin: 8px 0 0; opacity: 0.9;">${sistemaAnalytics.obtenerMensajeAlentador('productos')}</p>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; padding: 24px; border-radius: 16px; text-align: center;">
                                <div style="font-size: 3rem; margin-bottom: 10px;"></div>
                                <h3 style="margin: 0 0 8px 0;">Ingresos</h3>
                                <p style="font-size: 2rem; margin: 0; font-weight: bold;" id="metricIngresos">$${sistemaAnalytics.datos.ingresos.toLocaleString()}</p>
                                <p style="font-size: 0.9rem; margin: 8px 0 0; opacity: 0.9;">${sistemaAnalytics.obtenerMensajeAlentador('ingresos')}</p>
                            </div>
                        </div>
                        
                        <!-- Estad铆sticas detalladas -->
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                            <h3 style="margin: 0 0 20px; color: #374151;"> Estad铆sticas Detalladas</h3>
                            
                            <div style="display: grid; gap: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: white; border-radius: 8px; border: 1px solid #E5E7EB;">
                                    <div>
                                        <h4 style="margin: 0; color: #374151;">Visitas Totales</h4>
                                        <p style="margin: 5px 0 0; color: #6B7280; font-size: 0.9rem;">Desde el inicio</p>
                                    </div>
                                    <div style="text-align: right;">
                                        <span style="color: #374151; font-weight: 600;">${sistemaAnalytics.datos.visitas}</span>
                                    </div>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: white; border-radius: 8px; border: 1px solid #E5E7EB;">
                                    <div>
                                        <h4 style="margin: 0; color: #374151;">Visitas nicas</h4>
                                        <p style="margin: 5px 0 0; color: #6B7280; font-size: 0.9rem;">Visitantes diferentes</p>
                                    </div>
                                    <div style="text-align: right;">
                                        <span style="color: #374151; font-weight: 600;">${Math.floor(sistemaAnalytics.datos.visitas * 0.7)}</span>
                                    </div>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: white; border-radius: 8px; border: 1px solid #E5E7EB;">
                                    <div>
                                        <h4 style="margin: 0; color: #374151;">Conversiones</h4>
                                        <p style="margin: 5px 0 0; color: #6B7280; font-size: 0.9rem;">De visitante a cliente</p>
                                    </div>
                                    <div style="text-align: right;">
                                        <span style="color: #374151; font-weight: 600;">${Math.floor(sistemaAnalytics.datos.visitas * 0.4)}</span>
                                    </div>
                                </div>
                                
                                <div style="padding: 16px; background: white; border-radius: 8px; border: 1px solid #E5E7EB;">
                                    <h4 style="margin: 0 0 12px; color: #374151;">Tasa de Conversi贸n</h4>
                                    <div style="background: #F3F4F6; height: 24px; border-radius: 12px; overflow: hidden; position: relative;">
                                        <div style="width: ${sistemaAnalytics.datos.conversionRate}%; height: 100%; background: linear-gradient(135deg, #EF4444, #DC2626); border-radius: 12px;"></div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                                        <span style="color: #6B7280; font-size: 0.9rem;">0%</span>
                                        <span style="color: #374151; font-weight: 600;">${sistemaAnalytics.datos.ventas}</span>
                                        <span style="color: #6B7280; font-size: 0.9rem;">100%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botones de acci贸n -->
                        <div style="display: flex; gap: 16px; justify-content: center;">
                            <button onclick="actualizarAnalytics()" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-sync-alt"></i> Actualizar Datos
                            </button>
                            <button onclick="cerrarAnalyticsAvanzado()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Animar n煤meros
            setTimeout(() => {
                animarNumeroAnalytics('metricVisitas', sistemaAnalytics.datos.visitas);
                animarNumeroAnalytics('metricVentas', sistemaAnalytics.datos.ventas);
                animarNumeroAnalytics('metricProductos', sistemaAnalytics.datos.productos);
                animarNumeroAnalytics('metricIngresos', sistemaAnalytics.datos.ingresos);
            }, 100);
        }
        
        // Funci贸n para animar n煤meros en analytics
        function animarNumeroAnalytics(elementId, valorFinal) {
            const elemento = document.getElementById(elementId);
            if (!elemento) return;
            
            let valorActual = 0;
            const incremento = valorFinal / 50;
            const interval = setInterval(() => {
                valorActual += incremento;
                if (valorActual >= valorFinal) {
                    valorActual = valorFinal;
                    clearInterval(interval);
                }
                
                if (elementId === 'metricIngresos') {
                    elemento.textContent = `$${Math.floor(valorActual).toLocaleString()}`;
                } else {
                    elemento.textContent = Math.floor(valorActual).toLocaleString();
                }
            }, 20);
        }
        
        // Funci贸n para actualizar analytics
        function actualizarAnalytics() {
            // Simular nuevos datos
            sistemaAnalytics.datos.visitas += Math.floor(Math.random() * 50) + 10;
            sistemaAnalytics.datos.ventas += Math.floor(Math.random() * 5) + 1;
            sistemaAnalytics.datos.ingresos += Math.floor(Math.random() * 500) + 100;
            sistemaAnalytics.guardarDatos();
            
            mostrarNotificacion(' Analytics actualizados con datos frescos', 'success');
            
            // Reabrir modal
            cerrarAnalyticsAvanzado();
            abrirAnalyticsAvanzado();
        }
        
        // Funci贸n para cerrar analytics avanzado
        function cerrarAnalyticsAvanzado() {
            const modal = document.getElementById('modalAnalyticsAvanzado');
            if (modal) modal.remove();
        }
        
        // ============================================
        // SISTEMA DE FEEDBACKS DE TIENDA
        // ============================================
        
        class SistemaFeedbacksTienda {
            constructor() {
                this.feedbacks = this.cargarFeedbacks();
                this.configuracion = this.cargarConfiguracion();
            }
            
            cargarFeedbacks() {
                return JSON.parse(localStorage.getItem('feedbacks_tienda') || '[]');
            }
            
            cargarConfiguracion() {
                const config = JSON.parse(localStorage.getItem('configuracion_feedbacks_tienda') || '{}');
                return {
                    mostrarFeedbacks: config.mostrarFeedbacks !== false,
                    permitirAnonimos: config.permitirAnonimos !== false,
                    moderarComentarios: config.moderarComentarios || false,
                    mensajePersonalizado: config.mensajePersonalizado || '隆Tu opini贸n es muy importante para nosotros!'
                };
            }
            
            guardarFeedbacks() {
                localStorage.setItem('feedbacks_tienda', JSON.stringify(this.feedbacks));
            }
            
            guardarConfiguracion() {
                localStorage.setItem('configuracion_feedbacks_tienda', JSON.stringify(this.configuracion));
                mostrarNotificacion(' Configuraci贸n de feedbacks guardada', 'success');
            }
            
            agregarFeedback(feedback) {
                const nuevoFeedback = {
                    id: Date.now().toString(),
                    nombre: feedback.nombre || 'An贸nimo',
                    email: feedback.email || '',
                    rating: feedback.rating || 0,
                    comentario: feedback.comentario,
                    fecha: new Date().toISOString(),
                    moderado: false,
                    respondido: false,
                    respuesta: ''
                };
                
                this.feedbacks.unshift(nuevoFeedback);
                this.guardarFeedbacks();
                return nuevoFeedback;
            }
            
            responderFeedback(feedbackId, respuesta) {
                const feedback = this.feedbacks.find(f => f.id === feedbackId);
                if (feedback) {
                    feedback.respondido = true;
                    feedback.respuesta = respuesta;
                    feedback.fechaRespuesta = new Date().toISOString();
                    this.guardarFeedbacks();
                }
            }
            
            moderarFeedback(feedbackId, aprobado) {
                const feedback = this.feedbacks.find(f => f.id === feedbackId);
                if (feedback) {
                    feedback.moderado = aprobado;
                    this.guardarFeedbacks();
                }
            }
            
            eliminarFeedback(feedbackId) {
                this.feedbacks = this.feedbacks.filter(f => f.id !== feedbackId);
                this.guardarFeedbacks();
            }
            
            obtenerEstadisticas() {
                const total = this.feedbacks.length;
                const promedio = total > 0 ? (this.feedbacks.reduce((sum, f) => sum + f.rating, 0) / total).toFixed(1) : 0;
                const respondidos = this.feedbacks.filter(f => f.respondido).length;
                const pendientes = this.feedbacks.filter(f => !f.moderado && this.configuracion.moderarComentarios).length;
                
                return { total, promedio, respondidos, pendientes };
            }
        }
        
        // Instancia global de Feedbacks Tienda
        let sistemaFeedbacksTienda = new SistemaFeedbacksTienda();
        
        // Funci贸n para abrir gesti贸n de feedbacks de tienda
        function abrirGestionFeedbacksTienda() {
            console.log(' Abriendo gesti贸n de feedbacks de tienda...');
            
            // Cerrar modal anterior si existe
            const modalAnterior = document.getElementById('modalGestionFeedbacksTienda');
            if (modalAnterior) modalAnterior.remove();
            
            const modal = document.createElement('div');
            modal.id = 'modalGestionFeedbacksTienda';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            
            const estadisticas = sistemaFeedbacksTienda.obtenerEstadisticas();
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 1000px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #8B5CF6, #A855F7); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarGestionFeedbacksTienda()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;"></div>
                        <h2 style="margin: 0;">Feedbacks de tu Tienda</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Gestiona las opiniones de tus clientes</p>
                    </div>
                    
                    <div style="padding: 32px;">
                        <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); padding: 20px; border-radius: 16px; border: 2px solid #F59E0B; margin-bottom: 24px;">
                            <h4 style="color: #92400E; margin: 0 0 12px; font-size: 1.1rem;"> Filosof铆a Cresalia</h4>
                            <p style="color: #92400E; margin: 0; font-size: 0.95rem; line-height: 1.5;">
                                Los feedbacks de tus clientes son valiosos para mejorar tu tienda. 
                                Responde siempre con respeto y gratitud, creando una conexi贸n c谩lida con tu comunidad.
                            </p>
                        </div>
                        
                        <!-- Estad铆sticas -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #F0F9FF; padding: 20px; border-radius: 12px; border: 1px solid #BAE6FD; text-align: center;">
                                <div style="font-size: 2rem; color: #0369A1; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #0369A1; font-size: 1.5rem;">${estadisticas.total}</h3>
                                <p style="margin: 0; color: #0369A1; font-size: 0.9rem;">Total Feedbacks</p>
                            </div>
                            
                            <div style="background: #F0FDF4; padding: 20px; border-radius: 12px; border: 1px solid #BBF7D0; text-align: center;">
                                <div style="font-size: 2rem; color: #166534; margin-bottom: 8px;">猸</div>
                                <h3 style="margin: 0; color: #166534; font-size: 1.5rem;">${estadisticas.promedio}</h3>
                                <p style="margin: 0; color: #166534; font-size: 0.9rem;">Promedio</p>
                            </div>
                            
                            <div style="background: #FEF3C7; padding: 20px; border-radius: 12px; border: 1px solid #FDE68A; text-align: center;">
                                <div style="font-size: 2rem; color: #92400E; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #92400E; font-size: 1.5rem;">${estadisticas.respondidos}</h3>
                                <p style="margin: 0; color: #92400E; font-size: 0.9rem;">Respondidos</p>
                            </div>
                            
                            <div style="background: #FEF2F2; padding: 20px; border-radius: 12px; border: 1px solid #FECACA; text-align: center;">
                                <div style="font-size: 2rem; color: #DC2626; margin-bottom: 8px;"></div>
                                <h3 style="margin: 0; color: #DC2626; font-size: 1.5rem;">${estadisticas.pendientes}</h3>
                                <p style="margin: 0; color: #DC2626; font-size: 0.9rem;">Pendientes</p>
                            </div>
                        </div>
                        
                        <!-- Configuraci贸n -->
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                            <h3 style="margin: 0 0 20px; color: #374151;">锔 Configuraci贸n</h3>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div>
                                    <label style="display: flex; align-items: center; gap: 8px; color: #374151; cursor: pointer;">
                                        <input type="checkbox" id="mostrarFeedbacks" ${sistemaFeedbacksTienda.configuracion.mostrarFeedbacks ? 'checked' : ''}>
                                        <span>Mostrar feedbacks en la tienda</span>
                                    </label>
                                </div>
                                <div>
                                    <label style="display: flex; align-items: center; gap: 8px; color: #374151; cursor: pointer;">
                                        <input type="checkbox" id="permitirAnonimos" ${sistemaFeedbacksTienda.configuracion.permitirAnonimos ? 'checked' : ''}>
                                        <span>Permitir feedbacks an贸nimos</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Mensaje Personalizado</label>
                                <textarea id="mensajePersonalizadoFeedbacks" rows="2" 
                                          placeholder="隆Tu opini贸n es muy importante para nosotros!" 
                                          style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem; resize: vertical;">${sistemaFeedbacksTienda.configuracion.mensajePersonalizado}</textarea>
                            </div>
                            
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button onclick="guardarConfiguracionFeedbacksTienda()" style="background: linear-gradient(135deg, #8B5CF6, #A855F7); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Guardar Configuraci贸n
                                </button>
                            </div>
                        </div>
                        
                        <!-- Lista de Feedbacks -->
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                            <h3 style="margin: 0 0 20px; color: #374151;"> Feedbacks Recibidos</h3>
                            
                            <div id="listaFeedbacksTienda" style="max-height: 400px; overflow-y: auto;">
                                ${sistemaFeedbacksTienda.feedbacks.length > 0 ? 
                                    sistemaFeedbacksTienda.feedbacks.map(feedback => `
                                        <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                                <div>
                                                    <h4 style="margin: 0; color: #374151; font-size: 1.1rem;">${feedback.nombre}</h4>
                                                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                                                        <div style="color: #F59E0B;">
                                                            ${''.repeat(feedback.rating)}${''.repeat(5 - feedback.rating)}
                                                        </div>
                                                        <span style="color: #6B7280; font-size: 0.9rem;">${new Date(feedback.fecha).toLocaleDateString('es-ES')}</span>
                                                    </div>
                                                </div>
                                                <div style="display: flex; gap: 8px;">
                                                    ${feedback.respondido ? 
                                                        '<span style="background: #10B981; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">Respondido</span>' :
                                                        '<span style="background: #F59E0B; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">Pendiente</span>'
                                                    }
                                                </div>
                                            </div>
                                            
                                            <p style="color: #4B5563; line-height: 1.6; margin-bottom: 15px;">${feedback.comentario}</p>
                                            
                                            ${feedback.respuesta ? `
                                                <div style="background: #F0F9FF; padding: 15px; border-radius: 8px; border-left: 4px solid #3B82F6; margin-bottom: 15px;">
                                                    <strong style="color: #1F2937;">Tu Respuesta:</strong>
                                                    <p style="margin: 5px 0 0 0; color: #4B5563;">${feedback.respuesta}</p>
                                                </div>
                                            ` : `
                                                <div style="margin-bottom: 15px;">
                                                    <textarea id="respuesta_${feedback.id}" rows="3" 
                                                              placeholder="Escribe tu respuesta aqu铆..." 
                                                              style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                                                </div>
                                            `}
                                            
                                            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                                ${!feedback.respuesta ? `
                                                    <button onclick="responderFeedbackTienda('${feedback.id}')" style="background: #3B82F6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                                        Responder
                                                    </button>
                                                ` : ''}
                                                <button onclick="eliminarFeedbackTienda('${feedback.id}')" style="background: #DC2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                                    Eliminar
                                                </button>
                                            </div>
                                        </div>
                                    `).join('') : 
                                    '<div style="text-align: center; padding: 40px; color: #6B7280;"><i class="fas fa-comment-dots" style="font-size: 3rem; margin-bottom: 15px;"></i><p>No hay feedbacks a煤n</p></div>'
                                }
                            </div>
                        </div>
                        
                        <!-- Botones de acci贸n -->
                        <div style="display: flex; gap: 16px; justify-content: center;">
                            <button onclick="cerrarGestionFeedbacksTienda()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Funci贸n para guardar configuraci贸n de feedbacks
        function guardarConfiguracionFeedbacksTienda() {
            sistemaFeedbacksTienda.configuracion = {
                mostrarFeedbacks: document.getElementById('mostrarFeedbacks').checked,
                permitirAnonimos: document.getElementById('permitirAnonimos').checked,
                moderarComentarios: false,
                mensajePersonalizado: document.getElementById('mensajePersonalizadoFeedbacks').value
            };
            
            sistemaFeedbacksTienda.guardarConfiguracion();
        }
        
        // Funci贸n para responder feedback
        function responderFeedbackTienda(feedbackId) {
            const respuesta = document.getElementById(`respuesta_${feedbackId}`).value;
            if (respuesta.trim()) {
                sistemaFeedbacksTienda.responderFeedback(feedbackId, respuesta);
                mostrarNotificacion(' Respuesta enviada', 'success');
                cerrarGestionFeedbacksTienda();
                abrirGestionFeedbacksTienda(); // Recargar modal
            } else {
                mostrarNotificacion('锔 Escribe una respuesta', 'warning');
            }
        }
        
        // Funci贸n para eliminar feedback
        function eliminarFeedbackTienda(feedbackId) {
            if (confirm('驴Est谩s seguro de que quieres eliminar este feedback?')) {
                sistemaFeedbacksTienda.eliminarFeedback(feedbackId);
                mostrarNotificacion(' Feedback eliminado', 'success');
                cerrarGestionFeedbacksTienda();
                abrirGestionFeedbacksTienda(); // Recargar modal
            }
        }
        
        // Funci贸n para cerrar gesti贸n de feedbacks
        function cerrarGestionFeedbacksTienda() {
            const modal = document.getElementById('modalGestionFeedbacksTienda');
            if (modal) modal.remove();
        }
        
        // ============================================
        // SISTEMA DE SUSCRIPCIONES Y HISTORIAL
        // ============================================
        
        class SistemaSuscripciones {
            constructor() {
                this.suscripcionActual = this.cargarSuscripcionActual();
                this.historial = this.cargarHistorial();
            }
            
            cargarSuscripcionActual() {
                const suscripcion = JSON.parse(localStorage.getItem('suscripcion_actual') || '{}');
                return {
                    plan: suscripcion.plan || 'free',
                    fechaInicio: suscripcion.fechaInicio || new Date().toISOString(),
                    fechaFin: suscripcion.fechaFin || this.calcularFechaFin(30),
                    precio: suscripcion.precio || 0,
                    estado: suscripcion.estado || 'activo'
                };
            }
            
            cargarHistorial() {
                return JSON.parse(localStorage.getItem('historial_suscripciones') || '[]');
            }
            
            guardarSuscripcionActual() {
                localStorage.setItem('suscripcion_actual', JSON.stringify(this.suscripcionActual));
            }
            
            guardarHistorial() {
                localStorage.setItem('historial_suscripciones', JSON.stringify(this.historial));
            }
            
            calcularFechaFin(dias) {
                const fecha = new Date();
                fecha.setDate(fecha.getDate() + dias);
                return fecha.toISOString();
            }
            
            calcularDiasRestantes() {
                const ahora = new Date();
                const fechaFin = new Date(this.suscripcionActual.fechaFin);
                const diferencia = fechaFin - ahora;
                const dias = Math.ceil(diferencia / (1000 * 60 * 60 * 24));
                return dias > 0 ? dias : 0;
            }
            
            cambiarPlan(nuevoPlan, precio) {
                // Guardar suscripci贸n anterior en historial
                if (this.suscripcionActual.plan) {
                    this.historial.unshift({
                        ...this.suscripcionActual,
                        fechaFinReal: new Date().toISOString()
                    });
                }
                
                // Crear nueva suscripci贸n
                this.suscripcionActual = {
                    plan: nuevoPlan,
                    fechaInicio: new Date().toISOString(),
                    fechaFin: this.calcularFechaFin(30),
                    precio: precio,
                    estado: 'activo'
                };
                
                this.guardarSuscripcionActual();
                this.guardarHistorial();
                this.actualizarUI();
            }
            
            actualizarUI() {
                // Actualizar d铆as restantes
                const diasRestantes = this.calcularDiasRestantes();
                const elementoDias = document.getElementById('dias-restantes');
                const elementoDiasDetalle = document.getElementById('diasRestantesDetalle');
                
                if (elementoDias) elementoDias.textContent = diasRestantes;
                if (elementoDiasDetalle) elementoDiasDetalle.textContent = diasRestantes;
                
                // Actualizar plan actual
                const elementoPlan = document.getElementById('planActualNombre');
                if (elementoPlan) elementoPlan.textContent = this.suscripcionActual.plan.toUpperCase();
                
                // Actualizar fecha de renovaci贸n
                const elementoFechaRenovacion = document.getElementById('fechaRenovacion');
                if (elementoFechaRenovacion) {
                    const fechaFin = new Date(this.suscripcionActual.fechaFin);
                    elementoFechaRenovacion.textContent = fechaFin.toLocaleDateString('es-ES');
                }
                
                // Actualizar historial
                this.actualizarHistorial();
            }
            
            actualizarHistorial() {
                const tbody = document.getElementById('historialSuscripcionesBody');
                if (!tbody) return;
                
                if (this.historial.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #6B7280;">No hay historial de suscripciones a煤n</td></tr>';
                    return;
                }
                
                tbody.innerHTML = this.historial.map(suscripcion => {
                    const fechaInicio = new Date(suscripcion.fechaInicio).toLocaleDateString('es-ES');
                    const fechaFin = new Date(suscripcion.fechaFinReal || suscripcion.fechaFin).toLocaleDateString('es-ES');
                    const duracion = Math.ceil((new Date(suscripcion.fechaFinReal || suscripcion.fechaFin) - new Date(suscripcion.fechaInicio)) / (1000 * 60 * 60 * 24));
                    
                    const estadoBadge = suscripcion.estado === 'activo' 
                        ? '<span style="background: #10B981; color: white; padding: 4px 12px; border-radius: 6px; font-size: 0.85rem;">Activo</span>'
                        : '<span style="background: #6B7280; color: white; padding: 4px 12px; border-radius: 6px; font-size: 0.85rem;">Finalizado</span>';
                    
                    return `
                        <tr style="border-bottom: 1px solid #E5E7EB;">
                            <td style="padding: 12px; font-weight: 600; color: #8B5CF6;">${suscripcion.plan.toUpperCase()}</td>
                            <td style="padding: 12px; color: #374151;">${fechaInicio}</td>
                            <td style="padding: 12px; color: #374151;">${fechaFin}</td>
                            <td style="padding: 12px; color: #374151;">${duracion} d铆as</td>
                            <td style="padding: 12px; font-weight: 600; color: #10B981;">$${suscripcion.precio.toLocaleString('es-AR')} ARS</td>
                            <td style="padding: 12px;">${estadoBadge}</td>
                        </tr>
                    `;
                }).join('');
            }
            
            obtenerPrecioPlan(plan) {
                const precios = {
                    'free': 0,
                    'basic': 29000,
                    'pro': 79000,
                    'enterprise': 199000
                };
                return precios[plan.toLowerCase()] || 0;
            }
        }
        
        // Instancia global de Suscripciones
        let sistemaSuscripciones = new SistemaSuscripciones();
        
        // CONFIGURACIN DE CUENTA CRESALIA (SUSCRIPCIONES Y COMISIONES)
        const CUENTA_CRESALIA = {
            alias: 'cresalia.07.mp',
            cvu: '0000003100091477391368'
        };
        
        // COMISIONES POR PLAN
        const COMISIONES_CRESALIA = {
            'free': 0.008,      // 0.8%
            'basic': 0.012,     // 1.2%
            'pro': 0.012,       // 1.2%
            'enterprise': 0.008 // 0.8%
        };
        
        // Funci贸n para calcular comisi贸n seg煤n plan
        function calcularComisionCresalia(monto, plan) {
            const comision = COMISIONES_CRESALIA[plan.toLowerCase()] || 0.012;
            return monto * comision;
        }
        
        // Funci贸n para validar datos de pago antes de procesar
        function validarDatosDePago() {
            const config = configuracionMediosPago.configuracion;
            
            if (!config.validado) {
                mostrarNotificacion('锔 Debes validar tus datos de pago primero', 'warning');
                abrirConfiguracionMediosPago();
                return false;
            }
            
            if (!config.alias || !config.cvu || !config.emailMercadoPago) {
                mostrarNotificacion('锔 Datos de pago incompletos. Por favor config煤ralos.', 'warning');
                abrirConfiguracionMediosPago();
                return false;
            }
            
            return true;
        }
        
        // Funci贸n para cambiar plan con validaci贸n de seguridad
        function cambiarPlan(nuevoPlan) {
            // Validar datos de pago del vendedor
            if (!validarDatosDePago()) {
                return;
            }
            
            const precio = sistemaSuscripciones.obtenerPrecioPlan(nuevoPlan);
            const planActual = sistemaSuscripciones.suscripcionActual.plan;
            
            // Mensaje de confirmaci贸n detallado
            const mensaje = `
 CONFIRMACIN DE CAMBIO DE PLAN

Plan Actual: ${planActual.toUpperCase()}
Nuevo Plan: ${nuevoPlan.toUpperCase()}
Precio: $${precio.toLocaleString('es-AR')} ARS/mes

 DISTRIBUCIN DE PAGOS:
- Suscripci贸n completa va a: Cresalia (${CUENTA_CRESALIA.alias})
- Comisi贸n por ventas (${(COMISIONES_CRESALIA[nuevoPlan.toLowerCase()] * 100).toFixed(1)}%) va a: Cresalia
- Resto de pagos de tus ventas van a: TU cuenta (${configuracionMediosPago.configuracion.alias})

 Todos los pagos est谩n protegidos y son procesados de forma segura.

驴Confirmas el cambio de plan?
            `.trim();
            
            if (confirm(mensaje)) {
                // Registrar transacci贸n de forma segura
                const transaccion = {
                    id: Date.now().toString(),
                    tipo: 'cambio_plan',
                    planAnterior: planActual,
                    planNuevo: nuevoPlan,
                    monto: precio,
                    cuentaDestino: CUENTA_CRESALIA.alias,
                    vendedor: configuracionMediosPago.configuracion.alias,
                    fecha: new Date().toISOString(),
                    estado: 'pendiente'
                };
                
                // Guardar transacci贸n en historial seguro
                const historialTransacciones = JSON.parse(localStorage.getItem('historial_transacciones_seguras') || '[]');
                historialTransacciones.unshift(transaccion);
                localStorage.setItem('historial_transacciones_seguras', JSON.stringify(historialTransacciones));
                
                // Cambiar plan
                sistemaSuscripciones.cambiarPlan(nuevoPlan, precio);
                
                mostrarNotificacion(` Plan actualizado a ${nuevoPlan.toUpperCase()} exitosamente. Pago procesado de forma segura.`, 'success');
            }
        }
        
        // ============================================
        // SISTEMA DE AGRADECIMIENTOS AUTOMTICOS (PRO/ENTERPRISE)
        // ============================================
        
        class SistemaAgradecimientos {
            constructor() {
                this.configuracion = this.cargarConfiguracion();
            }
            
            cargarConfiguracion() {
                const config = JSON.parse(localStorage.getItem('agradecimientos_config') || '{}');
                return {
                    activo: config.activo !== false,
                    metodo: config.metodo || 'email', // 'email' o 'whatsapp'
                    nombreTienda: config.nombreTienda || '',
                    logo: config.logo || '',
                    eslogan: config.eslogan || '',
                    mensaje: config.mensaje || 'Gracias por tu compra. 隆Esperamos verte pronto!',
                    incluirAgradecimientoCresalia: config.incluirAgradecimientoCresalia !== false,
                    mensajeCresalia: config.mensajeCresalia || 'Powered by Cresalia - Tu plataforma de confianza',
                    colores: config.colores || { primario: '#8B5CF6', secundario: '#EC4899' }
                };
            }
            
            guardarConfiguracion() {
                localStorage.setItem('agradecimientos_config', JSON.stringify(this.configuracion));
            }
            
            enviarAgradecimiento(datosVenta) {
                if (!this.configuracion.activo) return;
                
                const mensaje = this.generarMensaje(datosVenta);
                
                if (this.configuracion.metodo === 'email') {
                    this.enviarEmail(datosVenta.emailCliente, mensaje);
                } else {
                    this.enviarWhatsApp(datosVenta.telefonoCliente, mensaje);
                }
            }
            
            generarMensaje(datosVenta) {
                return `
                    ${this.configuracion.nombreTienda}
                    ${this.configuracion.eslogan}
                    
                    ${this.configuracion.mensaje}
                    
                    Detalles de tu compra:
                    - Producto/Servicio: ${datosVenta.producto}
                    - Fecha: ${new Date().toLocaleDateString('es-ES')}
                    
                    ${this.configuracion.incluirAgradecimientoCresalia ? '\n' + this.configuracion.mensajeCresalia : ''}
                `;
            }
            
            enviarEmail(email, mensaje) {
                console.log(` Enviando email a ${email}:`, mensaje);
                mostrarNotificacion(' Email de agradecimiento enviado', 'success');
            }
            
            enviarWhatsApp(telefono, mensaje) {
                console.log(` Enviando WhatsApp a ${telefono}:`, mensaje);
                const mensajeEncoded = encodeURIComponent(mensaje);
                window.open(`https://wa.me/${telefono}?text=${mensajeEncoded}`, '_blank');
                mostrarNotificacion(' WhatsApp de agradecimiento abierto', 'success');
            }
        }
        
        // Instancia global
        let sistemaAgradecimientos = new SistemaAgradecimientos();
        
        // Funci贸n para abrir configuraci贸n de agradecimientos
        function abrirConfiguracionAgradecimiento() {
            const planActual = localStorage.getItem('plan-actual') || 'free';
            
            if (!['pro', 'enterprise'].includes(planActual.toLowerCase())) {
                mostrarNotificacion('锔 Esta funci贸n solo est谩 disponible para planes PRO y ENTERPRISE', 'warning');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'modalAgradecimientos';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 999999; overflow-y: auto; padding: 20px;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarModalAgradecimientos()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;"></div>
                        <h2 style="margin: 0;">Agradecimientos Autom谩ticos</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">PRO & ENTERPRISE - Post-Venta Personalizado</p>
                    </div>
                    
                    <div style="padding: 32px;">
                        <div style="background: #FEF3C7; padding: 20px; border-radius: 12px; border-left: 4px solid #F59E0B; margin-bottom: 30px;">
                            <p style="margin: 0; color: #92400E; font-size: 0.95rem;">
                                <strong> Filosof铆a Cresalia:</strong> Env铆a mensajes personalizados post-venta por email o WhatsApp. Fortalece la conexi贸n con tus clientes.
                            </p>
                        </div>
                        
                        <form id="formAgradecimientos" onsubmit="guardarConfiguracionAgradecimientos(event)">
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; cursor: pointer;">
                                    <input type="checkbox" id="agradecimientosActivo" ${sistemaAgradecimientos.configuracion.activo ? 'checked' : ''} style="width: 20px; height: 20px;">
                                    <span style="font-weight: 600; color: #374151;"> Activar agradecimientos autom谩ticos</span>
                                </label>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">M茅todo de Env铆o *</label>
                                    <select id="metodoAgradecimiento" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                        <option value="email" ${sistemaAgradecimientos.configuracion.metodo === 'email' ? 'selected' : ''}> Email</option>
                                        <option value="whatsapp" ${sistemaAgradecimientos.configuracion.metodo === 'whatsapp' ? 'selected' : ''}> WhatsApp</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Nombre de tu Tienda *</label>
                                    <input type="text" id="nombreTiendaAgradecimiento" required value="${sistemaAgradecimientos.configuracion.nombreTienda}"
                                           placeholder="Ej: Mi Tienda" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Eslogan</label>
                                <input type="text" id="esloganAgradecimiento" value="${sistemaAgradecimientos.configuracion.eslogan}"
                                       placeholder="Ej: Calidad y servicio que inspiran" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Mensaje de Agradecimiento *</label>
                                <textarea id="mensajeAgradecimiento" required rows="4" 
                                          placeholder="Escribe tu mensaje personalizado..."
                                          style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem; resize: vertical;">${sistemaAgradecimientos.configuracion.mensaje}</textarea>
                            </div>
                            
                            <div style="background: #E0E7FF; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #818CF8;">
                                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                                    <input type="checkbox" id="incluirCresalia" ${sistemaAgradecimientos.configuracion.incluirAgradecimientoCresalia ? 'checked' : ''} style="width: 20px; height: 20px;">
                                    <span style="font-weight: 600; color: #4338CA;"> Incluir agradecimiento de Cresalia</span>
                                </label>
                                <input type="text" id="mensajeCresalia" value="${sistemaAgradecimientos.configuracion.mensajeCresalia}"
                                       placeholder="Powered by Cresalia" style="width: 100%; padding: 12px; border: 1px solid #818CF8; border-radius: 8px; font-size: 0.9rem; background: white;">
                            </div>
                            
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" onclick="cerrarModalAgradecimientos()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Cancelar
                                </button>
                                <button type="submit" style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-save"></i> Guardar Configuraci贸n
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Funci贸n para guardar configuraci贸n de agradecimientos
        function guardarConfiguracionAgradecimientos(event) {
            event.preventDefault();
            
            sistemaAgradecimientos.configuracion = {
                activo: document.getElementById('agradecimientosActivo').checked,
                metodo: document.getElementById('metodoAgradecimiento').value,
                nombreTienda: document.getElementById('nombreTiendaAgradecimiento').value,
                eslogan: document.getElementById('esloganAgradecimiento').value,
                mensaje: document.getElementById('mensajeAgradecimiento').value,
                incluirAgradecimientoCresalia: document.getElementById('incluirCresalia').checked,
                mensajeCresalia: document.getElementById('mensajeCresalia').value
            };
            
            sistemaAgradecimientos.guardarConfiguracion();
            mostrarNotificacion(' Configuraci贸n de agradecimientos guardada', 'success');
            cerrarModalAgradecimientos();
        }
        
        // Funci贸n para cerrar modal de agradecimientos
        function cerrarModalAgradecimientos() {
            const modal = document.getElementById('modalAgradecimientos');
            if (modal) modal.remove();
        }
        
        // ============================================
        // SISTEMA DE PUNTOS COMUNES
        // ============================================
        
        class SistemaPuntosComunes {
            constructor() {
                this.puntosComunes = this.cargarPuntosComunes();
            }
            
            cargarPuntosComunes() {
                return JSON.parse(localStorage.getItem('puntos_comunes') || '[]');
            }
            
            guardarPuntosComunes() {
                localStorage.setItem('puntos_comunes', JSON.stringify(this.puntosComunes));
            }
            
            agregarPunto(punto) {
                const nuevoPunto = {
                    id: Date.now().toString(),
                    zona: punto.zona,
                    direccion: punto.direccion,
                    precio: parseFloat(punto.precio),
                    medioTransporte: punto.medioTransporte,
                    observaciones: punto.observaciones || '',
                    fecha: new Date().toISOString()
                };
                
                this.puntosComunes.unshift(nuevoPunto);
                this.guardarPuntosComunes();
                return nuevoPunto;
            }
            
            editarPunto(id, datosActualizados) {
                const index = this.puntosComunes.findIndex(p => p.id === id);
                if (index !== -1) {
                    this.puntosComunes[index] = {
                        ...this.puntosComunes[index],
                        ...datosActualizados,
                        precio: parseFloat(datosActualizados.precio)
                    };
                    this.guardarPuntosComunes();
                }
            }
            
            eliminarPunto(id) {
                this.puntosComunes = this.puntosComunes.filter(p => p.id !== id);
                this.guardarPuntosComunes();
            }
            
            obtenerPunto(id) {
                return this.puntosComunes.find(p => p.id === id);
            }
        }
        
        // Instancia global
        let sistemaPuntosComunes = new SistemaPuntosComunes();
        
        // Funci贸n para abrir gesti贸n de puntos comunes
        function abrirGestionPuntosComunes() {
            const modal = document.createElement('div');
            modal.id = 'modalPuntosComunes';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 999999; overflow-y: auto; padding: 20px;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 1200px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarModalPuntosComunes()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;"></div>
                        <h2 style="margin: 0;">Gesti贸n de Puntos Comunes</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Configura zonas, precios y transporte</p>
                    </div>
                    
                    <div style="padding: 32px;">
                        <!-- Formulario de Puntos Comunes -->
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                            <h3 style="margin: 0 0 20px; color: #374151;"> Agregar Nuevo Punto Com煤n</h3>
                            
                            <form id="formPuntoComun" onsubmit="guardarPuntoComun(event)">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Zona/Barrio *</label>
                                        <input type="text" id="zonaPuntoComun" required placeholder="Ej: Centro, Zona Norte"
                                               style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Precio de Env铆o *</label>
                                        <input type="number" id="precioPuntoComun" required placeholder="0.00" step="0.01" min="0"
                                               style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Direcci贸n del Punto de Encuentro *</label>
                                    <input type="text" id="direccionPuntoComun" required placeholder="Ej: Av. Principal 123"
                                           style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Medio de Transporte *</label>
                                    <select id="transportePuntoComun" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                        <option value="">Seleccionar medio</option>
                                        <option value="auto"> Auto particular</option>
                                        <option value="moto">锔 Moto</option>
                                        <option value="bicicleta"> Bicicleta</option>
                                        <option value="transporte-publico"> Transporte p煤blico</option>
                                        <option value="correo"> Correo/Mensajer铆a</option>
                                        <option value="otro"> Otro</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Observaciones</label>
                                    <textarea id="observacionesPuntoComun" rows="2" placeholder="Horarios, referencias adicionales, etc..."
                                              style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                                </div>
                                
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="submit" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        <i class="fas fa-save"></i> Guardar Punto Com煤n
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Lista de Puntos Comunes -->
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB;">
                            <h3 style="margin: 0 0 20px; color: #374151;"> Puntos Comunes Configurados (${sistemaPuntosComunes.puntosComunes.length})</h3>
                            
                            <div id="listaPuntosComunes" style="display: grid; gap: 15px; max-height: 400px; overflow-y: auto;">
                                ${sistemaPuntosComunes.puntosComunes.length > 0 ? 
                                    sistemaPuntosComunes.puntosComunes.map(punto => `
                                        <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: center;">
                                            <div>
                                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                                    <h4 style="margin: 0; color: #374151; font-size: 1.1rem;"> ${punto.zona}</h4>
                                                </div>
                                                <p style="margin: 0 0 4px; color: #6B7280; font-size: 0.9rem;"> ${punto.direccion}</p>
                                                <p style="margin: 0 0 8px; color: #6B7280; font-size: 0.9rem;">${punto.medioTransporte}</p>
                                                <div style="display: flex; align-items: center; gap: 15px;">
                                                    <span style="font-weight: 700; color: #10B981; font-size: 1.2rem;">$${punto.precio.toFixed(2)}</span>
                                                    ${punto.observaciones ? `<span style="color: #6B7280; font-size: 0.85rem; font-style: italic;">${punto.observaciones}</span>` : ''}
                                                </div>
                                            </div>
                                            <div style="display: flex; gap: 8px;">
                                                <button onclick="eliminarPuntoComun('${punto.id}')" style="background: #DC2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    `).join('') : 
                                    '<div style="text-align: center; padding: 40px; color: #6B7280;"><i class="fas fa-map-marked-alt" style="font-size: 3rem; margin-bottom: 15px;"></i><p>No hay puntos comunes configurados a煤n</p></div>'
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Funci贸n para guardar punto com煤n
        function guardarPuntoComun(event) {
            event.preventDefault();
            
            const punto = {
                zona: document.getElementById('zonaPuntoComun').value,
                direccion: document.getElementById('direccionPuntoComun').value,
                precio: document.getElementById('precioPuntoComun').value,
                medioTransporte: document.getElementById('transportePuntoComun').value,
                observaciones: document.getElementById('observacionesPuntoComun').value
            };
            
            sistemaPuntosComunes.agregarPunto(punto);
            mostrarNotificacion(' Punto com煤n agregado exitosamente', 'success');
            cerrarModalPuntosComunes();
            abrirGestionPuntosComunes();
        }
        
        // Funci贸n para eliminar punto com煤n
        function eliminarPuntoComun(id) {
            if (confirm('驴Est谩s seguro de eliminar este punto com煤n?')) {
                sistemaPuntosComunes.eliminarPunto(id);
                mostrarNotificacion(' Punto com煤n eliminado', 'success');
                cerrarModalPuntosComunes();
                abrirGestionPuntosComunes();
            }
        }
        
        // Funci贸n para cerrar modal de puntos comunes
        function cerrarModalPuntosComunes() {
            const modal = document.getElementById('modalPuntosComunes');
            if (modal) modal.remove();
        }
        
        // ============================================
        // SISTEMA DE ENVOS A DOMICILIO
        // ============================================
        
        class SistemaEnviosDomicilio {
            constructor() {
                this.configuracion = this.cargarConfiguracion();
            }
            
            cargarConfiguracion() {
                const config = JSON.parse(localStorage.getItem('envios_domicilio_config') || '{}');
                return {
                    activo: config.activo !== false,
                    metodoEnvio: config.metodoEnvio || 'correo',
                    nombreServicio: config.nombreServicio || '',
                    precioBase: parseFloat(config.precioBase) || 0,
                    precioPorKm: parseFloat(config.precioPorKm) || 0,
                    zonasCubiertas: config.zonasCubiertas || [],
                    tiempoEstimado: config.tiempoEstimado || ''
                };
            }
            
            guardarConfiguracion() {
                localStorage.setItem('envios_domicilio_config', JSON.stringify(this.configuracion));
            }
            
            calcularPrecioEnvio(distanciaKm) {
                return this.configuracion.precioBase + (distanciaKm * this.configuracion.precioPorKm);
            }
        }
        
        // Instancia global
        let sistemaEnviosDomicilio = new SistemaEnviosDomicilio();
        
        // Funci贸n para abrir gesti贸n de env铆os a domicilio
        function abrirGestionEnviosDomicilio() {
            const modal = document.createElement('div');
            modal.id = 'modalEnviosDomicilio';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 999999; overflow-y: auto; padding: 20px;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #3B82F6, #1D4ED8); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarModalEnviosDomicilio()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;"></div>
                        <h2 style="margin: 0;">Configuraci贸n de Env铆os a Domicilio</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Precios autom谩ticos por distancia</p>
                    </div>
                    
                    <div style="padding: 32px;">
                        <form id="formEnviosDomicilio" onsubmit="guardarConfiguracionEnvios(event)">
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; cursor: pointer;">
                                    <input type="checkbox" id="enviosActivo" ${sistemaEnviosDomicilio.configuracion.activo ? 'checked' : ''} style="width: 20px; height: 20px;">
                                    <span style="font-weight: 600; color: #374151;"> Ofrecer env铆os a domicilio</span>
                                </label>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">M茅todo de Env铆o *</label>
                                    <select id="metodoEnvio" required style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                        <option value="correo" ${sistemaEnviosDomicilio.configuracion.metodoEnvio === 'correo' ? 'selected' : ''}> Correo</option>
                                        <option value="mensajeria" ${sistemaEnviosDomicilio.configuracion.metodoEnvio === 'mensajeria' ? 'selected' : ''}>锔 Mensajer铆a</option>
                                        <option value="propio" ${sistemaEnviosDomicilio.configuracion.metodoEnvio === 'propio' ? 'selected' : ''}> Transporte propio</option>
                                        <option value="otro" ${sistemaEnviosDomicilio.configuracion.metodoEnvio === 'otro' ? 'selected' : ''}> Otro</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Nombre del Servicio</label>
                                    <input type="text" id="nombreServicioEnvio" value="${sistemaEnviosDomicilio.configuracion.nombreServicio}"
                                           placeholder="Ej: Correo Argentino, OCA" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                </div>
                            </div>
                            
                            <div style="background: #EFF6FF; padding: 20px; border-radius: 12px; border-left: 4px solid #3B82F6; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 15px; color: #1E40AF;"> C谩lculo Autom谩tico de Precio</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Precio Base *</label>
                                        <input type="number" id="precioBaseEnvio" required value="${sistemaEnviosDomicilio.configuracion.precioBase}" placeholder="0.00" step="0.01" min="0"
                                               style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Precio por Km *</label>
                                        <input type="number" id="precioPorKmEnvio" required value="${sistemaEnviosDomicilio.configuracion.precioPorKm}" placeholder="0.00" step="0.01" min="0"
                                               style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                    </div>
                                </div>
                                <p style="margin: 10px 0 0; color: #374151; font-size: 0.9rem;">
                                    <strong>F贸rmula:</strong> Precio Total = Precio Base + (Distancia en Km  Precio por Km)
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Tiempo Estimado de Entrega</label>
                                <input type="text" id="tiempoEstimadoEnvio" value="${sistemaEnviosDomicilio.configuracion.tiempoEstimado}"
                                       placeholder="Ej: 24-48 horas, 3-5 d铆as h谩biles" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                            </div>
                            
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" onclick="cerrarModalEnviosDomicilio()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Cancelar
                                </button>
                                <button type="submit" style="background: linear-gradient(135deg, #3B82F6, #1D4ED8); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-save"></i> Guardar Configuraci贸n
                                </button>
                            </div>
                        </form>
                        
                        <!-- Calculadora de Env铆o -->
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-top: 30px;">
                            <h3 style="margin: 0 0 20px; color: #374151;">М Calculadora de Precio de Env铆o</h3>
                            <div style="display: flex; gap: 15px; align-items: end;">
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Distancia (Km)</label>
                                    <input type="number" id="distanciaCalculadora" placeholder="0" step="0.1" min="0"
                                           style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                </div>
                                <button onclick="calcularPrecioEnvio()" style="background: #10B981; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Calcular
                                </button>
                            </div>
                            <div id="resultadoCalculadora" style="margin-top: 15px; display: none; background: #D1FAE5; padding: 15px; border-radius: 8px; text-align: center;">
                                <p style="margin: 0; color: #065F46; font-size: 1.1rem; font-weight: 600;">
                                    Precio de Env铆o: <span id="precioCalculado" style="font-size: 1.5rem;">$0.00</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Funci贸n para guardar configuraci贸n de env铆os
        function guardarConfiguracionEnvios(event) {
            event.preventDefault();
            
            sistemaEnviosDomicilio.configuracion = {
                activo: document.getElementById('enviosActivo').checked,
                metodoEnvio: document.getElementById('metodoEnvio').value,
                nombreServicio: document.getElementById('nombreServicioEnvio').value,
                precioBase: parseFloat(document.getElementById('precioBaseEnvio').value),
                precioPorKm: parseFloat(document.getElementById('precioPorKmEnvio').value),
                tiempoEstimado: document.getElementById('tiempoEstimadoEnvio').value
            };
            
            sistemaEnviosDomicilio.guardarConfiguracion();
            mostrarNotificacion(' Configuraci贸n de env铆os guardada', 'success');
        }
        
        // Funci贸n para calcular precio de env铆o
        function calcularPrecioEnvio() {
            const distancia = parseFloat(document.getElementById('distanciaCalculadora').value);
            
            if (!distancia || distancia < 0) {
                mostrarNotificacion('锔 Por favor ingresa una distancia v谩lida', 'warning');
                return;
            }
            
            const precio = sistemaEnviosDomicilio.calcularPrecioEnvio(distancia);
            
            document.getElementById('precioCalculado').textContent = `$${precio.toFixed(2)}`;
            document.getElementById('resultadoCalculadora').style.display = 'block';
        }
        
        // Funci贸n para cerrar modal de env铆os
        function cerrarModalEnviosDomicilio() {
            const modal = document.getElementById('modalEnviosDomicilio');
            if (modal) modal.remove();
        }
        
        // ============================================
        // CONFIGURACIN DE MEDIOS DE PAGO (VALIDACIN)
        // ============================================
        
        class ConfiguracionMediosPago {
            constructor() {
                this.configuracion = this.cargarConfiguracion();
            }
            
            cargarConfiguracion() {
                const config = JSON.parse(localStorage.getItem('medios_pago_config') || '{}');
                return {
                    alias: config.alias || '',
                    cvu: config.cvu || '',
                    cbu: config.cbu || '',
                    emailMercadoPago: config.emailMercadoPago || '',
                    nombreTitular: config.nombreTitular || '',
                    validado: config.validado || false,
                    fechaValidacion: config.fechaValidacion || null
                };
            }
            
            guardarConfiguracion() {
                localStorage.setItem('medios_pago_config', JSON.stringify(this.configuracion));
            }
            
            validarCVU(cvu) {
                // CVU debe tener 22 d铆gitos
                return /^\d{22}$/.test(cvu);
            }
            
            validarCBU(cbu) {
                // CBU debe tener 22 d铆gitos
                return /^\d{22}$/.test(cbu);
            }
            
            validarAlias(alias) {
                // Alias debe tener entre 6 y 20 caracteres, solo letras, n煤meros y puntos
                return /^[a-zA-Z0-9.]{6,20}$/.test(alias);
            }
            
            validarEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            }
        }
        
        // Instancia global
        let configuracionMediosPago = new ConfiguracionMediosPago();
        
        // Funci贸n para abrir configuraci贸n de medios de pago
        function abrirConfiguracionMediosPago() {
            const modal = document.createElement('div');
            modal.id = 'modalConfiguracionMediosPago';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 999999; overflow-y: auto; padding: 20px;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #8B5CF6, #6D28D9); color: white; padding: 32px; text-align: center; position: relative;">
                        <button onclick="cerrarModalConfiguracionMediosPago()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 40px; height: 40px;"></button>
                        <div style="font-size: 64px; margin-bottom: 16px;"></div>
                        <h2 style="margin: 0;">Configuraci贸n de Medios de Pago</h2>
                        <p style="margin: 8px 0 0; opacity: 0.95;">Elige qu茅 medios de pago aceptas</p>
                    </div>
                    
                    <div style="padding: 32px;">
                        <div style="background: #E0E7FF; padding: 20px; border-radius: 12px; border-left: 4px solid #8B5CF6; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px; color: #4338CA;"> Cuenta de Cresalia (Suscripciones y Comisiones)</h4>
                            <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 10px;">
                                <p style="margin: 0 0 8px; color: #374151; font-size: 0.9rem;"><strong>Alias:</strong> cresalia.07.mp</p>
                                <p style="margin: 0; color: #374151; font-size: 0.9rem;"><strong>CVU:</strong> 0000003100091477391368</p>
                                <p style="margin: 10px 0 0; color: #6B7280; font-size: 0.85rem; font-style: italic;">
                                    Solo para pagos de suscripciones y comisiones de Cresalia
                                </p>
                            </div>
                        </div>
                        
                        <div style="background: #FEF3C7; padding: 20px; border-radius: 12px; border-left: 4px solid #F59E0B; margin-bottom: 30px;">
                            <p style="margin: 0; color: #92400E; font-size: 0.95rem;">
                                <strong> Seguridad:</strong> Solo las <strong>comisiones de Cresalia (seg煤n tu plan)</strong> van a la cuenta de Cresalia. <strong>El resto de los pagos van DIRECTAMENTE a TU cuenta.</strong>
                            </p>
                        </div>
                        
                        <form id="formConfiguracionMediosPago" onsubmit="guardarConfiguracionMediosPago(event)">
                            <!-- Selecci贸n de M茅todos de Pago -->
                            <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 30px;">
                                <h3 style="margin: 0 0 20px; color: #374151;"> 驴Qu茅 medios de pago aceptas?</h3>
                                
                                <div style="display: grid; gap: 15px;">
                                    <label style="display: flex; align-items: center; gap: 12px; padding: 15px; background: white; border: 2px solid #E5E7EB; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                                        <input type="checkbox" id="aceptaMercadoPago" ${configuracionMediosPago.configuracion.aceptaMercadoPago !== false ? 'checked' : ''} style="width: 20px; height: 20px;">
                                        <div style="flex: 1;">
                                            <strong style="color: #374151; font-size: 1.05rem;"> Mercado Pago</strong>
                                            <p style="margin: 5px 0 0; color: #6B7280; font-size: 0.9rem;">Transferencias, QR, tarjetas</p>
                                        </div>
                                    </label>
                                    
                                    <label style="display: flex; align-items: center; gap: 12px; padding: 15px; background: white; border: 2px solid #E5E7EB; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                                        <input type="checkbox" id="aceptaEfectivo" ${configuracionMediosPago.configuracion.aceptaEfectivo ? 'checked' : ''} style="width: 20px; height: 20px;">
                                        <div style="flex: 1;">
                                            <strong style="color: #374151; font-size: 1.05rem;"> Efectivo</strong>
                                            <p style="margin: 5px 0 0; color: #6B7280; font-size: 0.9rem;">Pago en persona</p>
                                        </div>
                                    </label>
                                    
                                    <label style="display: flex; align-items: center; gap: 12px; padding: 15px; background: white; border: 2px solid #E5E7EB; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                                        <input type="checkbox" id="aceptaTransferencia" ${configuracionMediosPago.configuracion.aceptaTransferencia ? 'checked' : ''} style="width: 20px; height: 20px;">
                                        <div style="flex: 1;">
                                            <strong style="color: #374151; font-size: 1.05rem;"> Transferencia Bancaria</strong>
                                            <p style="margin: 5px 0 0; color: #6B7280; font-size: 0.9rem;">CBU/CVU directo</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Datos de Mercado Pago (solo si est谩 activado) -->
                            <div id="datosMercadoPago" style="display: ${configuracionMediosPago.configuracion.aceptaMercadoPago !== false ? 'block' : 'none'};">
                                <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 20px;">
                                    <h3 style="margin: 0 0 20px; color: #374151;"> Datos de Mercado Pago</h3>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Alias *</label>
                                        <input type="text" id="aliasMercadoPago" value="${configuracionMediosPago.configuracion.alias || ''}"
                                               placeholder="mi.alias.mp" pattern="[a-zA-Z0-9.]{6,20}" 
                                               style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                        <small style="color: #6B7280; font-size: 0.85rem;">6-20 caracteres. Solo letras, n煤meros y puntos</small>
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">CVU *</label>
                                        <input type="text" id="cvuMercadoPago" value="${configuracionMediosPago.configuracion.cvu || ''}"
                                               placeholder="0000003100010075471234" pattern="\\d{22}" maxlength="22"
                                               style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                        <small style="color: #6B7280; font-size: 0.85rem;">22 d铆gitos</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Datos de Transferencia Bancaria (solo si est谩 activado) -->
                            <div id="datosTransferencia" style="display: ${configuracionMediosPago.configuracion.aceptaTransferencia ? 'block' : 'none'};">
                                <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 20px;">
                                    <h3 style="margin: 0 0 20px; color: #374151;"> Datos Bancarios</h3>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">CBU *</label>
                                        <input type="text" id="cbuBanco" value="${configuracionMediosPago.configuracion.cbu || ''}"
                                               placeholder="0170076620000003912345" pattern="\\d{22}" maxlength="22"
                                               style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                        <small style="color: #6B7280; font-size: 0.85rem;">22 d铆gitos</small>
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Alias Bancario</label>
                                        <input type="text" id="aliasBanco" value="${configuracionMediosPago.configuracion.aliasBanco || ''}"
                                               placeholder="mi.alias.banco"
                                               style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Titular y Email -->
                            <div style="background: #F8FAFC; padding: 24px; border-radius: 16px; border: 1px solid #E5E7EB; margin-bottom: 20px;">
                                <h3 style="margin: 0 0 20px; color: #374151;"> Informaci贸n del Titular</h3>
                                
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Nombre del Titular *</label>
                                    <input type="text" id="nombreTitular" required value="${configuracionMediosPago.configuracion.nombreTitular || ''}"
                                           placeholder="Juan P茅rez" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Email de Contacto *</label>
                                    <input type="email" id="emailContacto" required value="${configuracionMediosPago.configuracion.emailMercadoPago || ''}"
                                           placeholder="tu@email.com" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem;">
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" onclick="cerrarModalConfiguracionMediosPago()" style="padding: 12px 24px; border: 2px solid #E5E7EB; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Cancelar
                                </button>
                                <button type="submit" style="background: linear-gradient(135deg, #8B5CF6, #6D28D9); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-save"></i> Guardar Configuraci贸n
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Event listeners para mostrar/ocultar secciones
            document.getElementById('aceptaMercadoPago').addEventListener('change', function() {
                document.getElementById('datosMercadoPago').style.display = this.checked ? 'block' : 'none';
            });
            
            document.getElementById('aceptaTransferencia').addEventListener('change', function() {
                document.getElementById('datosTransferencia').style.display = this.checked ? 'block' : 'none';
            });
        }
        
        // Funci贸n para guardar configuraci贸n de medios de pago
        function guardarConfiguracionMediosPago(event) {
            event.preventDefault();
            
            const aceptaMercadoPago = document.getElementById('aceptaMercadoPago').checked;
            const aceptaEfectivo = document.getElementById('aceptaEfectivo').checked;
            const aceptaTransferencia = document.getElementById('aceptaTransferencia').checked;
            
            // Validar que al menos un m茅todo est茅 seleccionado
            if (!aceptaMercadoPago && !aceptaEfectivo && !aceptaTransferencia) {
                mostrarNotificacion('锔 Debes seleccionar al menos un medio de pago', 'warning');
                return;
            }
            
            const config = {
                aceptaMercadoPago: aceptaMercadoPago,
                aceptaEfectivo: aceptaEfectivo,
                aceptaTransferencia: aceptaTransferencia,
                nombreTitular: document.getElementById('nombreTitular').value,
                emailMercadoPago: document.getElementById('emailContacto').value,
                validado: true,
                fechaValidacion: new Date().toISOString()
            };
            
            // Si acepta Mercado Pago, validar y guardar datos
            if (aceptaMercadoPago) {
                const alias = document.getElementById('aliasMercadoPago').value.trim();
                const cvu = document.getElementById('cvuMercadoPago').value.trim();
                
                if (!alias || !cvu) {
                    mostrarNotificacion('锔 Completa los datos de Mercado Pago (Alias y CVU)', 'warning');
                    return;
                }
                
                if (!configuracionMediosPago.validarAlias(alias)) {
                    mostrarNotificacion('锔 Alias inv谩lido. Debe tener 6-20 caracteres (letras, n煤meros y puntos)', 'warning');
                    return;
                }
                
                if (!configuracionMediosPago.validarCVU(cvu)) {
                    mostrarNotificacion('锔 CVU inv谩lido. Debe tener exactamente 22 d铆gitos', 'warning');
                    return;
                }
                
                config.alias = alias;
                config.cvu = cvu;
            }
            
            // Si acepta transferencia bancaria, validar y guardar datos
            if (aceptaTransferencia) {
                const cbu = document.getElementById('cbuBanco').value.trim();
                const aliasBanco = document.getElementById('aliasBanco').value.trim();
                
                if (!cbu) {
                    mostrarNotificacion('锔 Completa el CBU para transferencias bancarias', 'warning');
                    return;
                }
                
                if (!configuracionMediosPago.validarCBU(cbu)) {
                    mostrarNotificacion('锔 CBU inv谩lido. Debe tener exactamente 22 d铆gitos', 'warning');
                    return;
                }
                
                config.cbu = cbu;
                config.aliasBanco = aliasBanco;
            }
            
            // Guardar configuraci贸n
            configuracionMediosPago.configuracion = config;
            configuracionMediosPago.guardarConfiguracion();
            
            mostrarNotificacion(' Medios de pago configurados correctamente', 'success');
            cerrarModalConfiguracionMediosPago();
        }
        
        // Funci贸n para cerrar modal de configuraci贸n de medios de pago
        function cerrarModalConfiguracionMediosPago() {
            const modal = document.getElementById('modalConfiguracionMediosPago');
            if (modal) modal.remove();
        }
        
        // ============================================
        // INICIALIZACIN
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log(' Cresalia - Panel Final Inicializado');
            console.log(' Todas las funcionalidades cargadas');
            console.log(' Sistema de bienestar emocional activo');
            console.log(' Bot IA disponible para plan PRO');
            console.log(' Analytics y reportes funcionando');
            console.log('锔 Sistema de servicios completo');
            console.log(' Sistema de turnos operativo');
            console.log(' Gesti贸n de suscripciones lista');
            console.log(' Sistema de remiser铆a completo');
            console.log(' Medios de pago configurados');
            console.log(' P谩gina de tienda editable');
            console.log(' Todas las interconexiones activas');
            
            // Forzar visualizaci贸n
            document.body.style.display = 'block';
            document.body.style.visibility = 'visible';
            document.body.style.opacity = '1';
            
            // Inicializar sistema de suscripciones
            sistemaSuscripciones.actualizarUI();
            
            // Verificar plan y mostrar/ocultar bienestar emocional (despu茅s de que el DOM est茅 listo)
            setTimeout(() => {
                actualizarVisibilidadBienestar();
            }, 100);
            
            // Tambi茅n verificar despu茅s de un segundo por si acaso
            setTimeout(() => {
                actualizarVisibilidadBienestar();
            }, 1000);
            
        // Cerrar todos los modales al cargar + sincronizaci贸n de interconexiones
            const modales = document.querySelectorAll('.modal');
            modales.forEach(modal => {
                modal.classList.remove('show');
            });
            document.body.style.overflow = 'auto';
        
        // Interconexi贸n: sincronizaci贸n de datos (sin abrir paneles)
        try {
            const datos = {
                timestamp: new Date().toISOString(),
                tienda: 'Mi Tienda Demo',
                plan: localStorage.getItem('plan-actual') || 'free'
            };
            localStorage.setItem('cresalia_sync_panel', JSON.stringify(datos));
            console.log(' Interconexi贸n sincronizada');
        } catch (e) {
            console.warn('Interconexi贸n no disponible en este contexto');
        }
            
            // Cerrar modales con tecla Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modalesAbiertos = document.querySelectorAll('.modal.show');
                    modalesAbiertos.forEach(modal => {
                        cerrarModal(modal.id);
                    });
                }
            });
            
            // Animar n煤meros de analytics
            animarNumero('metricVisitas', 1234);
            animarNumero('metricVentas', 56);
            animarNumero('metricProductos', 12);
            animarNumero('metricIngresos', 2450);
            
            console.log(' 隆Panel completamente funcional con TODAS las funcionalidades!');
        });
    </script>
    
    <!-- Sistema de Alertas de Emergencia Global -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../js/inject-env-vars.js"></script>
    <!-- Configuraci贸n de Supabase - Cargar auth/supabase-config.js directamente -->
    <script src="../../auth/supabase-config.js"></script>
    <script src="../../js/sistema-alertas-comunidades.js"></script>
    
    <!-- Sistema de Sesiones Persistentes (despu茅s de config-supabase) -->
    <script src="../../js/sistema-sesiones-persistentes.js"></script>
    
    <!-- Panel de Celebraciones (opcional - puede generar 404 si no hay API) -->
    <!-- <script src="../../js/panel-celebracion-tiendas.js"></script> -->
    <script src="../../js/panel-historias-corazon.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (typeof SistemaAlertasComunidades !== 'undefined') {
                    window.alertasGlobal = new SistemaAlertasComunidades('global');
                }
                
                // Inicializar panel de historias cuando se muestre la secci贸n
                const originalMostrarSeccion = window.mostrarSeccion;
                window.mostrarSeccion = function(seccionId) {
                    originalMostrarSeccion(seccionId);
                    if (seccionId === 'historias-corazon') {
                        // Obtener ID del vendedor (ajustar seg煤n tu sistema)
                        const vendedorId = localStorage.getItem('tienda-id') || 'ejemplo-tienda';
                        const tipoVendedor = 'tienda'; // o 'servicio' seg煤n corresponda
                        panelHistorias.init(vendedorId, tipoVendedor);
                    }
                    
                    if (seccionId === 'configuracion-celebraciones') {
                        inicializarPanelCelebraciones();
                    }
                };
            }, 500);
        });
        
        function inicializarPanelCelebraciones() {
            const seccion = document.getElementById('configuracion-celebraciones');
            if (!seccion) return;
            
            seccion.innerHTML = `
                <div class="content-header">
                    <h1> Configuraci贸n de Celebraciones</h1>
                    <p>Gestiona las celebraciones y eventos especiales de tu tienda</p>
                </div>
                
                <div class="card">
                    <div class="alert alert-info">
                        <h3><i class="fas fa-info-circle"></i> 驴Qu茅 son las Celebraciones?</h3>
                        <p>Las celebraciones son banners especiales que aparecen en tu panel de administraci贸n para conmemorar fechas importantes como:</p>
                        <ul>
                            <li> Cumplea帽os del fundador/emprendedor</li>
                            <li> Aniversario del negocio</li>
                            <li> Aniversario en Cresalia</li>
                        </ul>
                    </div>
                    
                    <div class="card" style="margin-top: 2rem;">
                        <h3><i class="fas fa-cog"></i> Estado Actual</h3>
                        <div id="estadoCelebraciones" style="padding: 1rem; background: #F3F4F6; border-radius: 8px; margin-top: 1rem;">
                            <p style="color: #6B7280;">Cargando informaci贸n de celebraciones...</p>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 2rem;">
                        <h3><i class="fas fa-eye"></i> Previsualizaci贸n</h3>
                        <p style="color: #6B7280; margin-top: 0.5rem;">El banner de celebraci贸n aparecer谩 autom谩ticamente en tu panel cuando haya una fecha especial.</p>
                        <p style="color: #6B7280;">Puedes ocultarlo temporalmente usando los botones del banner.</p>
                    </div>
                </div>
            `;
            
            // Cargar estado de celebraciones
            setTimeout(() => {
                const estadoDiv = document.getElementById('estadoCelebraciones');
                if (estadoDiv) {
                    const banner = document.getElementById('celebracionBanner');
                    const estaVisible = banner && banner.style.display !== 'none';
                    
                    estadoDiv.innerHTML = `
                        <p><strong>Banner de Celebraci贸n:</strong> ${estaVisible ? '<span style="color: #10B981;"> Visible</span>' : '<span style="color: #6B7280;"> Oculto</span>'}</p>
                        <p style="margin-top: 0.5rem; color: #6B7280; font-size: 0.9rem;">Las celebraciones se cargan autom谩ticamente desde nuestro sistema cuando hay fechas especiales.</p>
                    `;
                }
            }, 500);
        }
    </script>
    
    <style>
        .historias-panel-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .historias-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .historias-header h2 {
            color: #1e293b;
            margin-bottom: 0.5rem;
        }
        
        .historias-header p {
            color: #64748b;
        }
        
        .historias-form .form-group {
            margin-bottom: 1.5rem;
        }
        
        .historias-form label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 500;
        }
        
        .historias-form input,
        .historias-form textarea,
        .historias-form select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .historias-form textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        .historias-form small {
            display: block;
            margin-top: 0.5rem;
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .preview-foto {
            margin-top: 1rem;
        }
        
        .preview-foto img {
            max-width: 200px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .btn-guardar-historia {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-guardar-historia:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn-eliminar-historia {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-eliminar-historia:hover {
            background: #dc2626;
        }
    </style>
    
    <!-- Widget de Chat de Email - Brevo -->
    <script src="../../js/widget-brevo-chat.js"></script>
    
    <script>
        // ============================================
        // SISTEMA DE BIENESTAR EMOCIONAL - WIDGET
        // ============================================
        
        // Funci贸n para deshabilitar widget de bienestar
        function deshabilitarBienestar() {
            console.log(' Deshabilitando widget de bienestar...');
            const widget = document.getElementById('bienestarWidget');
            const menu = document.getElementById('bienestarMenu');
            const panelControl = document.getElementById('panelControlBienestar');
            
            if (widget) {
                // Ocultar widget y men煤
                widget.style.display = 'none';
                if (menu) menu.style.display = 'none';
                
                // Guardar estado
                localStorage.setItem('bienestar_deshabilitado', 'true');
                
                // Mostrar panel de control simple
                mostrarPanelControlBienestar();
                
                if (typeof mostrarNotificacion === 'function') {
                    mostrarNotificacion(' Widget de bienestar deshabilitado', 'success');
                }
            } else {
                console.log('锔 Widget de bienestar no encontrado');
            }
        }
        
        // Funci贸n para habilitar widget de bienestar
        function habilitarBienestar() {
            console.log(' Habilitando widget de bienestar...');
            const widget = document.getElementById('bienestarWidget');
            const panelControl = document.getElementById('panelControlBienestar');
            
            if (widget) {
                // Mostrar widget
                widget.style.display = 'flex';
                
                // Remover estado deshabilitado
                localStorage.removeItem('bienestar_deshabilitado');
                
                // Ocultar panel de control
                if (panelControl) {
                    panelControl.style.display = 'none';
                }
                
                if (typeof mostrarNotificacion === 'function') {
                    mostrarNotificacion(' Widget de bienestar habilitado', 'success');
                }
            } else {
                console.log('锔 Widget de bienestar no encontrado');
            }
        }
        
        // Funci贸n para mostrar panel de control simple (solo botones)
        function mostrarPanelControlBienestar() {
            let panelControl = document.getElementById('panelControlBienestar');
            
            // Si no existe, crearlo
            if (!panelControl) {
                panelControl = document.createElement('div');
                panelControl.id = 'panelControlBienestar';
                panelControl.style.cssText = `
                    position: fixed !important;
                    bottom: 20px !important;
                    right: 20px !important;
                    background: white !important;
                    border-radius: 15px !important;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.15) !important;
                    padding: 20px !important;
                    z-index: 999998 !important;
                    min-width: 250px !important;
                    border: 2px solid #E5E7EB !important;
                `;
                
                panelControl.innerHTML = `
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #374151; font-size: 1rem;"> Bienestar Emocional</h4>
                        <p style="margin: 0; color: #6B7280; font-size: 0.85rem; line-height: 1.5;">Sabemos que no todos los d铆as son buenos. Si deseas desahogarte, puedes habilitarlo en cualquier momento. Estamos aqu铆 para ayudarte </p>
                    </div>
                    <div style="display: flex; gap: 10px; flex-direction: column;">
                        <button onclick="habilitarBienestar()" style="
                            background: #22c55e !important;
                            color: white !important;
                            border: none !important;
                            padding: 12px 20px !important;
                            border-radius: 8px !important;
                            cursor: pointer !important;
                            font-size: 0.9rem !important;
                            font-weight: 600 !important;
                            width: 100% !important;
                        ">
                            <i class="fas fa-heart"></i> Habilitar
                        </button>
                        <button onclick="deshabilitarBienestar()" style="
                            background: #ef4444 !important;
                            color: white !important;
                            border: none !important;
                            padding: 12px 20px !important;
                            border-radius: 8px !important;
                            cursor: pointer !important;
                            font-size: 0.9rem !important;
                            font-weight: 600 !important;
                            width: 100% !important;
                            opacity: 0.5 !important;
                            cursor: not-allowed !important;
                        " disabled>
                            <i class="fas fa-heart-broken"></i> Deshabilitar
                        </button>
                    </div>
                `;
                
                document.body.appendChild(panelControl);
            }
            
            // Mostrar panel
            panelControl.style.display = 'block';
        }
        
        // Hacer funciones globales para acceso desde onclick
        window.deshabilitarBienestar = deshabilitarBienestar;
        window.habilitarBienestar = habilitarBienestar;
        window.mostrarPanelControlBienestar = mostrarPanelControlBienestar;
        
        // Funci贸n para verificar estado del widget de bienestar al cargar
        function verificarEstadoWidgetBienestar() {
            console.log(' Verificando estado del widget de bienestar...');
            const widget = document.getElementById('bienestarWidget');
            const menu = document.getElementById('bienestarMenu');
            
            if (widget) {
                const deshabilitado = localStorage.getItem('bienestar_deshabilitado');
                if (deshabilitado === 'true') {
                    // Ocultar widget y men煤 completamente
                    widget.style.display = 'none';
                    if (menu) menu.style.display = 'none';
                    
                    // Mostrar panel de control simple
                    mostrarPanelControlBienestar();
                    
                    console.log(' Widget de bienestar deshabilitado por configuraci贸n - Panel de control mostrado');
                } else {
                    // Asegurar que el widget est茅 visible
                    widget.style.display = 'flex';
                    
                    // Ocultar panel de control si existe
                    const panelControl = document.getElementById('panelControlBienestar');
                    if (panelControl) {
                        panelControl.style.display = 'none';
                    }
                    
                    console.log(' Widget de bienestar habilitado');
                }
            } else {
                console.log('锔 Widget de bienestar no encontrado en el DOM');
            }
        }
        
        // Verificar estado al cargar
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                verificarEstadoWidgetBienestar();
            }, 1500);
        });
    </script>
    
    <!-- Sistema de Alertas Inteligente (Solidaridad Global + Proximidad Local) -->
    <script src="../../js/sistema-alertas-inteligente.js"></script>
    
    <!-- Funci贸n de Logout -->
    <script>
        async function cerrarSesionSegura() {
            if (!confirm('驴Est谩s seguro que quer茅s cerrar sesi贸n?')) {
                return;
            }
            
            try {
                console.log(' Cerrando sesi贸n...');
                
                const supabase = initSupabase();
                
                if (supabase) {
                    const { error } = await supabase.auth.signOut();
                    
                    if (error) {
                        console.error('Error al cerrar sesi贸n:', error);
                    }
                }
                
                // Limpiar localStorage
                localStorage.removeItem('cresalia_sesion_activa');
                localStorage.removeItem('cresalia_session_token');
                localStorage.removeItem('cresalia_user_data');
                localStorage.removeItem('plan-actual');
                
                // Limpiar sessionStorage
                sessionStorage.clear();
                
                console.log(' Sesi贸n cerrada correctamente');
                
                // Redirigir al login
                window.location.href = '../../login-tienda.html';
                
            } catch (error) {
                console.error(' Error al cerrar sesi贸n:', error);
                alert('Error al cerrar sesi贸n. Recargando p谩gina...');
                window.location.reload();
            }
        }
        
        // Hacer disponible globalmente
        window.cerrarSesionSegura = cerrarSesionSegura;
        
        // ===== SISTEMA DE AVATAR/LOGO PARA TIENDA =====
        async function cargarDatosTienda() {
            try {
                const supabase = initSupabase();
                if (!supabase) {
                    // Reintentar despu茅s de 1 segundo
                    setTimeout(cargarDatosTienda, 1000);
                    return;
                }
                
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error || !user) {
                    // Usuario no logueado, ocultar widget
                    document.getElementById('widget-perfil-tienda').style.display = 'none';
                    return;
                }
                
                // Mostrar widget
                const widget = document.getElementById('widget-perfil-tienda');
                widget.style.display = 'block';
                
                // Cargar datos del usuario/tienda
                const nombreTienda = user.user_metadata?.nombre_tienda || user.user_metadata?.nombre || user.email?.split('@')[0] || 'Mi Tienda';
                const email = user.email || '';
                const plan = user.user_metadata?.plan || localStorage.getItem('plan-actual') || 'FREE';
                
                document.getElementById('nombre-tienda-widget').textContent = nombreTienda;
                document.getElementById('email-tienda-widget').textContent = email;
                document.getElementById('plan-tienda-widget').textContent = `Plan: ${plan.toUpperCase()}`;
                
                // Cargar avatar/logo guardado
                const avatarUrl = localStorage.getItem('cresalia_avatar_tienda_url');
                if (avatarUrl) {
                    document.getElementById('avatar-tienda').src = avatarUrl;
                } else {
                    // Avatar por defecto con iniciales
                    const iniciales = nombreTienda.substring(0, 2).toUpperCase();
                    document.getElementById('avatar-tienda').src = `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'><rect width='100' height='100' fill='%237C3AED'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='36' font-weight='bold' fill='white'>${iniciales}</text></svg>`;
                }
                
            } catch (error) {
                console.error('Error cargando datos de tienda:', error);
            }
        }
        
        async function cambiarAvatarTienda(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validar tama帽o (m谩x 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('锔 La imagen es muy grande. Por favor, eleg铆 una imagen menor a 2MB.');
                return;
            }
            
            // Validar tipo
            if (!file.type.startsWith('image/')) {
                alert('锔 Por favor, eleg铆 una imagen v谩lida.');
                return;
            }
            
            try {
                // Crear preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const avatarImg = document.getElementById('avatar-tienda');
                    avatarImg.src = e.target.result;
                    
                    // Guardar en localStorage
                    localStorage.setItem('cresalia_avatar_tienda_url', e.target.result);
                    
                    console.log(' Logo/Avatar de tienda guardado');
                };
                reader.readAsDataURL(file);
                
            } catch (error) {
                console.error('Error cambiando avatar:', error);
                alert(' Error al cambiar el logo. Por favor, intent谩 de nuevo.');
            }
        }
        
        // Funci贸n para esperar a que initSupabase est茅 disponible
        function esperarInitSupabaseAdmin(callback, maxIntentos = 10, intento = 0) {
            if (typeof initSupabase !== 'undefined' && typeof initSupabase === 'function') {
                callback();
            } else if (intento < maxIntentos) {
                setTimeout(() => esperarInitSupabaseAdmin(callback, maxIntentos, intento + 1), 500);
            } else {
                console.warn('锔 initSupabase no est谩 disponible para cargar datos de tienda');
            }
        }
        
        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', () => {
            esperarInitSupabaseAdmin(cargarDatosTienda);
        });
        
        // Hacer funciones globales
        window.cambiarAvatarTienda = cambiarAvatarTienda;
        window.cargarDatosTienda = cargarDatosTienda;
    </script>
</body>
</html>
