<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesi√≥n - CRESALIA</title>
    
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 100%;
            padding: 40px;
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo img {
            max-width: 150px;
            height: auto;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }
        
        input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn-login {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn-login:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .forgot-password {
            text-align: center;
            margin-top: 15px;
        }
        
        .forgot-password a {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }
        
        .forgot-password a:hover {
            text-decoration: underline;
        }
        
        .register-link {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 14px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .register-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        
        .register-link a:hover {
            text-decoration: underline;
        }
        
        .notification {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .notification.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .notification.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .notification.visible {
            display: block;
        }
        
        /* ===== RESPONSIVE PARA M√ìVILES ===== */
        @media (max-width: 768px) {
            body {
                overflow-x: hidden !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 15px !important;
            }
            
            .login-container {
                width: 100% !important;
                max-width: 100% !important;
                padding: 25px 20px !important;
                margin: 0 !important;
            }
            
            h1 {
                font-size: 1.5rem !important;
                line-height: 1.3 !important;
            }
            
            .subtitle {
                font-size: 0.85rem !important;
            }
            
            .logo img {
                max-width: 100px !important;
            }
            
            label {
                font-size: 0.85rem !important;
            }
            
            input {
                padding: 10px 12px !important;
                font-size: 0.9rem !important;
            }
            
            .btn-login {
                padding: 12px !important;
                font-size: 0.95rem !important;
            }
            
            .back-link {
                font-size: 0.85rem !important;
            }
            
            .links {
                font-size: 0.85rem !important;
            }
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo">
            <img src="assets/logo/logo-cresalia.png" alt="CRESALIA" onerror="this.style.display='none'">
        </div>
        
        <h1>üè™ Acceso a Mi Tienda</h1>
        <p class="subtitle">Inicia sesi√≥n para gestionar tu negocio</p>
        
        <div id="notificacion" class="notification"></div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="email">
                    <i class="fas fa-envelope"></i> Email
                </label>
                <input 
                    type="email" 
                    id="email" 
                    placeholder="tu@email.com" 
                    required
                    autocomplete="email"
                >
            </div>
            
            <div class="form-group">
                <label for="password">
                    <i class="fas fa-lock"></i> Contrase√±a
                </label>
                <input 
                    type="password" 
                    id="password" 
                    placeholder="Tu contrase√±a" 
                    required
                    autocomplete="current-password"
                >
            </div>
            
            <button type="submit" class="btn-login" id="btnLogin">
                <i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n
            </button>
        </form>
        
        <div class="forgot-password">
            <a href="#" onclick="recuperarPasswordUI(); return false;">
                ¬øOlvidaste tu contrase√±a?
            </a>
        </div>
        
        <div class="register-link">
            ¬øNo tienes una tienda? <a href="registro-tienda.html">Cr√©ala gratis</a>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/inject-env-vars.js"></script>
    <script src="auth/supabase-config.js"></script>
    <script src="auth/auth-system.js"></script>
    <script src="auth/security-enhanced.js"></script>
    
    <script>
        // LIMPIAR URLs INV√ÅLIDAS INMEDIATAMENTE AL CARGAR
        (function() {
            console.log('üßπ Limpiando URLs inv√°lidas...');
            
            // Limpiar TODAS las keys que puedan contener URLs problem√°ticas
            const keysToCheck = [
                'cresalia_redirect_after_login',
                'cresalia_widget_acceso_activo',
                'cresalia_widget_comunidad_activo',
                'redirectAfterLogin',
                'cresalia_widget_url',
                'widget_url',
                'panel_url'
            ];
            
            // Limpiar localStorage
            keysToCheck.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    // Verificar si contiene variables sin procesar
                    if (value.includes('{widgetUrl}') || 
                        value.includes('$%7BwidgetUrl%7D') || 
                        value.includes('${widgetUrl}') ||
                        value.includes('widgetUrl') ||
                        value.includes('${') ||
                        (value.includes('%7B') && value.includes('%7D'))) {
                        console.warn('‚ö†Ô∏è Eliminando ' + key + ' con valor inv√°lido:', value);
                        localStorage.removeItem(key);
                    }
                }
            });
            
            // Limpiar TODAS las keys de localStorage que contengan URLs problem√°ticas
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key) {
                        const value = localStorage.getItem(key);
                        if (value && typeof value === 'string') {
                            // Verificar si es una URL y contiene variables sin procesar
                            if ((value.startsWith('http://') || value.startsWith('https://') || value.startsWith('/') || value.includes('/tiendas/')) &&
                                (value.includes('{widgetUrl}') || 
                                 value.includes('$%7BwidgetUrl%7D') || 
                                 value.includes('${widgetUrl}') ||
                                 value.includes('${') ||
                                 (value.includes('%7B') && value.includes('%7D')))) {
                                console.warn('‚ö†Ô∏è Eliminando key con URL inv√°lida:', key, value);
                                localStorage.removeItem(key);
                            }
                        }
                    }
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è Error limpiando localStorage:', e);
            }
            
            // Tambi√©n verificar en sessionStorage
            try {
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    if (key) {
                        const value = sessionStorage.getItem(key);
                        if (value && typeof value === 'string') {
                            if (value.includes('{widgetUrl}') || 
                                value.includes('$%7BwidgetUrl%7D') || 
                                value.includes('${widgetUrl}') ||
                                value.includes('widgetUrl')) {
                                console.warn('‚ö†Ô∏è Eliminando de sessionStorage:', key, value);
                                sessionStorage.removeItem(key);
                            }
                        }
                    }
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è Error limpiando sessionStorage:', e);
            }
            
            console.log('‚úÖ Limpieza completada');
        })();
        
        // Inicializar al cargar
        document.addEventListener('DOMContentLoaded', async function() {
            initSupabase();
            
            // Si viene de un registro exitoso, pre-llenar el email
            const registroExitoso = localStorage.getItem('registro_exitoso');
            const emailRegistro = localStorage.getItem('email_registro');
            
            if (registroExitoso === 'true' && emailRegistro) {
                document.getElementById('email').value = emailRegistro;
                mostrarNotificacion('‚úÖ Registro exitoso. Ahora inicia sesi√≥n con tu contrase√±a', 'success');
                
                // Limpiar flags
                localStorage.removeItem('registro_exitoso');
                localStorage.removeItem('email_registro');
            }
            
            // Verificar si ya hay sesi√≥n activa
            const session = await verificarSesion();
            if (session) {
                console.log('‚úÖ Ya hay sesi√≥n activa, redirigiendo...');
                redirigirAAdmin();
                return;
            }
            
            // Manejar env√≠o del formulario
            const form = document.getElementById('loginForm');
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                
                // Verificar seguridad (anti fuerza bruta)
                const verificacion = verificarSeguridadLogin(email, password);
                if (!verificacion.permitido) {
                    mostrarNotificacion(verificacion.mensaje, 'error');
                    return;
                }
                
                // Deshabilitar bot√≥n
                const btnLogin = document.getElementById('btnLogin');
                btnLogin.disabled = true;
                btnLogin.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando sesi√≥n...';
                
                // Intentar login
                const resultado = await loginCliente(email, password);
                
                if (resultado.success) {
                    // Resetear intentos fallidos
                    securityEnhanced.resetearIntentos();
                    
                    // Registrar evento de seguridad
                    securityEnhanced.registrarEvento('login_exitoso', {
                        email: email,
                        tienda: resultado.tienda.nombre_tienda
                    });
                    
                    mostrarNotificacion('‚úÖ ' + resultado.mensaje, 'success');
                    
                    // Redirigir al admin
                    setTimeout(() => {
                        redirigirAAdmin(resultado.tienda);
                    }, 1500);
                } else {
                    // Registrar intento fallido
                    const intentos = securityEnhanced.registrarIntentoFallido();
                    
                    let mensaje = resultado.mensaje;
                    if (intentos.intentosRestantes > 0) {
                        mensaje += ` (${intentos.intentosRestantes} intentos restantes)`;
                    }
                    
                    mostrarNotificacion('‚ùå ' + mensaje, 'error');
                    btnLogin.disabled = false;
                    btnLogin.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n';
                }
            });
        });
        
        function redirigirAAdmin(tienda) {
            // LIMPIAR COMPLETAMENTE cualquier URL guardada - NO USAR NUNCA URLs guardadas
            // Esto previene cualquier problema con URLs inv√°lidas
            console.log('üßπ Limpiando todas las URLs guardadas antes de redirigir...');
            
            // Limpiar keys espec√≠ficas
            const keysToRemove = [
                'cresalia_redirect_after_login',
                'redirectAfterLogin',
                'cresalia_widget_acceso_activo',
                'cresalia_widget_comunidad_activo',
                'cresalia_widget_url',
                'widget_url',
                'panel_url'
            ];
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                sessionStorage.removeItem(key);
            });
            
            // Limpiar CUALQUIER key que contenga una URL problem√°tica
            try {
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key) {
                        const value = localStorage.getItem(key);
                        if (value && typeof value === 'string') {
                            // Si contiene una URL con variables sin procesar, eliminarla
                            if ((value.includes('/tiendas/') || value.includes('admin-final') || value.includes('widget')) &&
                                (value.includes('{widgetUrl}') || 
                                 value.includes('$%7BwidgetUrl%7D') || 
                                 value.includes('${widgetUrl}') ||
                                 value.includes('${') ||
                                 (value.includes('%7B') && value.includes('%7D')))) {
                                console.warn('‚ö†Ô∏è Eliminando URL inv√°lida de localStorage:', key, value);
                                localStorage.removeItem(key);
                            }
                        }
                    }
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è Error limpiando localStorage:', e);
            }
            
            // Guardar info de la tienda antes de redirigir
            if (tienda) {
                localStorage.setItem('tienda_actual', JSON.stringify(tienda));
                localStorage.setItem('login_tipo', 'supabase');
                
                // Guardar informaci√≥n de sesi√≥n completa
                localStorage.setItem('cresalia_sesion_activa', 'true');
                localStorage.setItem('cresalia_session_token', 'login_exitoso');
                localStorage.setItem('cresalia_user_data', JSON.stringify({
                    email: tienda.email,
                    nombre_tienda: tienda.nombre_tienda,
                    plan: tienda.plan || 'basic',
                    tipo: 'tienda'
                }));
                localStorage.setItem('plan-actual', tienda.plan || 'basic');
            }
            
            // Prevenir redirecciones m√∫ltiples
            if (window.location.pathname.includes('admin-final.html') || window.location.pathname.includes('admin.html')) {
                console.log('‚úÖ Ya estamos en el panel admin');
                return;
            }
            
            // SIEMPRE usar URL por defecto - NO usar URLs guardadas
            // Detectar si estamos en file:// o http:// y construir la ruta correctamente
            const isFileProtocol = window.location.protocol === 'file:';
            let urlFinal;
            
            if (isFileProtocol) {
                // Para file:// en Windows, usar ruta relativa (m√°s confiable)
                // login-tienda.html est√° en la ra√≠z, admin-final.html est√° en tiendas/ejemplo-tienda/
                urlFinal = 'tiendas/ejemplo-tienda/admin-final.html';
                console.log('‚úÖ Contexto file:// detectado - usando ruta relativa');
            } else {
                // Para http:// o https://, usar URL absoluta
                const baseUrl = window.location.origin;
                urlFinal = baseUrl + '/tiendas/ejemplo-tienda/admin-final.html';
                console.log('‚úÖ Contexto http/https detectado - usando URL absoluta');
            }
            
            // Todos los clientes usan el mismo panel admin
            // pero ver√°n sus propios datos personalizados
            console.log('üöÄ Redirigiendo al panel admin (URL por defecto)...');
            console.log('üìç URL destino:', urlFinal);
            
            // Validar que la URL final NO contenga variables sin procesar (triple verificaci√≥n)
            if (urlFinal.includes('{widgetUrl}') || 
                urlFinal.includes('$%7BwidgetUrl%7D') || 
                urlFinal.includes('widgetUrl') ||
                urlFinal.includes('${') ||
                (urlFinal.includes('%7B') && urlFinal.includes('%7D'))) {
                console.error('‚ùå ERROR CR√çTICO: URL final contiene variables sin procesar:', urlFinal);
                alert('‚ùå Error: URL inv√°lida detectada. Por favor, contacta soporte.');
                return;
            }
            
            // Redirigir seg√∫n el protocolo
            if (isFileProtocol) {
                // Para file://, usar ruta relativa con href
                console.log('üöÄ Redirigiendo con ruta relativa...');
                console.log('üìç URL destino (relativa):', urlFinal);
                
                // Intentar m√∫ltiples m√©todos para asegurar la redirecci√≥n
                try {
                    // M√©todo 1: href directo
                    window.location.href = urlFinal;
                    
                    // Si despu√©s de 1 segundo no se redirigi√≥, intentar otros m√©todos
                    setTimeout(() => {
                        if (window.location.href.indexOf('admin-final.html') === -1) {
                            console.warn('‚ö†Ô∏è Redirecci√≥n con href fall√≥, intentando con replace...');
                            try {
                                window.location.replace(urlFinal);
                            } catch (e) {
                                console.error('‚ùå Error con replace:', e);
                                // √öltimo intento: construir URL absoluta desde la ruta actual
                                const currentDir = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
                                const absolutePath = currentDir + '/' + urlFinal;
                                console.log('üîÑ Intentando con ruta absoluta:', absolutePath);
                                window.location.href = absolutePath;
                            }
                        }
                    }, 1000);
                } catch (error) {
                    console.error('‚ùå Error en redirecci√≥n file://:', error);
                    alert('Error al redirigir. Por favor, abre manualmente: ' + urlFinal);
                }
            } else {
                // Para http:// o https://, validar con URL() y redirigir
                try {
                    const urlTest = new URL(urlFinal);
                    console.log('‚úÖ URL v√°lida, redirigiendo...');
                    console.log('üìç URL completa:', urlFinal);
                    
                    // Intentar redirigir
                    window.location.replace(urlFinal);
                    
                    // Si despu√©s de 2 segundos no se redirigi√≥, intentar con href
                    setTimeout(() => {
                        if (window.location.href !== urlFinal) {
                            console.warn('‚ö†Ô∏è Redirecci√≥n con replace fall√≥, intentando con href...');
                            window.location.href = urlFinal;
                        }
                    }, 2000);
                } catch (error) {
                    console.error('‚ùå Error: URL inv√°lida:', urlFinal);
                    console.error('Error details:', error);
                    // Fallback a URL por defecto absoluta
                    const fallbackUrl = window.location.origin + '/tiendas/ejemplo-tienda/admin-final.html';
                    console.log('‚ö†Ô∏è Usando URL fallback:', fallbackUrl);
                    window.location.href = fallbackUrl;
                }
            }
        }
        
        function mostrarNotificacion(mensaje, tipo) {
            const notif = document.getElementById('notificacion');
            notif.textContent = mensaje;
            notif.className = `notification ${tipo} visible`;
            
            setTimeout(() => {
                notif.classList.remove('visible');
            }, 5000);
        }
        
        async function recuperarPasswordUI() {
            const email = prompt('Ingresa tu email para recuperar tu contrase√±a:');
            if (!email) return;
            try {
                const resultado = await window.recuperarPassword(email);
                if (resultado?.success) {
                    alert(resultado.mensaje || 'Revisa tu correo para el enlace de recuperaci√≥n.');
                } else {
                    alert('Error: ' + (resultado?.mensaje || 'No se pudo enviar el correo.'));
                }
            } catch (err) {
                console.error('‚ùå Error en recuperaci√≥n de contrase√±a:', err);
                alert('Error enviando email de recuperaci√≥n. Intenta de nuevo.');
            }
        }
    </script>
</body>
</html>

